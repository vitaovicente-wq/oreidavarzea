<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRFutebol - Finanças</title>
    <script src="engine.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700;900&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root { --bg-dark: #0f1216; --card: #1e2329; --neon: #00ff88; --red: #ff4757; --orange: #ff9f43; --text: #fff; --border: #333; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-dark); color: var(--text); margin: 0; padding: 20px; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 15px; }
        .title { font-family: 'Rajdhani'; font-weight: 800; font-size: 2rem; text-transform: uppercase; }
        .back-btn { text-decoration: none; color: #ccc; border: 1px solid #444; padding: 8px 20px; border-radius: 6px; font-size: 0.9rem; transition: 0.2s; }
        .back-btn:hover { border-color: var(--neon); color: var(--neon); }

        .dashboard { display: grid; grid-template-columns: 300px 1fr; gap: 20px; flex: 1; overflow: hidden; }
        
        /* SIDEBAR DE RESUMO */
        .summary-col { display: flex; flex-direction: column; gap: 15px; }
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; }
        .card-label { font-size: 0.8rem; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
        .card-value { font-family: 'Rajdhani'; font-weight: 900; font-size: 2rem; color: #fff; }
        .card-value.pos { color: var(--neon); }
        .card-value.neg { color: var(--red); }

        .list-container { flex: 1; background: var(--card); border: 1px solid var(--border); border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; }
        .list-header { padding: 15px; background: rgba(0,0,0,0.2); font-family: 'Rajdhani'; font-weight: 700; border-bottom: 1px solid var(--border); }
        .trans-list { overflow-y: auto; flex: 1; }
        .trans-item { display: flex; justify-content: space-between; padding: 12px 15px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.9rem; }
        .trans-item:last-child { border-bottom: none; }
        .t-desc { color: #ccc; }
        .t-val { font-weight: 700; font-family: 'Rajdhani'; }
        
        /* ÁREA DO GRÁFICO */
        .chart-col { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; display: flex; flex-direction: column; }
        .chart-wrapper { flex: 1; position: relative; min-height: 0; }
    </style>
</head>
<body>

    <div class="header">
        <div class="title">Departamento Financeiro</div>
        <a href="dashboard.html" class="back-btn">❮ Voltar</a>
    </div>

    <div class="dashboard">
        <div class="summary-col">
            <div class="card">
                <div class="card-label">Saldo em Caixa</div>
                <div class="card-value" id="disp-saldo">R$ 0,00</div>
            </div>
            
            <div class="list-container">
                <div class="list-header">Últimos Lançamentos</div>
                <div class="trans-list" id="lista-transacoes">
                    </div>
            </div>
        </div>

        <div class="chart-col">
            <div class="card-label">Fluxo de Caixa (Mensal)</div>
            <div class="chart-wrapper">
                <canvas id="finChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        window.onload = function() {
            const game = Engine.carregarJogo();
            if(!game) return;

            // 1. ATUALIZA SALDO
            const saldo = game.recursos.dinheiro;
            const elSaldo = document.getElementById('disp-saldo');
            elSaldo.innerText = saldo.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            elSaldo.className = `card-value ${saldo >= 0 ? 'pos' : 'neg'}`;

            // 2. LISTA DE TRANSAÇÕES
            const lista = document.getElementById('lista-transacoes');
            const historico = game.financas ? game.financas.historico : [];
            
            [...historico].reverse().forEach(t => {
                const div = document.createElement('div');
                div.className = 'trans-item';
                const cor = t.tipo === 'entrada' ? 'var(--neon)' : 'var(--red)';
                const sinal = t.tipo === 'entrada' ? '+' : '';
                div.innerHTML = `
                    <span class="t-desc">${t.texto}</span>
                    <span class="t-val" style="color:${cor}">${sinal} ${t.valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</span>
                `;
                lista.appendChild(div);
            });

            // 3. PREPARAR DADOS DO GRÁFICO (AGRUPADO POR "MÊS" = 4 RODADAS)
            renderizarGrafico(historico);
        };

        function renderizarGrafico(historico) {
            // Agrupa dados
            const meses = {};
            
            historico.forEach(h => {
                // Se o histórico não tiver 'rodada', assume 1.
                // Simulamos Mês: Rodada 1-4 = Mês 1, 5-8 = Mês 2, etc.
                // Como o objeto histórico original não salvava rodada, vamos inferir pela ordem ou adicionar suporte futuro.
                // Para simplificar, vamos agrupar sequencialmente em blocos de 4 lançamentos de cada tipo ou usar um índice simulado.
                // MELHOR: Vamos considerar que cada 5 lançamentos representam um período se não tiver data.
                
                // Mas, para ficar perfeito com a engine nova, vamos assumir que o jogo avança.
                // Vamos criar uma lógica simples: Agrupar por "Rodada" se disponível, ou sequencial.
                
                let label = "Atual";
                // Lógica simples para demonstração visual imediata
                // Pega os últimos lançamentos e categoriza
            });

            // Como o histórico pode ser antigo e sem data, vamos criar datasets baseados nos tipos
            // Para o gráfico ficar bonito agora, vamos somar tudo por CATEGORIA.
            
            let receitaTotal = 0;
            let gastoSalario = 0;
            let gastoManutencao = 0;

            // Simula evolução temporal (acumulado)
            let labels = [];
            let dataRec = [];
            let dataSal = [];
            let dataMan = [];
            
            // Vamos pegar as últimas 10 "rodadas financeiras" (onde houve pagamento de salário)
            let salariosP = historico.filter(h => h.texto.includes("Salários"));
            
            // Se tiver pouco dado, cria fictício pro gráfico não ficar vazio
            if(salariosP.length < 2) {
                labels = ["Mês 1", "Mês 2 (Proj)"];
                dataRec = [0, 0]; 
                dataSal = [0, 0];
                dataMan = [0, 0];
            } else {
                // Monta timeline baseada nos pagamentos de salário (que ocorrem 1x por rodada)
                salariosP.forEach((s, i) => {
                    labels.push(`Rodada ${i+1}`);
                    dataSal.push(Math.abs(s.valor));
                    
                    // Tenta achar manutenção próxima desse salário
                    // (Lógica aproximada para visualização)
                    dataMan.push(Math.random() * 50000); // Placeholder até a engine gerar dados reais
                    dataRec.push(Math.random() * 500000); // Placeholder
                });
            }

            // REFAZENDO A LÓGICA PARA DADOS REAIS DA ENGINE ATUALIZADA
            // O gráfico vai mostrar as últimas entradas reais
            const chartData = processarDadosReais(historico);

            const ctx = document.getElementById('finChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.labels,
                    datasets: [
                        {
                            label: 'Receitas (Bilheteria/Vendas)',
                            data: chartData.receitas,
                            backgroundColor: '#00ff88',
                            borderRadius: 4
                        },
                        {
                            label: 'Despesa: Salários',
                            data: chartData.salarios,
                            backgroundColor: '#ff4757',
                            borderRadius: 4
                        },
                        {
                            label: 'Despesa: Manutenção Arena',
                            data: chartData.manutencao,
                            backgroundColor: '#ff9f43', // Laranja
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#fff' } }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            grid: { color: '#333' },
                            ticks: { color: '#888' } 
                        },
                        x: { 
                            grid: { display: false },
                            ticks: { color: '#fff' }
                        }
                    }
                }
            });
        }

        function processarDadosReais(historico) {
            let labels = [];
            let receitas = [];
            let salarios = [];
            let manutencao = [];

            // Agrupa por índice sequencial de eventos de "fechamento de caixa"
            // Vamos varrer o histórico. Toda vez que acharmos "Salários", fechamos um bloco (uma rodada)
            
            let tempRec = 0;
            let tempSal = 0;
            let tempMan = 0;
            let rodadaCount = 1;

            // Inverter para processar do antigo pro novo
            const histCronologico = [...historico]; 

            histCronologico.forEach(h => {
                if(h.tipo === 'entrada') tempRec += h.valor;
                if(h.texto.includes("Salários")) tempSal += Math.abs(h.valor);
                if(h.texto.includes("Manutenção")) tempMan += Math.abs(h.valor);

                // Gatilho: Se pagou salário, fecha a coluna do gráfico
                if(h.texto.includes("Salários")) {
                    labels.push(`Rod ${rodadaCount}`);
                    receitas.push(tempRec);
                    salarios.push(tempSal);
                    manutencao.push(tempMan);
                    
                    // Reseta para proxima
                    tempRec = 0; tempSal = 0; tempMan = 0;
                    rodadaCount++;
                }
            });

            // Se não tiver dados suficientes, cria um dummy inicial zerado
            if(labels.length === 0) {
                return { labels: ["Início"], receitas: [0], salarios: [0], manutencao: [0] };
            }

            return { labels, receitas, salarios, manutencao };
        }
    </script>
</body>
</html>
