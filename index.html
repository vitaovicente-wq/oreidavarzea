<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>O Rei da Várzea — Protótipo</title>
<style>
  :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
  body{margin:0;background:#f5f7fb;color:#111}
  header{background:#0b6bd6;color:#fff;padding:14px 18px}
  .container{max-width:1100px;margin:18px auto;padding:10px}
  .card{background:#fff;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.06);padding:16px;margin-bottom:16px;}
  label{display:block;margin-top:8px}
  input[type=text]{width:100%;padding:10px;border:1px solid #ddd;border-radius:6px}
  button{background:#0b6bd6;color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
  button[disabled]{opacity:0.45;cursor:default}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
  th{background:#fafafa}
  .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:10px}
  .muted{color:#666;font-size:13px}
  .bench{display:flex;flex-direction:column;gap:6px;max-height:260px;overflow:auto;padding:8px;border:1px dashed #ccc;border-radius:8px}
  .player-card{padding:8px;border-radius:8px;background:#fff;border:1px solid #eee;margin-bottom:6px;cursor:grab;display:flex;justify-content:space-between;align-items:center}
  .player-card.locked{background:#ddd;cursor:not-allowed}
  .position-slot{width:90px;height:40px;border-radius:6px;background:rgba(255,255,255,0.95);display:flex;align-items:center;justify-content:center;cursor:pointer;margin:6px}
  .pitch{width:100%;height:420px;background:linear-gradient(#73c26b,#5eb95e);border-radius:12px;padding:12px;box-sizing:border-box}
  .notif{position:fixed;top:18px;right:18px;background:#ffefc2;color:#333;padding:10px 14px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,.12);border:1px solid #e6b800}
</style>
</head>
<body>
<header>
  <div class="container"><h1>O Rei da Várzea — Protótipo</h1></div>
</header>

<div class="container">

  <!-- Tela 1 -->
  <div id="tela1" class="card">
    <h2>Tela 1 — Cadastro</h2>
    <label>Nome do seu time
      <input id="teamName" type="text" placeholder="Ex: Os Meninos da Rua" />
    </label>
    <label>Seu nome
      <input id="userName" type="text" placeholder="Seu nome" />
    </label>
    <label>Cidade
      <input id="cityName" type="text" placeholder="Cidade" />
    </label>
    <div class="controls">
      <button id="btnToTela2" disabled>Contratar jogadores</button>
      <div class="muted">Preencha todos os campos para habilitar.</div>
    </div>
  </div>

  <!-- Tela 2 -->
  <div id="tela2" class="card" style="display:none">
    <h2>Tela 2 — Mercado de Jogadores</h2>

    <!-- orientação acima da tabela -->
    <div id="marketMessage" style="font-weight:bold;margin-bottom:10px">Escolha no mínimo 2 goleiros para o seu time</div>

    <div style="margin-top:10px;overflow:auto;max-height:480px">
      <table id="playersTable">
        <thead>
          <tr><th>Nome</th><th>Posição</th><th>Pé</th><th>Idade</th><th>Salário</th><th>Contratar</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- botões abaixo da tabela -->
    <div class="controls">
      <button id="btnNextStep">Próximo</button>
      <button id="btnEscalar" disabled>Escalar time</button>
      <div style="margin-left:auto">
        <strong>Dinheiro em caixa:</strong>
        <span id="cashDisplay">R$ 5.000</span> |
        <span class="muted">Elenco <span id="selectedCount">0</span>/22</span>
      </div>
    </div>
  </div>

  <!-- Tela 3 -->
  <div id="tela3" class="card" style="display:none">
    <h2>Tela 3 — Escalação</h2>
    <div style="display:flex;gap:16px">
      <div style="flex:1">
        <div class="card">
          <h3>Escalação (arraste do banco para a posição)</h3>
          <div class="pitch" id="pitch">
            <div style="display:flex;flex-wrap:wrap;justify-content:center">
              <div class="position-slot" data-pos="GK" id="slot-GK" ondrop="dropHandler(event)" ondragover="allowDrop(event)">GK</div>
            </div>
            <div style="display:flex;justify-content:space-between;margin-top:12px">
              <div class="position-slot" data-pos="LB" id="slot-LB" ondrop="dropHandler(event)" ondragover="allowDrop(event)">LB</div>
              <div class="position-slot" data-pos="CB1" id="slot-CB1" ondrop="dropHandler(event)" ondragover="allowDrop(event)">CB</div>
              <div class="position-slot" data-pos="CB2" id="slot-CB2" ondrop="dropHandler(event)" ondragover="allowDrop(event)">CB</div>
              <div class="position-slot" data-pos="RB" id="slot-RB" ondrop="dropHandler(event)" ondragover="allowDrop(event)">RB</div>
            </div>
            <div style="display:flex;justify-content:space-around;margin-top:12px">
              <div class="position-slot" data-pos="DM" id="slot-DM" ondrop="dropHandler(event)" ondragover="allowDrop(event)">VOL</div>
              <div class="position-slot" data-pos="CM1" id="slot-CM1" ondrop="dropHandler(event)" ondragover="allowDrop(event)">MEI</div>
              <div class="position-slot" data-pos="CM2" id="slot-CM2" ondrop="dropHandler(event)" ondragover="allowDrop(event)">MEI</div>
            </div>
            <div style="display:flex;justify-content:space-between;margin-top:12px">
              <div class="position-slot" data-pos="LW" id="slot-LW" ondrop="dropHandler(event)" ondragover="allowDrop(event)">AE</div>
              <div class="position-slot" data-pos="ST" id="slot-ST" ondrop="dropHandler(event)" ondragover="allowDrop(event)">ATA</div>
              <div class="position-slot" data-pos="RW" id="slot-RW" ondrop="dropHandler(event)" ondragover="allowDrop(event)">AD</div>
            </div>
          </div>
        </div>

        <div class="controls" style="margin-top:10px">
          <button id="btnPlayMatch" disabled>Jogar partida</button>
        </div>
      </div>

      <div style="width:320px">
        <div class="card">
          <h3>Banco / Jogadores contratados</h3>
          <div class="bench" id="bench"></div>
          <div class="muted" style="margin-top:8px">Clique no jogador no banco para desassociar (se já estiver escalado).</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tela 4 -->
  <div id="tela4" class="card" style="display:none">
    <h2>Partida em andamento</h2>
    <div style="display:flex;gap:16px">
      <div style="flex:1">
        <h3 id="userTeamName">Meu Time</h3>
        <ul id="jogadoresUsuario"></ul>
      </div>
      <div style="flex:2;text-align:center">
        <h2 id="placar">0 x 0</h2>
        <div id="comentarios" style="text-align:left;max-height:300px;overflow:auto;border:1px solid #ddd;border-radius:6px;padding:10px"></div>
        <div style="margin-top:10px"><button id="btnContinuar" style="display:none">Continuar</button></div>
      </div>
      <div style="flex:1">
        <h3>Vila Freitas</h3>
        <ul id="jogadoresVila"></ul>
      </div>
    </div>
  </div>

</div>

<script>
/* ---------- Config e dados ---------- */
const MAX_PLAYERS = 22;
const TOTAL_MARKET = 42;
let CASH = 5000;
let players = [];
let hired = [];
let marketStep = 1; // começamos em goleiros

const steps = [
  { msg: "Hora de montar o seu time, escolha 22 jogadores para iniciar", filter: null, min: 0 },
  { msg: "Escolha no mínimo 2 goleiros para o seu time", filter: "Goleiro", min: 2 },
  { msg: "Escolha no mínimo 3 laterais para o seu time", filter: "Lateral", min: 3 },
  { msg: "Escolha no mínimo 3 zagueiros para o seu time", filter: "Zagueiro", min: 3 },
  { msg: "Escolha no mínimo 3 volantes para o seu time", filter: "Volante", min: 3 },
  { msg: "Escolha no mínimo 6 meias para o seu time", filter: "Meia", min: 6 },
  { msg: "Escolha no mínimo 4 atacantes para o seu time", filter: "Atacante", min: 4 }
];

/* ---------- Elementos ---------- */
const teamName = document.getElementById('teamName');
const userName = document.getElementById('userName');
const cityName = document.getElementById('cityName');

const tela1 = document.getElementById('tela1');
const tela2 = document.getElementById('tela2');
const tela3 = document.getElementById('tela3');
const tela4 = document.getElementById('tela4');

const btnToTela2 = document.getElementById('btnToTela2');
const marketMessage = document.getElementById('marketMessage');
const playersTbody = document.querySelector('#playersTable tbody');
const btnNextStep = document.getElementById('btnNextStep');
const btnEscalar = document.getElementById('btnEscalar');
const cashDisplay = document.getElementById('cashDisplay');
const selectedCountEl = document.getElementById('selectedCount');

const bench = document.getElementById('bench');
const btnPlayMatch = document.getElementById('btnPlayMatch');

const jogadoresUsuario = document.getElementById('jogadoresUsuario');
const jogadoresVila = document.getElementById('jogadoresVila');
const userTeamNameEl = document.getElementById('userTeamName');
const placar = document.getElementById('placar');
const comentarios = document.getElementById('comentarios');
const btnContinuar = document.getElementById('btnContinuar');

/* ---------- helpers ---------- */
function showNotif(text, time=2500){
  const box = document.createElement('div'); box.className='notif'; box.textContent = text;
  document.body.appendChild(box);
  setTimeout(()=>box.remove(), time);
}
function formatReal(n){ return 'R$ ' + n.toLocaleString('pt-BR'); }
function updateCash(){ cashDisplay.textContent = formatReal(CASH); }
function updateSelectedCount(){ selectedCountEl.textContent = hired.length; }

/* ---------- Gera jogadores (fictícios) ---------- */
const firsts = ["Marrentinho","Juscelino","Ronaldinho","Berg","Tico","Zeca","Xandão","Pedrinho","Claudinho","Sandro","Marollo","Ricardão"];
const lastParts = ["Carioca","Paulista","Baiano","Gaucho","Mineiro","Nordestino","Pernambucano","Capixaba"];
const distribution = { GK:4, ZAG:8, LAT:8, VOL:6, MEI:8, ATA:8 };

function pickFoot(){ const r=Math.random()*100; if(r<10) return 'Ambidestro'; if(r<70) return 'Direito'; return 'Esquerdo'; }
function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

function generatePlayers(){
  players = [];
  const buckets = [];
  Object.keys(distribution).forEach(k=>{ for(let i=0;i<distribution[k];i++) buckets.push(k); });
  while(buckets.length < TOTAL_MARKET) buckets.push('MEI');
  for(let i=0;i<TOTAL_MARKET;i++){
    const posKey = buckets[i];
    const map = { GK:'Goleiro', ZAG:'Zagueiro', LAT:'Lateral', VOL:'Volante', MEI:'Meia', ATA:'Atacante' };
    const posLabel = map[posKey] || 'Meia';
    const name = firsts[i % firsts.length] + ' ' + lastParts[i % lastParts.length];
    players.push({
      id: 'p'+i,
      name,
      pos: posLabel,
      foot: pickFoot(),
      age: randInt(16,45),
      salary: Math.round(randInt(50,200)/10)*10
    });
  }
}

/* ---------- Mercado (render + eventos) ---------- */
function renderMarket(filter){
  playersTbody.innerHTML = '';
  const list = players.filter(p => !filter || p.pos === filter);
  if(list.length === 0){
    const tr = document.createElement('tr');
    tr.innerHTML = '<td colspan="6" class="muted">Nenhum jogador disponível para essa posição.</td>';
    playersTbody.appendChild(tr);
    return;
  }
  list.forEach(p=>{
    const tr = document.createElement('tr');
    const hiredAlready = hired.some(h=>h.id===p.id);
    tr.innerHTML = `
      <td><strong>${p.name}</strong><div class="muted">${p.pos}</div></td>
      <td>${p.pos}</td>
      <td>${p.foot}</td>
      <td>${p.age}</td>
      <td>${formatReal(p.salary)}</td>
      <td style="width:120px"><input type="checkbox" id="cb-${p.id}" data-id="${p.id}" ${hiredAlready?'checked':''}></td>
    `;
    playersTbody.appendChild(tr);
  });
  // ligando eventos nos checkboxes
  document.querySelectorAll('#playersTable input[type=checkbox]').forEach(cb=>{
    cb.onchange = onToggleHire;
    // set disabled state according to funds / limit
    const pid = cb.dataset.id;
    const ply = players.find(x=>x.id===pid);
    if(!cb.checked && (hired.length >= MAX_PLAYERS || CASH - ply.salary < 0)) cb.disabled = true;
    else cb.disabled = false;
  });
  updateButtonStates();
}

function onToggleHire(ev){
  const cb = ev.currentTarget;
  const pid = cb.dataset.id;
  const ply = players.find(x=>x.id===pid);
  if(cb.checked){
    if(hired.length >= MAX_PLAYERS){ showNotif('Limite de 22 jogadores atingido'); cb.checked=false; return; }
    if(CASH - ply.salary < 0){ showNotif('Saldo insuficiente para este jogador'); cb.checked=false; return; }
    CASH -= ply.salary;
    hired.push(ply);
  } else {
    CASH += ply.salary;
    hired = hired.filter(h=>h.id !== pid);
    // se estava escalado, desassocia automaticamente (segurança)
    document.querySelectorAll('.position-slot[data-assigned]').forEach(slot=>{
      if(slot.dataset.assigned === pid){
        slot.textContent = slot.dataset.pos; // volta label
        delete slot.dataset.assigned;
        // reativa visual do card no banco quando estiver visível
        const card = document.getElementById('bench-'+pid);
        if(card){ card.classList.remove('locked'); card.draggable = true; card.style.cursor = 'grab'; }
      }
    });
  }
  updateCash(); updateSelectedCount();
  // re-render current filter (to refresh disabled checkboxes)
  renderMarket(steps[marketStep].filter);
}

/* ---------- validações e passos ---------- */
function countHiredByPos(posLabel){
  return hired.filter(h => h.pos === posLabel).length;
}

function updateButtonStates(){
  // btnEscalar habilita somente quando houver exatamente 22 jogadores
  btnEscalar.disabled = (hired.length !== MAX_PLAYERS);
  // btnNextStep sempre habilitado (mas validação ao clicar)
  // checkboxes already updated on renderMarket
  // atualizar contador
  updateSelectedCount();
  updateCash();
}

/* ---------- passo (Next) ---------- */
btnNextStep.addEventListener('click', ()=>{
  // valida o mínimo do passo atual antes de avançar (exceto se filter = null)
  const current = steps[marketStep];
  if(current && current.filter){
    const have = countHiredByPos(current.filter);
    if(have < current.min){
      showNotif(`Escolha no mínimo ${current.min} ${current.filter}(s).`);
      return;
    }
  }
  // avança o passo
  marketStep++;
  if(marketStep >= steps.length) marketStep = steps.length - 1;
  marketMessage.textContent = steps[marketStep].msg;
  renderMarket(steps[marketStep].filter);
});

/* ---------- Escalar (vai pra tela 3) ---------- */
btnEscalar.addEventListener('click', ()=>{
  if(hired.length !== MAX_PLAYERS){ showNotif('Você precisa contratar exatamente 22 jogadores para escalar.'); return; }
  tela2.style.display = 'none';
  tela3.style.display = 'block';
  populateBench();
});

/* ---------- Escalação / drag & drop ---------- */
function populateBench(){
  bench.innerHTML = '';
  hired.forEach(p=>{
    const div = document.createElement('div');
    div.className = 'player-card';
    div.id = 'bench-'+p.id;
    div.draggable = true;
    div.dataset.pid = p.id;
    div.dataset.pos = p.pos;
    div.innerHTML = `<div><strong>${p.name}</strong><div class="muted">${p.pos} • ${p.foot} • ${p.age} anos</div></div>
                     <div class="muted">${formatReal(p.salary)}</div>`;
    div.addEventListener('dragstart', dragStart);
    // clique: desassociar se estava preso a algum slot
    div.addEventListener('click', ()=>{
      const pid = div.dataset.pid;
      const slot = document.querySelector(`.position-slot[data-assigned="${pid}"]`);
      if(slot){
        // libera slot
        slot.textContent = slot.dataset.pos;
        delete slot.dataset.assigned;
        // libera cartão do banco
        div.classList.remove('locked');
        div.draggable = true;
        div.style.cursor = 'grab';
        // depois de liberar, desabilita botão de jogar se menos de 11 preenchidos
        if(document.querySelectorAll('.position-slot[data-assigned]').length < 11) btnPlayMatch.disabled = true;
      }
    });
    bench.appendChild(div);
  });
}

function allowDrop(ev){ ev.preventDefault(); }
function dragStart(ev){ ev.dataTransfer.setData('text/plain', ev.target.dataset.pid); }

function dropHandler(ev){
  ev.preventDefault();
  const pid = ev.dataTransfer.getData('text/plain');
  const slot = ev.currentTarget;
  const p = hired.find(h=>h.id===pid);
  if(!p) return;
  // se já escalado -> não permite
  if(document.querySelector(`[data-assigned="${pid}"]`)){
    showNotif(`${p.name} já está escalado!`);
    return;
  }
  // regras de posição
  const slotPos = slot.dataset.pos;
  let allowed = false;
  if(slotPos === 'GK' && p.pos === 'Goleiro') allowed = true;
  if(['CB1','CB2','LB','RB'].includes(slotPos) && (p.pos === 'Zagueiro' || p.pos === 'Lateral')) allowed = true;
  if(slotPos === 'DM' && p.pos === 'Volante') allowed = true;
  if(['CM1','CM2','LW','RW'].includes(slotPos) && p.pos === 'Meia') allowed = true;
  if(slotPos === 'ST' && p.pos === 'Atacante') allowed = true;
  if(!allowed){ showNotif('Eu não sei jogar aí, professor!'); return; }

  // associa
  slot.dataset.assigned = pid;
  slot.textContent = p.name;
  // trava o card no banco (se visível)
  const card = document.getElementById('bench-'+pid);
  if(card){ card.classList.add('locked'); card.draggable = false; card.style.cursor = 'not-allowed'; }
  // atualizar botão de jogar se 11 slots preenchidos
  if(document.querySelectorAll('.position-slot[data-assigned]').length >= 11) btnPlayMatch.disabled = false;
}

/* ---------- Partida (simulação) ---------- */
btnPlayMatch.addEventListener('click', ()=>{
  tela3.style.display = 'none';
  tela4.style.display = 'block';
  userTeamNameEl.textContent = teamName.value || 'Meu Time';

  // preencher escalação do usuário (apenas slots atribuídos)
  jogadoresUsuario.innerHTML = '';
  document.querySelectorAll('.position-slot[data-assigned]').forEach(slot=>{
    const pid = slot.dataset.assigned;
    const p = hired.find(h=>h.id === pid);
    if(p){
      const li = document.createElement('li');
      li.textContent = p.name + ' (' + p.pos + ')';
      jogadoresUsuario.appendChild(li);
    }
  });

  // escalação Vila Freitas (fictícia)
  const escalaVila = ["Tadeu (GK)","Joãozinho (LB)","Bira (ZAG)","Marcão (ZAG)","Nego (RB)","Léo (VOL)","Careca (VOL)","Tico (MEI)","Juninho (MEI)","Beto (ATA)","Formiga (ATA)"];
  jogadoresVila.innerHTML = '';
  escalaVila.forEach(j=>{ const li=document.createElement('li'); li.textContent=j; jogadoresVila.appendChild(li); });

  // simulação com ~10 updates em 60s
  placar.textContent = '0 x 0';
  comentarios.innerHTML = '<p><em>Apito inicial...</em></p>';
  let golsU = 0, golsV = 0;
  let minuto = 1;
  const lances = [
    "Escanteio perigoso!",
    "Falta dura no meio-campo.",
    "Chutão pra fora, quase na arquibancada!",
    "Torcida grita 'é campeão!' sem motivo.",
    "Juiz tropeçou na bola.",
    "Goleiro saiu jogando errado.",
    "Zagueiro furou feio, risos na torcida.",
    "Bola na trave!!!",
    "Carrinho criminoso, juiz fingiu que não viu.",
    "Bandeirinha levantou a bandeira sem motivo."
  ];

  // 10 eventos distribuídos em 60s -> intervalo de ~6000ms
  const intervalMs = 6000;
  const interval = setInterval(()=>{
    if(minuto >= 60){
      clearInterval(interval);
      comentarios.innerHTML += '<p><strong>Fim de jogo!</strong></p>';
      btnContinuar.style.display = 'inline-block';
      return;
    }
    let lance = lances[Math.floor(Math.random()*lances.length)];
    if(Math.random() < 0.15){ // 15% de chance gol por evento
      if(Math.random() < 0.5){ golsU++; lance = "GOOOOL do " + (teamName.value || "Meu Time") + "!!!"; }
      else { golsV++; lance = "GOOOOL da Vila Freitas!!!"; }
      placar.textContent = `${golsU} x ${golsV}`;
    }
    comentarios.innerHTML += `<p>${minuto} min - ${lance}</p>`;
    comentarios.scrollTop = comentarios.scrollHeight;
    minuto += 6;
  }, intervalMs);
});

/* ---------- Continuar volta para escalação ---------- */
btnContinuar.addEventListener('click', ()=>{
  btnContinuar.style.display = 'none';
  tela4.style.display = 'none';
  tela3.style.display = 'block';
  // reseta estado de jogar (pra forçar re-escalar se quiser)
  btnPlayMatch.disabled = true;
});

/* ---------- Inicialização ---------- */
generatePlayers();
updateCash();
updateSelectedCount();
// começar Tela2 em Goleiros apenas, caso usuário clique pra entrar
marketMessage.textContent = steps[marketStep].msg;
renderMarket(steps[marketStep].filter);

document.getElementById('btnToTela2').addEventListener('click', ()=>{ /* já tratado acima, mas mantemos */ });

// ativar botão Tela1 quando preencher form
function validateTela1(){
  document.getElementById('btnToTela2').disabled = !(teamName.value.trim() && userName.value.trim() && cityName.value.trim());
}
teamName.addEventListener('input', validateTela1);
userName.addEventListener('input', validateTela1);
cityName.addEventListener('input', validateTela1);

/* Expor funções para ondrop inline (necessário) */
window.allowDrop = allowDrop;
window.dropHandler = dropHandler;
</script>
</body>
</html>
