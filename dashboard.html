<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRFutebol - Dashboard</title>
    
    <script src="database_jogadores.js"></script>
    <script src="engine.js"></script>
    
    <style>
        :root { --primary:#1e272e; --secondary:#0fb9b1; --accent:#ff4757; --gold:#f1c40f; --green:#2ecc71; --bg:#0d1115; --card-bg:#2d3436; --text:#ecf0f1; --text-muted:#bdc3c7; }
        body { font-family:'Segoe UI',sans-serif; background-color:var(--bg); color:var(--text); margin:0; display:grid; grid-template-rows:80px 1fr; height:100vh; overflow:hidden; }

        header { background-color:rgba(30,39,46,0.95); border-bottom:2px solid var(--secondary); display:flex; align-items:center; justify-content:space-between; padding:0 30px; box-shadow:0 4px 15px rgba(0,0,0,0.3); }
        .team-identity { display:flex; align-items:center; gap:15px; }
        .team-logo { width:50px; height:50px; object-fit:contain; }
        .team-info h1 { margin:0; font-size:1.4rem; color:#fff; text-transform:uppercase; }
        .status-bar { display:flex; gap:30px; }
        .status-item { text-align:right; }
        .status-value { font-size:1.2rem; font-weight:700; color:var(--secondary); }

        main { display:grid; grid-template-columns:350px 1fr; gap:25px; padding:25px; overflow:hidden; }
        aside { display:flex; flex-direction:column; gap:15px; overflow-y:auto; padding-right:5px; }
        
        .card { background-color:var(--card-bg); border-radius:16px; padding:20px; box-shadow:0 4px 10px rgba(0,0,0,0.2); border:1px solid rgba(255,255,255,0.05); }
        .next-match-card { text-align:center; border-top:4px solid var(--secondary); background:linear-gradient(180deg, #2d3436 0%, #22282a 100%); }
        .competition-badge { background:#000; color:#fff; padding:6px 18px; border-radius:20px; font-size:0.75rem; text-transform:uppercase; font-weight:bold; display:inline-block; margin-bottom:20px; border:1px solid #444; }
        
        .matchup { display:flex; justify-content:space-between; align-items:center; margin-bottom:25px; padding:0 10px; }
        .match-crest { width:65px; height:65px; object-fit:contain; }
        .play-btn { background:linear-gradient(135deg, var(--secondary), #098e87); color:#fff; border:none; padding:15px; width:100%; border-radius:10px; font-size:1rem; font-weight:800; text-transform:uppercase; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; }
        .play-btn:hover { transform:translateY(-3px); box-shadow:0 8px 20px rgba(15,185,177,0.4); }
        
        .btn-season { background:linear-gradient(135deg, var(--gold), #e67e22); color:#000; }
        .btn-season:hover { box-shadow:0 8px 20px rgba(241,196,15,0.4); }

        .sidebar-btn { background:transparent; border:2px solid var(--secondary); color:var(--text); padding:12px; width:100%; border-radius:8px; font-weight:700; text-transform:uppercase; cursor:pointer; margin-top:10px; }
        .sidebar-btn:hover { background:var(--secondary); color:#1e272e; }

        .finance-card { cursor:pointer; padding:20px; }
        .finance-card:hover { transform:translateY(-3px); border-color:var(--gold); }
        .finance-value { font-size:1.4rem; color:#fff; font-weight:800; margin-bottom:10px; }
        .finance-bar-bg { background:rgba(255,255,255,0.1); height:6px; border-radius:3px; overflow:hidden; }
        .finance-bar-fill { background:var(--gold); height:100%; width:0%; transition:width 1s; }

        .content-area { background-color:var(--card-bg); border-radius:16px; display:flex; flex-direction:column; overflow:hidden; border:1px solid rgba(255,255,255,0.05); }
        .tabs { display:flex; background-color:rgba(0,0,0,0.2); border-bottom:1px solid #444; }
        .tab-btn { padding:18px 30px; background:none; border:none; color:var(--text-muted); cursor:pointer; font-weight:600; border-bottom:3px solid transparent; text-transform:uppercase; }
        .tab-btn.active { color:var(--secondary); border-bottom-color:var(--secondary); background:rgba(15,185,177,0.05); }
        .tab-content { padding:0; overflow-y:auto; flex-grow:1; }

        table { width:100%; border-collapse:collapse; }
        th { position:sticky; top:0; background:#262c2e; text-align:left; color:var(--text-muted); font-size:0.75rem; text-transform:uppercase; padding:15px 12px; }
        td { padding:12px; border-bottom:1px solid #383e42; font-size:0.9rem; }
    </style>
</head>
<body>

    <header>
        <div class="team-identity">
            <img id="header-escudo" class="team-logo" onerror="this.src='https://cdn-icons-png.flaticon.com/512/53/53283.png'">
            <div class="team-info">
                <h1 id="header-time">...</h1>
                <p>Treinador: <strong id="header-tecnico" style="color:white;">...</strong></p>
            </div>
        </div>
        <div class="status-bar">
            <div class="status-item"><div class="status-label">Ano</div><div class="status-value" id="header-ano" style="color:var(--text);">2026</div></div>
            <div class="status-item"><div class="status-label">For√ßa</div><div class="status-value" id="header-forca">0</div></div>
        </div>
    </header>

    <main>
        <aside>
            <div class="card next-match-card">
                <div class="competition-badge" id="match-comp">Carregando...</div>
                
                <div id="match-area">
                    <div class="matchup">
                        <div style="text-align:center;"><img id="home-crest" class="match-crest"><div id="home-name" style="font-size:0.8rem; font-weight:bold; margin-top:5px;">Casa</div></div>
                        <div style="font-size:1.2rem; font-weight:900; color:#555;">X</div>
                        <div style="text-align:center;"><img id="away-crest" class="match-crest"><div id="away-name" style="font-size:0.8rem; font-weight:bold; margin-top:5px;">Fora</div></div>
                    </div>
                    <button class="play-btn" onclick="jogarRodada()"><span>‚öΩ Ir para o Jogo</span></button>
                </div>

                <div id="season-end-area" style="display:none;">
                    <h2 style="color:var(--gold); margin-bottom:5px;">Fim da Temporada!</h2>
                    <p style="font-size:0.9rem; color:#aaa; margin-bottom:20px;">Jogadores v√£o envelhecer e evoluir. O calend√°rio ser√° sorteado.</p>
                    <button class="play-btn btn-season" onclick="virarAno()">üåü Iniciar <span id="next-year-lbl">2027</span></button>
                </div>

                <div id="no-match-area" style="display:none; padding:10px;">
                    <h3 style="color:#777;">Semana Livre</h3>
                    <p style="color:#555; font-size:0.8rem;">Seu time folga nesta rodada.</p>
                    <button class="play-btn" style="background:#444;" onclick="jogarRodada()">‚è© Simular Semana</button>
                </div>
            </div>

            <div class="card">
                <button class="sidebar-btn" onclick="window.location.href='escalacao.html'">üëï T√°tica</button>
                <button class="sidebar-btn" style="border-color:var(--gold); color:var(--gold);" onclick="window.location.href='central-competicoes.html'">üèÜ Competi√ß√µes</button>
                <button class="sidebar-btn" style="border-color:var(--green); color:var(--green);" onclick="window.location.href='mercado.html'">‚öΩ Mercado</button>
                <button class="sidebar-btn" onclick="window.location.href='financeiro.html'">üí∞ Finan√ßas</button>
            </div>

            <div class="card finance-card" onclick="window.location.href='financeiro.html'">
                <div style="color:var(--gold); font-weight:bold; text-transform:uppercase; font-size:0.8rem; margin-bottom:10px;">üí∞ Caixa</div>
                <div class="finance-value" id="dash-caixa">R$ 0</div>
                <div class="finance-bar-bg"><div class="finance-bar-fill" id="dash-bar"></div></div>
            </div>
        </aside>

        <div class="content-area">
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('elenco')">Meu Elenco</button>
                <button class="tab-btn" onclick="switchTab('calendario')">Calend√°rio</button>
            </div>
            <div id="tab-elenco" class="tab-content">
                <table id="squad-table"><thead><tr><th>Pos</th><th>Nome</th><th>For√ßa</th><th>Idade</th><th>Gols</th></tr></thead><tbody></tbody></table>
            </div>
            <div id="tab-calendario" class="tab-content" style="display:none; padding:20px;"><ul id="calendar-list" style="list-style:none; padding:0;"></ul></div>
        </div>
    </main>

    <script>
        let gameState, myTeamObj;

        window.onload = function() {
            if (typeof Engine === 'undefined') { alert("Engine Off"); return; }
            gameState = Engine.carregarJogo();
            if (!gameState) { window.location.href = 'index.html'; return; }
            myTeamObj = Engine.encontrarTime(gameState, gameState.meuTime);
            if (!myTeamObj.financas) Engine.inicializarFinancas(myTeamObj);
            atualizarInterface();
        };

        function atualizarInterface() {
            document.getElementById('header-escudo').src = localStorage.getItem('brfutebol_escudo');
            document.getElementById('header-time').innerText = myTeamObj.nome;
            document.getElementById('header-tecnico').innerText = localStorage.getItem('brfutebol_tecnico');
            document.getElementById('header-ano').innerText = gameState.ano;
            document.getElementById('header-forca').innerText = myTeamObj.forca;

            renderNextMatch();
            renderSquad();
            renderCalendarList();
            atualizarFinancas();
        }

        function renderNextMatch() {
            const semIdx = gameState.semanaAtual - 1;
            const evento = gameState.calendarioUsuario[semIdx];

            // SE N√ÉO TEM MAIS JOGOS: FIM DE TEMPORADA
            if (!evento) {
                document.getElementById('match-comp').innerText = "F√âRIAS";
                document.getElementById('match-area').style.display = 'none';
                document.getElementById('no-match-area').style.display = 'none';
                
                // Mostra bot√£o de virada
                document.getElementById('season-end-area').style.display = 'block';
                document.getElementById('next-year-lbl').innerText = gameState.ano + 1;
                return;
            }

            document.getElementById('season-end-area').style.display = 'none';
            document.getElementById('match-comp').innerText = `${evento.nome} (${evento.tipo})`;
            const meuJogo = evento.jogos.find(j => j.casa === myTeamObj.nome || j.fora === myTeamObj.nome);

            if (meuJogo) {
                document.getElementById('match-area').style.display = 'block';
                document.getElementById('no-match-area').style.display = 'none';
                
                const isCasa = (meuJogo.casa === myTeamObj.nome);
                const advObj = Engine.encontrarTime(gameState, isCasa ? meuJogo.fora : meuJogo.casa);
                const advEscudo = advObj ? advObj.escudo : 'https://cdn-icons-png.flaticon.com/512/53/53283.png';
                const meuEscudo = localStorage.getItem('brfutebol_escudo');

                document.getElementById('home-name').innerText = meuJogo.casa;
                document.getElementById('home-crest').src = isCasa ? meuEscudo : advEscudo;
                document.getElementById('away-name').innerText = meuJogo.fora;
                document.getElementById('away-crest').src = isCasa ? advEscudo : meuEscudo;
            } else {
                document.getElementById('match-area').style.display = 'none';
                document.getElementById('no-match-area').style.display = 'block';
            }
        }

        function jogarRodada() {
            const semIdx = gameState.semanaAtual - 1;
            if (semIdx >= 50 || !gameState.calendarioUsuario[semIdx]) return; // Prote√ß√£o
            
            const evento = gameState.calendarioUsuario[semIdx];
            const meuJogo = evento.jogos.find(j => j.casa === myTeamObj.nome || j.fora === myTeamObj.nome);

            if (meuJogo) window.location.href = 'partida.html';
            else {
                const btn = document.querySelector('#no-match-area .play-btn');
                btn.disabled = true; btn.innerText = "Simulando...";
                setTimeout(() => { Engine.processarSemana(gameState); window.location.reload(); }, 800);
            }
        }

        function virarAno() {
            if(!confirm(`Deseja iniciar a temporada ${gameState.ano + 1}? O progresso ser√° salvo.`)) return;
            
            // Chama o Engine para processar envelhecimento e novo calend√°rio
            Engine.virarTemporada(gameState);
            
            alert("Feliz Ano Novo! Jogadores evolu√≠ram e o calend√°rio foi atualizado.");
            window.location.reload();
        }

        function atualizarFinancas() {
            const f = myTeamObj.financas;
            const tRec = f.receitas.tv + f.receitas.patrocinioMaster;
            const tDes = f.despesas.folhaSalarial + f.despesas.manutencao;
            const pct = Math.min((tDes/tRec)*100, 100);
            document.getElementById('dash-caixa').innerText = Engine.formatarDinheiro(f.caixa, f.moeda);
            document.getElementById('dash-bar').style.width = pct + "%";
            const b = document.getElementById('dash-bar');
            if(pct>90) b.style.backgroundColor="#ff4757"; else if(pct>70) b.style.backgroundColor="#f1c40f"; else b.style.backgroundColor="#2ecc71";
        }

        function renderSquad() {
            const tb = document.querySelector('#squad-table tbody'); tb.innerHTML = '';
            const m = {'GOL':1,'ZAG':2,'MEI':3,'ATA':4};
            [...myTeamObj.elenco].sort((a,b)=> (m[a.pos]-m[b.pos]) || (b.forca-a.forca)).forEach(j => {
                tb.innerHTML += `<tr><td style="color:#aaa;font-weight:bold;">${j.pos}</td><td>${j.nome}</td><td style="font-weight:bold;">${j.forca}</td><td>${j.idade}</td><td style="color:var(--gold);font-weight:bold;">${j.gols||0}</td></tr>`;
            });
        }

        function renderCalendarList() {
            const l = document.getElementById('calendar-list'); l.innerHTML = '';
            const s = gameState.semanaAtual - 1;
            gameState.calendarioUsuario.forEach((ev, i) => {
                if (Math.abs(i - s) > 3) return;
                const j = ev.jogos.find(x => x.casa === myTeamObj.nome || x.fora === myTeamObj.nome);
                let txt = j ? `${j.casa} vs ${j.fora}` : "Folga";
                if(j && j.golsCasa !== undefined) txt += ` (${j.golsCasa}-${j.golsFora})`;
                const style = i === s ? "background:rgba(15,185,177,0.1);color:#fff;" : "color:#888;";
                l.innerHTML += `<li style="padding:10px;border-bottom:1px solid #444;display:flex;justify-content:space-between;${style}"><span>S${i+1}</span><span>${txt}</span></li>`;
            });
        }

        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(d=>d.style.display='none');
            document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
            document.getElementById('tab-'+id).style.display='block';
            if(event) event.target.classList.add('active');
        }
    </script>
</body>
</html>
