<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRFutebol - Central do Clube</title>
    
    <script src="database.js"></script>
    <script src="calendario.js"></script>
    <script src="engine-core.js"></script>
    <script src="engine-contratos.js"></script>
    <script src="engine-mercado.js"></script>
    <script src="engine-eventos.js"></script>
    <script src="engine-match.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700;900&family=Inter:wght@400;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-dark: #0f1216; --sidebar-bg: #161b22; --card-bg: #1e2329; --neon-green: #00ff88;
            --text-main: #ffffff; --text-muted: #8b949e; --border: #30363d; --gold: #f1c40f;
            --red: #ff4757; --blue: #3498db; --msg-user: #238636; --msg-cpu: #21262d;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            margin: 0; padding: 0;
            display: flex; height: 100vh; overflow: hidden;
        }

        /* SIDEBAR */
        .sidebar {
            width: 250px; background: var(--sidebar-bg);
            border-right: 1px solid var(--border);
            padding: 20px; display: flex; flex-direction: column; gap: 10px; flex-shrink: 0;
        }
        .logo {
            font-family: 'Rajdhani', sans-serif; font-size: 2rem; font-weight: 900;
            margin-bottom: 20px; color: #fff; text-transform: uppercase; letter-spacing: 2px;
        }
        .logo span { color: var(--neon-green); }
        .menu-btn {
            display: flex; align-items: center; gap: 12px; padding: 12px;
            border-radius: 8px; color: var(--text-muted); text-decoration: none;
            font-weight: 600; transition: 0.2s; cursor: pointer;
        }
        .menu-btn:hover, .menu-btn.active { background: rgba(0, 255, 136, 0.1); color: var(--neon-green); }
        .menu-btn.logout { margin-top: auto; color: var(--red); }
        .menu-btn.logout:hover { background: rgba(255, 71, 87, 0.1); }
        
        .badge { background: var(--red); color: #fff; font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; display: none; margin-left: auto; }
        .badge.show { display: inline-block; }

        /* MAIN CONTENT */
        .main-content {
            flex: 1; padding: 30px; overflow-y: auto;
            display: flex; flex-direction: column; gap: 25px;
        }

        /* HEADER INFO */
        .top-bar {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--card-bg); padding: 15px 25px; border-radius: 12px;
            border: 1px solid var(--border);
        }
        .club-title h1 { margin: 0; font-family: 'Rajdhani'; font-size: 2rem; text-transform: uppercase; }
        .club-title span { color: var(--text-muted); font-size: 0.9rem; letter-spacing: 1px; }
        .finances { display: flex; gap: 20px; }
        .stat-badge {
            background: #0d1117; padding: 8px 15px; border-radius: 6px; border: 1px solid var(--border);
            text-align: right; min-width: 120px;
        }
        .stat-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; display: block; }
        .stat-val { font-family: 'Rajdhani'; font-weight: 700; font-size: 1.2rem; color: var(--neon-green); }
        .date-val { font-size: 0.85rem; color: #fff; font-weight: 600; margin-top: 2px; display: block; }

        /* MATCHDAY BANNER */
        .match-banner {
            background: linear-gradient(to bottom, rgba(15, 18, 22, 0.6), rgba(15, 18, 22, 0.9)), url('https://images.unsplash.com/photo-1522770179533-24471fcdba45?q=80&w=1000&auto=format&fit=crop');
            background-size: cover; background-position: center;
            border-radius: 16px; border: 1px solid var(--border);
            padding: 40px; min-height: 250px; 
            display: flex; align-items: center; justify-content: center;
            position: relative; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.6);
        }
        
        .match-content-grid {
            display: grid; grid-template-columns: 1fr auto 1fr; 
            width: 100%; max-width: 800px; 
            align-items: center; justify-items: center; z-index: 2;
        }

        .match-info-center { display: flex; flex-direction: column; align-items: center; text-align: center; }
        .match-label { font-family: 'Rajdhani'; font-weight: 700; color: var(--neon-green); letter-spacing: 3px; margin-bottom: 5px; font-size: 0.9rem; text-transform: uppercase; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }
        .stadium-name { font-size: 0.8rem; color: #ccc; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
        
        .team-display { display: flex; flex-direction: column; align-items: center; gap: 15px; }
        .team-logo-big { width: 100px; height: 100px; object-fit: contain; filter: drop-shadow(0 0 20px rgba(255,255,255,0.1)); }
        .team-name-big { font-family: 'Rajdhani'; font-weight: 800; font-size: 1.4rem; text-align: center; color: #fff; text-shadow: 0 2px 5px rgba(0,0,0,0.8); }
        
        .vs-text { font-family: 'Rajdhani'; font-size: 3rem; font-weight: 900; color: #fff; margin: 0 30px; text-shadow: 0 0 10px rgba(0,0,0,0.5); }
        
        .play-btn {
            background: linear-gradient(45deg, var(--neon-green), #27ae60);
            color: #000; border: none;
            padding: 15px 40px; border-radius: 30px; font-family: 'Rajdhani';
            font-weight: 900; font-size: 1.2rem; cursor: pointer; text-transform: uppercase;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3); margin-top: 15px;
        }
        .play-btn:hover { transform: scale(1.05); }

        /* SQUAD SECTION */
        .section-header {
            display: flex; justify-content: space-between; align-items: flex-end;
            margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px;
        }
        .section-title { font-family: 'Rajdhani'; font-size: 1.5rem; font-weight: 700; color: #fff; }
        
        .squad-table-container {
            background: var(--card-bg); border: 1px solid var(--border);
            border-radius: 12px; overflow: hidden;
        }
        .squad-table { width: 100%; border-collapse: collapse; }
        .squad-table th {
            text-align: left; background: rgba(0,0,0,0.3); color: var(--text-muted);
            padding: 15px 10px; font-size: 0.8rem; text-transform: uppercase; font-weight: 700;
        }
        .squad-table td {
            padding: 12px 10px; border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 0.9rem; vertical-align: middle;
        }
        .squad-table tr { cursor: pointer; transition: background 0.2s; }
        .squad-table tr:hover { background: rgba(255,255,255,0.08); }

        /* Colunas */
        .pos-badge { font-size: 0.75rem; font-weight: 800; padding: 4px 0; border-radius: 4px; text-align: center; color: #000; width: 40px; display: inline-block; }
        .pos-gol { background-color: #f1c40f; } 
        .pos-def { background-color: #3498db; color: #fff; } 
        .pos-mei { background-color: #2ecc71; } 
        .pos-ata { background-color: #ff4757; color: #fff; } 

        .col-name { font-weight: 600; color: #fff; font-size: 1rem; }
        .col-ovr { width: 50px; font-family: 'Rajdhani'; font-weight: 800; font-size: 1.2rem; color: var(--gold); text-align: center; }
        .col-stat { width: 40px; text-align: center; font-family: 'Rajdhani'; font-weight: 600; color: #ccc; font-size: 0.9rem; }
        .stat-high { color: var(--neon-green); } .stat-low { color: #555; }
        .carac-badge { font-size: 0.7rem; font-weight: 600; color: #aaa; background: rgba(255,255,255,0.05); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.1); }
        
        /* Barra de Sa√∫de */
        .condition-bar-bg { width: 100%; height: 6px; background: #333; border-radius: 3px; overflow: hidden; }
        .condition-bar-fill { height: 100%; border-radius: 3px; transition: width 0.3s ease; }

        /* --- MODAL DE NEGOCIA√á√ÉO (ATUALIZADO) --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .neg-card { width: 900px; height: 600px; background: #121519; border: 1px solid #444; border-radius: 12px; display: flex; overflow: hidden; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        
        /* Lateral Esquerda (Info do Jogador) - VISUAL NOVO */
        .neg-sidebar { width: 260px; background: #161b22; border-right: 1px solid #333; padding: 30px 20px; display: flex; flex-direction: column; gap: 25px; }
        
        .neg-header-info { border-bottom: 1px solid #333; padding-bottom: 20px; }
        .neg-p-name { font-family: 'Rajdhani'; font-weight: 800; font-size: 2rem; color: #fff; line-height: 1; margin-bottom: 5px; }
        .neg-p-details { font-size: 0.9rem; color: #888; display: flex; gap: 10px; align-items: center; }
        .neg-pos-tag { background: #333; color: #fff; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 0.8rem; }
        .neg-ovr-box { font-family: 'Rajdhani'; font-weight: 900; font-size: 2.5rem; color: var(--gold); margin-top: 10px; }

        .neg-stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; }
        .neg-stat-item { background: rgba(255,255,255,0.03); padding: 10px; border-radius: 6px; text-align: center; border: 1px solid #333; }
        .neg-stat-label { display: block; font-size: 0.7rem; color: #666; text-transform: uppercase; letter-spacing: 1px; }
        .neg-stat-val { display: block; font-family: 'Rajdhani'; font-weight: 700; font-size: 1.4rem; color: #fff; }

        .neg-contract-info { font-size: 0.85rem; color: #888; background: #111; padding: 15px; border-radius: 8px; border: 1px solid #333; }
        .neg-contract-row { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .neg-contract-val { color: var(--neon-green); font-weight: 600; }

        /* √Årea Direita (Chat) */
        .neg-chat-area { flex: 1; display: flex; flex-direction: column; background: #0f1216; }
        .neg-header { padding: 15px 25px; border-bottom: 1px solid #333; background: #161b22; font-family: 'Rajdhani'; font-weight: 700; display: flex; justify-content: space-between; align-items: center; }
        .neg-close-btn { background: none; border: none; color: #666; font-size: 1.2rem; cursor: pointer; }
        .neg-close-btn:hover { color: #fff; }

        .chat-feed { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .msg { max-width: 80%; padding: 12px 18px; border-radius: 12px; font-size: 0.95rem; line-height: 1.4; animation: popIn 0.3s ease; }
        .msg.cpu { align-self: flex-start; background: var(--msg-cpu); border-bottom-left-radius: 2px; border: 1px solid #333; color: #ddd; }
        .msg.user { align-self: flex-end; background: var(--msg-user); border-bottom-right-radius: 2px; color: #fff; font-weight: 600; }
        .msg.system { align-self: center; background: rgba(255,255,255,0.05); color: #aaa; font-size: 0.8rem; padding: 5px 15px; border-radius: 20px; }
        @keyframes popIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .neg-controls { padding: 20px; border-top: 1px solid #333; background: #161b22; min-height: 120px; display: flex; flex-direction: column; justify-content: center; }
        .opt-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .opt-btn { background: #222; border: 1px solid #444; color: #ccc; padding: 12px; border-radius: 6px; cursor: pointer; font-family: 'Inter'; font-size: 0.9rem; transition: 0.2s; text-align: left; }
        .opt-btn:hover { background: #333; border-color: #666; color: #fff; }
        .opt-btn.confirm { background: var(--neon-green); color: #000; border-color: var(--neon-green); font-weight: 700; text-align: center; }
        .opt-btn.cancel { background: var(--red); color: #fff; border-color: var(--red); font-weight: 700; text-align: center; }

        /* Inputs de Negocia√ß√£o */
        .input-group { display: flex; flex-direction: column; gap: 5px; margin-bottom: 10px; }
        .input-label { font-size: 0.8rem; color: #888; text-transform: uppercase; letter-spacing: 1px; }
        .neg-input { background: #000; border: 1px solid #444; color: #fff; padding: 10px; border-radius: 4px; font-family: 'Rajdhani'; font-size: 1.1rem; }
        .range-slider { width: 100%; cursor: pointer; accent-color: var(--neon-green); }

        @media (max-width: 900px) { .col-stat { display: none; } }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="logo">BR<span>FUTEBOL</span></div>
        <a class="menu-btn active">üìä Vis√£o Geral</a>
        <a class="menu-btn" href="escalacao.html">üëï Escala√ß√£o</a>
        <a class="menu-btn" href="mercado.html">üîÑ Mercado</a>
        <a class="menu-btn" href="calendario.html">üìÖ Calend√°rio</a>
        <a class="menu-btn" href="classificacao.html">üèÜ Classifica√ß√£o</a>
        <a class="menu-btn" href="estadio.html">üèüÔ∏è Est√°dio</a>
        <a class="menu-btn" href="financeiro.html">üí∞ Finan√ßas</a>
        <a class="menu-btn" href="mensagens.html">üì© Mensagens <span id="badge-msg" class="badge">0</span></a>
        <a class="menu-btn logout" onclick="sair()">‚úñ Sair</a>
    </nav>

    <main class="main-content">
        
        <div class="top-bar">
            <div class="club-title">
                <h1 id="team-name">Carregando...</h1>
                <span id="coach-name">Treinador: ---</span>
            </div>
            <div class="finances">
                <div class="stat-badge">
                    <span class="stat-label">Or√ßamento</span>
                    <span class="stat-val" id="money-display">R$ 0M</span>
                </div>
                <div class="stat-badge">
                    <span class="stat-label">Calend√°rio</span>
                    <span class="stat-val" id="round-display">--</span>
                    <span class="date-val" id="date-display">01/01/2026</span>
                </div>
            </div>
        </div>

        <div class="match-banner" id="match-banner">
            <h2 style="margin:auto; color:#888;">Carregando temporada...</h2>
        </div>

        <div>
            <div class="section-header">
                <div class="section-title">Elenco Principal</div>
                <button onclick="window.location.href='escalacao.html'" style="background:none; border:1px solid #444; color:#888; padding:8px 20px; border-radius:6px; cursor:pointer;">T√°tica ‚öôÔ∏è</button>
            </div>
            <p style="color:#666; font-size:0.8rem; margin-bottom:10px;">‚ÑπÔ∏è Clique em um jogador para negociar contrato.</p>
            
            <div class="squad-table-container">
                <table class="squad-table">
                    <thead>
                        <tr>
                            <th style="width:50px; text-align:center;">Pos</th>
                            <th>Nome</th>
                            <th style="width:50px; text-align:center;">OVR</th>
                            <th style="width:100px;">Contrato</th>
                            <th class="col-stat">PAC</th>
                            <th class="col-stat">SHO</th>
                            <th class="col-stat">PAS</th>
                            <th class="col-stat">DRI</th>
                            <th class="col-stat">DEF</th>
                            <th class="col-stat">PHY</th>
                            <th style="width:120px;">Carac.</th>
                            <th style="width:100px;">Condi√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody id="squad-body"></tbody>
                </table>
            </div>
        </div>

    </main>

    <div id="neg-modal" class="modal-overlay">
        <div class="neg-card">
            <div class="neg-sidebar">
                <div class="neg-header-info">
                    <div class="neg-p-name" id="neg-name">Nome Jogador</div>
                    <div class="neg-p-details">
                        <span class="neg-pos-tag" id="neg-pos">POS</span>
                        <span id="neg-age">00 anos</span>
                    </div>
                    <div class="neg-ovr-box" id="neg-ovr">00</div>
                </div>

                <div class="neg-stats-grid">
                    <div class="neg-stat-item">
                        <span class="neg-stat-label">Jogos</span>
                        <span class="neg-stat-val" id="neg-games">0</span>
                    </div>
                    <div class="neg-stat-item">
                        <span class="neg-stat-label">Gols</span>
                        <span class="neg-stat-val" id="neg-goals">0</span>
                    </div>
                </div>

                <div class="neg-contract-info">
                    <div class="neg-contract-row">
                        <span>Sal√°rio Atual:</span>
                        <span class="neg-contract-val" id="neg-sal">R$ 0</span>
                    </div>
                    <div class="neg-contract-row">
                        <span>T√©rmino:</span>
                        <span class="neg-contract-val" id="neg-end">00/00/0000</span>
                    </div>
                </div>
            </div>
            
            <div class="neg-chat-area">
                <div class="neg-header">
                    <span>Mesa de Negocia√ß√£o</span>
                    <button class="neg-close-btn" onclick="fecharNegociacao()">‚úï</button>
                </div>
                <div class="chat-feed" id="chat-feed">
                    </div>
                <div class="neg-controls" id="neg-controls">
                    </div>
            </div>
        </div>
    </div>

    <script>
        const DEFAULT_SHIELD = "https://cdn-icons-png.flaticon.com/512/53/53283.png";
        const ESTADIOS_REAIS = {
            "Corinthians": "Neo Qu√≠mica Arena", "Palmeiras": "Allianz Parque", "S√£o Paulo": "MorumBIS",
            "Santos": "Vila Belmiro", "Flamengo": "Maracan√£", "Fluminense": "Maracan√£",
            "Vasco": "S√£o Janu√°rio", "Botafogo": "Nilton Santos", "Gr√™mio": "Arena do Gr√™mio",
            "Internacional": "Beira-Rio", "Atl√©tico-MG": "Arena MRV", "Cruzeiro": "Mineir√£o",
            "Bahia": "Fonte Nova", "Vit√≥ria": "Barrad√£o", "Fortaleza": "Castel√£o",
            "Cear√°": "Castel√£o", "Athletico-PR": "Ligga Arena", "Coritiba": "Couto Pereira",
            "Sport": "Ilha do Retiro", "Bragantino": "Nabi Abi Chedid", "Ponte Preta": "Mois√©s Lucarelli"
        };

        /* --- BANCO DE DADOS DE INTERA√á√ïES --- */
        const DIALOGOS = {
            ELOGIAR: {
                opcoes: [
                    { id: 'treino', texto: "Elogiar desempenho nos treinos" },
                    { id: 'forma', texto: "Elogiar fase atual" },
                    { id: 'lideranca', texto: "Elogiar postura de lideran√ßa" }
                ],
                respostas: {
                    sucesso: [
                        "Obrigado, chefe! Estou dando meu sangue nos treinos.",
                        "Fico feliz que voc√™ notou. Vou continuar assim.",
                        "√â bom ser reconhecido. Isso me motiva muito!",
                        "Estamos juntos, professor! O grupo est√° fechado com voc√™.",
                        "Agrade√ßo a confian√ßa. Sinto que estou na minha melhor forma.",
                        "Valeu! O trabalho duro compensa.",
                        "Isso √© resultado do trabalho de toda a equipe t√©cnica.",
                        "Vou continuar focado para n√£o deixar o ritmo cair.",
                        "Obrigado! Estou me sentindo voando fisicamente.",
                        "Conta comigo para o que der e vier."
                    ],
                    neutro: [
                        "Obrigado.",
                        "Ok, vou manter o ritmo.",
                        "Tudo bem, fa√ßo meu trabalho.",
                        "Sem problemas.",
                        "√â minha obriga√ß√£o, n√£o √©?",
                        "Certo, professor.",
                        "Beleza.",
                        "Seguimos trabalhando.",
                        "Ok.",
                        "Hum."
                    ],
                    falha: [ 
                        "S√©rio? N√£o achei que treinei t√£o bem assim.",
                        "Parece que voc√™ s√≥ fala isso para me agradar.",
                        "Menos, professor. Menos.",
                        "N√£o precisa de bajula√ß√£o, eu sei o que fa√ßo.",
                        "Engra√ßado voc√™ dizer isso logo agora que ia pedir aumento.",
                        "Prefiro que me elogie colocando de titular.",
                        "N√£o estou aqui para ouvir elogios, estou aqui para jogar.",
                        "Hum... t√° bom.",
                        "Voc√™ diz isso para todos, n√©?",
                        "Guarde os elogios para quando ganharmos o t√≠tulo."
                    ]
                }
            },
            COBRAR: {
                opcoes: [
                    { id: 'raca', texto: "Cobrar mais ra√ßa em campo" },
                    { id: 'tatico', texto: "Cobrar disciplina t√°tica" },
                    { id: 'extra', texto: "Cobrar comportamento extra-campo" }
                ],
                respostas: {
                    sucesso: [
                        "Voc√™ tem raz√£o. Vou me dedicar mais.",
                        "Entendido. N√£o vai se repetir.",
                        "Pe√ßo desculpas ao grupo. Vou melhorar.",
                        "Pode deixar, vou comer a grama no pr√≥ximo jogo.",
                        "Fui mal mesmo. Vou focar mais.",
                        "A mensagem foi recebida. Mudan√ßa de postura j√°!",
                        "Reconhe√ßo meu erro. Vou dar a volta por cima.",
                        "Justo. Preciso entregar mais pelo sal√°rio que ganho.",
                        "T√° certo, professor. Vou fechar a boca e trabalhar.",
                        "Compromisso renovado. Vou provar meu valor."
                    ],
                    falha: [
                        "Voc√™ est√° de marca√ß√£o comigo?",
                        "Eu corro por dois nesse time! Cobre os outros!",
                        "N√£o concordo. Acho que voc√™ est√° vendo outro jogo.",
                        "Se n√£o est√° satisfeito, me coloca na lista de transfer√™ncias.",
                        "Sempre sobra pra mim, impressionante.",
                        "O problema n√£o sou eu, √© essa t√°tica furada.",
                        "Me respeita, tenho hist√≥ria aqui.",
                        "N√£o venha levantar a voz pra mim.",
                        "Falou o Guardiola, n√©?",
                        "Ah, me erra. Vou falar com meu empres√°rio."
                    ]
                }
            },
            PARTIDA: {
                respostas: [
                    "Estou sentindo que vou brocar hoje!",
                    "Jogo dif√≠cil, mas vamos pra cima.",
                    "A torcida vai empurrar a gente.",
                    "Estou focado. Ningu√©m passa por mim.",
                    "Se o time ajudar, eu resolvo.",
                    "Estou ansioso, √© um cl√°ssico pra mim.",
                    "N√£o podemos perder pontos bobos.",
                    "O gramado l√° √© horr√≠vel, mas vamos tentar.",
                    "Estou 100% fisicamente, me deixa jogar os 90 minutos.",
                    "Tenho um pressentimento bom.",
                    "Eles s√£o fortes, vamos ter que jogar fechadinho.",
                    "S√≥ penso na vit√≥ria.",
                    "Vou dar a vida em campo.",
                    "Aquele lateral deles √© fraco, vou explorar ali.",
                    "Hoje √© dia de guerra!",
                    "Estou tranquilo.",
                    "Espero que a arbitragem n√£o atrapalhe.",
                    "Vamos jogar por uma bola.",
                    "√â matar ou morrer.",
                    "Confio na sua estrat√©gia, professor."
                ]
            }
        };

        window.onload = function() {
            try {
                const game = Engine.carregarJogo();
                if (!game || !game.info) throw new Error("Save inv√°lido.");

                document.getElementById('team-name').innerText = game.info.time;
                document.getElementById('coach-name').innerText = "Manager: " + game.info.tecnico;
                const dinheiro = game.recursos.dinheiro || 0;
                document.getElementById('money-display').innerText = dinheiro.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                document.getElementById('round-display').innerText = "Rodada " + game.rodadaAtual;
                if (Engine.data) document.getElementById('date-display').innerText = Engine.data.getDataAtual(game.rodadaAtual);

                renderizarMatchDay(game);
                renderizarElencoPro(game);

                const badge = document.getElementById('badge-msg');
                if(badge && game.mensagens) {
                    const naoLidas = game.mensagens.filter(m => !m.lida).length;
                    if(naoLidas > 0) { badge.innerText = naoLidas; badge.classList.add('show'); }
                }
            } catch (err) { alert("Erro: " + err.message); window.location.href = 'index.html'; }
        };

        function renderizarMatchDay(game) {
            const container = document.getElementById('match-banner');
            const rodadaIndex = game.rodadaAtual - 1;
            if (!game.calendario || !game.calendario[rodadaIndex]) { container.innerHTML = "<h2 style='margin:auto; color:#ccc'>Fim de Temporada</h2>"; return; }
            const jogos = game.calendario[rodadaIndex].jogos;
            const meuJogo = jogos.find(j => j.mandante === game.info.time || j.visitante === game.info.time);

            if (meuJogo) {
                const mandanteObj = Engine.encontrarTime(meuJogo.mandante) || { escudo: DEFAULT_SHIELD };
                const visitanteObj = Engine.encontrarTime(meuJogo.visitante) || { escudo: DEFAULT_SHIELD };
                let nomeEstadio = ESTADIOS_REAIS[meuJogo.mandante] || "Est√°dio Municipal";

                container.innerHTML = `
                    <div class="match-content-grid">
                        <div class="team-display">
                            <img src="${mandanteObj.escudo || DEFAULT_SHIELD}" class="team-logo-big" onerror="this.src='${DEFAULT_SHIELD}'">
                            <div class="team-name-big">${meuJogo.mandante}</div>
                        </div>
                        <div class="match-info-center">
                            <div class="match-label">RODADA ${game.rodadaAtual} ‚Ä¢ <span style="color:#fff">${nomeEstadio}</span></div>
                            <div class="vs-text">VS</div>
                            <button class="play-btn" onclick="irParaEstadio()">JOGAR</button>
                        </div>
                        <div class="team-display">
                            <img src="${visitanteObj.escudo || DEFAULT_SHIELD}" class="team-logo-big" onerror="this.src='${DEFAULT_SHIELD}'">
                            <div class="team-name-big">${meuJogo.visitante}</div>
                        </div>
                    </div>`;
            } else { container.innerHTML = "<h2 style='margin:auto; color:#ccc'>Folga nesta rodada</h2>"; }
        }

        function renderizarElencoPro(game) {
            const tbody = document.getElementById('squad-body');
            tbody.innerHTML = "";
            let meuTime = Engine.encontrarTime(game.info.time);

            if(game.jogadoresStatus) {
                meuTime.elenco.forEach((j, i) => {
                    const uid = j.uid || `p_${i}`;
                    if(game.jogadoresStatus[uid]) j.saude = game.jogadoresStatus[uid].saude;
                });
            }

            if (!meuTime || !meuTime.elenco) { tbody.innerHTML = "<tr><td colspan='11' style='text-align:center'>Sem elenco.</td></tr>"; return; }

            const ordem = {'GOL':1, 'ZAG':2, 'LD':3, 'LE':3, 'VOL':4, 'MEI':5, 'ATA':6};
            meuTime.elenco.sort((a,b) => (ordem[a.pos]||99) - (ordem[b.pos]||99) || b.forca - a.forca);

            meuTime.elenco.forEach((jog, idx) => {
                const atr = garantirAtributos(jog); 
                const saude = jog.saude !== undefined ? jog.saude : 100;
                let colorBar = saude < 50 ? '#ff4757' : (saude < 80 ? '#f1c40f' : '#2ecc71');
                let posClass = jog.pos==='GOL'?'pos-gol':['ZAG','LD','LE'].includes(jog.pos)?'pos-def':['VOL','MEI'].includes(jog.pos)?'pos-mei':'pos-ata';
                const fmtStat = (v) => v >= 80 ? `<span class="stat-high">${v}</span>` : (v < 60 ? `<span class="stat-low">${v}</span>` : v);

                const tr = document.createElement('tr');
                tr.onclick = () => iniciarNegociacao(jog.nome); 
                tr.innerHTML = `
                    <td><span class="pos-badge ${posClass}">${jog.pos}</span></td>
                    <td class="col-name">${jog.nome}</td>
                    <td class="col-ovr">${jog.forca}</td>
                    <td style="color:#aaa; font-size:0.8rem; text-align:center;">${jog.contrato || '31/12/2026'}</td>
                    <td class="col-stat">${fmtStat(atr.VEL)}</td>
                    <td class="col-stat">${fmtStat(atr.FIN)}</td>
                    <td class="col-stat">${fmtStat(atr.PAS)}</td>
                    <td class="col-stat">${fmtStat(atr.DRI)}</td>
                    <td class="col-stat">${fmtStat(atr.DEF)}</td>
                    <td class="col-stat">${fmtStat(atr.PHY)}</td>
                    <td><span class="carac-badge">${jog.carac || '-'}</span></td>
                    <td><div class="condition-bar-bg" title="${saude}%"><div class="condition-bar-fill" style="width:${saude}%; background:${colorBar}"></div></div></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function garantirAtributos(jog) {
            if(jog.atributos && jog.atributos.VEL) return jog.atributos;
            const b = jog.forca || 60;
            if(jog.pos === 'GOL') return { VEL:b, FIN:b-10, PAS:b-5, DRI:b-10, DEF:b+5, PHY:b };
            if(jog.pos === 'ATA') return { VEL:b+2, FIN:b+5, PAS:b-5, DRI:b+2, DEF:b-20, PHY:b };
            if(jog.pos === 'ZAG') return { VEL:b-5, FIN:b-15, PAS:b-5, DRI:b-10, DEF:b+5, PHY:b+5 };
            return { VEL:b, FIN:b-5, PAS:b+2, DRI:b, DEF:b, PHY:b }; 
        }

        function irParaEstadio() {
            const game = Engine.carregarJogo();
            const rodadaIndex = game.rodadaAtual - 1;
            const jogo = game.calendario[rodadaIndex].jogos.find(j => j.mandante === game.info.time || j.visitante === game.info.time);
            if(jogo) {
                const adv = jogo.mandante === game.info.time ? jogo.visitante : jogo.mandante;
                localStorage.setItem('brfutebol_oponente_atual', adv);
                window.location.href = 'partida.html';
            } else { alert("Erro ao identificar o jogo."); }
        }

        function sair() { if(confirm("Deseja sair para o menu inicial?")) window.location.href='index.html'; }

        /* --- SISTEMA DE NEGOCIA√á√ÉO V2.0 (Corrigido e Aprimorado) --- */
        let currentNeg = { 
            player: null, 
            idx: -1, 
            expectations: {}, // O que o jogador quer
            offer: {} 
        };

        function iniciarNegociacao(nomeJogador) {
            const game = Engine.carregarJogo();
            const meuTime = Engine.encontrarTime(game.info.time);
            const playerIdx = meuTime.elenco.findIndex(p => p.nome === nomeJogador);
            
            if (playerIdx === -1) { alert("Erro ao carregar jogador."); return; }

            const p = meuTime.elenco[playerIdx];

            // Define Expectativas do Jogador
            const baseSalario = (p.forca || 60) * 1600;
            const salarioDesejado = Math.floor(baseSalario * 1.2); 
            let papelDesejado = 'Rota√ß√£o';
            if (p.forca > 84) papelDesejado = 'Titular Absoluto';
            else if (p.forca > 78) papelDesejado = 'Importante';

            currentNeg = { 
                player: p, 
                idx: playerIdx,
                expectations: {
                    salary: salarioDesejado,
                    years: 2 + Math.floor(Math.random() * 2),
                    role: papelDesejado
                },
                offer: { salary: 0, years: 1, bonus: 0, role: '' } 
            };

            // Preenche UI
            document.getElementById('neg-name').innerText = p.nome;
            document.getElementById('neg-ovr').innerText = p.forca;
            document.getElementById('neg-age').innerText = p.idade + " anos";
            document.getElementById('neg-pos').innerText = p.pos;
            
            // Define 0 se n√£o tiver o dado ainda
            document.getElementById('neg-games').innerText = p.jogos || 0; 
            document.getElementById('neg-goals').innerText = p.gols || 0;

            const salAtual = p.salario || baseSalario;
            document.getElementById('neg-sal').innerText = salAtual.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
            document.getElementById('neg-end').innerText = p.contrato || "31/12/2026";

            // Limpa Chat e mostra o Modal
            document.getElementById('chat-feed').innerHTML = '';
            document.getElementById('neg-modal').style.display = 'flex';
            
            // L√≥gica de Recusa Inicial
            const chanceRecusa = Math.random();
            if (chanceRecusa < 0.15) {
                addMsg('cpu', "Chefe, sinceramente? N√£o estou com cabe√ßa para negociar agora. Vamos focar nos jogos.");
                showOptions('fechar');
            } else {
                addMsg('cpu', `Ol√° mister. Estou disposto a ouvir sua proposta de renova√ß√£o.`);
                showOptions('inicio');
            }
        }
        
        function fecharNegociacao() { document.getElementById('neg-modal').style.display = 'none'; }

        function addMsg(who, text) {
            const d = document.createElement('div');
            d.className = `msg ${who}`;
            d.innerText = text;
            document.getElementById('chat-feed').appendChild(d);
            document.getElementById('chat-feed').scrollTop = document.getElementById('chat-feed').scrollHeight;
        }

        function showOptions(step) {
            const area = document.getElementById('neg-controls');
            area.innerHTML = '';

            // MENU PRINCIPAL DE INTERA√á√ÉO
            if (step === 'inicio') {
                area.innerHTML = `
                    <div class="opt-grid">
                        <div class="opt-btn confirm" onclick="iniciarRenovacao()">üìÑ Renovar Contrato</div>
                        <div class="opt-btn" onclick="abrirMenuElogios()">üëç Elogiar Jogador</div>
                        <div class="opt-btn" onclick="abrirMenuCobranca()">üò° Cobrar Desempenho</div>
                        <div class="opt-btn" onclick="perguntarPartida()">‚öΩ Sobre o Pr√≥ximo Jogo</div>
                        <div class="opt-btn cancel" onclick="fecharNegociacao()" style="grid-column: span 2;">Sair da Sala</div>
                    </div>
                `;
            } else if (step === 'fechar') {
                 area.innerHTML = `<div class="opt-btn cancel" onclick="fecharNegociacao()">Entendo. (Sair)</div>`;
            }

            // SUB-MENU: ELOGIAR
            else if (step === 'menu_elogio') {
                let html = '<div class="opt-grid">';
                DIALOGOS.ELOGIAR.opcoes.forEach(opt => {
                    html += `<div class="opt-btn" onclick="executarInteracao('ELOGIAR', '${opt.id}')">${opt.texto}</div>`;
                });
                html += `<div class="opt-btn cancel" onclick="showOptions('inicio')">üîô Voltar</div>`;
                html += '</div>';
                area.innerHTML = html;
            }

            // SUB-MENU: COBRAR
            else if (step === 'menu_cobranca') {
                let html = '<div class="opt-grid">';
                DIALOGOS.COBRAR.opcoes.forEach(opt => {
                    html += `<div class="opt-btn" onclick="executarInteracao('COBRAR', '${opt.id}')">${opt.texto}</div>`;
                });
                html += `<div class="opt-btn cancel" onclick="showOptions('inicio')">üîô Voltar</div>`;
                html += '</div>';
                area.innerHTML = html;
            }

            // SUB-MENU: RENOVA√á√ÉO
            else if (step === 'papel') {
                area.innerHTML = `
                    <div class="input-group">
                        <span class="input-label">Papel no Time</span>
                        <select id="sel-role" class="neg-input">
                            <option>Titular Absoluto</option>
                            <option selected>Importante</option>
                            <option>Rota√ß√£o</option>
                            <option>Reserva</option>
                        </select>
                    </div>
                    <div class="opt-btn confirm" onclick="verificarPapel()">Oferecer Papel</div>
                `;
            }
            else if (step === 'duracao') {
                area.innerHTML = `
                    <div class="input-group">
                        <span class="input-label">Dura√ß√£o (Anos)</span>
                        <input type="range" min="1" max="5" value="${currentNeg.expectations.years}" class="range-slider" oninput="document.getElementById('val-anos').innerText = this.value + ' anos'">
                        <div id="val-anos" style="text-align:center; color:var(--neon-green); font-weight:bold; margin-top:5px;">${currentNeg.expectations.years} anos</div>
                    </div>
                    <div class="opt-btn confirm" onclick="definirDuracao()">Oferecer Dura√ß√£o</div>
                `;
            }
            else if (step === 'salario') {
                area.innerHTML = `
                    <div class="input-group">
                        <span class="input-label">Sal√°rio Mensal (R$)</span>
                        <input type="number" id="input-sal" class="neg-input" value="${currentNeg.expectations.salary}">
                    </div>
                    <div class="opt-btn confirm" onclick="definirSalario()">Fazer Oferta</div>
                `;
            }
            else if (step === 'bonus') {
                area.innerHTML = `
                    <div class="input-group">
                        <span class="input-label">Luvas (R$)</span>
                        <input type="number" id="input-bon" class="neg-input" value="10000">
                    </div>
                    <div class="opt-btn confirm" onclick="fecharAcordo()">Finalizar Contrato</div>
                `;
            }
            else if (step === 'fim_renovacao') {
                area.innerHTML = `<div class="opt-btn confirm" onclick="fecharNegociacao(); location.reload();">Assinar e Sair</div>`;
            }
            // FIM DE INTERA√á√ÉO SIMPLES (Volta pro menu)
            else if (step === 'voltar_menu') {
                area.innerHTML = `<div class="opt-btn" onclick="showOptions('inicio')">Continuar Conversando</div>`;
            }
        }

        // --- L√ìGICA DE VALIDA√á√ÉO ---

        function verificarPapel() {
            const role = document.getElementById('sel-role').value;
            currentNeg.offer.role = role;
            addMsg('user', `Vejo voc√™ como ${role}.`);

            // Sistema de Hierarquia
            const niveis = { "Titular Absoluto": 4, "Importante": 3, "Rota√ß√£o": 2, "Reserva": 1 };
            const nivelOferta = niveis[role] || 0;
            const nivelDesejado = niveis[currentNeg.expectations.role] || 0;

            setTimeout(() => {
                if (nivelOferta < nivelDesejado) {
                    addMsg('cpu', `Isso √© um insulto. Eu sou jogador para ser ${currentNeg.expectations.role}! Se for para ser ${role}, vou embora.`);
                    addMsg('system', "O jogador encerrou a negocia√ß√£o ofendido.");
                    showOptions('fechar');
                } else {
                    addMsg('cpu', "Certo, concordo com essa fun√ß√£o. E o tempo de contrato?");
                    showOptions('duracao');
                }
            }, 1000);
        }

        function definirDuracao() {
            const anos = parseInt(document.querySelector('.range-slider').value);
            currentNeg.offer.years = anos;
            addMsg('user', `Proponho ${anos} anos de contrato.`);

            setTimeout(() => {
                if (anos !== currentNeg.expectations.years) {
                    addMsg('cpu', `N√£o concordo. Quero um contrato de ${currentNeg.expectations.years} anos para ter estabilidade.`);
                    showOptions('duracao');
                } else {
                    addMsg('cpu', "O tempo est√° √≥timo. Agora vamos falar de sal√°rio.");
                    showOptions('salario');
                }
            }, 1000);
        }

        function definirSalario() {
            const val = parseInt(document.getElementById('input-sal').value);
            currentNeg.offer.salary = val;
            addMsg('user', `Ofere√ßo R$ ${val.toLocaleString()} mensais.`);
            
            const minAceitavel = currentNeg.expectations.salary * 0.9;

            setTimeout(() => {
                if (val < minAceitavel) {
                    addMsg('cpu', `Muito baixo. Minha pedida √© R$ ${currentNeg.expectations.salary.toLocaleString()}. Melhore essa oferta.`);
                    showOptions('salario');
                } else {
                    addMsg('cpu', "Os n√∫meros agradam. Vamos fechar os b√¥nus?");
                    showOptions('bonus');
                }
            }, 1000);
        }

        function fecharAcordo() {
            const bon = parseInt(document.getElementById('input-bon').value);
            const bonFormatado = bon.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
            
            addMsg('user', `E ofere√ßo mais ${bonFormatado} de luvas (b√¥nus de assinatura).`);
            
            setTimeout(() => {
                const game = Engine.carregarJogo();
                
                if (game.recursos.dinheiro < bon) {
                    addMsg('system', "‚ùå ERRO: O clube n√£o tem dinheiro suficiente em caixa para pagar essas luvas.");
                    showOptions('fechar'); 
                    return;
                }

                addMsg('cpu', "Proposta aceita! Onde eu assino?");
                
                const meuTime = Engine.encontrarTime(game.info.time);
                const realIdx = meuTime.elenco.findIndex(p => p.nome === currentNeg.player.nome);
                
                if (realIdx > -1) {
                    meuTime.elenco[realIdx].salario = currentNeg.offer.salary;
                    meuTime.elenco[realIdx].papel = currentNeg.offer.role;
                    
                    const partes = Engine.data.getDataAtual(game.rodadaAtual).split('/'); 
                    const novoAno = parseInt(partes[2]) + currentNeg.offer.years;
                    meuTime.elenco[realIdx].contrato = `31/12/${novoAno}`;
                    
                    game.recursos.dinheiro -= bon;

                    const timeIdx = game.times.findIndex(t => t.nome === game.info.time);
                    if(timeIdx > -1) game.times[timeIdx] = meuTime;
                    
                    Engine.salvarJogo(game);
                }
                
                showOptions('fim_renovacao');
            }, 1000);
        }
        
        /* --- FUN√á√ïES DE NAVEGA√á√ÉO E L√ìGICA DE INTERA√á√ÉO --- */

        function iniciarRenovacao() {
            addMsg('user', "Quero renovar seu contrato.");
            setTimeout(() => {
                addMsg('cpu', "Ok. Qual papel voc√™ v√™ pra mim?");
                showOptions('papel');
            }, 800);
        }

        function abrirMenuElogios() { showOptions('menu_elogio'); }
        function abrirMenuCobranca() { showOptions('menu_cobranca'); }

        function executarInteracao(tipo, subtipo) {
            let msgUser = "";
            
            if (tipo === 'ELOGIAR') {
                if (subtipo === 'treino') msgUser = "Tenho gostado muito do seu empenho nos treinos.";
                if (subtipo === 'forma') msgUser = "Voc√™ est√° numa fase espetacular.";
                if (subtipo === 'lideranca') msgUser = "Sua lideran√ßa √© fundamental para o grupo.";
            } else if (tipo === 'COBRAR') {
                if (subtipo === 'raca') msgUser = "Preciso de mais intensidade. Voc√™ est√° andando em campo!";
                if (subtipo === 'tatico') msgUser = "Voc√™ n√£o est√° obedecendo a t√°tica. Aten√ß√£o!";
                if (subtipo === 'extra') msgUser = "Seu comportamento fora de campo est√° prejudicando o time.";
            }

            addMsg('user', msgUser);

            setTimeout(() => {
                const humorAtual = currentNeg.player.humor || 50; 
                const rng = Math.random() * 100;
                let resultado = 'neutro';

                if (tipo === 'ELOGIAR') {
                    if (humorAtual < 20 && rng > 50) resultado = 'falha';
                    else if (rng < 70) resultado = 'sucesso';
                    else resultado = 'neutro';
                }
                else if (tipo === 'COBRAR') {
                    if (humorAtual > 80 && rng < 60) resultado = 'sucesso'; 
                    else if (rng < 40) resultado = 'sucesso';
                    else resultado = 'falha';
                }

                const listaFrases = DIALOGOS[tipo].respostas[resultado];
                const fraseFinal = listaFrases[Math.floor(Math.random() * listaFrases.length)];

                addMsg('cpu', fraseFinal);
                atualizarHumorAposInteracao(tipo, resultado);
                showOptions('voltar_menu');
            }, 1000);
        }

        function perguntarPartida() {
            addMsg('user', "O que voc√™ espera do pr√≥ximo jogo?");
            
            setTimeout(() => {
                const lista = DIALOGOS.PARTIDA.respostas;
                const frase = lista[Math.floor(Math.random() * lista.length)];
                
                addMsg('cpu', frase);
                showOptions('voltar_menu');
            }, 1000);
        }

        function atualizarHumorAposInteracao(tipo, resultado) {
            const game = Engine.carregarJogo();
            const meuTime = Engine.encontrarTime(game.info.time);
            const pIdx = meuTime.elenco.findIndex(p => p.nome === currentNeg.player.nome);

            if (pIdx > -1) {
                let p = meuTime.elenco[pIdx];
                if (!p.humor) p.humor = 50; 

                if (tipo === 'ELOGIAR') {
                    if (resultado === 'sucesso') { p.humor = Math.min(100, p.humor + 10); addMsg('system', "Humor melhorou (+10)"); }
                    if (resultado === 'falha') { p.humor = Math.max(0, p.humor - 5); addMsg('system', "Humor piorou (-5)"); }
                } else if (tipo === 'COBRAR') {
                    if (resultado === 'sucesso') { p.humor = Math.min(100, p.humor + 5); addMsg('system', "Jogador motivado (+5)"); }
                    if (resultado === 'falha') { p.humor = Math.max(0, p.humor - 15); addMsg('system', "Humor piorou muito (-15)"); }
                }

                const timeIdx = game.times.findIndex(t => t.nome === game.info.time);
                game.times[timeIdx] = meuTime;
                Engine.salvarJogo(game);
                
                currentNeg.player.humor = p.humor;
            }
        }
    </script>
</body>
</html>
