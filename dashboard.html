<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRFutebol - Painel</title>
    
    <script src="database_jogadores.js"></script>
    <script src="engine.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700;800&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg-dark: #0f1216; --bg-panel: #1e2329; --accent: #00ff88; --text-main: #ffffff; --text-dim: #8b9bb4; --border: 1px solid rgba(255, 255, 255, 0.1); }
        * { box-sizing: border-box; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: #111; } ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-dark); color: var(--text-main); margin: 0; display: grid; grid-template-columns: 250px 1fr; min-height: 100vh; }
        .sidebar { background: #161b22; border-right: var(--border); padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .logo-area { font-family: 'Rajdhani', sans-serif; font-size: 1.8rem; font-weight: 800; margin-bottom: 30px; color: #fff; text-transform: uppercase; letter-spacing: 2px; } .logo-area span { color: var(--accent); }
        .nav-btn { background: transparent; border: none; color: var(--text-dim); text-align: left; padding: 12px 15px; font-size: 1rem; font-weight: 600; cursor: pointer; border-radius: 8px; transition: 0.2s; display: flex; align-items: center; gap: 10px; } .nav-btn:hover, .nav-btn.active { background: rgba(0, 255, 136, 0.1); color: var(--accent); }
        .main-content { padding: 30px; overflow-y: auto; }
        .dash-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; background: var(--bg-panel); padding: 20px; border-radius: 12px; border: var(--border); }
        .team-profile { display: flex; align-items: center; gap: 20px; } .team-shield { width: 60px; height: 60px; object-fit: contain; filter: drop-shadow(0 0 10px rgba(0,0,0,0.5)); }
        .team-info h2 { margin: 0; font-family: 'Rajdhani'; text-transform: uppercase; font-size: 1.5rem; } .coach-name { color: var(--text-dim); font-size: 0.9rem; margin-top: 5px; }
        .status-pill { background: #111; padding: 8px 20px; border-radius: 30px; border: 1px solid #333; font-family: 'Rajdhani'; font-weight: 700; display: flex; gap: 20px; } .stat-item span { color: var(--accent); }
        .grid-container { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        .card { background: var(--bg-panel); border: var(--border); border-radius: 12px; padding: 20px; }
        .card-title { font-family: 'Rajdhani'; font-weight: 700; text-transform: uppercase; color: var(--text-dim); font-size: 0.9rem; margin-bottom: 15px; display: flex; justify-content: space-between; }
        .next-match { display: flex; align-items: center; justify-content: space-between; background: linear-gradient(90deg, #1e2329 0%, #161b22 100%); padding: 30px; border-radius: 8px; border: 1px solid #333; position: relative; overflow: hidden; }
        .match-team { text-align: center; width: 30%; z-index: 2; } .match-team img { width: 60px; height: 60px; margin-bottom: 10px; } .match-team h3 { margin: 0; font-size: 1.1rem; }
        .vs-badge { font-family: 'Rajdhani'; font-size: 2rem; font-weight: 900; color: #333; background: #000; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border-radius: 50%; border: 2px solid #333; z-index: 2; }
        .play-btn { width: 100%; margin-top: 20px; padding: 15px; background: var(--accent); color: #000; border: none; font-family: 'Rajdhani'; font-weight: 800; font-size: 1.2rem; text-transform: uppercase; border-radius: 6px; cursor: pointer; transition: 0.2s; } .play-btn:hover { transform: scale(1.02); background: #fff; }
        .mini-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; } .mini-table th { text-align: left; color: #666; padding: 8px; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; } .mini-table td { padding: 10px 8px; border-bottom: 1px solid rgba(255,255,255,0.05); vertical-align: middle; }
        .pos-num { font-weight: 700; width: 30px; display: inline-block; } .my-team-row { background: rgba(0, 255, 136, 0.1); color: var(--accent); font-weight: bold; }
        
        .health-track { width: 100%; height: 4px; background: #333; border-radius: 2px; margin-top: 5px; position: relative; }
        .health-fill { height: 100%; border-radius: 2px; transition: width 0.3s; }

        @media (max-width: 800px) { body { grid-template-columns: 1fr; } .sidebar { display: none; } .grid-container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="logo-area">BR<span>FUTEBOL</span></div>
        <button class="nav-btn active">üìä Vis√£o Geral</button>
        <button class="nav-btn" onclick="window.location.href='escalacao.html'">üëï Escala√ß√£o</button>
        <button class="nav-btn" onclick="alert('Janela fechada.')">üí∞ Transfer√™ncias</button>
        <button class="nav-btn" onclick="alert('Em breve.')">üèÜ Classifica√ß√£o</button>
        <div style="margin-top: auto;"><button class="nav-btn" onclick="resetGame()" style="color: #ff4757;">‚úñ Sair do Jogo</button></div>
    </div>

    <div class="main-content">
        <div class="dash-header">
            <div class="team-profile"><img id="dash-escudo" src="" class="team-shield"><div class="team-info"><h2 id="dash-team-name">Carregando...</h2><div class="coach-name">T√©cnico: <span id="dash-coach">---</span></div></div></div>
            <div class="status-pill"><div class="stat-item">üí∞ <span id="dash-money">---</span></div><div class="stat-item">üìÖ Semana <span id="dash-week">1</span></div></div>
        </div>

        <div class="grid-container">
            <div style="display: flex; flex-direction: column; gap: 20px;">
                <div class="card">
                    <div class="card-title">PR√ìXIMA RODADA</div>
                    <div class="next-match">
                        <div class="match-team"><img id="home-logo" src=""><h3 id="home-name">Casa</h3></div>
                        <div class="vs-badge">VS</div>
                        <div class="match-team"><img id="away-logo" src=""><h3 id="away-name">Fora</h3></div>
                    </div>
                    <button class="play-btn" onclick="irParaPartida()">JOGAR PARTIDA</button>
                </div>

                <div class="card" style="max-height: 600px; overflow-y: auto;">
                    <div class="card-title">ELENCO DO CLUBE</div>
                    <table class="mini-table">
                        <thead><tr><th width="10%">POS</th><th width="40%">NOME</th><th width="10%">OVR</th><th width="20%">SA√öDE</th><th width="20%">CARAC.</th></tr></thead>
                        <tbody id="squad-body"></tbody>
                    </table>
                </div>
            </div>

            <div style="display: flex; flex-direction: column; gap: 20px;">
                <div class="card">
                    <div class="card-title">RELAT√ìRIO T√âCNICO</div>
                    <div style="text-align: center; padding: 15px;"><div style="font-size: 3rem; font-weight: 800; color: var(--accent);" id="team-ovr">0</div><div style="color: #666; font-size: 0.8rem; text-transform: uppercase;">For√ßa Geral</div></div>
                </div>
                <div class="card">
                    <div class="card-title">CLASSIFICA√á√ÉO</div>
                    <table class="mini-table">
                        <thead><tr><th>#</th><th>TIME</th><th>PTS</th></tr></thead>
                        <tbody id="table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        if (typeof database !== 'undefined') window.Database = database;
        if (typeof Database !== 'undefined') window.database = Database;

        window.onload = function() {
            if (window.Database && window.Database.brasil && Array.isArray(window.Database.brasil)) {
                const todos = window.Database.brasil;
                window.Database.brasil = { 'serieA': todos, 'serieB': [], 'serieC': [], 'serieD': [] };
            }
            carregarDados();
        };

        let gameState = null;
        let meuTime = null;

        function carregarDados() {
            try {
                gameState = Engine.carregarJogo();
                if (!gameState) { window.location.href = 'index.html'; return; }

                // 1. Carrega Time Original do DB
                meuTime = encontrarTimeNoDatabase(gameState.meuTime);
                if (!meuTime) meuTime = Engine.encontrarTime(gameState, gameState.meuTime);
                if (!meuTime) throw new Error("Erro de time.");

                // 2. Gera IDs consistentes (importante para sa√∫de)
                if(meuTime.elenco) {
                    meuTime.elenco.forEach((j, i) => { j.uid = `p_${i}`; }); // ID Baseado na posi√ß√£o original
                }

                // 3. APLICA SA√öDE DO SAVE (O PASSO IMPORTANTE!)
                if (gameState.jogadoresStatus) {
                    meuTime.elenco.forEach(j => {
                        const salvo = gameState.jogadoresStatus[j.uid];
                        if (salvo && salvo.saude !== undefined) {
                            j.saude = salvo.saude;
                        } else {
                            j.saude = 100; // Padr√£o se n√£o tiver save
                        }
                    });
                } else {
                    // Se n√£o tiver save de sa√∫de, come√ßa tudo 100
                    meuTime.elenco.forEach(j => j.saude = 100);
                }

                // Renderiza
                document.getElementById('dash-team-name').innerText = meuTime.nome;
                document.getElementById('dash-coach').innerText = localStorage.getItem('brfutebol_tecnico') || "T√©cnico";
                document.getElementById('dash-escudo').src = localStorage.getItem('brfutebol_escudo');
                document.getElementById('dash-money').innerText = meuTime.orcamento || "R$ 5 Mi";
                document.getElementById('dash-week').innerText = gameState.rodada;
                document.getElementById('team-ovr').innerText = meuTime.forca || 60;

                atualizarTabela();
                carregarOuGerarProximoJogo();
                atualizarListaElenco();

            } catch (e) { console.error(e); alert("Erro: " + e.message); }
        }

        function encontrarTimeNoDatabase(nomeOuId) {
            const db = window.database || window.Database;
            if (!db || !db.brasil) return null;
            for (let serie in db.brasil) {
                const lista = db.brasil[serie];
                const achou = lista.find(t => t.id === nomeOuId || t.nome === nomeOuId);
                if (achou) return JSON.parse(JSON.stringify(achou)); // Clona para n√£o alterar o DB original
            }
            return null;
        }

        function atualizarListaElenco() {
            const tbody = document.getElementById('squad-body');
            tbody.innerHTML = '';
            
            // Ordem: GOL > DEF > MEI > ATA
            const ordem = {'GOL':1, 'LD':2, 'LE':2, 'ZAG':3, 'VOL':4, 'MEI':5, 'ATA':6};
            const elenco = meuTime.elenco.sort((a,b) => (ordem[a.pos]||99) - (ordem[b.pos]||99) || b.forca - a.forca);

            elenco.forEach(jog => {
                const tr = document.createElement('tr');
                
                let corPos = '#888';
                if(jog.pos==='GOL') corPos='#e67e22'; else if(jog.pos==='ATA') corPos='#e74c3c'; else if(jog.pos==='MEI') corPos='#2ecc71'; else corPos='#3498db';

                const saude = jog.saude !== undefined ? jog.saude : 100;
                let corSaude = '#2ecc71';
                if(saude < 80) corSaude = '#f1c40f';
                if(saude < 50) corSaude = '#e74c3c';

                tr.innerHTML = `
                    <td><b style="color:${corPos}">${jog.pos}</b></td>
                    <td style="font-weight:600; color:#fff;">${jog.nome}</td>
                    <td><span style="background:#222; padding:2px 6px; border-radius:4px; font-weight:700;">${jog.forca}</span></td>
                    <td>
                        <div style="font-size:0.75rem; color:${corSaude}; font-weight:bold;">${saude}%</div>
                        <div class="health-track"><div class="health-fill" style="width:${saude}%; background:${corSaude}"></div></div>
                    </td>
                    <td style="font-size:0.8rem; color:#8b9bb4;">${jog.carac || '-'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function atualizarTabela() {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            let timesTabela = gameState.tabela || [];

            if (timesTabela.length === 0) {
                const db = window.database || window.Database;
                for(let s in db.brasil) {
                    if(db.brasil[s].find(t => t.nome === meuTime.nome)) {
                        timesTabela = db.brasil[s].map(t => ({ nome: t.nome, p:0 }));
                        break;
                    }
                }
            }
            timesTabela.sort((a,b) => b.p - a.p);
            timesTabela.slice(0, 10).forEach((t, i) => {
                const tr = document.createElement('tr');
                if(t.nome === meuTime.nome) tr.className = 'my-team-row';
                tr.innerHTML = `<td><span class="pos-num">${i + 1}</span></td><td>${t.nome}</td><td>${t.p}</td>`;
                tbody.appendChild(tr);
            });
        }

        function carregarOuGerarProximoJogo() {
            let oponente = null;
            const opNome = localStorage.getItem('brfutebol_oponente_atual');
            if (opNome) oponente = encontrarTimeNoDatabase(opNome);
            if (!oponente) {
                const db = window.database || window.Database;
                for(let s in db.brasil) {
                    if(db.brasil[s].find(t => t.nome === meuTime.nome)) {
                        const rivais = db.brasil[s].filter(t => t.nome !== meuTime.nome);
                        oponente = rivais[Math.floor(Math.random()*rivais.length)];
                        break;
                    }
                }
                if(oponente) localStorage.setItem('brfutebol_oponente_atual', oponente.nome);
            }
            if (oponente) {
                document.getElementById('home-name').innerText = meuTime.nome;
                document.getElementById('home-logo').src = document.getElementById('dash-escudo').src;
                document.getElementById('away-name').innerText = oponente.nome;
                document.getElementById('away-logo').src = oponente.escudo;
            }
        }

        function irParaPartida() { if(confirm("Ir para o est√°dio?")) window.location.href = 'partida.html'; }
        function resetGame() { if(confirm("Apagar progresso?")) { localStorage.clear(); window.location.href = 'index.html'; } }
        function gerarElencoBackup(n) { let l=[]; ['GOL','ZAG','ZAG','LE','LD','VOL','VOL','MEI','MEI','ATA','ATA'].forEach((p,i)=>l.push({nome:`Jog ${i}`,pos:p,forca:70,saude:100})); return l; }
    </script>
</body>
</html>
