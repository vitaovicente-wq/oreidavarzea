<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRFutebol - Central do Clube</title>
    
    <script src="engine.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700;900&family=Inter:wght@400;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-dark: #0f1216; --sidebar-bg: #161b22; --card-bg: #1e2329; --neon-green: #00ff88;
            --text-main: #ffffff; --text-muted: #8b949e; --border: #30363d; --gold: #f1c40f;
            --red: #ff4757; --blue: #3498db; --msg-user: #238636; --msg-cpu: #21262d;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            margin: 0; padding: 0;
            display: flex; height: 100vh; overflow: hidden;
        }

        /* SIDEBAR */
        .sidebar {
            width: 250px; background: var(--sidebar-bg);
            border-right: 1px solid var(--border);
            padding: 20px; display: flex; flex-direction: column; gap: 10px; flex-shrink: 0;
        }
        .logo {
            font-family: 'Rajdhani', sans-serif; font-size: 2rem; font-weight: 900;
            margin-bottom: 20px; color: #fff; text-transform: uppercase; letter-spacing: 2px;
        }
        .logo span { color: var(--neon-green); }
        .menu-btn {
            display: flex; align-items: center; gap: 12px; padding: 12px;
            border-radius: 8px; color: var(--text-muted); text-decoration: none;
            font-weight: 600; transition: 0.2s; cursor: pointer;
        }
        .menu-btn:hover, .menu-btn.active { background: rgba(0, 255, 136, 0.1); color: var(--neon-green); }
        .menu-btn.logout { margin-top: auto; color: var(--red); }
        .menu-btn.logout:hover { background: rgba(255, 71, 87, 0.1); }
        
        .badge { background: var(--red); color: #fff; font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; display: none; margin-left: auto; }
        .badge.show { display: inline-block; }

        /* MAIN CONTENT */
        .main-content {
            flex: 1; padding: 30px; overflow-y: auto;
            display: flex; flex-direction: column; gap: 25px;
        }

        /* HEADER INFO */
        .top-bar {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--card-bg); padding: 15px 25px; border-radius: 12px;
            border: 1px solid var(--border);
        }
        .club-title h1 { margin: 0; font-family: 'Rajdhani'; font-size: 2rem; text-transform: uppercase; }
        .club-title span { color: var(--text-muted); font-size: 0.9rem; letter-spacing: 1px; }
        .finances { display: flex; gap: 20px; }
        .stat-badge {
            background: #0d1117; padding: 8px 15px; border-radius: 6px; border: 1px solid var(--border);
            text-align: right; min-width: 120px;
        }
        .stat-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; display: block; }
        .stat-val { font-family: 'Rajdhani'; font-weight: 700; font-size: 1.2rem; color: var(--neon-green); }
        .date-val { font-size: 0.85rem; color: #fff; font-weight: 600; margin-top: 2px; display: block; }

        /* MATCHDAY BANNER */
        .match-banner {
            background: linear-gradient(to bottom, rgba(15, 18, 22, 0.6), rgba(15, 18, 22, 0.9)), url('https://images.unsplash.com/photo-1522770179533-24471fcdba45?q=80&w=1000&auto=format&fit=crop');
            background-size: cover; background-position: center;
            border-radius: 16px; border: 1px solid var(--border);
            padding: 40px; min-height: 250px; 
            display: flex; align-items: center; justify-content: center;
            position: relative; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.6);
        }
        
        .match-content-grid {
            display: grid; grid-template-columns: 1fr auto 1fr; 
            width: 100%; max-width: 800px; 
            align-items: center; justify-items: center; z-index: 2;
        }

        .match-info-center { display: flex; flex-direction: column; align-items: center; text-align: center; }
        .match-label { font-family: 'Rajdhani'; font-weight: 700; color: var(--neon-green); letter-spacing: 3px; margin-bottom: 5px; font-size: 0.9rem; text-transform: uppercase; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }
        .stadium-name { font-size: 0.8rem; color: #ccc; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
        
        .team-display { display: flex; flex-direction: column; align-items: center; gap: 15px; }
        .team-logo-big { width: 100px; height: 100px; object-fit: contain; filter: drop-shadow(0 0 20px rgba(255,255,255,0.1)); }
        .team-name-big { font-family: 'Rajdhani'; font-weight: 800; font-size: 1.4rem; text-align: center; color: #fff; text-shadow: 0 2px 5px rgba(0,0,0,0.8); }
        
        .vs-text { font-family: 'Rajdhani'; font-size: 3rem; font-weight: 900; color: #fff; margin: 0 30px; text-shadow: 0 0 10px rgba(0,0,0,0.5); }
        
        .play-btn {
            background: linear-gradient(45deg, var(--neon-green), #27ae60);
            color: #000; border: none;
            padding: 15px 40px; border-radius: 30px; font-family: 'Rajdhani';
            font-weight: 900; font-size: 1.2rem; cursor: pointer; text-transform: uppercase;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3); margin-top: 15px;
        }
        .play-btn:hover { transform: scale(1.05); }

        /* SQUAD SECTION */
        .section-header {
            display: flex; justify-content: space-between; align-items: flex-end;
            margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px;
        }
        .section-title { font-family: 'Rajdhani'; font-size: 1.5rem; font-weight: 700; color: #fff; }
        
        .squad-table-container {
            background: var(--card-bg); border: 1px solid var(--border);
            border-radius: 12px; overflow: hidden;
        }
        .squad-table { width: 100%; border-collapse: collapse; }
        .squad-table th {
            text-align: left; background: rgba(0,0,0,0.3); color: var(--text-muted);
            padding: 15px 10px; font-size: 0.8rem; text-transform: uppercase; font-weight: 700;
        }
        .squad-table td {
            padding: 12px 10px; border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 0.9rem; vertical-align: middle;
        }
        .squad-table tr { cursor: pointer; transition: background 0.2s; }
        .squad-table tr:hover { background: rgba(255,255,255,0.08); }

        /* Colunas */
        .pos-badge { font-size: 0.75rem; font-weight: 800; padding: 4px 0; border-radius: 4px; text-align: center; color: #000; width: 40px; display: inline-block; }
        .pos-gol { background-color: #f1c40f; } 
        .pos-def { background-color: #3498db; color: #fff; } 
        .pos-mei { background-color: #2ecc71; } 
        .pos-ata { background-color: #ff4757; color: #fff; } 

        .col-name { font-weight: 600; color: #fff; font-size: 1rem; }
        .col-ovr { width: 50px; font-family: 'Rajdhani'; font-weight: 800; font-size: 1.2rem; color: var(--gold); text-align: center; }
        .col-stat { width: 40px; text-align: center; font-family: 'Rajdhani'; font-weight: 600; color: #ccc; font-size: 0.9rem; }
        .stat-high { color: var(--neon-green); } .stat-low { color: #555; }
        .carac-badge { font-size: 0.7rem; font-weight: 600; color: #aaa; background: rgba(255,255,255,0.05); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.1); }
        
        /* Barra de Sa√∫de */
        .condition-bar-bg { width: 100%; height: 6px; background: #333; border-radius: 3px; overflow: hidden; }
        .condition-bar-fill { height: 100%; border-radius: 3px; transition: width 0.3s ease; }

        /* --- MODAL DE NEGOCIA√á√ÉO --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .neg-card { width: 900px; height: 650px; background: #121519; border: 1px solid #444; border-radius: 12px; display: flex; overflow: hidden; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        
        /* Lateral Esquerda (Info do Jogador) */
        .neg-sidebar { width: 280px; background: #161b22; border-right: 1px solid #333; padding: 25px; display: flex; flex-direction: column; gap: 20px; }
        .neg-photo-area { text-align: center; }
        .neg-photo-ph { width: 120px; height: 120px; background: #222; border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; font-size: 3rem; color: #555; border: 2px solid var(--neon-green); }
        .neg-p-name { font-family: 'Rajdhani'; font-weight: 800; font-size: 1.5rem; color: #fff; margin-bottom: 5px; }
        .neg-p-ovr { font-family: 'Rajdhani'; font-weight: 900; font-size: 2rem; color: var(--gold); }
        .neg-info-row { display: flex; justify-content: space-between; font-size: 0.9rem; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px; color: #aaa; }
        .neg-info-val { color: #fff; font-weight: 700; }

        /* √Årea Direita (Chat) */
        .neg-chat-area { flex: 1; display: flex; flex-direction: column; background: #0f1216; }
        .neg-header { padding: 15px 25px; border-bottom: 1px solid #333; background: #161b22; font-family: 'Rajdhani'; font-weight: 700; display: flex; justify-content: space-between; align-items: center; }
        .neg-close-btn { background: none; border: none; color: #666; font-size: 1.2rem; cursor: pointer; }
        .neg-close-btn:hover { color: #fff; }

        .chat-feed { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .msg { max-width: 80%; padding: 12px 18px; border-radius: 12px; font-size: 0.95rem; line-height: 1.4; animation: popIn 0.3s ease; }
        .msg.cpu { align-self: flex-start; background: var(--msg-cpu); border-bottom-left-radius: 2px; border: 1px solid #333; color: #ddd; }
        .msg.user { align-self: flex-end; background: var(--msg-user); border-bottom-right-radius: 2px; color: #fff; font-weight: 600; }
        @keyframes popIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .neg-controls { padding: 20px; border-top: 1px solid #333; background: #161b22; min-height: 120px; display: flex; flex-direction: column; justify-content: center; }
        .opt-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .opt-btn { background: #222; border: 1px solid #444; color: #ccc; padding: 12px; border-radius: 6px; cursor: pointer; font-family: 'Inter'; font-size: 0.9rem; transition: 0.2s; text-align: left; }
        .opt-btn:hover { background: #333; border-color: #666; color: #fff; }
        .opt-btn.confirm { background: var(--neon-green); color: #000; border-color: var(--neon-green); font-weight: 700; text-align: center; }
        .opt-btn.cancel { background: var(--red); color: #fff; border-color: var(--red); font-weight: 700; text-align: center; }

        /* Inputs de Negocia√ß√£o */
        .input-group { display: flex; flex-direction: column; gap: 5px; margin-bottom: 10px; }
        .input-label { font-size: 0.8rem; color: #888; text-transform: uppercase; letter-spacing: 1px; }
        .neg-input { background: #000; border: 1px solid #444; color: #fff; padding: 10px; border-radius: 4px; font-family: 'Rajdhani'; font-size: 1.1rem; }
        .range-slider { width: 100%; cursor: pointer; accent-color: var(--neon-green); }

        @media (max-width: 900px) { .col-stat { display: none; } }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="logo">BR<span>FUTEBOL</span></div>
        <a class="menu-btn active">üìä Vis√£o Geral</a>
        <a class="menu-btn" href="escalacao.html">üëï Escala√ß√£o</a>
        <a class="menu-btn" href="calendario.html">üìÖ Calend√°rio</a>
        <a class="menu-btn" href="classificacao.html">üèÜ Classifica√ß√£o</a>
        <a class="menu-btn" href="estadio.html">üèüÔ∏è Est√°dio</a>
        <a class="menu-btn" href="financeiro.html">üí∞ Finan√ßas</a>
        <a class="menu-btn" href="mensagens.html">üì© Mensagens <span id="badge-msg" class="badge">0</span></a>
        <a class="menu-btn logout" onclick="sair()">‚úñ Sair</a>
    </nav>

    <main class="main-content">
        
        <div class="top-bar">
            <div class="club-title">
                <h1 id="team-name">Carregando...</h1>
                <span id="coach-name">Treinador: ---</span>
            </div>
            <div class="finances">
                <div class="stat-badge">
                    <span class="stat-label">Or√ßamento</span>
                    <span class="stat-val" id="money-display">R$ 0M</span>
                </div>
                <div class="stat-badge">
                    <span class="stat-label">Calend√°rio</span>
                    <span class="stat-val" id="round-display">--</span>
                    <span class="date-val" id="date-display">01/01/2026</span>
                </div>
            </div>
        </div>

        <div class="match-banner" id="match-banner">
            <h2 style="margin:auto; color:#888;">Carregando temporada...</h2>
        </div>

        <div>
            <div class="section-header">
                <div class="section-title">Elenco Principal</div>
                <button onclick="window.location.href='escalacao.html'" style="background:none; border:1px solid #444; color:#888; padding:8px 20px; border-radius:6px; cursor:pointer;">T√°tica ‚öôÔ∏è</button>
            </div>
            <p style="color:#666; font-size:0.8rem; margin-bottom:10px;">‚ÑπÔ∏è Clique em um jogador para negociar contrato.</p>
            
            <div class="squad-table-container">
                <table class="squad-table">
                    <thead>
                        <tr>
                            <th style="width:50px; text-align:center;">Pos</th>
                            <th>Nome</th>
                            <th style="width:50px; text-align:center;">OVR</th>
                            <th style="width:100px;">Contrato</th>
                            
                            <th class="col-stat">PAC</th>
                            <th class="col-stat">SHO</th>
                            <th class="col-stat">PAS</th>
                            <th class="col-stat">DRI</th>
                            <th class="col-stat">DEF</th>
                            <th class="col-stat">PHY</th>
                            <th style="width:120px;">Carac.</th>
                            <th style="width:100px;">Condi√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody id="squad-body"></tbody>
                </table>
            </div>
        </div>

    </main>

    <div id="neg-modal" class="modal-overlay">
        <div class="neg-card">
            <div class="neg-sidebar">
                <div class="neg-photo-area">
                    <div class="neg-photo-ph" id="neg-pic">üë§</div>
                    <div class="neg-p-name" id="neg-name">Nome</div>
                    <div class="neg-p-ovr" id="neg-ovr">00</div>
                </div>
                <div class="neg-info-row"><span>Idade:</span> <span class="neg-info-val" id="neg-age">00</span></div>
                <div class="neg-info-row"><span>Posi√ß√£o:</span> <span class="neg-info-val" id="neg-pos">POS</span></div>
                <div class="neg-info-row"><span>Sal√°rio Atual:</span> <span class="neg-info-val" id="neg-sal">R$ 0</span></div>
                <div class="neg-info-row"><span>Fim Contrato:</span> <span class="neg-info-val" id="neg-end">00/00/0000</span></div>
                <div class="neg-info-row"><span>Humor:</span> <span class="neg-info-val" style="color:var(--neon-green)">Normal</span></div>
            </div>
            <div class="neg-chat-area">
                <div class="neg-header">
                    <span>Sala de Reuni√£o</span>
                    <button class="neg-close-btn" onclick="fecharNegociacao()">‚úï</button>
                </div>
                <div class="chat-feed" id="chat-feed">
                    </div>
                <div class="neg-controls" id="neg-controls">
                    </div>
            </div>
        </div>
    </div>

    <script>
        const DEFAULT_SHIELD = "https://cdn-icons-png.flaticon.com/512/53/53283.png";

        // LISTA DE EST√ÅDIOS REAIS PARA IMERS√ÉO
        const ESTADIOS_REAIS = {
            "Corinthians": "Neo Qu√≠mica Arena", "Palmeiras": "Allianz Parque", "S√£o Paulo": "MorumBIS",
            "Santos": "Vila Belmiro", "Flamengo": "Maracan√£", "Fluminense": "Maracan√£",
            "Vasco": "S√£o Janu√°rio", "Botafogo": "Nilton Santos", "Gr√™mio": "Arena do Gr√™mio",
            "Internacional": "Beira-Rio", "Atl√©tico-MG": "Arena MRV", "Cruzeiro": "Mineir√£o",
            "Bahia": "Fonte Nova", "Vit√≥ria": "Barrad√£o", "Fortaleza": "Castel√£o",
            "Cear√°": "Castel√£o", "Athletico-PR": "Ligga Arena", "Coritiba": "Couto Pereira",
            "Sport": "Ilha do Retiro", "Bragantino": "Nabi Abi Chedid", "Ponte Preta": "Mois√©s Lucarelli"
        };

        window.onload = function() {
            try {
                // Carrega o save da Engine
                const game = Engine.carregarJogo();
                if (!game || !game.info) throw new Error("Save inv√°lido ou inexistente.");

                // 1. Preenche Topo
                document.getElementById('team-name').innerText = game.info.time;
                document.getElementById('coach-name').innerText = "Manager: " + game.info.tecnico;
                
                // ATUALIZA√á√ÉO DO OR√áAMENTO (Formata√ß√£o melhorada)
                const dinheiro = game.recursos.dinheiro || 0;
                document.getElementById('money-display').innerText = dinheiro.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                
                document.getElementById('round-display').innerText = "Rodada " + game.rodadaAtual;

                // --- DATA DO JOGO (INTEGRA√á√ÉO COM ENGINE V6.0) ---
                if (Engine.data) {
                    document.getElementById('date-display').innerText = Engine.data.getDataAtual(game.rodadaAtual);
                }

                // 2. Renderiza Pr√≥ximo Jogo
                try { renderizarMatchDay(game); } catch(e) { console.error("Erro no banner:", e); }
                
                // 3. Renderiza Elenco com Atributos e Sa√∫de
                try { renderizarElencoPro(game); } catch(e) { console.error("Erro no elenco:", e); }

                // 4. Badge de Mensagens
                const badge = document.getElementById('badge-msg');
                if(badge && game.mensagens) {
                    const naoLidas = game.mensagens.filter(m => !m.lida).length;
                    if(naoLidas > 0) {
                        badge.innerText = naoLidas;
                        badge.classList.add('show');
                    }
                }

            } catch (err) {
                alert("Erro ao carregar dashboard: " + err.message);
                window.location.href = 'index.html';
            }
        };

        function renderizarMatchDay(game) {
            const container = document.getElementById('match-banner');
            const rodadaIndex = game.rodadaAtual - 1;

            if (!game.calendario || !game.calendario[rodadaIndex]) {
                container.innerHTML = "<h2 style='margin:auto; color:#ccc'>Fim de Temporada</h2>";
                return;
            }

            const jogos = game.calendario[rodadaIndex].jogos;
            const meuJogo = jogos.find(j => j.mandante === game.info.time || j.visitante === game.info.time);

            if (meuJogo) {
                const mandanteObj = Engine.encontrarTime(meuJogo.mandante) || { escudo: DEFAULT_SHIELD };
                const visitanteObj = Engine.encontrarTime(meuJogo.visitante) || { escudo: DEFAULT_SHIELD };
                let nomeEstadio = ESTADIOS_REAIS[meuJogo.mandante] || "Est√°dio Municipal";

                container.innerHTML = `
                    <div class="match-content-grid">
                        <div class="team-display">
                            <img src="${mandanteObj.escudo || DEFAULT_SHIELD}" class="team-logo-big" onerror="this.src='${DEFAULT_SHIELD}'">
                            <div class="team-name-big">${meuJogo.mandante}</div>
                        </div>
                        <div class="match-info-center">
                            <div class="match-label">RODADA ${game.rodadaAtual} ‚Ä¢ <span style="color:#fff">${nomeEstadio}</span></div>
                            <div class="vs-text">VS</div>
                            <button class="play-btn" onclick="irParaEstadio()">JOGAR</button>
                        </div>
                        <div class="team-display">
                            <img src="${visitanteObj.escudo || DEFAULT_SHIELD}" class="team-logo-big" onerror="this.src='${DEFAULT_SHIELD}'">
                            <div class="team-name-big">${meuJogo.visitante}</div>
                        </div>
                    </div>`;
            } else {
                container.innerHTML = "<h2 style='margin:auto; color:#ccc'>Folga nesta rodada</h2>";
            }
        }

        function renderizarElencoPro(game) {
            const tbody = document.getElementById('squad-body');
            tbody.innerHTML = "";

            let meuTime = Engine.encontrarTime(game.info.time);

            if(game.jogadoresStatus) {
                meuTime.elenco.forEach((j, i) => {
                    const uid = j.uid || `p_${i}`;
                    if(game.jogadoresStatus[uid]) {
                        j.saude = game.jogadoresStatus[uid].saude;
                    }
                });
            }

            if (!meuTime || !meuTime.elenco) {
                tbody.innerHTML = "<tr><td colspan='11' style='text-align:center'>Sem elenco.</td></tr>";
                return;
            }

            const ordem = {'GOL':1, 'ZAG':2, 'LD':3, 'LE':3, 'VOL':4, 'MEI':5, 'ATA':6};
            meuTime.elenco.sort((a,b) => (ordem[a.pos]||99) - (ordem[b.pos]||99) || b.forca - a.forca);

            meuTime.elenco.forEach((jog, idx) => {
                const atr = garantirAtributos(jog); 
                const saude = jog.saude !== undefined ? jog.saude : 100;
                let colorBar = '#2ecc71'; 
                if(saude < 80) colorBar = '#f1c40f'; 
                if(saude < 50) colorBar = '#ff4757'; 
                
                let posClass = "";
                if(jog.pos==='GOL') posClass='pos-gol';
                else if(['ZAG','LD','LE'].includes(jog.pos)) posClass='pos-def';
                else if(['VOL','MEI'].includes(jog.pos)) posClass='pos-mei';
                else posClass='pos-ata';

                const fmtStat = (v) => v >= 80 ? `<span class="stat-high">${v}</span>` : (v < 60 ? `<span class="stat-low">${v}</span>` : v);

                const tr = document.createElement('tr');
                tr.onclick = () => iniciarNegociacao(idx); // TRIGGER DO MODAL
                tr.innerHTML = `
                    <td><span class="pos-badge ${posClass}">${jog.pos}</span></td>
                    <td class="col-name">${jog.nome}</td>
                    <td class="col-ovr">${jog.forca}</td>
                    <td style="color:#aaa; font-size:0.8rem; text-align:center;">${jog.contrato || '-'}</td>
                    
                    <td class="col-stat">${fmtStat(atr.VEL)}</td>
                    <td class="col-stat">${fmtStat(atr.FIN)}</td>
                    <td class="col-stat">${fmtStat(atr.PAS)}</td>
                    <td class="col-stat">${fmtStat(atr.DRI)}</td>
                    <td class="col-stat">${fmtStat(atr.DEF)}</td>
                    <td class="col-stat">${fmtStat(atr.PHY)}</td>
                    <td><span class="carac-badge">${jog.carac || '-'}</span></td>
                    <td>
                        <div class="condition-bar-bg" title="${saude}%">
                            <div class="condition-bar-fill" style="width:${saude}%; background:${colorBar}"></div>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function garantirAtributos(jog) {
            if(jog.atributos && jog.atributos.VEL) return jog.atributos;
            const b = jog.forca || 60;
            if(jog.pos === 'GOL') return { VEL:b, FIN:b-10, PAS:b-5, DRI:b-10, DEF:b+5, PHY:b };
            if(jog.pos === 'ATA') return { VEL:b+2, FIN:b+5, PAS:b-5, DRI:b+2, DEF:b-20, PHY:b };
            if(jog.pos === 'ZAG') return { VEL:b-5, FIN:b-15, PAS:b-5, DRI:b-10, DEF:b+5, PHY:b+5 };
            return { VEL:b, FIN:b-5, PAS:b+2, DRI:b, DEF:b, PHY:b }; 
        }

        function irParaEstadio() {
            const game = Engine.carregarJogo();
            const rodadaIndex = game.rodadaAtual - 1;
            const jogo = game.calendario[rodadaIndex].jogos.find(j => j.mandante === game.info.time || j.visitante === game.info.time);
            
            if(jogo) {
                const adv = jogo.mandante === game.info.time ? jogo.visitante : jogo.mandante;
                localStorage.setItem('brfutebol_oponente_atual', adv);
                window.location.href = 'partida.html';
            } else {
                alert("Erro ao identificar o jogo.");
            }
        }

        function sair() { if(confirm("Deseja sair para o menu inicial?")) window.location.href='index.html'; }

        /* --- SISTEMA DE NEGOCIA√á√ÉO V1.0 --- */
        let currentNeg = { player: null, idx: -1, step: 0, offer: {} };

        const REA√áOES_INICIAIS = [
            "Gosto muito do clube, vamos renovar sim!",
            "Estou feliz aqui, podemos conversar.",
            "Depende da proposta, tenho sondagens.",
            "N√£o sei se √© o momento, mas vou ouvir.",
            "Quero uma valoriza√ß√£o salarial justa.",
            "S√≥ fico se tiver garantia de titularidade.",
            "Meu agente vai analisar a oferta.",
            "Sinto que meu ciclo aqui acabou. (Encerrar)"
        ];

        function iniciarNegociacao(playerIdx) {
            const game = Engine.carregarJogo();
            const meuTime = Engine.encontrarTime(game.info.time);
            const p = meuTime.elenco[playerIdx];
            
            currentNeg = { player: p, idx: playerIdx, step: 0, offer: { salary: 0, years: 1, bonus: 0, role: 'Rota√ß√£o' } };

            // Preenche Sidebar
            document.getElementById('neg-name').innerText = p.nome;
            document.getElementById('neg-ovr').innerText = p.forca;
            document.getElementById('neg-age').innerText = p.idade;
            document.getElementById('neg-pos').innerText = p.pos;
            
            const salAtual = p.salario || ((p.forca||60)*1500);
            document.getElementById('neg-sal').innerText = salAtual.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
            document.getElementById('neg-end').innerText = p.contrato || "31/12/2026";

            // Limpa Chat
            const feed = document.getElementById('chat-feed');
            feed.innerHTML = '';
            
            document.getElementById('neg-modal').style.display = 'flex';
            
            // Passo 1: In√≠cio
            addMsg('cpu', `Ol√° mister. Voc√™ queria falar sobre meu contrato?`);
            showOptions('inicio');
        }

        function fecharNegociacao() { document.getElementById('neg-modal').style.display = 'none'; }

        function addMsg(who, text) {
            const d = document.createElement('div');
            d.className = `msg ${who}`;
            d.innerText = text;
            document.getElementById('chat-feed').appendChild(d);
            document.getElementById('chat-feed').scrollTop = document.getElementById('chat-feed').scrollHeight;
        }

        function showOptions(step) {
            const area = document.getElementById('neg-controls');
            area.innerHTML = '';

            if (step === 'inicio') {
                area.innerHTML = `
                    <div class="opt-grid">
                        <div class="opt-btn" onclick="responder(0)">Quero renovar seu contrato.</div>
                        <div class="opt-btn" onclick="responder(1)">S√≥ queria ver como voc√™ est√°. (Sair)</div>
                    </div>
                `;
            } 
            else if (step === 'papel') {
                area.innerHTML = `
                    <div class="input-group">
                        <span class="input-label">Qual ser√° meu papel no time?</span>
                        <select id="sel-role" class="neg-input">
                            <option>Titular Absoluto</option>
                            <option selected>Importante</option>
                            <option>Rota√ß√£o de Elenco</option>
                            <option>Reserva</option>
                            <option>Promessa</option>
                        </select>
                    </div>
                    <div class="opt-btn confirm" onclick="definirPapel()">Confirmar Papel</div>
                `;
            }
            else if (step === 'duracao') {
                area.innerHTML = `
                    <div class="input-group">
                        <span class="input-label">Dura√ß√£o do Novo Contrato (Anos)</span>
                        <input type="range" min="1" max="5" value="2" class="range-slider" oninput="document.getElementById('val-anos').innerText = this.value + ' anos'">
                        <div id="val-anos" style="text-align:center; color:var(--neon-green); font-weight:bold; margin-top:5px;">2 anos</div>
                    </div>
                    <div class="opt-btn confirm" onclick="definirDuracao()">Oferecer Dura√ß√£o</div>
                `;
            }
            else if (step === 'salario') {
                // Sugest√£o baseada na for√ßa
                const base = (currentNeg.player.forca * 1600); 
                area.innerHTML = `
                    <div class="input-group">
                        <span class="input-label">Sal√°rio por Jogo (R$)</span>
                        <input type="number" id="input-sal" class="neg-input" value="${base}">
                    </div>
                    <div class="opt-btn confirm" onclick="definirSalario()">Fazer Proposta Final</div>
                `;
            }
            else if (step === 'bonus') {
                // L√≥gica de b√¥nus dependendo da posi√ß√£o
                const isDef = ['GOL','ZAG','LD','LE'].includes(currentNeg.player.pos);
                const labelBonus = isDef ? "B√¥nus por Jogo sem Sofrer Gol" : "B√¥nus por Gol Marcado";
                area.innerHTML = `
                    <div class="input-group">
                        <span class="input-label">${labelBonus} (R$)</span>
                        <input type="number" id="input-bon" class="neg-input" value="5000">
                    </div>
                    <div class="opt-btn confirm" onclick="fecharAcordo()">Enviar Proposta Completa</div>
                `;
            }
            else if (step === 'fim') {
                area.innerHTML = `<div class="opt-btn confirm" onclick="fecharNegociacao(); location.reload();">Fechar e Salvar</div>`;
            }
        }

        function responder(opt) {
            if(opt === 1) { fecharNegociacao(); return; }
            addMsg('user', "Queremos estender seu v√≠nculo com o clube.");
            
            setTimeout(() => {
                // IA Simples: Randomiza a rea√ß√£o inicial
                const reactionIdx = Math.floor(Math.random() * REA√áOES_INICIAIS.length);
                const reaction = REA√áOES_INICIAIS[reactionIdx];
                addMsg('cpu', reaction);

                if (reaction.includes("Encerrar")) {
                    setTimeout(() => { addMsg('user', "Entendo. Boa sorte no futuro."); fecharNegociacao(); }, 2000);
                } else {
                    currentNeg.step = 1;
                    setTimeout(() => { 
                        addMsg('cpu', "Primeiro, qual voc√™ v√™ sendo meu papel no elenco?");
                        showOptions('papel');
                    }, 1000);
                }
            }, 800);
        }

        function definirPapel() {
            const role = document.getElementById('sel-role').value;
            currentNeg.offer.role = role;
            addMsg('user', `Vejo voc√™ como ${role}.`);
            setTimeout(() => {
                addMsg('cpu', "Ok. E por quanto tempo seria o contrato?");
                showOptions('duracao');
            }, 800);
        }

        function definirDuracao() {
            const anos = document.querySelector('.range-slider').value;
            currentNeg.offer.years = parseInt(anos);
            addMsg('user', `Proponho um contrato de ${anos} anos.`);
            setTimeout(() => {
                addMsg('cpu', "Certo. Agora vamos falar de n√∫meros. Qual o sal√°rio base?");
                showOptions('salario');
            }, 800);
        }

        function definirSalario() {
            const val = parseInt(document.getElementById('input-sal').value);
            currentNeg.offer.salary = val;
            addMsg('user', `Ofere√ßo R$ ${val.toLocaleString()} por jogo.`);
            
            // Verifica se o valor √© aceit√°vel (Base: For√ßa * 1500)
            const minAceitavel = (currentNeg.player.forca * 1400); 
            
            setTimeout(() => {
                if (val < minAceitavel) {
                    addMsg('cpu', `Isso √© muito pouco. Eu esperava pelo menos R$ ${minAceitavel.toLocaleString()}.`);
                    // Chance de contraproposta ou recusa
                    showOptions('salario'); // Deixa tentar de novo
                } else {
                    addMsg('cpu', "O valor base me agrada. E quanto aos b√¥nus de desempenho?");
                    showOptions('bonus');
                }
            }, 1000);
        }

        function fecharAcordo() {
            const bon = parseInt(document.getElementById('input-bon').value);
            currentNeg.offer.bonus = bon;
            addMsg('user', `Mais R$ ${bon.toLocaleString()} de b√¥nus por meta atingida.`);
            
            setTimeout(() => {
                addMsg('cpu', "Temos um acordo! Onde eu assino?");
                
                // SALVAR NO ENGINE
                const game = Engine.carregarJogo();
                const meuTime = Engine.encontrarTime(game.info.time);
                
                // Atualiza o jogador no save
                meuTime.elenco[currentNeg.idx].salario = currentNeg.offer.salary;
                meuTime.elenco[currentNeg.idx].papel = currentNeg.offer.role;
                
                // Calcula nova data (Data Atual + Anos)
                const partes = Engine.data.getDataAtual(game.rodadaAtual).split('/'); // dd, mm, yyyy
                const novoAno = parseInt(partes[2]) + currentNeg.offer.years;
                meuTime.elenco[currentNeg.idx].contrato = `31/12/${novoAno}`;
                
                // Atualiza o time no array global e salva
                const timeIdx = game.times.findIndex(t => t.nome === game.info.time);
                if(timeIdx > -1) game.times[timeIdx] = meuTime;
                
                Engine.salvarJogo(game);
                
                showOptions('fim');
            }, 1000);
        }

    </script>
</body>
</html>
