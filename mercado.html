<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRFutebol - Negociações</title>
    <script src="database_jogadores.js"></script>
    <script src="engine.js"></script>
    <style>
        :root { --bg:#0d1115; --card:#1e272e; --text:#ecf0f1; --gold:#f1c40f; --green:#2ecc71; --red:#ff4757; }
        body { font-family:'Segoe UI',sans-serif; background:var(--bg); color:var(--text); margin:0; display:grid; grid-template-rows:70px 1fr; height:100vh; overflow:hidden; }
        
        header { background:rgba(30,39,46,0.95); border-bottom:2px solid var(--green); display:flex; align-items:center; justify-content:space-between; padding:0 30px; }
        .btn-back { background:#444; color:#fff; border:none; padding:10px 20px; border-radius:6px; cursor:pointer; font-weight:bold; }
        .caixa-display { font-size:1.1rem; font-weight:bold; color:var(--green); background:#111; padding:8px 15px; border-radius:8px; border:1px solid #333; }

        main { padding:30px; max-width:1200px; margin:0 auto; width:100%; box-sizing:border-box; display:flex; flex-direction:column; gap:20px; }

        .nav-bar { display:flex; gap:15px; align-items:center; }
        select { background:#111; color:#fff; padding:10px; border:1px solid #444; border-radius:6px; font-weight:bold; text-transform:uppercase; }
        
        .tabs { display:flex; gap:10px; margin-left:auto; }
        .tab-btn { background:none; border:none; color:#777; font-size:1rem; font-weight:bold; cursor:pointer; padding:10px; transition:0.2s; }
        .tab-btn.active { color:#fff; border-bottom:3px solid var(--green); }

        .clubs-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(200px, 1fr)); gap:15px; overflow-y:auto; }
        .club-card {
            background:var(--card); border:1px solid #333; border-radius:10px; padding:20px;
            display:flex; flex-direction:column; align-items:center; cursor:pointer; transition:transform 0.2s;
        }
        .club-card:hover { transform:translateY(-5px); border-color:var(--green); }
        .club-logo { width:60px; height:60px; object-fit:contain; margin-bottom:10px; }
        .club-name { font-weight:bold; font-size:1rem; text-align:center; }

        .players-list { display:none; flex-direction:column; gap:10px; overflow-y:auto; }
        .players-list.active { display:flex; }

        .player-row {
            background:var(--card); padding:15px; border-radius:8px; border:1px solid #333;
            display:flex; justify-content:space-between; align-items:center;
        }
        .p-info { display:flex; gap:15px; align-items:center; }
        .p-pos { background:#333; padding:4px 8px; border-radius:4px; font-weight:bold; font-size:0.8rem; width:30px; text-align:center; }
        .p-ovr { color:var(--gold); font-weight:900; font-size:1.1rem; }
        .p-val { color:var(--green); font-weight:bold; font-family:monospace; }

        .btn-action { padding:8px 15px; border-radius:5px; border:none; cursor:pointer; font-weight:bold; text-transform:uppercase; }
        .btn-buy { background:var(--green); color:#000; }
        .btn-sell { background:var(--red); color:#fff; }

        /* MODAL */
        #offer-modal {
            display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.9); z-index:200; align-items:center; justify-content:center;
        }
        .modal-box { background:var(--card); padding:30px; border-radius:10px; width:400px; border:1px solid var(--green); text-align:center; position:relative; }
        .modal-input { width:80%; padding:15px; font-size:1.5rem; background:#000; color:var(--green); border:1px solid #444; margin:20px 0; text-align:center; font-weight:bold; }
        .modal-info { color:#aaa; font-size:0.9rem; margin-bottom:20px; }

    </style>
</head>
<body>

    <header>
        <button class="btn-back" onclick="window.location.href='dashboard.html'">⬅ Dashboard</button>
        <h2 style="margin:0;">NEGOCIAÇÕES</h2>
        <div class="caixa-display" id="header-caixa">R$ 0</div>
    </header>

    <main>
        <div class="nav-bar">
            <select id="country-select" onchange="carregarClubes()"></select>
            <div class="tabs">
                <button class="tab-btn active" onclick="mudarModo('comprar')">Buscar Clubes</button>
                <button class="tab-btn" onclick="mudarModo('vender')">Meu Elenco (Vender)</button>
            </div>
        </div>

        <div id="view-clubs" class="clubs-grid"></div>

        <div id="view-squad" class="players-list">
            <button onclick="voltarParaClubes()" style="background:#333; color:#fff; border:none; padding:10px; cursor:pointer; width:150px;">⬅ Voltar aos Clubes</button>
            <h3 id="squad-title" style="margin:10px 0; color:var(--gold);">Jogadores</h3>
            <div id="squad-container" style="display:flex; flex-direction:column; gap:10px;"></div>
        </div>

        <div id="view-sell" class="players-list"></div>
    </main>

    <div id="offer-modal">
        <div class="modal-box">
            <h3 id="modal-p-name">Fazer Proposta</h3>
            <div class="modal-info">Valor de Mercado Estimado: <span id="modal-p-val" style="color:#fff;">R$ 0</span></div>
            <input type="number" id="offer-input" class="modal-input" placeholder="Valor">
            <div style="display:flex; gap:10px; justify-content:center;">
                <button class="btn-action" style="background:#444; color:#fff;" onclick="fecharModal()">Cancelar</button>
                <button class="btn-action btn-buy" onclick="confirmarProposta()">ENVIAR OFERTA</button>
            </div>
        </div>
    </div>

    <script>
        let gameState, meuTime;
        let timeAlvo = null; 
        let jogadorAlvoId = null;

        window.onload = function() {
            if (typeof Engine === 'undefined') { alert("ERRO: Engine não carregado."); return; }
            
            // Verifica se o usuário atualizou o Engine para a versão com negociação
            if (typeof Engine.processarProposta !== 'function') {
                alert("ATENÇÃO: Você precisa atualizar o arquivo 'engine.js' para a versão mais recente (Passo anterior) para que as negociações funcionem!");
            }

            gameState = Engine.carregarJogo();
            if (!gameState) { window.location.href = 'index.html'; return; }

            meuTime = Engine.encontrarTime(gameState, gameState.meuTime);
            
            atualizarHeader();
            popularPaises();
            carregarClubes();
        };

        function atualizarHeader() {
            document.getElementById('header-caixa').innerText = Engine.formatarDinheiro(meuTime.financas.caixa, meuTime.financas.moeda);
        }

        function popularPaises() {
            const sel = document.getElementById('country-select');
            Object.keys(gameState.mundo).forEach(p => {
                const opt = document.createElement('option');
                opt.value = p; opt.innerText = p.toUpperCase();
                if(p === gameState.paisUsuario) opt.selected = true;
                sel.appendChild(opt);
            });
        }

        function mudarModo(modo) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`[onclick="mudarModo('${modo}')"]`).classList.add('active');

            if (modo === 'comprar') {
                document.getElementById('view-clubs').style.display = 'grid';
                document.getElementById('view-squad').classList.remove('active');
                document.getElementById('view-sell').classList.remove('active');
                document.getElementById('country-select').style.display = 'block';
            } else {
                document.getElementById('view-clubs').style.display = 'none';
                document.getElementById('view-squad').classList.remove('active');
                document.getElementById('country-select').style.display = 'none';
                carregarVendas();
                document.getElementById('view-sell').classList.add('active');
            }
        }

        function carregarClubes() {
            const pais = document.getElementById('country-select').value;
            const container = document.getElementById('view-clubs');
            container.innerHTML = '';
            const liga = gameState.mundo[pais];
            
            liga.times.forEach(t => {
                if (t.nome === meuTime.nome) return;
                const card = document.createElement('div');
                card.className = 'club-card';
                card.onclick = () => abrirElencoAdversario(t.nome);
                card.innerHTML = `
                    <img src="${t.escudo}" class="club-logo" onerror="this.src='https://cdn-icons-png.flaticon.com/512/53/53283.png'">
                    <span class="club-name">${t.nome}</span>
                    <span style="font-size:0.8rem; color:#777;">Força: ${t.forca}</span>
                `;
                container.appendChild(card);
            });
        }

        function abrirElencoAdversario(nomeTime) {
            timeAlvo = Engine.encontrarTime(gameState, nomeTime);
            document.getElementById('view-clubs').style.display = 'none';
            document.getElementById('view-squad').classList.add('active');
            document.getElementById('squad-title').innerText = `Elenco: ${timeAlvo.nome}`;

            const container = document.getElementById('squad-container');
            container.innerHTML = '';

            timeAlvo.elenco.forEach(jog => {
                const valor = Engine.calcularValorPasse(jog);
                const div = document.createElement('div');
                div.className = 'player-row';
                // Passamos APENAS O ID aqui para evitar erros de sintaxe com aspas em nomes
                div.innerHTML = `
                    <div class="p-info">
                        <span class="p-pos">${jog.pos}</span>
                        <div>
                            <div style="font-weight:bold;">${jog.nome}</div>
                            <div style="font-size:0.8rem; color:#888;">${jog.idade} anos</div>
                        </div>
                    </div>
                    <div style="text-align:right;">
                        <div class="p-ovr">${jog.forca}</div>
                        <div class="p-val">${Engine.formatarDinheiro(valor, 'R$')}</div>
                    </div>
                    <button class="btn-action btn-buy" onclick="abrirModalCompra('${jog.id}')">OFERTAR</button>
                `;
                container.appendChild(div);
            });
        }

        function voltarParaClubes() {
            document.getElementById('view-squad').classList.remove('active');
            document.getElementById('view-clubs').style.display = 'grid';
        }

        function abrirModalCompra(id) {
            // Busca o jogador dentro do objeto timeAlvo (mais seguro)
            const jog = timeAlvo.elenco.find(j => j.id === id);
            if(!jog) return alert("Erro: Jogador não encontrado.");

            jogadorAlvoId = id;
            const valorEstimado = Engine.calcularValorPasse(jog);
            
            document.getElementById('modal-p-name').innerText = `Proposta por ${jog.nome}`;
            document.getElementById('modal-p-val').innerText = Engine.formatarDinheiro(valorEstimado, 'R$');
            document.getElementById('offer-input').value = valorEstimado;
            document.getElementById('offer-modal').style.display = 'flex';
        }

        function fecharModal() {
            document.getElementById('offer-modal').style.display = 'none';
        }

        function confirmarProposta() {
            const valor = parseFloat(document.getElementById('offer-input').value);
            if (!valor || valor <= 0) { alert("Valor inválido"); return; }

            const resultado = Engine.processarProposta(gameState, timeAlvo.nome, jogadorAlvoId, valor);

            if (resultado.sucesso) {
                alert("✅ " + resultado.msg);
                fecharModal();
                atualizarHeader();
                abrirElencoAdversario(timeAlvo.nome); // Recarrega lista
            } else {
                alert("❌ " + resultado.msg);
            }
        }

        function carregarVendas() {
            const container = document.getElementById('view-sell');
            container.innerHTML = '';
            meuTime.elenco.forEach(jog => {
                const valorVenda = Math.floor(Engine.calcularValorPasse(jog) * 0.85);
                const div = document.createElement('div');
                div.className = 'player-row';
                div.innerHTML = `
                    <div class="p-info">
                        <span class="p-pos">${jog.pos}</span>
                        <div><div>${jog.nome}</div><div style="font-size:0.8rem; color:#aaa;">Salário: ${Engine.formatarDinheiro(jog.salario, 'R$')}</div></div>
                    </div>
                    <div style="text-align:right; margin-right:15px;"><div style="font-size:0.7rem; color:#aaa;">Venda Imediata</div><div class="p-val" style="color:var(--gold);">${Engine.formatarDinheiro(valorVenda, 'R$')}</div></div>
                    <button class="btn-action btn-sell" onclick="vender('${jog.id}')">VENDER</button>
                `;
                container.appendChild(div);
            });
        }

        function vender(id) {
            if(!confirm("Vender este jogador?")) return;
            const res = Engine.venderJogadorUsuario(gameState, id);
            if(res.sucesso) {
                alert("Vendido!");
                atualizarHeader();
                carregarVendas();
            }
        }
    </script>
</body>
</html>
