<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRFutebol - Mercado</title>
    <script src="database_jogadores.js"></script>
    <script src="engine.js"></script>
    <style>
        :root { --bg:#0d1115; --card:#1e272e; --text:#ecf0f1; --gold:#f1c40f; --green:#2ecc71; --red:#ff4757; }
        body { font-family:'Segoe UI',sans-serif; background:var(--bg); color:var(--text); margin:0; display:grid; grid-template-rows:70px 1fr; height:100vh; overflow:hidden; }
        
        header { background:rgba(30,39,46,0.95); border-bottom:2px solid var(--gold); display:flex; align-items:center; justify-content:space-between; padding:0 30px; }
        .btn-back { background:#444; color:#fff; border:none; padding:10px 20px; border-radius:6px; cursor:pointer; font-weight:bold; }
        
        .caixa-display { font-size:1.2rem; font-weight:bold; color:var(--green); background:#111; padding:8px 15px; border-radius:8px; border:1px solid #333; }

        main { padding:30px; max-width:1200px; margin:0 auto; width:100%; box-sizing:border-box; display:flex; flex-direction:column; gap:20px; }

        .tabs { display:flex; gap:10px; border-bottom:1px solid #333; padding-bottom:10px; }
        .tab-btn { background:none; border:none; color:#777; font-size:1.1rem; font-weight:bold; cursor:pointer; padding:10px 20px; transition:0.2s; }
        .tab-btn.active { color:#fff; border-bottom:3px solid var(--gold); }

        .market-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:20px; overflow-y:auto; padding-right:10px; }

        /* CARD JOGADOR */
        .player-card { background:var(--card); border-radius:10px; padding:15px; border:1px solid #333; position:relative; transition:transform 0.2s; }
        .player-card:hover { transform:translateY(-3px); border-color:var(--gold); }
        
        .pc-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
        .pc-pos { background:#333; padding:2px 8px; border-radius:4px; font-size:0.8rem; font-weight:bold; color:#aaa; }
        .pc-ovr { background:var(--gold); color:#000; width:35px; height:35px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:800; }
        
        .pc-name { font-size:1.1rem; font-weight:bold; margin-bottom:2px; }
        .pc-info { font-size:0.85rem; color:#888; margin-bottom:15px; }
        
        .pc-price { font-size:1.3rem; font-weight:800; color:var(--green); margin-bottom:10px; }
        
        .btn-buy { width:100%; background:var(--green); color:#000; border:none; padding:10px; border-radius:6px; font-weight:bold; cursor:pointer; text-transform:uppercase; }
        .btn-buy:hover { background:#27ae60; }
        
        .btn-sell { width:100%; background:var(--red); color:#fff; border:none; padding:10px; border-radius:6px; font-weight:bold; cursor:pointer; text-transform:uppercase; }
        .btn-sell:hover { background:#c0392b; }

        .hidden { display:none; }
    </style>
</head>
<body>

    <header>
        <button class="btn-back" onclick="window.location.href='dashboard.html'">⬅ Voltar</button>
        <h2 style="margin:0;">MERCADO DA BOLA</h2>
        <div class="caixa-display" id="header-caixa">R$ 0</div>
    </header>

    <main>
        <div class="tabs">
            <button class="tab-btn active" onclick="mudarAba('comprar')">Contratar Jogadores</button>
            <button class="tab-btn" onclick="mudarAba('vender')">Vender do Elenco</button>
        </div>

        <div id="aba-comprar" class="market-grid">
            </div>

        <div id="aba-vender" class="market-grid hidden">
            </div>
    </main>

    <script>
        let gameState, meuTime;

        window.onload = function() {
            if (typeof Engine === 'undefined') { alert("Engine Off"); return; }
            gameState = Engine.carregarJogo();
            if (!gameState) { window.location.href = 'index.html'; return; }

            meuTime = Engine.encontrarTime(gameState, gameState.meuTime);
            
            atualizarUI();
        };

        function atualizarUI() {
            document.getElementById('header-caixa').innerText = Engine.formatarDinheiro(meuTime.financas.caixa, meuTime.financas.moeda);
            renderizarMercado();
            renderizarVenda();
        }

        function renderizarMercado() {
            const container = document.getElementById('aba-comprar');
            container.innerHTML = '';

            if (gameState.mercado.length === 0) {
                container.innerHTML = '<p style="color:#777; grid-column:1/-1; text-align:center;">Nenhum jogador disponível no mercado esta semana.</p>';
                return;
            }

            gameState.mercado.forEach(jog => {
                const div = document.createElement('div');
                div.className = 'player-card';
                div.innerHTML = `
                    <div class="pc-header">
                        <span class="pc-pos">${jog.pos}</span>
                        <span class="pc-ovr">${jog.forca}</span>
                    </div>
                    <div class="pc-name">${jog.nome}</div>
                    <div class="pc-info">${jog.idade} anos • ${jog.timeOrigem} (${jog.paisOrigem})</div>
                    <div class="pc-price">${Engine.formatarDinheiro(jog.valorMercado, meuTime.financas.moeda)}</div>
                    <button class="btn-buy" onclick="comprar('${jog.id}')">COMPRAR</button>
                `;
                container.appendChild(div);
            });
        }

        function renderizarVenda() {
            const container = document.getElementById('aba-vender');
            container.innerHTML = '';

            meuTime.elenco.forEach(jog => {
                // Calcula valor de venda (80% do valor de mercado para venda rápida)
                const valorVenda = Math.floor(Engine.calcularValorPasse(jog) * 0.8);

                const div = document.createElement('div');
                div.className = 'player-card';
                div.style.borderColor = '#444'; // Diferenciar visualmente
                div.innerHTML = `
                    <div class="pc-header">
                        <span class="pc-pos">${jog.pos}</span>
                        <span class="pc-ovr" style="background:#444; color:#fff;">${jog.forca}</span>
                    </div>
                    <div class="pc-name">${jog.nome}</div>
                    <div class="pc-info">${jog.idade} anos • Salário: ${Engine.formatarDinheiro(jog.salario, 'R$')}</div>
                    <div class="pc-price" style="color:var(--gold); font-size:1.1rem;">Oferta: ${Engine.formatarDinheiro(valorVenda, meuTime.financas.moeda)}</div>
                    <button class="btn-sell" onclick="vender('${jog.id}')">VENDER AGORA</button>
                `;
                container.appendChild(div);
            });
        }

        function comprar(id) {
            if(!confirm("Confirmar a contratação deste jogador?")) return;
            
            const res = Engine.comprarJogador(gameState, id);
            
            if (res.sucesso) {
                alert(res.msg);
                atualizarUI();
            } else {
                alert("ERRO: " + res.msg);
            }
        }

        function vender(id) {
            if(!confirm("Tem certeza que deseja vender este jogador? A operação é irreversível.")) return;

            const res = Engine.venderJogadorUsuario(gameState, id);
            
            if (res.sucesso) {
                alert(`Vendido! Você recebeu ${Engine.formatarDinheiro(res.valor, 'R$')}.`);
                atualizarUI();
            }
        }

        function mudarAba(aba) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.market-grid').forEach(d => d.classList.add('hidden'));
            
            document.querySelector(`[onclick="mudarAba('${aba}')"]`).classList.add('active');
            document.getElementById(`aba-${aba}`).classList.remove('hidden');
        }
    </script>
</body>
</html>
