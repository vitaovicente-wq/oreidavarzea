<script>
        let gameState, meuTime;
        let escalacaoAtual = {}; 
        let funcoesAtuais = { capitao: null, penalti: null, falta: null, escanteioD: null, escanteioE: null };
        let formacaoAtual = "4-3-3";

        // COORDENADAS HORIZONTAIS
        const layouts = {
            "4-3-3": [
                {id:"slot-1",top:"50%",left:"5%",role:"GOL"},
                {id:"slot-2",top:"15%",left:"25%",role:"LE"},
                {id:"slot-3",top:"35%",left:"20%",role:"ZAG"},
                {id:"slot-4",top:"65%",left:"20%",role:"ZAG"},
                {id:"slot-5",top:"85%",left:"25%",role:"LD"},
                {id:"slot-6",top:"50%",left:"40%",role:"VOL"},
                {id:"slot-7",top:"30%",left:"55%",role:"MEI"},
                {id:"slot-8",top:"70%",left:"55%",role:"MEI"},
                {id:"slot-9",top:"20%",left:"80%",role:"ATA"},
                {id:"slot-10",top:"50%",left:"85%",role:"ATA"},
                {id:"slot-11",top:"80%",left:"80%",role:"ATA"}
            ],
            "4-4-2": [
                {id:"slot-1",top:"50%",left:"5%",role:"GOL"},
                {id:"slot-2",top:"10%",left:"25%",role:"LE"},
                {id:"slot-3",top:"35%",left:"20%",role:"ZAG"},
                {id:"slot-4",top:"65%",left:"20%",role:"ZAG"},
                {id:"slot-5",top:"90%",left:"25%",role:"LD"},
                {id:"slot-6",top:"35%",left:"45%",role:"VOL"},
                {id:"slot-7",top:"65%",left:"45%",role:"VOL"},
                {id:"slot-8",top:"15%",left:"60%",role:"MEI"}, 
                {id:"slot-9",top:"85%",left:"60%",role:"MEI"},
                {id:"slot-10",top:"35%",left:"85%",role:"ATA"},
                {id:"slot-11",top:"65%",left:"85%",role:"ATA"}
            ],
            "3-5-2": [
                {id:"slot-1",top:"50%",left:"5%",role:"GOL"},
                {id:"slot-2",top:"25%",left:"20%",role:"ZAG"},
                {id:"slot-3",top:"50%",left:"18%",role:"ZAG"},
                {id:"slot-4",top:"80%",left:"20%",role:"ZAG"},
                {id:"slot-5",top:"35%",left:"40%",role:"VOL"},
                {id:"slot-6",top:"65%",left:"40%",role:"VOL"},
                {id:"slot-7",top:"10%",left:"50%",role:"MEI"},
                {id:"slot-8",top:"90%",left:"50%",role:"MEI"},
                {id:"slot-9",top:"50%",left:"60%",role:"MEI"},
                {id:"slot-10",top:"35%",left:"85%",role:"ATA"},
                {id:"slot-11",top:"65%",left:"85%",role:"ATA"}
            ],
            "4-2-3-1": [
                {id:"slot-1",top:"50%",left:"5%",role:"GOL"},
                {id:"slot-2",top:"10%",left:"25%",role:"LE"},
                {id:"slot-3",top:"35%",left:"20%",role:"ZAG"},
                {id:"slot-4",top:"65%",left:"20%",role:"ZAG"},
                {id:"slot-5",top:"90%",left:"25%",role:"LD"},
                {id:"slot-6",top:"35%",left:"40%",role:"VOL"},
                {id:"slot-7",top:"65%",left:"40%",role:"VOL"},
                {id:"slot-8",top:"50%",left:"60%",role:"MEI"},
                {id:"slot-9",top:"20%",left:"75%",role:"ATA"},
                {id:"slot-10",top:"50%",left:"85%",role:"ATA"},
                {id:"slot-11",top:"80%",left:"75%",role:"ATA"}
            ],
            "3-4-3": [
                {id:"slot-1",top:"50%",left:"5%",role:"GOL"},
                {id:"slot-2",top:"20%",left:"20%",role:"ZAG"},
                {id:"slot-3",top:"50%",left:"18%",role:"ZAG"},
                {id:"slot-4",top:"80%",left:"20%",role:"ZAG"},
                {id:"slot-5",top:"15%",left:"45%",role:"MEI"},
                {id:"slot-6",top:"40%",left:"45%",role:"VOL"},
                {id:"slot-7",top:"60%",left:"45%",role:"VOL"},
                {id:"slot-8",top:"85%",left:"45%",role:"MEI"},
                {id:"slot-9",top:"20%",left:"80%",role:"ATA"},
                {id:"slot-10",top:"50%",left:"85%",role:"ATA"},
                {id:"slot-11",top:"80%",left:"80%",role:"ATA"}
            ]
        };

        window.onload = function() {
            // 1. CARREGA SAVE
            gameState = Engine.carregarJogo();
            if (!gameState) {
                console.error("Save não encontrado!");
                window.location.href = 'index.html'; 
                return;
            }

            // 2. CARREGA TIME
            meuTime = Engine.encontrarTime(gameState, gameState.meuTime);
            if (!meuTime) {
                console.error("Time não encontrado no save!");
                return;
            }

            console.log("Time carregado:", meuTime.nome);
            console.log("Jogadores:", meuTime.elenco.length);

            // 3. INICIA INTERFACE
            carregarDadosSalvos();
            aplicarLayout(formacaoAtual);
            
            // Renderiza lista (AQUI ESTAVA O PROBLEMA POTENCIAL)
            renderizarLista();
            
            atualizarCampo();
            povoarDropdowns();
        };

        function carregarDadosSalvos() {
            const formSalva = localStorage.getItem('brfutebol_esquema');
            if(formSalva) { 
                formacaoAtual = formSalva; 
                document.getElementById('formation-select').value = formacaoAtual; 
            }
            
            const formacaoJog = localStorage.getItem('brfutebol_formacao');
            if (formacaoJog) { 
                try { escalacaoAtual = JSON.parse(formacaoJog); } catch(e) {} 
            } else { 
                autoEscalar(true); 
            }
            
            const funcSalva = localStorage.getItem('brfutebol_funcoes');
            if (funcSalva) { 
                try { funcoesAtuais = JSON.parse(funcSalva); } catch(e) {} 
            }
        }

        function mudarFormacao() {
            formacaoAtual = document.getElementById('formation-select').value;
            aplicarLayout(formacaoAtual);
            atualizarCampo();
        }

        function aplicarLayout(nome) {
            if(!layouts[nome]) return;
            layouts[nome].forEach(p => {
                const s = document.getElementById(p.id);
                if(s) {
                    s.style.top = p.top; 
                    s.style.left = p.left; 
                    s.dataset.role = p.role;
                }
            });
        }

        function renderizarLista() {
            const container = document.getElementById('roster-list'); // NOME NOVO DO ID
            if (!container) {
                console.error("ERRO: Container 'roster-list' não encontrado no HTML!");
                return;
            }
            
            container.innerHTML = '';
            
            const emCampoIds = Object.values(escalacaoAtual);
            const lista = [...meuTime.elenco].sort((a,b) => b.forca - a.forca);

            lista.forEach(jog => {
                const div = document.createElement('div');
                div.className = 'roster-item';
                div.draggable = true;
                div.id = `card-${jog.id}`;
                
                if (emCampoIds.includes(jog.id)) div.classList.add('in-field');

                const saude = jog.saude !== undefined ? jog.saude : 100;
                let corSaude = '#2ecc71';
                if(saude < 80) corSaude = '#f1c40f';
                if(saude < 60) corSaude = '#e74c3c';

                let corOvr = '#8b9bb4'; // Cinza padrão
                if (jog.forca >= 80) corOvr = '#00ff88'; // Verde Neon
                else if (jog.forca >= 75) corOvr = '#f1c40f'; // Dourado

                div.innerHTML = `
                    <div class="pos-badge">${jog.pos}</div>
                    <div class="player-details">
                        <div class="player-name">${jog.nome}</div>
                        <div class="player-meta">
                            <span class="trait">${jog.carac || '-'}</span>
                            <span style="display:flex; align-items:center; gap:4px; margin-left:auto; color:#ccc; font-size:0.7rem;">
                                ❤️ ${Math.floor(saude)}%
                            </span>
                        </div>
                        <div class="health-line-bg">
                            <div class="health-line-fill" style="width:${saude}%; background:${corSaude}"></div>
                        </div>
                    </div>
                    <div class="player-status">
                        <div class="ovr-badge" style="color:${corOvr}">${jog.forca}</div>
                    </div>
                `;

                div.addEventListener('dragstart', handleDragStart);
                div.addEventListener('dragend', handleDragEnd);
                div.onclick = () => selecionarParaTroca(jog.id);
                
                container.appendChild(div);
            });
        }

        function atualizarCampo() {
            let forcaTotal = 0, count = 0;
            document.querySelectorAll('.field-slot').forEach(slot => {
                const jogId = escalacaoAtual[slot.id];
                const jog = jogId ? meuTime.elenco.find(j => j.id === jogId) : null;

                if (jog) {
                    slot.classList.add('filled');
                    // Kit number e Nome
                    const kitNum = slot.querySelector('.kit-number');
                    if(kitNum) kitNum.innerText = jog.pos; 
                    
                    // Atualiza Label Completo
                    const saude = jog.saude !== undefined ? jog.saude : 100;
                    let corBarra = '#2ecc71';
                    if(saude < 80) corBarra = '#f1c40f';
                    if(saude < 60) corBarra = '#e74c3c';

                    let corOvr = '#fff';
                    if (jog.forca >= 80) corOvr = '#00ff88';
                    else if (jog.forca >= 75) corOvr = '#f1c40f';

                    const label = slot.querySelector('.player-label');
                    if(label) {
                        label.innerHTML = `
                            <span class="label-name">${jog.nome.split(' ')[0]}</span>
                            <div class="label-meta">
                                <span class="label-ovr" style="color:${corOvr}">${jog.forca}</span>
                                <div class="micro-health"><div class="micro-health-fill" style="width:${saude}%; background:${corBarra}"></div></div>
                            </div>
                        `;
                    }

                    // Badge Capitão
                    const selectCapitao = document.getElementById('role-capitao');
                    const idCap = selectCapitao ? selectCapitao.value : funcoesAtuais.capitao;
                    
                    if (jog.id === idCap) slot.classList.add('is-captain');
                    else slot.classList.remove('is-captain');

                    forcaTotal += jog.forca; count++;
                } else {
                    slot.classList.remove('filled');
                    slot.classList.remove('is-captain');
                    
                    // Reset slot vazio
                    const kitNum = slot.querySelector('.kit-number');
                    if(kitNum) kitNum.innerText = slot.dataset.role || "";
                    
                    const label = slot.querySelector('.player-label');
                    if(label) label.innerHTML = `<span class="label-name" style="color:#666;">Vazio</span>`;
                }
            });
            
            const media = count > 0 ? Math.floor(forcaTotal / count) : 0;
            const elStr = document.getElementById('team-str');
            if(elStr) elStr.innerText = count === 11 ? media : `${media}`;
        }

        function povoarDropdowns() {
            const titularesIds = Object.values(escalacaoAtual);
            const titulares = meuTime.elenco.filter(j => titularesIds.includes(j.id));
            titulares.sort((a,b) => b.forca - a.forca);

            ['capitao', 'penalti', 'falta', 'escanteioD', 'escanteioE'].forEach(tipo => {
                const el = document.getElementById(`role-${tipo}`);
                if(!el) return;

                const valorAtual = el.value || funcoesAtuais[tipo];
                el.innerHTML = '<option value="">-- Escolher --</option>';
                
                titulares.forEach(jog => {
                    const opt = document.createElement('option');
                    opt.value = jog.id;
                    opt.innerText = `[${jog.pos}] ${jog.nome} (${jog.forca})`;
                    if (jog.id === valorAtual) opt.selected = true;
                    el.appendChild(opt);
                });
                
                if (valorAtual && !titularesIds.includes(valorAtual)) el.value = "";
            });
            atualizarIconesFuncao();
        }

        function atualizarIconesFuncao() {
            const el = document.getElementById('role-capitao');
            if(!el) return;
            const idCapitao = el.value;
            
            document.querySelectorAll('.field-slot').forEach(slot => {
                const jogId = escalacaoAtual[slot.id];
                if (jogId && jogId === idCapitao) slot.classList.add('is-captain');
                else slot.classList.remove('is-captain');
            });
        }

        // --- DRAG & DROP ---
        function handleDragStart(e) { 
            this.classList.add('dragging'); 
            e.dataTransfer.setData('text/plain', this.id.replace('card-', '')); 
        }
        function handleDragEnd(e) { this.classList.remove('dragging'); }
        
        document.querySelectorAll('.field-slot').forEach(slot => {
            slot.addEventListener('dragover', e => { e.preventDefault(); slot.style.transform = 'translate(-50%, -50%) scale(1.1)'; });
            slot.addEventListener('dragleave', e => { slot.style.transform = 'translate(-50%, -50%) scale(1)'; });
            slot.addEventListener('drop', handleDrop);
            slot.onclick = () => removerJogador(slot.id);
        });

        function handleDrop(e) {
            e.preventDefault();
            this.style.transform = 'translate(-50%, -50%) scale(1)';
            const jogId = e.dataTransfer.getData('text/plain');
            
            // Remove de onde estava
            Object.keys(escalacaoAtual).forEach(k => { if(escalacaoAtual[k]===jogId) delete escalacaoAtual[k]; });
            
            escalacaoAtual[this.id] = jogId;
            renderizarLista(); atualizarCampo(); povoarDropdowns();
        }

        function removerJogador(slotId) {
            if (escalacaoAtual[slotId]) { 
                delete escalacaoAtual[slotId]; 
                renderizarLista(); atualizarCampo(); povoarDropdowns(); 
            }
        }

        // --- MOBILE ---
        let selectedId = null;
        function selecionarParaTroca(id) {
            if (selectedId === id) { selectedId = null; renderizarLista(); return; }
            selectedId = id;
            
            // Feedback Visual na Lista
            document.querySelectorAll('.roster-item').forEach(c => c.style.background = 'transparent');
            const card = document.getElementById(`card-${id}`);
            if(card) card.style.background = 'rgba(0, 255, 136, 0.15)';
            
            // Ativa slots para clique
            document.querySelectorAll('.field-slot').forEach(slot => {
                slot.onclick = function() {
                    if (selectedId) {
                        Object.keys(escalacaoAtual).forEach(k => { if(escalacaoAtual[k]===selectedId) delete escalacaoAtual[k]; });
                        escalacaoAtual[this.id] = selectedId;
                        selectedId = null; 
                        renderizarLista(); atualizarCampo(); povoarDropdowns();
                        // Volta ao comportamento padrão (remover)
                        document.querySelectorAll('.field-slot').forEach(s => s.onclick = () => removerJogador(s.id));
                    } else { 
                        removerJogador(this.id); 
                    }
                }
            });
        }

        function autoEscalar(silencioso = false) {
            if(!silencioso && !confirm("Auto-escalar com melhores jogadores saudáveis?")) return;
            escalacaoAtual = {};
            const usados = [];
            const layout = layouts[formacaoAtual];
            
            layout.forEach(posData => {
                let melhor = meuTime.elenco.find(j => j.pos === posData.role && !usados.includes(j.id) && (j.saude === undefined || j.saude > 50));
                
                if(!melhor) {
                    if(posData.role === 'ATA') melhor = meuTime.elenco.find(j => (j.pos==='MEI'||j.pos==='ST') && !usados.includes(j.id));
                    if(posData.role === 'MEI') melhor = meuTime.elenco.find(j => (j.pos==='VOL'||j.pos==='ATA') && !usados.includes(j.id));
                    if(posData.role === 'VOL') melhor = meuTime.elenco.find(j => (j.pos==='MEI'||j.pos==='ZAG') && !usados.includes(j.id));
                    if(posData.role === 'LE' || posData.role === 'LD') melhor = meuTime.elenco.find(j => j.pos==='ZAG' && !usados.includes(j.id));
                }
                if(!melhor && posData.role !== 'GOL') melhor = meuTime.elenco.find(j => j.pos!=='GOL' && !usados.includes(j.id) && j.saude > 40);

                if(melhor) { escalacaoAtual[posData.id] = melhor.id; usados.push(melhor.id); }
            });

            renderizarLista(); atualizarCampo(); povoarDropdowns();
            const elCap = document.getElementById('role-capitao');
            if(elCap && !elCap.value && usados.length > 0) elCap.value = usados[0];
        }

        function salvarTudo() {
            const titulares = Object.keys(escalacaoAtual).length;
            if (titulares < 11) alert("Atenção: Time incompleto!");
            
            localStorage.setItem('brfutebol_formacao', JSON.stringify(escalacaoAtual));
            localStorage.setItem('brfutebol_esquema', formacaoAtual);
            
            const funcoes = {
                capitao: document.getElementById('role-capitao').value,
                penalti: document.getElementById('role-penalti').value,
                falta: document.getElementById('role-falta').value,
                escanteioD: document.getElementById('role-escanteioD').value,
                escanteioE: document.getElementById('role-escanteioE').value
            };
            localStorage.setItem('brfutebol_funcoes', JSON.stringify(funcoes));
            
            const btn = document.querySelector('.save-btn');
            btn.innerHTML = "SALVO! ✓";
            btn.style.background = "#fff";
            btn.style.color = "#000";
            setTimeout(() => { 
                btn.innerHTML = "SALVAR TÁTICA"; 
                btn.style.background = "var(--accent)"; 
                window.location.href='dashboard.html'; 
            }, 800);
        }
    </script>
</body>
</html>
