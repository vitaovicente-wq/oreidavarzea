<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRFutebol - Prancheta T√°tica</title>
    
    <script src="database_jogadores.js"></script>
    <script src="engine.js"></script>

    <style>
        :root {
            --primary: #1e272e;
            --secondary: #0fb9b1;
            --bg: #0d1115;
            --card-bg: #2d3436;
            --text: #ecf0f1;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            display: grid;
            grid-template-rows: 70px 1fr;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        /* HEADER */
        header {
            background-color: rgba(30, 39, 46, 0.95);
            border-bottom: 2px solid var(--secondary);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            z-index: 100;
        }

        .header-controls { display: flex; align-items: center; gap: 20px; }

        select {
            background: #1e272e; color: white; border: 1px solid #555;
            padding: 8px 15px; border-radius: 6px; font-size: 1rem; cursor: pointer;
        }

        .action-btn { padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; border: none; transition: 0.2s; }
        .btn-back { background: #444; color: #fff; }
        .btn-save { background: var(--secondary); color: #1e272e; text-transform: uppercase; }
        .btn-save:hover { box-shadow: 0 0 15px rgba(15, 185, 177, 0.4); }

        /* LAYOUT */
        main {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px; padding: 20px; height: 100%; box-sizing: border-box;
        }

        /* CAMPO */
        .field-container {
            background: linear-gradient(180deg, #27ae60 0%, #2ecc71 100%);
            border: 4px solid #fff; border-radius: 12px;
            position: relative; box-shadow: inset 0 0 80px rgba(0,0,0,0.5);
            margin: 0 auto; width: 100%; max-width: 700px; height: 100%; overflow: hidden;
        }

        .line { position: absolute; background: rgba(255,255,255,0.4); pointer-events: none; }
        .mid-line { width: 100%; height: 2px; top: 50%; }
        .circle { width: 100px; height: 100px; border: 2px solid rgba(255,255,255,0.4); border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .area-top { width: 40%; height: 16%; border: 2px solid rgba(255,255,255,0.4); border-top: none; top: 0; left: 30%; }
        .area-bottom { width: 40%; height: 16%; border: 2px solid rgba(255,255,255,0.4); border-bottom: none; bottom: 0; left: 30%; }

        /* JOGADOR NO CAMPO (TOKEN) */
        .player-token {
            position: absolute; width: 50px; height: 50px;
            background: #fff; border: 3px solid #333; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: 800; color: #333; font-size: 0.85rem;
            cursor: grab; box-shadow: 0 5px 15px rgba(0,0,0,0.4);
            transform: translate(-50%, -50%); z-index: 10;
            transition: all 0.2s;
        }

        /* Estado quando um reserva est√° sendo arrastado por cima */
        .player-token.drag-hover {
            transform: translate(-50%, -50%) scale(1.2);
            border-color: #f1c40f;
            background-color: #f1c40f;
            color: #1e272e;
            box-shadow: 0 0 20px #f1c40f;
        }

        /* Estado de ajuste de posi√ß√£o (mousedown) */
        .player-token:active { cursor: grabbing; transform: translate(-50%, -50%) scale(1.1); z-index: 20; }

        .player-label {
            position: absolute; top: 52px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white; padding: 3px 8px;
            border-radius: 4px; font-size: 0.75rem; white-space: nowrap; pointer-events: none;
            display: flex; flex-direction: column; align-items: center; gap: 2px;
        }
        .player-label span { font-size: 0.65rem; color: #bdc3c7; }

        /* SIDEBAR (RESERVAS) */
        .sidebar {
            background: var(--card-bg); border-radius: 12px;
            display: flex; flex-direction: column; overflow: hidden; border: 1px solid #444;
        }

        .sidebar h3 {
            margin: 0; padding: 15px; background: rgba(0,0,0,0.2);
            font-size: 0.9rem; text-transform: uppercase; border-bottom: 1px solid #444;
            color: var(--text-muted); display: flex; justify-content: space-between;
        }

        .player-list { overflow-y: auto; flex-grow: 1; }

        .list-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 15px; border-bottom: 1px solid #333; font-size: 0.9rem;
            cursor: grab; background: #2d3436; transition: 0.2s;
        }
        .list-item:hover { background: rgba(255,255,255,0.05); }
        .list-item:active { cursor: grabbing; opacity: 0.6; }

        .pos-badge { font-weight: bold; width: 35px; color: #888; font-size: 0.8rem; text-align: center; }
        .name-area { display: flex; flex-direction: column; }
        .trait-mini { font-size: 0.65rem; color: #aaa; }
        .ovr-badge { font-weight: bold; color: var(--secondary); font-size: 1.1rem; }

    </style>
</head>
<body>

    <header>
        <div class="header-controls">
            <button class="action-btn btn-back" onclick="voltar()">‚¨Ö Voltar</button>
            <h1 style="margin:0; font-size:1.2rem; text-transform:uppercase;">Prancheta</h1>
        </div>

        <div class="header-controls">
            <label style="font-size:0.9rem; color:#aaa;">Forma√ß√£o:</label>
            <select id="formationSelect" onchange="aplicarFormacaoAutomatica()">
                <option value="4-4-2">4-4-2 Cl√°ssico</option>
                <option value="4-3-3">4-3-3 Ofensivo</option>
                <option value="3-5-2">3-5-2 Equilibrado</option>
                <option value="3-4-3">3-4-3 Press√£o</option>
                <option value="5-4-1">5-4-1 Retranca</option>
            </select>
            <button class="action-btn btn-save" onclick="salvarTime()">üíæ Salvar Time</button>
        </div>
    </header>

    <main>
        <div class="field-container" id="campo">
            <div class="line mid-line"></div>
            <div class="line circle"></div>
            <div class="line area-top"></div>
            <div class="line area-bottom"></div>
            
            </div>

        <div class="sidebar">
            <h3><span>Banco de Reservas</span> <small style="font-size:0.7rem">Arraste para o campo</small></h3>
            <div class="player-list" id="listaReservas">
                </div>
        </div>
    </main>

    <script>
        // --- COORDENADAS DAS FORMA√á√ïES ---
        const formations = {
            "4-4-2": [
                {x:50,y:90,p:'GOL'}, 
                {x:15,y:75,p:'LE'}, {x:38,y:80,p:'ZAG'}, {x:62,y:80,p:'ZAG'}, {x:85,y:75,p:'LD'}, 
                {x:15,y:45,p:'ME'}, {x:38,y:55,p:'VOL'}, {x:62,y:55,p:'VOL'}, {x:85,y:45,p:'MD'}, 
                {x:35,y:15,p:'ATA'}, {x:65,y:15,p:'ATA'}
            ],
            "4-3-3": [
                {x:50,y:90,p:'GOL'},
                {x:15,y:75,p:'LE'}, {x:38,y:80,p:'ZAG'}, {x:62,y:80,p:'ZAG'}, {x:85,y:75,p:'LD'},
                {x:50,y:60,p:'VOL'}, {x:30,y:45,p:'MC'}, {x:70,y:45, p:'MC'},
                {x:15,y:20,p:'PE'}, {x:50,y:15,p:'ATA'}, {x:85,y:20,p:'PD'}
            ],
            "3-5-2": [
                {x:50,y:90,p:'GOL'},
                {x:25,y:80,p:'ZAG'}, {x:50,y:82,p:'ZAG'}, {x:75,y:80,p:'ZAG'},
                {x:10,y:50,p:'AE'}, {x:35,y:60,p:'VOL'}, {x:65,y:60,p:'VOL'}, {x:90,y:50,p:'AD'}, {x:50,y:40,p:'MAT'},
                {x:35,y:15,p:'ATA'}, {x:65,y:15,p:'ATA'}
            ],
            "3-4-3": [
                {x:50,y:90,p:'GOL'},
                {x:20,y:80,p:'ZAG'}, {x:50,y:82,p:'ZAG'}, {x:80,y:80,p:'ZAG'},
                {x:10,y:50,p:'ME'}, {x:40,y:55,p:'MC'}, {x:60,y:55,p:'MC'}, {x:90,y:50,p:'MD'},
                {x:20,y:20,p:'PE'}, {x:50,y:15,p:'ATA'}, {x:80,y:20,p:'PD'}
            ],
            "5-4-1": [
                {x:50,y:90,p:'GOL'},
                {x:10,y:70,p:'LE'}, {x:30,y:80,p:'ZAG'}, {x:50,y:82,p:'LIB'}, {x:70,y:80,p:'ZAG'}, {x:90,y:70,p:'LD'},
                {x:20,y:50,p:'ME'}, {x:40,y:55,p:'VOL'}, {x:60,y:55,p:'VOL'}, {x:80,y:50,p:'MD'},
                {x:50,y:15,p:'ATA'}
            ]
        };

        // --- ESTADO LOCAL ---
        let gameState = null;
        let myTeamObj = null;
        let titulares = []; // Array com 11 jogadores
        let reservas = [];  // Array com o resto
        let draggedPosElement = null; // Para ajuste de posi√ß√£o (Campo -> Campo)

        // --- INICIALIZA√á√ÉO ---
        window.onload = function() {
            if (typeof Engine === 'undefined') { alert("Engine n√£o carregada"); return; }
            gameState = Engine.carregarJogo();
            if (!gameState) { window.location.href = 'index.html'; return; }

            myTeamObj = gameState.times.find(t => t.nome === gameState.meuTime) || gameState.timesContinental.find(t => t.nome === gameState.meuTime);

            // SEPARA TITULARES E RESERVAS
            // Se j√° salvamos antes, o elenco j√° est√° ordenado (Titulares nos primeiros 11 √≠ndices)
            // Se for a primeira vez, o engine j√° gera ordenado por for√ßa tamb√©m.
            // Ent√£o podemos confiar na ordem do array do elenco.
            titulares = myTeamObj.elenco.slice(0, 11);
            reservas = myTeamObj.elenco.slice(11);

            // Inicializa posi√ß√µes padr√£o se n√£o tiverem sido salvas
            if(!titulares[0].x) {
                aplicarCoordenadasPadrao("4-4-2"); // Default inicial
            }

            renderizarCampo();
            renderizarBanco();
        };

        // --- FUN√á√ïES PRINCIPAIS DE RENDERIZA√á√ÉO ---

        function renderizarCampo() {
            const field = document.getElementById('campo');
            // Remove apenas os players, mant√©m as linhas
            const dots = document.querySelectorAll('.player-token');
            dots.forEach(d => d.remove());

            titulares.forEach((jog, index) => {
                const div = document.createElement('div');
                div.className = 'player-token';
                div.style.left = jog.x + '%';
                div.style.top = jog.y + '%';
                
                if (jog.pos === 'GOL') div.style.background = "#f1c40f";

                div.innerHTML = `
                    ${jog.role || jog.pos.substring(0,2)} 
                    <div class="player-label">
                        <b>${jog.nome.split(' ')[0]}</b>
                        <span>${jog.forca} | ${jog.carac}</span>
                    </div>
                `;

                // EVENTOS MOUSE (Ajuste fino de posi√ß√£o)
                div.onmousedown = (e) => startPosDrag(e, div, index);

                // EVENTOS DRAG & DROP (Receber substitui√ß√£o)
                // Permitir que soltem coisas aqui
                div.ondragover = (e) => {
                    e.preventDefault(); // Necess√°rio para permitir o drop
                    div.classList.add('drag-hover');
                };
                
                div.ondragleave = (e) => {
                    div.classList.remove('drag-hover');
                };

                div.ondrop = (e) => {
                    e.preventDefault();
                    div.classList.remove('drag-hover');
                    const indexReserva = e.dataTransfer.getData("text/plain");
                    if (indexReserva !== "") {
                        realizarSubstituicao(index, parseInt(indexReserva));
                    }
                };

                field.appendChild(div);
            });
        }

        function renderizarBanco() {
            const list = document.getElementById('listaReservas');
            list.innerHTML = '';

            // Ordena reservas por for√ßa
            reservas.sort((a,b) => b.forca - a.forca);

            reservas.forEach((jog, idx) => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.draggable = true; // Permite arrastar

                div.innerHTML = `
                    <div style="display:flex; gap:10px; align-items:center;">
                        <span class="pos-badge">${jog.pos}</span>
                        <div class="name-area">
                            <span>${jog.nome}</span>
                            <span class="trait-mini">${jog.carac}</span>
                        </div>
                    </div>
                    <span class="ovr-badge">${jog.forca}</span>
                `;

                // EVENTO DE IN√çCIO DO ARRASTO
                div.ondragstart = (e) => {
                    // Guarda o √≠ndice do reserva que est√° sendo arrastado
                    e.dataTransfer.setData("text/plain", idx);
                    e.dataTransfer.effectAllowed = "move";
                };

                list.appendChild(div);
            });
        }

        // --- L√ìGICA DE SUBSTITUI√á√ÉO ---

        function realizarSubstituicao(indexTitular, indexReserva) {
            const titularSaindo = titulares[indexTitular];
            const reservaSaindo = reservas[indexReserva];

            // Troca de lugares nos arrays
            titulares[indexTitular] = reservaSaindo;
            reservas[indexReserva] = titularSaindo;

            // Transfere as coordenadas e a fun√ß√£o t√°tica (role) para o novo titular
            // Assim ele cai exatamente onde o outro estava
            titulares[indexTitular].x = titularSaindo.x;
            titulares[indexTitular].y = titularSaindo.y;
            titulares[indexTitular].role = titularSaindo.role;

            // Re-renderiza tudo
            renderizarCampo();
            renderizarBanco();
        }

        // --- L√ìGICA DE FORMA√á√ÉO AUTOM√ÅTICA ---

        function aplicarFormacaoAutomatica() {
            const formacao = document.getElementById('formationSelect').value;
            aplicarCoordenadasPadrao(formacao);
            renderizarCampo();
        }

        function aplicarCoordenadasPadrao(nomeFormacao) {
            const coords = formations[nomeFormacao];
            
            // Aplica as posi√ß√µes para os 11 titulares atuais
            titulares.forEach((jog, idx) => {
                if (coords[idx]) {
                    jog.x = coords[idx].x;
                    jog.y = coords[idx].y;
                    jog.role = coords[idx].p; // Salva a fun√ß√£o (ex: VOL, MAT)
                }
            });
        }

        // --- SISTEMA DE ARRASTAR POSI√á√ÉO (AJUSTE FINO NO CAMPO) ---
        // Mantido do c√≥digo anterior para permitir mover os bonecos no campo

        function startPosDrag(e, divElement, index) {
            e.preventDefault(); // Impede conflito com o drag&drop nativo
            
            draggedPosElement = divElement;
            const field = document.getElementById('campo');
            const rect = field.getBoundingClientRect();

            function elementDrag(e) {
                e.preventDefault();
                // Calcula nova posi√ß√£o %
                let newX = ((e.clientX - rect.left) / rect.width) * 100;
                let newY = ((e.clientY - rect.top) / rect.height) * 100;

                // Limites
                if (newX < 0) newX = 0; if (newX > 100) newX = 100;
                if (newY < 0) newY = 0; if (newY > 100) newY = 100;

                // Atualiza visual
                draggedPosElement.style.left = newX + "%";
                draggedPosElement.style.top = newY + "%";

                // Atualiza dados do jogador em tempo real
                titulares[index].x = newX;
                titulares[index].y = newY;
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
                draggedPosElement = null;
            }

            document.onmouseup = closeDragElement;
            document.onmousemove = elementDrag;
        }

        // --- SALVAR E SAIR ---

        function salvarTime() {
            // Reconstr√≥i o array 'elenco' com a nova ordem:
            // 11 Titulares + Reservas
            const novoElenco = [...titulares, ...reservas];
            
            // Atualiza no objeto do time local
            myTeamObj.elenco = novoElenco;

            // Salva no Engine
            Engine.salvarJogo(gameState);
            
            alert("Escala√ß√£o definida!");
            voltar();
        }

        function voltar() {
            window.location.href = 'dashboard.html';
        }

    </script>
</body>
</html>
