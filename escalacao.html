<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRFutebol - T√°tica Pro</title>
    
    <script src="database_jogadores.js"></script>
    <script src="engine.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700;800&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-dark: #0f1216;
            --bg-panel: rgba(30, 35, 45, 0.98);
            --accent: #00ff88;
            --text-main: #ffffff;
            --text-dim: #8b9bb4;
            --border: 1px solid rgba(255, 255, 255, 0.1);
            --gold: #f1c40f;
            --red: #e74c3c;
            --blue: #3498db;
            --pos-ok: #2ecc71;
            --pos-med: #f1c40f;
            --pos-bad: #e74c3c;
        }

        * { box-sizing: border-box; user-select: none; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at 50% 50%, #1a202c 0%, #0f1216 100%);
            color: var(--text-main);
            margin: 0;
            height: 100vh;
            display: flex; flex-direction: column;
            overflow: hidden;
        }

        /* HEADER */
        header {
            height: 50px; flex-shrink: 0;
            background: rgba(15, 18, 22, 0.98);
            border-bottom: var(--border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; z-index: 100;
        }

        .back-btn {
            background: rgba(255,255,255,0.05); border: var(--border); color: var(--text-dim);
            padding: 6px 15px; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 0.8rem;
            transition: 0.2s; display: flex; align-items: center; gap: 5px;
        }
        .back-btn:hover { background: rgba(255,255,255,0.1); color: #fff; border-color: #fff; }

        .center-controls { display: flex; gap: 20px; align-items: center; }
        .formation-select {
            background: #000; color: var(--accent); border: 1px solid var(--accent);
            padding: 5px 15px; border-radius: 4px; font-family: 'Rajdhani', sans-serif;
            font-weight: 700; font-size: 0.9rem; cursor: pointer; outline: none; text-transform: uppercase;
        }
        .team-rating { font-family: 'Rajdhani'; font-weight: 700; font-size: 1.1rem; color: #fff; }
        
        .save-btn {
            background: var(--accent); color: #000; border: none; padding: 6px 25px;
            border-radius: 4px; font-weight: 800; text-transform: uppercase; cursor: pointer;
            font-size: 0.8rem; letter-spacing: 1px; transition: 0.2s;
        }
        .save-btn:hover { transform: scale(1.05); background: #fff; }

        /* WORKSPACE */
        .workspace {
            display: grid;
            grid-template-columns: 280px 1fr 280px; 
            height: calc(100vh - 50px);
            width: 100%;
            overflow: hidden;
        }

        .panel {
            background: var(--bg-panel);
            border-right: var(--border);
            display: flex; flex-direction: column; overflow: hidden; height: 100%;
        }
        .panel-right { border-right: none; border-left: var(--border); }

        .panel-header {
            padding: 10px 15px; border-bottom: var(--border); background: rgba(0,0,0,0.2);
            font-family: 'Rajdhani', sans-serif; font-weight: 700; text-transform: uppercase;
            color: var(--text-dim); display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem;
            flex-shrink: 0;
        }

        .btn-auto {
            background: rgba(255,255,255,0.1); border: none; color: #fff;
            padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; cursor: pointer;
        }
        .btn-auto:hover { background: var(--accent); color: #000; }

        .scroll-content { flex: 1; overflow-y: auto; padding: 10px; padding-bottom: 50px; }
        .scroll-content::-webkit-scrollbar { width: 5px; }
        .scroll-content::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }

        /* LISTA JOGADORES */
        .roster-item {
            display: flex; align-items: center;
            background: linear-gradient(90deg, rgba(255,255,255,0.03) 0%, transparent 100%);
            border-bottom: 1px solid rgba(255,255,255,0.05);
            padding: 8px; cursor: grab; margin-bottom: 4px; border-radius: 4px;
        }
        .roster-item:hover { background: rgba(255,255,255,0.08); border-left: 2px solid var(--accent); }
        
        .pos-badge {
            width: 26px; height: 26px; background: #222; border: 1px solid #444; color: #aaa;
            border-radius: 4px; font-size: 0.7rem; font-weight: 800;
            display: flex; align-items: center; justify-content: center; margin-right: 10px; flex-shrink: 0;
        }
        .player-info { flex: 1; min-width: 0; }
        .player-name { font-weight: 600; font-size: 0.85rem; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .health-bar-container { height: 3px; background: #111; width: 100%; margin-top: 3px; border-radius: 2px; }
        .health-bar-fill { height: 100%; border-radius: 2px; }
        .ovr-badge { font-family: 'Rajdhani'; font-weight: 800; font-size: 1.1rem; color: var(--gold); margin-left: 10px; }

        /* √ÅREA CENTRAL */
        .field-area {
            background: #0a0a0a;
            position: relative;
            display: flex; flex-direction: column; 
            align-items: center; 
            justify-content: space-between;
            padding: 20px 10px; 
            gap: 10px; 
            overflow: hidden;
        }

        /* CAMPO HORIZONTAL */
        .pitch {
            width: 95%; flex-grow: 1; max-height: 75%; aspect-ratio: 1.6;
            background-color: #2e7d32;
            background-image: repeating-linear-gradient(to right, #2e7d32, #2e7d32 10%, #368e3c 10%, #368e3c 20%);
            border: 3px solid rgba(255,255,255,0.8);
            position: relative; box-shadow: 0 10px 40px rgba(0,0,0,0.6); border-radius: 4px; overflow: hidden;
            transition: all 0.5s ease;
        }
        
        .pitch * { pointer-events: none; }
        .pitch-line { position: absolute; border: 2px solid rgba(255,255,255,0.6); }
        .half-line { top: 0; left: 50%; height: 100%; width: 2px; background: rgba(255,255,255,0.6); border: none; transform: translateX(-50%); }
        .center-circle { top: 50%; left: 50%; width: 120px; height: 120px; border-radius: 50%; transform: translate(-50%, -50%); }
        .center-spot { top: 50%; left: 50%; width: 8px; height: 8px; background: rgba(255,255,255,0.9); border-radius: 50%; transform: translate(-50%, -50%); }
        
        .penalty-area { width: 16%; height: 50%; top: 25%; }
        .penalty-area.left { left: -2px; border-left: none; }
        .penalty-area.right { right: -2px; border-right: none; }
        
        .goal-area { width: 6%; height: 22%; top: 39%; }
        .goal-area.left { left: -2px; border-left: none; }
        .goal-area.right { right: -2px; border-right: none; }
        
        .penalty-spot { width: 6px; height: 6px; background: rgba(255,255,255,0.9); border-radius: 50%; top: 50%; transform: translateY(-50%); }
        .penalty-spot.left { left: 11%; }
        .penalty-spot.right { right: 11%; }

        .corner { width: 25px; height: 25px; border: 2px solid rgba(255,255,255,0.6); border-radius: 50%; position: absolute; }
        .corner-tl { top: -12px; left: -12px; }
        .corner-tr { top: -12px; right: -12px; }
        .corner-bl { bottom: -12px; left: -12px; }
        .corner-br { bottom: -12px; right: -12px; }

        /* BANCO DE RESERVAS */
        .bench-container {
            width: 95%; height: 120px; flex-shrink: 0;
            display: flex; flex-direction: column;
        }
        .bench-title { font-size: 0.75rem; color: #888; font-weight: 800; letter-spacing: 1px; margin-bottom: 5px; margin-left: 5px; }
        .bench-box {
            flex: 1; background: rgba(255,255,255,0.03);
            border: 1px dashed rgba(255,255,255,0.1); border-radius: 8px;
            display: flex; align-items: center; justify-content: space-around; padding: 5px;
        }

        /* SLOTS E KITS */
        .field-slot {
            position: absolute; width: 70px; height: 70px;
            transform: translate(-50%, -50%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; z-index: 10; pointer-events: auto !important;
            transition: top 0.4s, left 0.4s;
        }
        .bench-slot {
            position: relative; width: 60px; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer;
        }

        .player-kit {
            width: 40px; height: 40px; background: #222;
            border: 2px dashed rgba(255,255,255,0.2); border-radius: 50%;
            color: #555; display: flex; align-items: center; justify-content: center;
            font-weight: 800; font-size: 0.75rem; position: relative;
            transition: 0.2s; box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .filled .player-kit { background: #1e2329; border: 2px solid var(--accent); color: #fff; transform: scale(1.15); box-shadow: 0 0 15px rgba(0,255,136,0.3); }
        .filled.pos-medium .player-kit { border-color: var(--pos-med); }
        .filled.pos-wrong .player-kit { border-color: var(--pos-bad); }

        .kit-number { font-family: 'Rajdhani'; font-size: 1rem; }
        .kit-score {
            position: absolute; top: -5px; right: -5px; width: 18px; height: 18px;
            background: var(--gold); color: #000; border-radius: 50%; border: 2px solid #1e2329;
            font-size: 0.7rem; font-weight: 900; display: none; align-items: center; justify-content: center; z-index: 2;
        }
        .filled .kit-score { display: flex; }

        .slot-info-box {
            margin-top: 5px; background: rgba(0,0,0,0.85); backdrop-filter: blur(4px);
            padding: 2px 6px; border-radius: 3px; border: 1px solid rgba(255,255,255,0.1);
            text-align: center; min-width: 65px;
        }
        .bench-slot .slot-info-box { font-size: 0.65rem; min-width: 50px; padding: 1px 4px; }
        .slot-name { display: block; font-size: 0.7rem; color: #fff; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 65px; }
        .slot-pos-mini { font-size: 0.6rem; color: #aaa; text-transform: uppercase; }
        
        .captain-c {
            position: absolute; top: -5px; left: -5px; background: #fff; color: #000;
            width: 16px; height: 16px; font-size: 0.65rem; font-weight: 900;
            border-radius: 50%; border: 1px solid #000; display: none; align-items: center; justify-content: center; z-index: 2;
        }
        .is-captain .captain-c { display: flex; }

        /* PAINEL DIREITO */
        .tabs { display: flex; border-bottom: var(--border); }
        .tab-btn { flex: 1; background: transparent; border: none; color: var(--text-dim); padding: 10px; font-family: 'Rajdhani'; font-weight: 700; cursor: pointer; border-bottom: 2px solid transparent; transition: 0.2s; }
        .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); background: rgba(0,255,136,0.05); }
        .tab-content { display: none; padding: 10px; height: 100%; overflow-y: auto; }
        .tab-content.active { display: block; }

        .role-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); padding: 10px; margin-bottom: 10px; border-radius: 6px; }
        .role-label { font-size: 0.7rem; color: var(--text-dim); text-transform: uppercase; font-weight: 700; display: block; margin-bottom: 5px; }
        .role-select { width: 100%; background: #111; border: 1px solid #333; color: #fff; padding: 8px; border-radius: 4px; font-size: 0.85rem; outline: none; }
        input[type=range] { width: 100%; -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 14px; width: 14px; border-radius: 50%; background: var(--accent); cursor: pointer; margin-top: -5px; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #333; border-radius: 2px; }
        .range-labels { display: flex; justify-content: space-between; font-size: 0.7rem; color: #666; margin-top: 5px; }
        .tactic-value { float: right; color: #fff; font-weight: bold; }

        /* TOOLTIP FIFA */
        #fifa-tooltip {
            position: fixed; display: none; width: 200px;
            background: rgba(18, 20, 24, 0.95); border: 1px solid #444; border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8); z-index: 2000; pointer-events: none;
            padding: 12px; backdrop-filter: blur(10px);
        }
        .fifa-header { display: flex; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px; margin-bottom: 8px; }
        .fifa-ovr { font-family: 'Rajdhani'; font-size: 2rem; font-weight: 900; color: var(--gold); margin-right: 12px; line-height: 1; }
        .fifa-info { display: flex; flex-direction: column; }
        .fifa-name { font-weight: 800; font-size: 0.9rem; color: #fff; }
        .fifa-pos { font-size: 0.75rem; color: var(--accent); font-weight: 700; }
        .fifa-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; row-gap: 4px; }
        .fifa-stat { font-family: 'Rajdhani'; font-size: 0.85rem; display: flex; justify-content: space-between; }
        .fifa-stat span { color: #888; font-weight: 600; margin-right: 5px; }
        .fifa-stat b { color: #fff; }
        .fifa-stat b.high { color: var(--pos-ok); }
        .fifa-stat b.mid { color: var(--pos-med); }
        .fifa-stat b.low { color: var(--pos-bad); }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-card { background: #161b22; border: 1px solid #444; border-radius: 12px; width: 350px; padding: 25px; box-shadow: 0 0 50px rgba(0,255,136,0.1); }
        .modal-header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 15px; }
        .modal-kit { width: 60px; height: 60px; background: #222; border: 2px solid var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 1.5rem; color: #fff; }
        .modal-header h2 { margin: 0; font-size: 1.2rem; color: #fff; text-transform: uppercase; font-family: 'Rajdhani'; }
        .modal-ovr { font-family: 'Rajdhani'; font-size: 2.2rem; color: var(--gold); margin-left: auto; font-weight: 900; }
        .chart-container { position: relative; height: 250px; width: 100%; }
        .btn-close { width: 100%; background: #333; color: #fff; border: none; padding: 10px; margin-top: 15px; border-radius: 6px; cursor: pointer; font-weight: 700; }
        .btn-close:hover { background: #444; }

    </style>
</head>
<body>

    <header>
        <button class="back-btn" onclick="window.location.href='dashboard.html'">‚ùÆ VOLTAR</button>
        <div class="center-controls">
            <select id="formation-select" class="formation-select" onchange="mudarFormacao()">
                <option value="4-3-3">4-3-3 OFENSIVO</option>
                <option value="4-4-2">4-4-2 CL√ÅSSICO</option>
                <option value="3-5-2">3-5-2 CONTROLE</option>
                <option value="4-2-3-1">4-2-3-1 MODERNO</option>
                <option value="3-4-3">3-4-3 PRESS√ÉO</option>
            </select>
            <div class="team-rating">FOR√áA: <span class="rating-val" id="team-str">0</span></div>
        </div>
        <button class="save-btn" onclick="salvarTudo()">SALVAR</button>
    </header>

    <div class="workspace">
        
        <div class="panel">
            <div class="panel-header">
                <span>ELENCO</span>
                <button class="btn-auto" onclick="autoEscalar()">‚ö° 11 INICIAIS</button>
            </div>
            <div class="scroll-content" id="roster-list"></div>
        </div>

        <div class="field-area">
            <div class="pitch">
                <div class="pitch-line half-line"></div>
                <div class="pitch-line center-circle"></div>
                <div class="pitch-line center-spot"></div>
                
                <div class="pitch-line penalty-area left"></div>
                <div class="pitch-line goal-area left"></div>
                <div class="pitch-line penalty-spot left"></div>

                <div class="pitch-line penalty-area right"></div>
                <div class="pitch-line goal-area right"></div>
                <div class="pitch-line penalty-spot right"></div>

                <div class="corner corner-tl"></div>
                <div class="corner corner-tr"></div>
                <div class="corner corner-bl"></div>
                <div class="corner corner-br"></div>

                <div class="field-slot" id="slot-1"><div class="player-kit"></div><div class="slot-info-box"><span class="slot-name">Vazio</span><div class="slot-pos-mini">GOL</div></div></div>
                <div class="field-slot" id="slot-2"><div class="player-kit"></div><div class="slot-info-box"><span class="slot-name">Vazio</span><div class="slot-pos-mini">DEF</div></div></div>
                <div class="field-slot" id="slot-3"><div class="player-kit"></div><div class="slot-info-box"><span class="slot-name">Vazio</span><div class="slot-pos-mini">DEF</div></div></div>
                <div class="field-slot" id="slot-4"><div class="player-kit"></div><div class="slot-info-box"><span class="slot-name">Vazio</span><div class="slot-pos-mini">DEF</div></div></div>
                <div class="field-slot" id="slot-5"><div class="player-kit"></div><div class="slot-info-box"><span class="slot-name">Vazio</span><div class="slot-pos-mini">DEF</div></div></div>
                <div class="field-slot" id="slot-6"><div class="player-kit"></div><div class="slot-info-box"><span class="slot-name">Vazio</span><div class="slot-pos-mini">MEI</div></div></div>
                <div class="field-slot" id="slot-7"><div class="player-kit"></div><div class="slot-info-box"><span class="slot-name">Vazio</span><div class="slot-pos-mini">MEI</div></div></div>
                <div class="field-slot" id="slot-8"><div class="player-kit"></div><div class="slot-info-box"><span class="slot-name">Vazio</span><div class="slot-pos-mini">MEI</div></div></div>
                <div class="field-slot" id="slot-9"><div class="player-kit"></div><div class="slot-info-box"><span class="slot-name">Vazio</span><div class="slot-pos-mini">ATA</div></div></div>
                <div class="field-slot" id="slot-10"><div class="player-kit"></div><div class="slot-info-box"><span class="slot-name">Vazio</span><div class="slot-pos-mini">ATA</div></div></div>
                <div class="field-slot" id="slot-11"><div class="player-kit"></div><div class="slot-info-box"><span class="slot-name">Vazio</span><div class="slot-pos-mini">ATA</div></div></div>
            </div>

            <div class="bench-container">
                <div class="bench-title">BANCO DE RESERVAS</div>
                <div class="bench-box">
                    <div class="bench-slot" id="bench-1" data-role="RES"><div class="player-kit"></div><div class="slot-info-box"><span class="slot-name">Vazio</span></div></div>
                    <div class="bench-slot" id="bench-2" data-role="RES"><div class="player-kit"></div><div class="slot-info-box"><span class="slot-name">Vazio</span></div></div>
                    <div class="bench-slot" id="bench-3" data-role="RES"><div class="player-kit"></div><div class="slot-info-box"><span class="slot-name">Vazio</span></div></div>
                    <div class="bench-slot" id="bench-4" data-role="RES"><div class="player-kit"></div><div class="slot-info-box"><span class="slot-name">Vazio</span></div></div>
                    <div class="bench-slot" id="bench-5" data-role="RES"><div class="player-kit"></div><div class="slot-info-box"><span class="slot-name">Vazio</span></div></div>
                    <div class="bench-slot" id="bench-6" data-role="RES"><div class="player-kit"></div><div class="slot-info-box"><span class="slot-name">Vazio</span></div></div>
                    <div class="bench-slot" id="bench-7" data-role="RES"><div class="player-kit"></div><div class="slot-info-box"><span class="slot-name">Vazio</span></div></div>
                </div>
            </div>
        </div>

        <div class="panel panel-right">
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('funcoes')">FUN√á√ïES</button>
                <button class="tab-btn" onclick="switchTab('estrategia')">ESTRAT√âGIA</button>
            </div>
            <div id="tab-funcoes" class="tab-content active">
                <div class="role-card"><label class="role-label">¬© Capit√£o</label><select id="role-capitao" class="role-select" onchange="atualizarIconesFuncao()"></select></div>
                <div class="role-card"><label class="role-label">‚öΩ P√™naltis</label><select id="role-penalti" class="role-select"></select></div>
                <div class="role-card"><label class="role-label">üéØ Faltas</label><select id="role-falta" class="role-select"></select></div>
                <div class="role-card"><label class="role-label">üö© Escanteio D</label><select id="role-escanteioD" class="role-select"></select></div>
                <div class="role-card"><label class="role-label">üö© Escanteio E</label><select id="role-escanteioE" class="role-select"></select></div>
            </div>
            <div id="tab-estrategia" class="tab-content">
                <div class="role-card">
                    <label class="role-label">MENTALIDADE <span id="val-mentalidade" class="tactic-value">Equilibrada</span></label>
                    <input type="range" id="slider-mentalidade" min="1" max="5" value="3" oninput="atualizarLabelsTatica()">
                    <div class="range-labels"><span>Def</span><span>Eq</span><span>Atq</span></div>
                </div>
                <div class="role-card">
                    <label class="role-label">INTENSIDADE <span id="val-intensidade" class="tactic-value">Normal</span></label>
                    <input type="range" id="slider-intensidade" min="1" max="3" value="2" oninput="atualizarLabelsTatica()">
                    <div class="range-labels"><span>Leve</span><span>Normal</span><span>Alta</span></div>
                </div>
            </div>
        </div>
    </div>

    <div id="fifa-tooltip">
        <div class="fifa-header">
            <div class="fifa-ovr" id="tip-ovr">00</div>
            <div class="fifa-info">
                <div class="fifa-name" id="tip-name">NOME</div>
                <div class="fifa-pos" id="tip-pos">POS</div>
            </div>
        </div>
        <div class="fifa-grid" id="tip-grid"></div>
    </div>

    <div id="player-modal" class="modal-overlay" onclick="fecharModal(event)">
        <div class="modal-card">
            <div class="modal-header">
                <div class="modal-kit" id="m-kit">10</div>
                <div>
                    <h2 id="m-nome">NOME</h2>
                    <span id="m-pos">POS</span> ‚Ä¢ <span id="m-carac" style="color:var(--blue)">Carac</span>
                </div>
                <div class="modal-ovr" id="m-ovr">00</div>
            </div>
            <div class="chart-container">
                <canvas id="radarChart"></canvas>
            </div>
            <button class="btn-close" onclick="fecharModal()">FECHAR</button>
        </div>
    </div>

    <script>
        // Corre√ß√£o de compatibilidade
        if (typeof database !== 'undefined') window.Database = database;
        if (typeof Database !== 'undefined') window.database = Database;

        let gameState, meuTime;
        let escalacaoAtual = {};
        let funcoesAtuais = { capitao: null, penalti: null, falta: null, escanteioD: null, escanteioE: null };
        let taticasAtuais = { mentalidade: 3, intensidade: 2 };
        let formacaoAtual = "4-3-3";
        let radarChart = null;

        const layouts = {
            "4-3-3": [{id:"slot-1",l:"6%",t:"50%",r:"GOL"},{id:"slot-2",l:"25%",t:"15%",r:"LE"},{id:"slot-3",l:"20%",t:"38%",r:"ZAG"},{id:"slot-4",l:"20%",t:"62%",r:"ZAG"},{id:"slot-5",l:"25%",t:"85%",r:"LD"},{id:"slot-6",l:"40%",t:"50%",r:"VOL"},{id:"slot-7",l:"55%",t:"30%",r:"MEI"},{id:"slot-8",l:"55%",t:"70%",r:"MEI"},{id:"slot-9",l:"85%",t:"20%",r:"ATA"},{id:"slot-10",l:"85%",t:"50%",r:"ATA"},{id:"slot-11",l:"85%",t:"80%",r:"ATA"}],
            "4-4-2": [{id:"slot-1",l:"6%",t:"50%",r:"GOL"},{id:"slot-2",l:"25%",t:"15%",r:"LE"},{id:"slot-3",l:"20%",t:"38%",r:"ZAG"},{id:"slot-4",l:"20%",t:"62%",r:"ZAG"},{id:"slot-5",l:"25%",t:"85%",r:"LD"},{id:"slot-6",l:"45%",t:"30%",r:"VOL"},{id:"slot-7",l:"45%",t:"70%",r:"VOL"},{id:"slot-8",l:"60%",t:"15%",r:"MEI"},{id:"slot-9",l:"60%",t:"85%",r:"MEI"},{id:"slot-10",l:"85%",t:"35%",r:"ATA"},{id:"slot-11",l:"85%",t:"65%",r:"ATA"}],
            "3-5-2": [{id:"slot-1",l:"6%",t:"50%",r:"GOL"},{id:"slot-2",l:"20%",t:"20%",r:"ZAG"},{id:"slot-3",l:"18%",t:"50%",r:"ZAG"},{id:"slot-4",l:"20%",t:"80%",r:"ZAG"},{id:"slot-5",l:"45%",t:"15%",r:"MEI"},{id:"slot-6",l:"40%",t:"35%",r:"VOL"},{id:"slot-7",l:"40%",t:"65%",r:"VOL"},{id:"slot-8",l:"45%",t:"85%",r:"MEI"},{id:"slot-9",l:"60%",t:"50%",r:"MEI"},{id:"slot-10",l:"85%",t:"35%",r:"ATA"},{id:"slot-11",l:"85%",t:"65%",r:"ATA"}],
            "4-2-3-1":[{id:"slot-1",l:"6%",t:"50%",r:"GOL"},{id:"slot-2",l:"25%",t:"15%",r:"LE"},{id:"slot-3",l:"20%",t:"38%",r:"ZAG"},{id:"slot-4",l:"20%",t:"62%",r:"ZAG"},{id:"slot-5",l:"25%",t:"85%",r:"LD"},{id:"slot-6",l:"40%",t:"35%",r:"VOL"},{id:"slot-7",l:"40%",t:"65%",r:"VOL"},{id:"slot-8",l:"65%",t:"20%",r:"MEI"},{id:"slot-9",l:"60%",t:"50%",r:"MEI"},{id:"slot-10",l:"65%",t:"80%",r:"MEI"},{id:"slot-11",l:"88%",t:"50%",r:"ATA"}],
            "3-4-3": [{id:"slot-1",l:"6%",t:"50%",r:"GOL"},{id:"slot-2",l:"20%",t:"20%",r:"ZAG"},{id:"slot-3",l:"18%",t:"50%",r:"ZAG"},{id:"slot-4",l:"20%",t:"80%",r:"ZAG"},{id:"slot-5",l:"45%",t:"15%",r:"MEI"},{id:"slot-6",l:"45%",t:"40%",r:"VOL"},{id:"slot-7",l:"45%",t:"60%",r:"VOL"},{id:"slot-8",l:"45%",t:"85%",r:"MEI"},{id:"slot-9",l:"85%",t:"20%",r:"ATA"},{id:"slot-10",l:"85%",t:"50%",r:"ATA"},{id:"slot-11",l:"85%",t:"80%",r:"ATA"}]
        };

        window.onload = function() {
            try {
                // CORRE√á√ÉO: Usa a Engine para carregar o jogo e o time do jogador
                gameState = Engine.carregarJogo();
                if(!gameState) throw new Error("Sem jogo salvo");

                // Carrega o time DO SAVE (que tem elenco), n√£o do Database
                if(Engine.getMeuTime) {
                    meuTime = Engine.getMeuTime();
                } else {
                    // Fallback se a engine for antiga
                    meuTime = gameState.times.find(t => t.nome === gameState.info.time);
                }

                if(!meuTime) throw new Error("Time n√£o encontrado no save.");

                // Garante que todo jogador tenha UID
                if(meuTime.elenco) {
                    meuTime.elenco.forEach((j, i) => { if(!j.uid) j.uid = `p_${i}`; });
                }

                carregarDadosSalvos();
                aplicarLayout(formacaoAtual);
                renderizarLista();
                atualizarCampo();
                povoarDropdowns();
                atualizarLabelsTatica();
            } catch(e) { 
                console.error(e); 
                alert("Erro ao carregar time: " + e.message); 
                window.location.href='index.html'; 
            }
        };

        function carregarDadosSalvos() {
            const fs = localStorage.getItem('brfutebol_esquema');
            if(fs) { formacaoAtual = fs; document.getElementById('formation-select').value = formacaoAtual; }
            
            const fj = localStorage.getItem('brfutebol_formacao');
            if(fj) { try{ escalacaoAtual = JSON.parse(fj); }catch(e){ escalacaoAtual = {}; } }
            // Se n√£o tiver nada salvo, auto-escala
            if (Object.keys(escalacaoAtual).length === 0) autoEscalar(true);

            const ff = localStorage.getItem('brfutebol_funcoes');
            if(ff) { try{ funcoesAtuais = JSON.parse(ff); }catch(e){} }
            const ft = localStorage.getItem('brfutebol_taticas');
            if(ft) { try{ taticasAtuais = JSON.parse(ft); document.getElementById('slider-mentalidade').value=taticasAtuais.mentalidade; document.getElementById('slider-intensidade').value=taticasAtuais.intensidade; }catch(e){} }
        }

        function switchTab(t) {
            document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
            document.getElementById('tab-'+t).classList.add('active');
            document.querySelectorAll('.tab-btn')[t==='funcoes'?0:1].classList.add('active');
        }

        function atualizarLabelsTatica() {
            const m = ["Ultra Def", "Retranca", "Equilibrada", "Ofensiva", "Tudo ou Nada"];
            const i = ["Leve", "Normal", "Press√£o Alta"];
            document.getElementById('val-mentalidade').innerText = m[document.getElementById('slider-mentalidade').value-1];
            document.getElementById('val-intensidade').innerText = i[document.getElementById('slider-intensidade').value-1];
        }

        function mudarFormacao() {
            formacaoAtual = document.getElementById('formation-select').value;
            aplicarLayout(formacaoAtual);
            atualizarCampo();
        }

        function aplicarLayout(nome) {
            if(!layouts[nome]) return;
            layouts[nome].forEach(p => {
                const s = document.getElementById(p.id);
                if(s) { s.style.top=p.t; s.style.left=p.l; s.dataset.role=p.r; }
            });
        }

        function renderizarLista() {
            const container = document.getElementById('roster-list');
            container.innerHTML = '';
            const emCampo = Object.values(escalacaoAtual);
            
            // Filtra quem N√ÉO est√° na escala√ß√£o
            let lista = meuTime.elenco.filter(j => !emCampo.includes(j.uid));

            const ordem = {'GOL':1, 'LD':2, 'LE':2, 'ZAG':3, 'VOL':4, 'MEI':5, 'ATA':6};
            lista.sort((a,b) => {
                const pa = ordem[a.pos]||99, pb = ordem[b.pos]||99;
                if(pa!==pb) return pa-pb;
                return b.forca - a.forca;
            });

            lista.forEach(jog => {
                const div = document.createElement('div');
                div.className = 'roster-item';
                div.draggable = true;
                div.id = `card-${jog.uid}`;
                div.dataset.uid = jog.uid; 
                
                const saude = jog.saude !== undefined ? jog.saude : 100;
                let cor = saude < 60 ? '#e74c3c' : (saude < 80 ? '#f1c40f' : '#2ecc71');

                div.innerHTML = `
                    <div class="pos-badge">${jog.pos}</div>
                    <div class="player-info">
                        <div class="player-name">${jog.nome}</div>
                        <div class="health-bar-container"><div class="health-bar-fill" style="width:${saude}%; background:${cor}"></div></div>
                    </div>
                    <div class="ovr-badge">${jog.forca}</div>
                `;
                div.addEventListener('dragstart', handleDragStart);
                div.addEventListener('dblclick', () => abrirModalAtributos(jog.uid));
                div.addEventListener('mouseenter', showTooltip);
                div.addEventListener('mousemove', moveTooltip);
                div.addEventListener('mouseleave', hideTooltip);
                container.appendChild(div);
            });
        }

        function atualizarCampo() {
            let soma = 0, count = 0;
            const slots = [...document.querySelectorAll('.field-slot'), ...document.querySelectorAll('.bench-slot')];
            
            slots.forEach(slot => {
                const jUid = escalacaoAtual[slot.id];
                const jog = jUid ? meuTime.elenco.find(x => x.uid === jUid) : null;
                const kit = slot.querySelector('.player-kit');
                const info = slot.querySelector('.slot-info-box');

                slot.classList.remove('filled', 'pos-wrong', 'pos-medium', 'is-captain');
                slot.removeEventListener('mouseenter', showTooltip);
                slot.removeEventListener('mousemove', moveTooltip);
                slot.removeEventListener('mouseleave', hideTooltip);

                if(jog) {
                    slot.classList.add('filled');
                    slot.dataset.uid = jog.uid; 
                    slot.addEventListener('mouseenter', showTooltip);
                    slot.addEventListener('mousemove', moveTooltip);
                    slot.addEventListener('mouseleave', hideTooltip);

                    const role = slot.dataset.role;
                    if(role && role !== 'RES') {
                        if(role === jog.pos) { /* ok */ }
                        else if(posicaoAceitavel(role, jog.pos)) { slot.classList.add('pos-medium'); }
                        else { slot.classList.add('pos-wrong'); }
                    }

                    kit.innerHTML = `
                        <span class="kit-number">${jog.pos}</span>
                        <div class="kit-score">${jog.forca}</div>
                        <div class="captain-c">C</div>
                    `;

                    info.querySelector('.slot-name').innerText = jog.nome.split(' ')[0];
                    
                    const cId = document.getElementById('role-capitao').value || funcoesAtuais.capitao;
                    if(jog.uid === cId) slot.classList.add('is-captain');

                    if(slot.id.startsWith('slot-')) { soma += jog.forca; count++; }
                } else {
                    delete slot.dataset.uid;
                    kit.innerHTML = `<span class="kit-number">${slot.dataset.role || "?"}</span>`;
                    info.querySelector('.slot-name').innerText = "Vazio";
                }
            });
            document.getElementById('team-str').innerText = count === 11 ? Math.floor(soma/11) : "-";
        }

        function posicaoAceitavel(role, pos) {
            const comp = { 'GOL':[], 'ZAG':['LE','LD','VOL'], 'LE':['LD','ZAG','MEI'], 'LD':['LE','ZAG','MEI'], 'VOL':['ZAG','MEI'], 'MEI':['VOL','ATA'], 'ATA':['MEI','ST'] };
            return comp[pos] && comp[pos].includes(role);
        }

        function povoarDropdowns() {
            const titulares = Object.values(escalacaoAtual).filter(uid => {
                const k = Object.keys(escalacaoAtual).find(key => escalacaoAtual[key] === uid);
                return k && k.startsWith('slot-');
            }).map(uid => meuTime.elenco.find(j => j.uid === uid));
            titulares.sort((a,b) => b.forca - a.forca);

            ['capitao','penalti','falta','escanteioD','escanteioE'].forEach(r => {
                const el = document.getElementById(`role-${r}`);
                const val = el.value || funcoesAtuais[r];
                el.innerHTML = '<option value="">-- Escolher --</option>';
                titulares.forEach(j => {
                    const op = document.createElement('option');
                    op.value = j.uid; op.innerText = `[${j.pos}] ${j.nome}`;
                    if(j.uid===val) op.selected = true;
                    el.appendChild(op);
                });
            });
            atualizarIconesFuncao();
        }

        function atualizarIconesFuncao() {
            const cid = document.getElementById('role-capitao').value;
            document.querySelectorAll('.field-slot').forEach(s => {
                const jid = escalacaoAtual[s.id];
                if(jid && jid === cid) s.classList.add('is-captain');
                else s.classList.remove('is-captain');
            });
        }

        // TOOLTIP
        function showTooltip(e) {
            const uid = this.dataset.uid;
            if(!uid) return;
            const jog = meuTime.elenco.find(j => j.uid === uid);
            if(!jog) return;
            gerarAtributosSeNecessario(jog);

            document.getElementById('tip-name').innerText = jog.nome;
            document.getElementById('tip-pos').innerText = jog.pos;
            document.getElementById('tip-ovr').innerText = jog.forca;

            const grid = document.getElementById('tip-grid');
            grid.innerHTML = '';
            
            const labels = { VEL:'PAC', FIN:'SHO', PAS:'PAS', DRI:'DRI', DEF:'DEF', FIS:'PHY' };
            for(let key in labels) {
                const val = jog.atributos[key];
                let cls = 'mid'; if(val>=80) cls='high'; if(val<60) cls='low';
                grid.innerHTML += `<div class="fifa-stat"><span>${labels[key]}</span><b class="${cls}">${val}</b></div>`;
            }
            const tip = document.getElementById('fifa-tooltip');
            tip.style.display = 'block';
            moveTooltip(e);
        }

        function moveTooltip(e) {
            const tip = document.getElementById('fifa-tooltip');
            tip.style.top = (e.clientY + 15) + 'px';
            tip.style.left = (e.clientX + 15) + 'px';
        }

        function hideTooltip() { document.getElementById('fifa-tooltip').style.display = 'none'; }

        function gerarAtributosSeNecessario(jog) {
            if(!jog.atributos || !jog.atributos.VEL) {
                const base = jog.forca;
                if(jog.pos === 'GOL') {
                    jog.atributos = { VEL: base+2, FIN: base-5, PAS: base, DRI: base-10, DEF: base+5, FIS: base };
                } else if (jog.pos === 'ATA') {
                    jog.atributos = { VEL:base+5, FIN:base+5, PAS:base-5, DRI:base+5, DEF:base-30, FIS:base };
                } else {
                    jog.atributos = { VEL:base, FIN:base-5, PAS:base+5, DRI:base, DEF:base, FIS:base };
                }
            }
        }

        function abrirModalAtributos(jogUid) {
            const jog = meuTime.elenco.find(j => j.uid === jogUid);
            if(!jog) return;
            gerarAtributosSeNecessario(jog);

            document.getElementById('m-nome').innerText = jog.nome;
            document.getElementById('m-pos').innerText = jog.pos;
            document.getElementById('m-carac').innerText = jog.carac || '-';
            document.getElementById('m-ovr').innerText = jog.forca;
            document.getElementById('m-kit').innerText = jog.pos;

            if(radarChart) radarChart.destroy();
            const ctx = document.getElementById('radarChart').getContext('2d');
            radarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: Object.keys(jog.atributos),
                    datasets: [{
                        label: 'Stats',
                        data: Object.values(jog.atributos),
                        backgroundColor: 'rgba(0, 255, 136, 0.2)',
                        borderColor: '#00ff88',
                        pointBackgroundColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    scales: { r: { angleLines: { color: '#333' }, grid: { color: '#333' }, pointLabels: { color: '#fff', font: { size: 14, family: 'Rajdhani', weight: 'bold' } }, ticks: { display: false, max: 100, min: 0 } } },
                    plugins: { legend: { display: false } }
                }
            });
            document.getElementById('player-modal').style.display = 'flex';
        }

        function fecharModal(e) {
            if (!e || e.target.id === 'player-modal' || e.target.classList.contains('btn-close')) {
                document.getElementById('player-modal').style.display = 'none';
            }
        }

        function handleDragStart(e) { e.dataTransfer.setData('text/plain', this.id.replace('card-','')); }
        const allSlots = [...document.querySelectorAll('.field-slot'), ...document.querySelectorAll('.bench-slot')];
        allSlots.forEach(s => {
            s.addEventListener('dragover', e => { e.preventDefault(); s.style.transform='translate(-50%,-50%) scale(1.1)'; });
            s.addEventListener('dragleave', e => { s.style.transform='translate(-50%,-50%) scale(1)'; });
            s.addEventListener('drop', handleDrop);
            s.addEventListener('dblclick', () => { if(escalacaoAtual[s.id]) abrirModalAtributos(escalacaoAtual[s.id]); });
            s.onclick = () => removerJogador(s.id);
        });

        function handleDrop(e) {
            e.preventDefault(); this.style.transform='translate(-50%,-50%) scale(1)';
            const jUid = e.dataTransfer.getData('text/plain');
            Object.keys(escalacaoAtual).forEach(k => { if(escalacaoAtual[k]===jUid) delete escalacaoAtual[k]; });
            escalacaoAtual[this.id] = jUid;
            renderizarLista(); atualizarCampo(); povoarDropdowns();
        }

        function removerJogador(sid) {
            if(escalacaoAtual[sid]) { delete escalacaoAtual[sid]; renderizarLista(); atualizarCampo(); povoarDropdowns(); }
        }

        function autoEscalar(silencioso=false) {
            if(!silencioso && !confirm("Auto-escalar?")) return;
            escalacaoAtual = {};
            const usados = [];
            // Prioriza posi√ß√£o certa
            layouts[formacaoAtual].forEach(p => {
                let m = meuTime.elenco.find(j => j.pos===p.r && !usados.includes(j.uid) && (j.saude||100)>50);
                if(m) { escalacaoAtual[p.id] = m.uid; usados.push(m.uid); }
            });
            // Tapa buraco
            layouts[formacaoAtual].forEach(p => {
                if(!escalacaoAtual[p.id]) {
                    let m = meuTime.elenco.find(j => j.pos!=='GOL' && !usados.includes(j.uid) && (j.saude||100)>40);
                    if(m) { escalacaoAtual[p.id] = m.uid; usados.push(m.uid); }
                }
            });
            renderizarLista(); atualizarCampo(); povoarDropdowns();
            const cap = document.getElementById('role-capitao');
            if(cap && !cap.value && usados.length>0) cap.value = usados[0];
        }

        function salvarTudo() {
            localStorage.setItem('brfutebol_formacao', JSON.stringify(escalacaoAtual));
            localStorage.setItem('brfutebol_esquema', formacaoAtual);
            const f = {
                capitao: document.getElementById('role-capitao').value,
                penalti: document.getElementById('role-penalti').value,
                falta: document.getElementById('role-falta').value,
                escanteioD: document.getElementById('role-escanteioD').value,
                escanteioE: document.getElementById('role-escanteioE').value
            };
            localStorage.setItem('brfutebol_funcoes', JSON.stringify(f));
            const t = {
                mentalidade: document.getElementById('slider-mentalidade').value,
                intensidade: document.getElementById('slider-intensidade').value
            };
            localStorage.setItem('brfutebol_taticas', JSON.stringify(t));
            const b = document.querySelector('.save-btn');
            b.innerText = "SALVO!";
            setTimeout(() => { b.innerText="SALVAR"; window.location.href='dashboard.html'; }, 800);
        }
    </script>
</body>
</html>
