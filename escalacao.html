<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRFutebol - EscalaÃ§Ã£o</title>
    <script src="database_jogadores.js"></script>
    <script src="engine.js"></script>
    <style>
        :root { --bg:#0d1115; --card:#1e272e; --text:#ecf0f1; --green:#2ecc71; --gold:#f1c40f; --red:#e74c3c; }
        body { font-family:'Segoe UI',sans-serif; background:var(--bg); color:var(--text); margin:0; height:100vh; display:flex; flex-direction:column; overflow:hidden; }

        /* HEADER */
        header { height: 60px; background: rgba(22,27,34,0.95); border-bottom:1px solid #333; display:flex; align-items:center; justify-content:space-between; padding:0 20px; }
        .btn-back { background:none; border:1px solid #444; color:#fff; padding:8px 15px; border-radius:5px; cursor:pointer; font-weight:bold; }
        .btn-save { background:var(--green); border:none; color:#000; padding:10px 30px; border-radius:30px; cursor:pointer; font-weight:900; text-transform:uppercase; box-shadow:0 0 10px rgba(46,204,113,0.3); }
        .btn-save:hover { transform:scale(1.05); }

        /* MAIN LAYOUT */
        .container { display:flex; height:calc(100vh - 60px); }
        
        /* LISTA DE JOGADORES (ESQUERDA) */
        .sidebar { width: 350px; background:#161b22; border-right:1px solid #333; display:flex; flex-direction:column; }
        .sidebar-header { padding:15px; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center; }
        .player-list { flex:1; overflow-y:auto; padding:10px; }

        .player-card {
            background:var(--card); padding:10px; margin-bottom:8px; border-radius:6px; border:1px solid #333;
            display:flex; align-items:center; justify-content:space-between; cursor:grab; user-select:none;
            transition:0.2s;
        }
        .player-card:hover { border-color:var(--green); background:#252e33; }
        .player-card.dragging { opacity:0.5; }
        .player-card.used { opacity:0.3; pointer-events:none; filter:grayscale(1); }

        .p-pos { background:#000; color:#aaa; font-size:0.7rem; padding:2px 5px; border-radius:3px; font-weight:bold; width:30px; text-align:center; }
        .p-info { flex:1; margin-left:10px; }
        .p-name { font-weight:bold; font-size:0.9rem; }
        .p-ovr { font-weight:900; color:var(--gold); font-size:1rem; }
        
        .health-mini { width:100%; height:4px; background:#000; margin-top:4px; border-radius:2px; }
        .health-fill { height:100%; border-radius:2px; }

        /* CAMPO (DIREITA) */
        .field-area { flex:1; display:flex; justify-content:center; align-items:center; position:relative; background:#111; overflow:hidden; }
        .pitch {
            width: 500px; height: 700px;
            background: linear-gradient(180deg, #27ae60 0%, #2ecc71 100%);
            border: 4px solid #fff; border-radius: 8px;
            position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: flex; justify-content: center;
        }
        /* Linhas do campo */
        .pitch::before { content:''; position:absolute; top:50%; left:0; width:100%; height:2px; background:rgba(255,255,255,0.5); }
        .pitch::after { content:''; position:absolute; top:50%; left:50%; width:100px; height:100px; border:2px solid rgba(255,255,255,0.5); border-radius:50%; transform:translate(-50%, -50%); }
        .box-top { position:absolute; top:0; width:250px; height:100px; border:2px solid rgba(255,255,255,0.5); border-top:none; left:50%; transform:translateX(-50%); }
        .box-bottom { position:absolute; bottom:0; width:250px; height:100px; border:2px solid rgba(255,255,255,0.5); border-bottom:none; left:50%; transform:translateX(-50%); }

        /* SLOTS DOS JOGADORES NO CAMPO */
        .slot {
            position: absolute; width: 80px; height: 80px;
            transform: translate(-50%, -50%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s;
        }
        .slot-circle {
            width: 45px; height: 45px; background: rgba(0,0,0,0.3);
            border: 2px dashed rgba(255,255,255,0.5); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: #fff; font-size: 0.7rem; font-weight: bold; overflow: hidden;
        }
        .slot.filled .slot-circle { background: var(--card); border: 2px solid var(--green); }
        .slot-name { background: rgba(0,0,0,0.8); color: #fff; padding: 2px 6px; border-radius: 10px; font-size: 0.7rem; margin-top: 5px; white-space: nowrap; }
        .slot-ovr { position: absolute; top: -5px; right: 10px; background: var(--gold); color: #000; font-size: 0.7rem; font-weight: bold; padding: 1px 4px; border-radius: 4px; display: none; }
        .slot.filled .slot-ovr { display: block; }

        /* AVISO DE SAÃšDE BAIXA NO CAMPO */
        .warn-icon { position: absolute; top: -5px; left: 10px; color: var(--red); font-size: 1rem; display: none; filter: drop-shadow(0 1px 1px #000); }
        .slot.low-health .warn-icon { display: block; }

        /* FormaÃ§Ã£o 4-3-3 PadrÃ£o */
        #pos-GK { bottom: 2%; left: 50%; }
        #pos-LB { bottom: 20%; left: 15%; }
        #pos-CB1 { bottom: 15%; left: 38%; }
        #pos-CB2 { bottom: 15%; left: 62%; }
        #pos-RB { bottom: 20%; left: 85%; }
        #pos-CDM { bottom: 35%; left: 50%; }
        #pos-CM1 { bottom: 50%; left: 30%; }
        #pos-CM2 { bottom: 50%; left: 70%; }
        #pos-LW { top: 20%; left: 15%; }
        #pos-ST { top: 15%; left: 50%; }
        #pos-RW { top: 20%; left: 85%; }

    </style>
</head>
<body>

    <header>
        <button class="btn-back" onclick="window.location.href='dashboard.html'">â¬… Voltar</button>
        <div style="font-weight:bold; color:var(--text-muted);">FORÃ‡A DO TIME: <span id="team-str" style="color:var(--text);">0</span></div>
        <button class="btn-save" onclick="salvarTime()">SALVAR ESCALAÃ‡ÃƒO</button>
    </header>

    <div class="container">
        <div class="sidebar">
            <div class="sidebar-header">
                <span>Elenco</span>
                <button onclick="autoEscalar()" style="background:#333; color:#fff; border:none; padding:5px 10px; border-radius:4px; cursor:pointer; font-size:0.8rem;">âš¡ Auto-Escalar</button>
            </div>
            <div class="player-list" id="roster">
                </div>
        </div>

        <div class="field-area" id="field-dropzone">
            <div class="pitch">
                <div class="box-top"></div>
                <div class="box-bottom"></div>

                <div class="slot" id="pos-GK" data-role="GOL"><div class="slot-circle">GOL</div><div class="slot-name">Vazio</div><div class="slot-ovr"></div><div class="warn-icon">ðŸš‘</div></div>
                <div class="slot" id="pos-LB" data-role="LE"><div class="slot-circle">LE</div><div class="slot-name">Vazio</div><div class="slot-ovr"></div><div class="warn-icon">ðŸš‘</div></div>
                <div class="slot" id="pos-CB1" data-role="ZAG"><div class="slot-circle">ZAG</div><div class="slot-name">Vazio</div><div class="slot-ovr"></div><div class="warn-icon">ðŸš‘</div></div>
                <div class="slot" id="pos-CB2" data-role="ZAG"><div class="slot-circle">ZAG</div><div class="slot-name">Vazio</div><div class="slot-ovr"></div><div class="warn-icon">ðŸš‘</div></div>
                <div class="slot" id="pos-RB" data-role="LD"><div class="slot-circle">LD</div><div class="slot-name">Vazio</div><div class="slot-ovr"></div><div class="warn-icon">ðŸš‘</div></div>
                <div class="slot" id="pos-CDM" data-role="VOL"><div class="slot-circle">VOL</div><div class="slot-name">Vazio</div><div class="slot-ovr"></div><div class="warn-icon">ðŸš‘</div></div>
                <div class="slot" id="pos-CM1" data-role="MEI"><div class="slot-circle">MEI</div><div class="slot-name">Vazio</div><div class="slot-ovr"></div><div class="warn-icon">ðŸš‘</div></div>
                <div class="slot" id="pos-CM2" data-role="MEI"><div class="slot-circle">MEI</div><div class="slot-name">Vazio</div><div class="slot-ovr"></div><div class="warn-icon">ðŸš‘</div></div>
                <div class="slot" id="pos-LW" data-role="ATA"><div class="slot-circle">PTE</div><div class="slot-name">Vazio</div><div class="slot-ovr"></div><div class="warn-icon">ðŸš‘</div></div>
                <div class="slot" id="pos-ST" data-role="ATA"><div class="slot-circle">ATA</div><div class="slot-name">Vazio</div><div class="slot-ovr"></div><div class="warn-icon">ðŸš‘</div></div>
                <div class="slot" id="pos-RW" data-role="ATA"><div class="slot-circle">PTD</div><div class="slot-name">Vazio</div><div class="slot-ovr"></div><div class="warn-icon">ðŸš‘</div></div>
            </div>
        </div>
    </div>

    <script>
        let gameState, meuTime;
        let escalacaoAtual = {}; // { "pos-GK": "id_jogador", ... }
        let dragSrcEl = null;

        window.onload = function() {
            gameState = Engine.carregarJogo();
            if (!gameState) { window.location.href = 'index.html'; return; }
            meuTime = Engine.encontrarTime(gameState, gameState.meuTime);
            
            // Tenta carregar escalaÃ§Ã£o salva
            const salva = localStorage.getItem('brfutebol_formacao');
            if (salva) {
                try {
                    const obj = JSON.parse(salva);
                    // Mapeia para os slots visuais
                    // O formato salvo Ã© { "GK": id, ... } simplificado, ou { "pos-GK": id }
                    // Vamos assumir que salvamos com as chaves dos IDs dos slots para facilitar
                    escalacaoAtual = obj;
                } catch(e) { console.log("Erro ao carregar tÃ¡tica"); }
            } else {
                autoEscalar(true); // Se nÃ£o tiver, auto-escala na primeira vez silenciosamente
            }

            renderizarLista();
            atualizarCampo();
        };

        function renderizarLista() {
            const container = document.getElementById('roster');
            container.innerHTML = '';

            // Pega IDs que jÃ¡ estÃ£o em campo
            const emCampoIds = Object.values(escalacaoAtual);

            // Ordena lista
            const listaOrdenada = [...meuTime.elenco].sort((a,b) => b.forca - a.forca);

            listaOrdenada.forEach(jog => {
                const div = document.createElement('div');
                div.className = 'player-card';
                div.draggable = true;
                div.id = `card-${jog.id}`;
                
                // Se jÃ¡ estÃ¡ em campo, marca visualmente
                if (emCampoIds.includes(jog.id)) div.classList.add('used');

                // LÃ³gica de SaÃºde
                const saude = jog.saude !== undefined ? jog.saude : 100;
                let corBarra = '#2ecc71';
                if(saude < 80) corBarra = '#f1c40f';
                if(saude < 60) corBarra = '#e74c3c';

                div.innerHTML = `
                    <div class="p-pos">${jog.pos}</div>
                    <div class="p-info">
                        <div class="p-name">${jog.nome}</div>
                        <div class="health-mini"><div class="health-fill" style="width:${saude}%; background:${corBarra};"></div></div>
                    </div>
                    <div class="p-ovr">${jog.forca}</div>
                `;

                // Eventos de Drag
                div.addEventListener('dragstart', handleDragStart);
                div.addEventListener('dragend', handleDragEnd);
                
                // Evento de Clique (Mobile Friendly - Clique na lista, depois no campo)
                div.onclick = () => selecionarParaTroca(jog.id);

                container.appendChild(div);
            });
        }

        // --- LÃ“GICA DE DRAG & DROP ---
        function handleDragStart(e) {
            this.classList.add('dragging');
            dragSrcEl = this;
            e.dataTransfer.effectAllowed = 'move';
            // Passa o ID do jogador (extraÃ­do do id da div "card-XXXX")
            const jogId = this.id.replace('card-', '');
            e.dataTransfer.setData('text/plain', jogId);
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.slot').forEach(slot => slot.classList.remove('drag-over'));
        }

        // Configura os Slots do Campo
        document.querySelectorAll('.slot').forEach(slot => {
            slot.addEventListener('dragover', (e) => {
                e.preventDefault();
                slot.classList.add('drag-over');
            });
            slot.addEventListener('dragleave', () => slot.classList.remove('drag-over'));
            slot.addEventListener('drop', handleDrop);
            
            // Clique no slot para remover jogador
            slot.onclick = () => {
                const slotId = slot.id;
                if (escalacaoAtual[slotId]) {
                    delete escalacaoAtual[slotId];
                    atualizarCampo();
                    renderizarLista();
                }
            };
        });

        function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            const jogId = e.dataTransfer.getData('text/plain');
            const slotId = this.id;

            // Remove o jogador de qualquer outro slot que ele esteja
            Object.keys(escalacaoAtual).forEach(key => {
                if (escalacaoAtual[key] === jogId) delete escalacaoAtual[key];
            });

            // Coloca no novo slot
            escalacaoAtual[slotId] = jogId;
            
            atualizarCampo();
            renderizarLista();
        }

        function atualizarCampo() {
            let forcaTotal = 0;
            let count = 0;

            document.querySelectorAll('.slot').forEach(slot => {
                const jogId = escalacaoAtual[slot.id];
                const jog = jogId ? meuTime.elenco.find(j => j.id === jogId) : null;

                if (jog) {
                    slot.classList.add('filled');
                    slot.querySelector('.slot-circle').innerText = jog.forca;
                    slot.querySelector('.slot-circle').style.background = `url('https://cdn-icons-png.flaticon.com/512/847/847969.png') center/cover`; // Placeholder de rosto ou numero
                    slot.querySelector('.slot-circle').innerText = jog.pos; // Ou numero da camisa
                    slot.querySelector('.slot-name').innerText = jog.nome.split(' ')[0]; // Primeiro nome
                    slot.querySelector('.slot-ovr').innerText = jog.forca;
                    
                    // Aviso de saÃºde
                    if(jog.saude < 60) slot.classList.add('low-health');
                    else slot.classList.remove('low-health');

                    forcaTotal += jog.forca;
                    count++;
                } else {
                    slot.classList.remove('filled');
                    slot.querySelector('.slot-circle').innerText = slot.dataset.role;
                    slot.querySelector('.slot-circle').style.background = 'rgba(0,0,0,0.3)';
                    slot.querySelector('.slot-name').innerText = "Vazio";
                    slot.classList.remove('low-health');
                }
            });

            const media = count > 0 ? Math.floor(forcaTotal / count) : 0;
            document.getElementById('team-str').innerText = count === 11 ? media : `${media} (Incompleto)`;
        }

        function autoEscalar(silencioso = false) {
            if(!silencioso && !confirm("Substituir a escalaÃ§Ã£o atual pelos melhores jogadores disponÃ­veis?")) return;

            escalacaoAtual = {};
            const usados = [];

            // Mapeamento simples de posiÃ§Ãµes ideais
            const slotsMap = {
                'pos-GK': ['GOL'],
                'pos-LB': ['LE', 'ZAG'],
                'pos-CB1': ['ZAG'],
                'pos-CB2': ['ZAG'],
                'pos-RB': ['LD', 'ZAG'],
                'pos-CDM': ['VOL', 'MEI'],
                'pos-CM1': ['MEI', 'VOL'],
                'pos-CM2': ['MEI', 'ATA'],
                'pos-LW': ['ATA', 'MEI'],
                'pos-ST': ['ATA'],
                'pos-RW': ['ATA', 'MEI']
            };

            Object.keys(slotsMap).forEach(slotId => {
                const posPreferencia = slotsMap[slotId];
                // Busca o melhor jogador para a posiÃ§Ã£o que tenha saÃºde > 50 e nÃ£o esteja usado
                let melhor = null;
                
                // Tenta achar da posiÃ§Ã£o exata primeiro
                for(let pos of posPreferencia) {
                    const candidatos = meuTime.elenco.filter(j => j.pos === pos && !usados.includes(j.id) && (j.saude === undefined || j.saude > 50));
                    candidatos.sort((a,b) => b.forca - a.forca);
                    if(candidatos.length > 0) {
                        melhor = candidatos[0];
                        break;
                    }
                }

                // Se nÃ£o achou (ou todos cansados), pega qualquer um de linha (exceto GOL)
                if(!melhor && !slotId.includes('GK')) {
                    const sobra = meuTime.elenco.filter(j => j.pos !== 'GOL' && !usados.includes(j.id));
                    sobra.sort((a,b) => b.forca - a.forca);
                    if(sobra.length > 0) melhor = sobra[0];
                }

                if (melhor) {
                    escalacaoAtual[slotId] = melhor.id;
                    usados.push(melhor.id);
                }
            });

            atualizarCampo();
            renderizarLista();
        }

        function salvarTime() {
            // Verifica se tem 11
            const titulares = Object.keys(escalacaoAtual).length;
            if (titulares < 11) {
                alert(`AtenÃ§Ã£o: VocÃª escalou apenas ${titulares} jogadores. O time entrarÃ¡ incompleto!`);
            }

            // Salva no LocalStorage para o Engine ler
            localStorage.setItem('brfutebol_formacao', JSON.stringify(escalacaoAtual));
            
            // Feedback
            const btn = document.querySelector('.btn-save');
            const originalText = btn.innerText;
            btn.innerText = "SALVO! âœ…";
            btn.style.background = "#fff";
            setTimeout(() => {
                btn.innerText = originalText;
                btn.style.background = "var(--green)";
                window.location.href = 'dashboard.html';
            }, 800);
        }

        // Mobile touch support fix para DragDrop simples (ou use biblioteca, aqui Ã© fallback bÃ¡sico)
        let selectedPlayerId = null;
        function selecionarParaTroca(id) {
            if(selectedPlayerId === id) {
                selectedPlayerId = null;
                renderizarLista(); // remove destaque
                return;
            }
            selectedPlayerId = id;
            // Visual feedback (adicionar classe selected manualmente nos cards)
            document.querySelectorAll('.player-card').forEach(c => c.style.borderColor = '#333');
            document.getElementById(`card-${id}`).style.borderColor = 'var(--gold)';
            
            // Agora espera clique no slot
            document.querySelectorAll('.slot').forEach(slot => {
                slot.onclick = function() {
                    if (selectedPlayerId) {
                        // Remove de onde estava
                        Object.keys(escalacaoAtual).forEach(key => {
                            if (escalacaoAtual[key] === selectedPlayerId) delete escalacaoAtual[key];
                        });
                        
                        escalacaoAtual[this.id] = selectedPlayerId;
                        selectedPlayerId = null;
                        atualizarCampo();
                        renderizarLista();
                        
                        // Reseta o onclick padrÃ£o do slot para remover
                        configurarSlotsParaRemover();
                    } else {
                        // Comportamento normal de remover
                        if (escalacaoAtual[this.id]) {
                            delete escalacaoAtual[this.id];
                            atualizarCampo();
                            renderizarLista();
                        }
                    }
                }
            });
        }
        
        function configurarSlotsParaRemover() {
             document.querySelectorAll('.slot').forEach(slot => {
                slot.onclick = () => {
                    if (escalacaoAtual[slot.id]) {
                        delete escalacaoAtual[slot.id];
                        atualizarCampo();
                        renderizarLista();
                    }
                };
             });
        }

    </script>
</body>
</html>
