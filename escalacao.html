<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRFutebol - Prancheta TÃ¡tica</title>
    
    <script src="database_jogadores.js"></script>
    <script src="engine.js"></script>

    <style>
        :root {
            --primary: #1e272e;
            --secondary: #0fb9b1;
            --highlight: #f1c40f;
            --bg: #0d1115;
            --card-bg: #2d3436;
            --text: #ecf0f1;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0; padding: 0;
            display: grid; grid-template-rows: 70px 1fr;
            height: 100vh; overflow: hidden;
            user-select: none;
        }

        /* HEADER */
        header {
            background-color: rgba(30, 39, 46, 0.95);
            border-bottom: 2px solid var(--secondary);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 30px;
        }

        .header-controls { display: flex; align-items: center; gap: 20px; }

        select {
            background: #1e272e; color: white; border: 1px solid #555;
            padding: 8px 15px; border-radius: 6px; font-size: 1rem; cursor: pointer;
        }

        .action-btn { padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; border: none; transition: 0.2s; }
        .btn-back { background: #444; color: #fff; }
        .btn-save { background: var(--secondary); color: #1e272e; text-transform: uppercase; }
        .btn-save:hover { box-shadow: 0 0 15px rgba(15, 185, 177, 0.4); transform: scale(1.05); }

        /* LAYOUT */
        main {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px; padding: 20px; height: 100%; box-sizing: border-box;
        }

        /* CAMPO */
        .field-container {
            background: linear-gradient(180deg, #27ae60 0%, #2ecc71 100%);
            border: 4px solid #fff; border-radius: 12px;
            position: relative; box-shadow: inset 0 0 80px rgba(0,0,0,0.5);
            margin: 0 auto; width: 100%; max-width: 750px; height: 100%;
        }

        .line { position: absolute; background: rgba(255,255,255,0.4); pointer-events: none; }
        .mid-line { width: 100%; height: 2px; top: 50%; }
        .circle { width: 100px; height: 100px; border: 2px solid rgba(255,255,255,0.4); border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .area-top { width: 40%; height: 16%; border: 2px solid rgba(255,255,255,0.4); border-top: none; top: 0; left: 30%; }
        .area-bottom { width: 40%; height: 16%; border: 2px solid rgba(255,255,255,0.4); border-bottom: none; bottom: 0; left: 30%; }

        /* JOGADOR NO CAMPO */
        .player-token {
            position: absolute; width: 55px; height: 55px;
            background: #fff; border: 3px solid #333; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: 800; color: #333; font-size: 0.9rem;
            cursor: grab; box-shadow: 0 5px 15px rgba(0,0,0,0.4);
            transform: translate(-50%, -50%); z-index: 10;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .player-token:active { cursor: grabbing; z-index: 100; transform: translate(-50%, -50%) scale(1.1); }
        
        .player-token.selected {
            border-color: var(--highlight);
            box-shadow: 0 0 0 4px var(--highlight);
            animation: pulse 1s infinite;
        }

        /* Classe usada quando um jogador Ã© arrastado sobre outro */
        .player-token.hover-swap {
            background-color: var(--highlight);
            border-color: #fff;
            transform: translate(-50%, -50%) scale(1.2);
        }

        .player-label {
            position: absolute; top: 58px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white; padding: 3px 8px;
            border-radius: 4px; font-size: 0.8rem; white-space: nowrap; pointer-events: none;
            display: flex; flex-direction: column; align-items: center; gap: 2px;
        }
        .player-label span { font-size: 0.65rem; color: #bdc3c7; }

        /* SIDEBAR */
        .sidebar {
            background: var(--card-bg); border-radius: 12px;
            display: flex; flex-direction: column; overflow: hidden; border: 1px solid #444;
        }

        .sidebar-header {
            padding: 15px; background: rgba(0,0,0,0.2);
            border-bottom: 1px solid #444;
            display: flex; justify-content: space-between; align-items: center;
        }
        .sidebar-header h3 { margin: 0; font-size: 0.9rem; text-transform: uppercase; color: var(--text-muted); }
        .sidebar-header.active-mode { background-color: var(--highlight); }
        .sidebar-header.active-mode h3 { color: #1e272e; font-weight: 800; }

        .player-list { overflow-y: auto; flex-grow: 1; }

        .list-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 15px; border-bottom: 1px solid #333; font-size: 0.9rem;
            cursor: pointer; background: #2d3436; transition: 0.2s;
        }
        .list-item:hover { background: rgba(255,255,255,0.05); }
        .list-item.selected { background: rgba(241, 196, 15, 0.1); border-left: 4px solid var(--highlight); }

        .pos-badge { font-weight: bold; width: 35px; color: #888; font-size: 0.8rem; text-align: center; }
        .name-area { display: flex; flex-direction: column; }
        .trait-mini { font-size: 0.65rem; color: #aaa; }
        .ovr-badge { font-weight: bold; color: var(--secondary); font-size: 1.1rem; }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0px rgba(241, 196, 15, 0.7); } 100% { box-shadow: 0 0 0 10px rgba(241, 196, 15, 0); } }

    </style>
</head>
<body>

    <header>
        <div class="header-controls">
            <button class="action-btn btn-back" onclick="voltar()">â¬… Voltar</button>
            <h1 style="margin:0; font-size:1.2rem; text-transform:uppercase;">Prancheta</h1>
        </div>

        <div class="header-controls">
            <label style="font-size:0.9rem; color:#aaa;">FormaÃ§Ã£o:</label>
            <select id="formationSelect" onchange="aplicarFormacaoAutomatica()">
                <option value="4-4-2">4-4-2 ClÃ¡ssico</option>
                <option value="4-3-3">4-3-3 Ofensivo</option>
                <option value="3-5-2">3-5-2 Equilibrado</option>
                <option value="3-4-3">3-4-3 PressÃ£o</option>
                <option value="5-4-1">5-4-1 Retranca</option>
            </select>
            <button class="action-btn btn-save" onclick="salvarTime()">ðŸ’¾ Salvar Time</button>
        </div>
    </header>

    <main>
        <div class="field-container" id="campo">
            <div class="line mid-line"></div>
            <div class="line circle"></div>
            <div class="line area-top"></div>
            <div class="line area-bottom"></div>
            </div>

        <div class="sidebar">
            <div class="sidebar-header" id="sidebarHeader">
                <h3 id="sidebarTitle">Banco de Reservas</h3>
            </div>
            <div class="player-list" id="listaReservas">
                </div>
        </div>
    </main>

    <script>
        // --- COORDENADAS ---
        const formations = {
            "4-4-2": [ {x:50,y:90,p:'GOL'}, {x:15,y:75,p:'LE'}, {x:38,y:80,p:'ZAG'}, {x:62,y:80,p:'ZAG'}, {x:85,y:75,p:'LD'}, {x:15,y:45,p:'ME'}, {x:38,y:55,p:'VOL'}, {x:62,y:55,p:'VOL'}, {x:85,y:45,p:'MD'}, {x:35,y:15,p:'ATA'}, {x:65,y:15,p:'ATA'} ],
            "4-3-3": [ {x:50,y:90,p:'GOL'}, {x:15,y:75,p:'LE'}, {x:38,y:80,p:'ZAG'}, {x:62,y:80,p:'ZAG'}, {x:85,y:75,p:'LD'}, {x:50,y:60,p:'VOL'}, {x:30,y:45,p:'MC'}, {x:70,y:45, p:'MC'}, {x:15,y:20,p:'PE'}, {x:50,y:15,p:'ATA'}, {x:85,y:20,p:'PD'} ],
            "3-5-2": [ {x:50,y:90,p:'GOL'}, {x:25,y:80,p:'ZAG'}, {x:50,y:82,p:'ZAG'}, {x:75,y:80,p:'ZAG'}, {x:10,y:50,p:'AE'}, {x:35,y:60,p:'VOL'}, {x:65,y:60,p:'VOL'}, {x:90,y:50,p:'AD'}, {x:50,y:40,p:'MAT'}, {x:35,y:15,p:'ATA'}, {x:65,y:15,p:'ATA'} ],
            "3-4-3": [ {x:50,y:90,p:'GOL'}, {x:20,y:80,p:'ZAG'}, {x:50,y:82,p:'ZAG'}, {x:80,y:80,p:'ZAG'}, {x:10,y:50,p:'ME'}, {x:40,y:55,p:'MC'}, {x:60,y:55,p:'MC'}, {x:90,y:50,p:'MD'}, {x:20,y:20,p:'PE'}, {x:50,y:15,p:'ATA'}, {x:80,y:20,p:'PD'} ],
            "5-4-1": [ {x:50,y:90,p:'GOL'}, {x:10,y:70,p:'LE'}, {x:30,y:80,p:'ZAG'}, {x:50,y:82,p:'LIB'}, {x:70,y:80,p:'ZAG'}, {x:90,y:70,p:'LD'}, {x:20,y:50,p:'ME'}, {x:40,y:55,p:'VOL'}, {x:60,y:55,p:'VOL'}, {x:80,y:50,p:'MD'}, {x:50,y:15,p:'ATA'} ]
        };

        // --- ESTADO ---
        let gameState = null;
        let myTeamObj = null;
        let titulares = [];
        let reservas = [];
        let selectedFieldIdx = null; // Para substituiÃ§Ã£o simples
        let selectedBenchIdx = null; // Para substituiÃ§Ã£o simples

        // VariÃ¡veis de Drag & Drop
        let isDragging = false;
        let dragIdx = null;
        let startX, startY;
        let originalLeft, originalTop;

        // --- INIT ---
        window.onload = function() {
            if (typeof Engine === 'undefined') { alert("Erro de Engine"); return; }
            gameState = Engine.carregarJogo();
            if (!gameState) { window.location.href = 'index.html'; return; }

            myTeamObj = gameState.times.find(t => t.nome === gameState.meuTime) || gameState.timesContinental.find(t => t.nome === gameState.meuTime);

            titulares = myTeamObj.elenco.slice(0, 11);
            reservas = myTeamObj.elenco.slice(11);

            // CORREÃ‡ÃƒO DO BUG: Se os jogadores nÃ£o tiverem coordenadas, forÃ§a o padrÃ£o
            if (typeof titulares[0].x === 'undefined') {
                console.log("Aplicando formaÃ§Ã£o padrÃ£o inicial...");
                aplicarCoordenadasPadrao("4-4-2");
            }

            renderizarCampo();
            renderizarBanco();
        };

        // --- RENDERIZAÃ‡ÃƒO ---

        function renderizarCampo() {
            const field = document.getElementById('campo');
            const tokens = document.querySelectorAll('.player-token');
            tokens.forEach(t => t.remove());

            titulares.forEach((jog, idx) => {
                const div = document.createElement('div');
                div.className = `player-token ${selectedFieldIdx === idx ? 'selected' : ''}`;
                div.style.left = jog.x + '%';
                div.style.top = jog.y + '%';
                div.id = `player-${idx}`;
                
                if (jog.pos === 'GOL') div.style.background = "#f1c40f";

                div.innerHTML = `
                    ${jog.role || jog.pos.substring(0,2)} 
                    <div class="player-label">
                        <b>${jog.nome.split(' ')[0]}</b>
                        <span>${jog.forca} | ${jog.carac ? jog.carac.substring(0,8) : 'Norm'}</span>
                    </div>
                `;

                // EVENTOS
                div.onmousedown = (e) => iniciarArrasto(e, idx, div);
                div.onclick = (e) => { e.stopPropagation(); }

                field.appendChild(div);
            });
        }

        function renderizarBanco() {
            const list = document.getElementById('listaReservas');
            list.innerHTML = '';
            reservas.sort((a,b) => b.forca - a.forca);

            reservas.forEach((jog, idx) => {
                const div = document.createElement('div');
                div.className = `list-item ${selectedBenchIdx === idx ? 'selected' : ''}`;
                div.innerHTML = `
                    <div style="display:flex; gap:10px; align-items:center;">
                        <span class="pos-badge">${jog.pos}</span>
                        <div class="name-area">
                            <span>${jog.nome}</span>
                            <span class="trait-mini">${jog.carac}</span>
                        </div>
                    </div>
                    <span class="ovr-badge">${jog.forca}</span>
                `;
                div.onclick = () => selecionarReserva(idx);
                list.appendChild(div);
            });
        }

        // --- SISTEMA HÃBRIDO (DRAG E CLICK) ---

        let hasMoved = false;

        function iniciarArrasto(e, idx, element) {
            e.preventDefault();
            isDragging = true;
            hasMoved = false;
            dragIdx = idx;
            
            startX = e.clientX;
            startY = e.clientY;
            originalLeft = element.style.left;
            originalTop = element.style.top;

            document.onmousemove = (e) => moverElemento(e, element);
            document.onmouseup = (e) => finalizarArrasto(e, idx, element);
        }

        function moverElemento(e, element) {
            if (!isDragging) return;

            // TolerÃ¢ncia para diferenciar clique de arrasto
            if (Math.abs(e.clientX - startX) > 5 || Math.abs(e.clientY - startY) > 5) {
                hasMoved = true;
            }

            const field = document.getElementById('campo');
            const rect = field.getBoundingClientRect();

            let newX = ((e.clientX - rect.left) / rect.width) * 100;
            let newY = ((e.clientY - rect.top) / rect.height) * 100;

            if (newX < 0) newX = 0; if (newX > 100) newX = 100;
            if (newY < 0) newY = 0; if (newY > 100) newY = 100;

            element.style.left = newX + "%";
            element.style.top = newY + "%";
            element.style.zIndex = 1000;

            detectarHover(element, dragIdx);
        }

        function finalizarArrasto(e, idx, element) {
            isDragging = false;
            document.onmousemove = null;
            document.onmouseup = null;
            element.style.zIndex = "";

            if (!hasMoved) {
                element.style.left = originalLeft;
                element.style.top = originalTop;
                selecionarTitular(idx);
                return;
            }

            const alvoIdx = detectarColisao(element, idx);

            if (alvoIdx !== null) {
                trocarPosicoesCampo(idx, alvoIdx);
            } else {
                atualizarCoordenadas(idx, element.style.left, element.style.top);
            }
            
            renderizarCampo();
        }

        function detectarColisao(draggedEl, myIdx) {
            const dragRect = draggedEl.getBoundingClientRect();
            const centroX = dragRect.left + dragRect.width / 2;
            const centroY = dragRect.top + dragRect.height / 2;
            let alvoEncontrado = null;

            document.querySelectorAll('.player-token').forEach((token) => {
                const tokenIdx = parseInt(token.id.replace('player-', ''));
                if (tokenIdx === myIdx) return;

                const rect = token.getBoundingClientRect();
                if (centroX >= rect.left && centroX <= rect.right && centroY >= rect.top && centroY <= rect.bottom) {
                    alvoEncontrado = tokenIdx;
                }
            });
            return alvoEncontrado;
        }

        function detectarHover(draggedEl, myIdx) {
            const alvoIdx = detectarColisao(draggedEl, myIdx);
            document.querySelectorAll('.player-token').forEach(t => t.classList.remove('hover-swap'));
            if (alvoIdx !== null) {
                document.getElementById(`player-${alvoIdx}`).classList.add('hover-swap');
            }
        }

        // --- LÃ“GICA DE DADOS ---

        function trocarPosicoesCampo(idx1, idx2) {
            const pos1 = { x: titulares[idx1].x, y: titulares[idx1].y, role: titulares[idx1].role };
            const pos2 = { x: titulares[idx2].x, y: titulares[idx2].y, role: titulares[idx2].role };

            const temp = titulares[idx1];
            titulares[idx1] = titulares[idx2];
            titulares[idx2] = temp;

            titulares[idx1].x = pos1.x; titulares[idx1].y = pos1.y; titulares[idx1].role = pos1.role;
            titulares[idx2].x = pos2.x; titulares[idx2].y = pos2.y; titulares[idx2].role = pos2.role;
        }

        function atualizarCoordenadas(idx, leftStyle, topStyle) {
            titulares[idx].x = parseFloat(leftStyle);
            titulares[idx].y = parseFloat(topStyle);
        }

        function selecionarTitular(idx) {
            if (selectedBenchIdx !== null) {
                realizarSubstituicao(idx, selectedBenchIdx);
                limparSelecao();
                return;
            }
            selectedFieldIdx = (selectedFieldIdx === idx) ? null : idx;
            atualizarInterfaceVisual();
        }

        function selecionarReserva(idx) {
            if (selectedFieldIdx !== null) {
                realizarSubstituicao(selectedFieldIdx, idx);
                limparSelecao();
                return;
            }
            selectedBenchIdx = (selectedBenchIdx === idx) ? null : idx;
            atualizarInterfaceVisual();
        }

        function realizarSubstituicao(idxTitular, idxReserva) {
            const titularSaindo = titulares[idxTitular];
            const reservaSaindo = reservas[idxReserva];

            titulares[idxTitular] = reservaSaindo;
            reservas[idxReserva] = titularSaindo;

            titulares[idxTitular].x = titularSaindo.x;
            titulares[idxTitular].y = titularSaindo.y;
            titulares[idxTitular].role = titularSaindo.role;

            renderizarCampo();
            renderizarBanco();
        }

        function limparSelecao() {
            selectedFieldIdx = null; selectedBenchIdx = null;
            atualizarInterfaceVisual();
        }

        function atualizarInterfaceVisual() {
            renderizarCampo(); renderizarBanco();
            const header = document.getElementById('sidebarHeader');
            const title = document.getElementById('sidebarTitle');
            
            if (selectedFieldIdx !== null) {
                header.classList.add('active-mode'); title.innerText = "ðŸ” Quem entra?";
            } else if (selectedBenchIdx !== null) {
                header.classList.add('active-mode'); title.innerText = "ðŸ” Quem sai?";
            } else {
                header.classList.remove('active-mode'); title.innerText = "Banco de Reservas";
            }
        }

        function aplicarFormacaoAutomatica() {
            const formacao = document.getElementById('formationSelect').value;
            aplicarCoordenadasPadrao(formacao);
            renderizarCampo();
        }

        function aplicarCoordenadasPadrao(nomeFormacao) {
            const coords = formations[nomeFormacao];
            titulares.forEach((jog, idx) => {
                if (coords[idx]) {
                    jog.x = coords[idx].x;
                    jog.y = coords[idx].y;
                    jog.role = coords[idx].p;
                }
            });
        }

        function salvarTime() {
            const novoElenco = [...titulares, ...reservas];
            myTeamObj.elenco = novoElenco;
            Engine.salvarJogo(gameState);
            alert("âœ… Time Escalado!");
            voltar();
        }

        function voltar() { window.location.href = 'dashboard.html'; }

    </script>
</body>
</html>
