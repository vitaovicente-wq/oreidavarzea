<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRFutebol - TÃ¡ticas</title>
    
    <script src="database_jogadores.js"></script>
    <script src="engine.js"></script>

    <style>
        :root {
            --bg: #0d1115;
            --panel: #1e272e;
            --field: #27ae60;
            --line: rgba(255,255,255,0.4);
            --text: #ecf0f1;
            --accent: #f1c40f;
            --drag-hover: rgba(241, 196, 15, 0.5);
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0; padding: 0;
            height: 100vh;
            display: grid;
            grid-template-rows: 60px 1fr;
            overflow: hidden;
            user-select: none; /* Evita selecionar texto ao arrastar */
        }

        /* HEADER */
        header {
            background: rgba(30, 39, 46, 0.95);
            border-bottom: 2px solid var(--accent);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px;
        }
        .btn-back { background: #444; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-save { background: var(--accent); color: #1e272e; border: none; padding: 8px 25px; border-radius: 5px; cursor: pointer; font-weight: 800; text-transform: uppercase; }
        .btn-save:hover { transform: scale(1.05); }

        /* LAYOUT */
        main {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 10px;
            padding: 10px;
            overflow: hidden;
        }

        /* CAMPO */
        .field-container {
            position: relative;
            background: var(--field);
            border-radius: 10px;
            border: 5px solid #1a5c36;
            overflow: hidden;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.5);
            display: flex; justify-content: center;
        }
        /* Linhas */
        .field-line-center { position: absolute; top: 50%; width: 100%; height: 2px; background: var(--line); }
        .field-circle { position: absolute; top: 50%; left: 50%; width: 100px; height: 100px; border: 2px solid var(--line); border-radius: 50%; transform: translate(-50%, -50%); }
        .field-area-top { position: absolute; top: 0; left: 50%; width: 250px; height: 100px; border: 2px solid var(--line); border-top: none; transform: translateX(-50%); }
        .field-area-bottom { position: absolute; bottom: 0; left: 50%; width: 250px; height: 100px; border: 2px solid var(--line); border-bottom: none; transform: translateX(-50%); }

        /* JOGADOR (TOKEN) */
        .player-token {
            position: absolute;
            width: 90px; height: 80px;
            transform: translate(-50%, -50%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: grab;
            transition: transform 0.2s;
            z-index: 10;
        }
        .player-token:active { cursor: grabbing; }
        .player-token:hover { transform: translate(-50%, -50%) scale(1.1); z-index: 20; }
        .player-token.selected { filter: drop-shadow(0 0 8px var(--accent)); }
        
        /* Estilo visual durante o drag */
        .player-token.dragging { opacity: 0.5; }
        .player-token.drag-over { transform: translate(-50%, -50%) scale(1.2); filter: drop-shadow(0 0 10px white); }

        .token-shirt {
            width: 40px; height: 40px; background: #fff; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 0.95rem; color: #333;
            border: 3px solid #333; box-shadow: 0 4px 5px rgba(0,0,0,0.4);
        }
        .token-info {
            background: rgba(0,0,0,0.8); color: #fff;
            padding: 2px 6px; border-radius: 4px; font-size: 0.75rem;
            margin-top: 4px; text-align: center; white-space: nowrap;
            text-shadow: 1px 1px 2px black;
        }
        .token-pos { font-size: 0.65rem; color: #ccc; text-transform: uppercase; font-weight: bold; }

        /* SIDEBAR */
        .sidebar {
            background: var(--panel);
            border-radius: 10px;
            display: flex; flex-direction: column;
            overflow: hidden;
            border: 1px solid #333;
        }
        .sidebar-header { padding: 15px; background: #222; border-bottom: 1px solid #333; }
        select { width: 100%; padding: 8px; background: #111; color: #fff; border: 1px solid #444; border-radius: 5px; }

        .bench-list { flex-grow: 1; overflow-y: auto; padding: 10px; }

        .bench-item {
            background: rgba(255,255,255,0.05);
            padding: 10px; margin-bottom: 5px; border-radius: 5px;
            display: flex; justify-content: space-between; align-items: center;
            cursor: grab; border: 1px solid transparent; transition: 0.2s;
        }
        .bench-item:hover { background: rgba(255,255,255,0.1); }
        .bench-item.selected { border-color: var(--accent); background: rgba(241, 196, 15, 0.1); }
        .bench-item.dragging { opacity: 0.4; }
        .bench-item.drag-over { border: 2px dashed var(--accent); background: rgba(255,255,255,0.1); }

        .b-pos { font-weight: bold; color: #888; width: 30px; font-size: 0.8rem; }
        .b-name { flex-grow: 1; font-size: 0.9rem; }
        .b-ovr { font-weight: bold; color: var(--accent); }

        /* TOAST */
        .status-msg {
            position: fixed; top: 70px; left: 50%; transform: translateX(-50%);
            background: #2ecc71; color: #fff; padding: 10px 20px; border-radius: 20px;
            font-weight: bold; display: none; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 100;
        }
    </style>
</head>
<body>

    <header>
        <button class="btn-back" onclick="voltar()">â¬… Dashboard</button>
        <h2 style="margin:0; text-transform:uppercase; font-size:1.2rem;">Prancheta TÃ¡tica</h2>
        <button class="btn-save" onclick="salvarTime()">ðŸ’¾ Salvar</button>
    </header>

    <main>
        <div class="field-container" id="field">
            <div class="field-area-top"></div>
            <div class="field-line-center"></div>
            <div class="field-circle"></div>
            <div class="field-area-bottom"></div>
            </div>

        <div class="sidebar">
            <div class="sidebar-header">
                <label style="font-size:0.8rem; color:#aaa;">FormaÃ§Ã£o TÃ¡tica</label>
                <select id="formation-select" onchange="mudarFormacao()">
                    <option value="442">4-4-2 ClÃ¡ssico</option>
                    <option value="433">4-3-3 Ofensivo</option>
                    <option value="352">3-5-2 Equilibrado</option>
                    <option value="541">5-4-1 Retranca</option>
                </select>
                <button onclick="autoEscalar()" style="width:100%; margin-top:10px; padding:8px; background:#444; color:#fff; border:none; cursor:pointer; border-radius:4px;">
                    âš¡ Auto-Escalar (Melhores)
                </button>
            </div>

            <div style="padding:10px; background:#151a1d; font-size:0.8rem; font-weight:bold; color:#aaa; text-align:center;">
                BANCO DE RESERVAS (Arraste para o campo)
            </div>
            
            <div class="bench-list" id="bench">
                </div>
        </div>
    </main>

    <div id="toast" class="status-msg">Time salvo com sucesso!</div>

    <script>
        let gameState = null;
        let myTeamObj = null;
        let selecionadoIndex = null; // Para clique (mobile/alternativo)
        let draggedIndex = null;     // Para Drag & Drop

        // COORDENADAS (Bottom-Up)
        const formations = {
            '442': [{t:90,l:50},{t:75,l:20},{t:75,l:40},{t:75,l:60},{t:75,l:80},{t:50,l:20},{t:50,l:40},{t:50,l:60},{t:50,l:80},{t:20,l:35},{t:20,l:65}],
            '433': [{t:90,l:50},{t:75,l:15},{t:75,l:38},{t:75,l:62},{t:75,l:85},{t:50,l:30},{t:55,l:50},{t:50,l:70},{t:20,l:20},{t:15,l:50},{t:20,l:80}],
            '352': [{t:90,l:50},{t:75,l:30},{t:80,l:50},{t:75,l:70},{t:50,l:15},{t:55,l:35},{t:55,l:65},{t:50,l:85},{t:40,l:50},{t:20,l:35},{t:20,l:65}],
            '541': [{t:92,l:50},{t:80,l:10},{t:80,l:30},{t:80,l:50},{t:80,l:70},{t:80,l:90},{t:60,l:20},{t:60,l:40},{t:60,l:60},{t:60,l:80},{t:20,l:50}]
        };

        window.onload = function() {
            if (typeof Engine === 'undefined') { alert("Engine Off"); return; }
            gameState = Engine.carregarJogo();
            if (!gameState) { window.location.href = 'index.html'; return; }

            myTeamObj = Engine.encontrarTime(gameState, gameState.meuTime);
            renderizarTudo();
        };

        function renderizarTudo() {
            renderizarCampo();
            renderizarBanco();
        }

        // --- RENDERIZAÃ‡ÃƒO DO CAMPO (TITULARES) ---
        function renderizarCampo() {
            const field = document.getElementById('field');
            document.querySelectorAll('.player-token').forEach(e => e.remove());

            const formCode = document.getElementById('formation-select').value;
            const coords = formations[formCode];

            // Renderiza apenas os 11 primeiros
            for(let i=0; i<11; i++) {
                if(!myTeamObj.elenco[i]) break;
                const jog = myTeamObj.elenco[i];
                const pos = coords[i];

                const token = document.createElement('div');
                token.className = `player-token ${selecionadoIndex === i ? 'selected' : ''}`;
                token.style.top = pos.t + '%';
                token.style.left = pos.l + '%';
                token.draggable = true; // Permite arrastar

                // Cores do Over
                let borderColor = "#333";
                if(jog.forca >= 85) borderColor = "#f1c40f";
                else if(jog.forca >= 75) borderColor = "#2ecc71";

                token.innerHTML = `
                    <div class="token-shirt" style="border-color:${borderColor}">${jog.forca}</div>
                    <div class="token-info">
                        <div>${jog.nome.split(' ')[0]}</div>
                        <div class="token-pos">${jog.pos}</div>
                    </div>
                `;

                // Eventos de Drag e Click
                token.onclick = () => handleClick(i);
                token.ondragstart = (e) => handleDragStart(e, i);
                token.ondragover = (e) => handleDragOver(e);
                token.ondragleave = (e) => handleDragLeave(e);
                token.ondrop = (e) => handleDrop(e, i);

                field.appendChild(token);
            }
        }

        // --- RENDERIZAÃ‡ÃƒO DO BANCO (RESERVAS) ---
        function renderizarBanco() {
            const bench = document.getElementById('bench');
            bench.innerHTML = '';

            for(let i=11; i<myTeamObj.elenco.length; i++) {
                const jog = myTeamObj.elenco[i];
                const item = document.createElement('div');
                item.className = `bench-item ${selecionadoIndex === i ? 'selected' : ''}`;
                item.draggable = true;

                item.innerHTML = `
                    <span class="b-pos">${jog.pos}</span>
                    <span class="b-name">${jog.nome}</span>
                    <span class="b-ovr">${jog.forca}</span>
                `;

                item.onclick = () => handleClick(i);
                item.ondragstart = (e) => handleDragStart(e, i);
                item.ondragover = (e) => handleDragOver(e);
                item.ondragleave = (e) => handleDragLeave(e);
                item.ondrop = (e) => handleDrop(e, i);

                bench.appendChild(item);
            }
        }

        // --- LÃ“GICA DE CLIQUE (FALLBACK) ---
        function handleClick(index) {
            if (selecionadoIndex === null) {
                selecionadoIndex = index;
                renderizarTudo();
            } else if (selecionadoIndex === index) {
                selecionadoIndex = null;
                renderizarTudo();
            } else {
                trocarJogadores(selecionadoIndex, index);
                selecionadoIndex = null;
            }
        }

        // --- LÃ“GICA DE DRAG & DROP (PRINCIPAL) ---
        
        function handleDragStart(e, index) {
            draggedIndex = index;
            e.dataTransfer.effectAllowed = 'move';
            // Adiciona classe visual
            e.target.classList.add('dragging');
        }

        function handleDragOver(e) {
            e.preventDefault(); // NecessÃ¡rio para permitir o drop
            e.dataTransfer.dropEffect = 'move';
            
            // Adiciona feedback visual no alvo
            const target = e.currentTarget;
            if (!target.classList.contains('drag-over')) {
                target.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function handleDrop(e, targetIndex) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            
            // Se soltar no mesmo lugar, nÃ£o faz nada
            if (draggedIndex === targetIndex || draggedIndex === null) return;

            trocarJogadores(draggedIndex, targetIndex);
            draggedIndex = null;
        }

        // --- FUNÃ‡ÃƒO DE TROCA (CORE) ---
        function trocarJogadores(idx1, idx2) {
            const temp = myTeamObj.elenco[idx1];
            myTeamObj.elenco[idx1] = myTeamObj.elenco[idx2];
            myTeamObj.elenco[idx2] = temp;
            renderizarTudo();
        }

        // --- OUTRAS FUNÃ‡Ã•ES ---
        function mudarFormacao() { renderizarCampo(); }

        function autoEscalar() {
            const melhores = Engine.escolherMelhores11(myTeamObj.elenco);
            const idsMelhores = melhores.map(j => j.id);
            const resto = myTeamObj.elenco.filter(j => !idsMelhores.includes(j.id));
            myTeamObj.elenco = [...melhores, ...resto];
            renderizarTudo();
        }

        function salvarTime() {
            const formCode = document.getElementById('formation-select').value;
            const coords = formations[formCode];
            for(let i=0; i<11; i++) {
                if(myTeamObj.elenco[i]) {
                    myTeamObj.elenco[i].x = coords[i].l;
                    myTeamObj.elenco[i].y = coords[i].t;
                }
            }
            Engine.salvarJogo(gameState);
            const toast = document.getElementById('toast');
            toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, 2000);
        }

        function voltar() { window.location.href = 'dashboard.html'; }

    </script>
</body>
</html>
