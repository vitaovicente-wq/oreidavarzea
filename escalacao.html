<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRFutebol - T√°ticas</title>
    
    <script src="database_jogadores.js"></script>
    <script src="engine.js"></script>

    <style>
        :root {
            --bg: #0d1115;
            --panel: #1e272e;
            --field: #27ae60;
            --line: rgba(255,255,255,0.4);
            --text: #ecf0f1;
            --accent: #f1c40f;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0; padding: 0;
            height: 100vh;
            display: grid;
            grid-template-rows: 60px 1fr;
            overflow: hidden;
        }

        /* HEADER */
        header {
            background: rgba(30, 39, 46, 0.95);
            border-bottom: 2px solid var(--accent);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px;
        }
        .btn-back { background: #444; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-save { background: var(--accent); color: #1e272e; border: none; padding: 8px 25px; border-radius: 5px; cursor: pointer; font-weight: 800; text-transform: uppercase; }
        .btn-save:hover { transform: scale(1.05); }

        /* LAYOUT PRINCIPAL */
        main {
            display: grid;
            grid-template-columns: 1fr 300px; /* Campo | Banco */
            gap: 10px;
            padding: 10px;
            overflow: hidden;
        }

        /* CAMPO DE JOGO */
        .field-container {
            position: relative;
            background: var(--field);
            border-radius: 10px;
            border: 5px solid #1a5c36;
            overflow: hidden;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.5);
            display: flex; justify-content: center;
        }

        /* Linhas do Campo */
        .field-line-center { position: absolute; top: 50%; width: 100%; height: 2px; background: var(--line); }
        .field-circle { position: absolute; top: 50%; left: 50%; width: 100px; height: 100px; border: 2px solid var(--line); border-radius: 50%; transform: translate(-50%, -50%); }
        .field-area-top { position: absolute; top: 0; left: 50%; width: 250px; height: 100px; border: 2px solid var(--line); border-top: none; transform: translateX(-50%); }
        .field-area-bottom { position: absolute; bottom: 0; left: 50%; width: 250px; height: 100px; border: 2px solid var(--line); border-bottom: none; transform: translateX(-50%); }

        /* JOGADOR NO CAMPO (TOKEN) */
        .player-token {
            position: absolute;
            width: 90px; height: 80px;
            transform: translate(-50%, -50%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer;
            transition: 0.2s;
            z-index: 10;
        }
        .player-token:hover { transform: translate(-50%, -50%) scale(1.1); z-index: 20; }
        .player-token.selected { filter: drop-shadow(0 0 10px var(--accent)); }

        .token-shirt {
            width: 35px; height: 35px; background: #fff; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 0.9rem; color: #333;
            border: 3px solid #333; box-shadow: 0 4px 5px rgba(0,0,0,0.4);
        }
        .token-info {
            background: rgba(0,0,0,0.7); color: #fff;
            padding: 2px 6px; border-radius: 4px; font-size: 0.75rem;
            margin-top: 4px; text-align: center; white-space: nowrap;
        }
        .token-pos { font-size: 0.65rem; color: #aaa; text-transform: uppercase; }

        /* SIDEBAR (BANCO E OP√á√ïES) */
        .sidebar {
            background: var(--panel);
            border-radius: 10px;
            display: flex; flex-direction: column;
            overflow: hidden;
            border: 1px solid #333;
        }

        .sidebar-header {
            padding: 15px; background: #222; border-bottom: 1px solid #333;
        }
        
        select {
            width: 100%; padding: 8px; background: #111; color: #fff; border: 1px solid #444; border-radius: 5px;
        }

        .bench-list {
            flex-grow: 1; overflow-y: auto; padding: 10px;
        }

        .bench-item {
            background: rgba(255,255,255,0.05);
            padding: 10px; margin-bottom: 5px; border-radius: 5px;
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; border: 1px solid transparent;
        }
        .bench-item:hover { background: rgba(255,255,255,0.1); }
        .bench-item.selected { border-color: var(--accent); background: rgba(241, 196, 15, 0.1); }

        .b-pos { font-weight: bold; color: #888; width: 30px; font-size: 0.8rem; }
        .b-name { flex-grow: 1; font-size: 0.9rem; }
        .b-ovr { font-weight: bold; color: var(--accent); }

        .status-msg {
            position: fixed; top: 70px; left: 50%; transform: translateX(-50%);
            background: #2ecc71; color: #fff; padding: 10px 20px; border-radius: 20px;
            font-weight: bold; display: none; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

    </style>
</head>
<body>

    <header>
        <button class="btn-back" onclick="voltar()">‚¨Ö Dashboard</button>
        <h2 style="margin:0; text-transform:uppercase; font-size:1.2rem;">Prancheta T√°tica</h2>
        <button class="btn-save" onclick="salvarTime()">üíæ Salvar</button>
    </header>

    <main>
        <div class="field-container" id="field">
            <div class="field-area-top"></div>
            <div class="field-line-center"></div>
            <div class="field-circle"></div>
            <div class="field-area-bottom"></div>
            
            </div>

        <div class="sidebar">
            <div class="sidebar-header">
                <label style="font-size:0.8rem; color:#aaa;">Forma√ß√£o T√°tica</label>
                <select id="formation-select" onchange="mudarFormacao()">
                    <option value="442">4-4-2 Cl√°ssico</option>
                    <option value="433">4-3-3 Ofensivo</option>
                    <option value="352">3-5-2 Equilibrado</option>
                    <option value="541">5-4-1 Retranca</option>
                </select>
                
                <button onclick="autoEscalar()" style="width:100%; margin-top:10px; padding:8px; background:#444; color:#fff; border:none; cursor:pointer; border-radius:4px;">
                    ‚ö° Auto-Escalar (Melhores)
                </button>
            </div>

            <div style="padding:10px; background:#151a1d; font-size:0.8rem; font-weight:bold; color:#aaa; text-align:center;">
                BANCO DE RESERVAS
            </div>
            
            <div class="bench-list" id="bench">
                </div>
        </div>
    </main>

    <div id="toast" class="status-msg">Time salvo com sucesso!</div>

    <script>
        let gameState = null;
        let myTeamObj = null;
        let selecionadoIndex = null; // √çndice do jogador clicado (0-10 campo, 11+ banco)

        // COORDENADAS DAS FORMA√á√ïES (Top %, Left %)
        // O campo √© vertical: Top 0% = Gol Advers√°rio (n√£o usamos), Bottom 100% = Nosso Gol
        // Vamos usar Bottom-Up: Goleiro fica perto de 90%, Atacante perto de 10%
        const formations = {
            '442': [
                {t: 90, l: 50}, // GOL
                {t: 75, l: 20}, {t: 75, l: 40}, {t: 75, l: 60}, {t: 75, l: 80}, // DEF
                {t: 50, l: 20}, {t: 50, l: 40}, {t: 50, l: 60}, {t: 50, l: 80}, // MEI
                {t: 20, l: 35}, {t: 20, l: 65}  // ATA
            ],
            '433': [
                {t: 90, l: 50},
                {t: 75, l: 15}, {t: 75, l: 38}, {t: 75, l: 62}, {t: 75, l: 85},
                {t: 50, l: 30}, {t: 55, l: 50}, {t: 50, l: 70},
                {t: 20, l: 20}, {t: 15, l: 50}, {t: 20, l: 80}
            ],
            '352': [
                {t: 90, l: 50},
                {t: 75, l: 30}, {t: 80, l: 50}, {t: 75, l: 70}, // 3 Zag
                {t: 50, l: 15}, {t: 55, l: 35}, {t: 55, l: 65}, {t: 50, l: 85}, {t: 40, l: 50}, // 5 Meia
                {t: 20, l: 35}, {t: 20, l: 65}
            ],
            '541': [
                {t: 92, l: 50},
                {t: 80, l: 10}, {t: 80, l: 30}, {t: 80, l: 50}, {t: 80, l: 70}, {t: 80, l: 90},
                {t: 60, l: 20}, {t: 60, l: 40}, {t: 60, l: 60}, {t: 60, l: 80},
                {t: 20, l: 50}
            ]
        };

        window.onload = function() {
            if (typeof Engine === 'undefined') { alert("Engine Off"); return; }
            gameState = Engine.carregarJogo();
            if (!gameState) { window.location.href = 'index.html'; return; }

            // Acha o time na nova estrutura global
            myTeamObj = Engine.encontrarTime(gameState, gameState.meuTime);
            
            renderizarTudo();
        };

        function renderizarTudo() {
            renderizarCampo();
            renderizarBanco();
        }

        function renderizarCampo() {
            const field = document.getElementById('field');
            // Limpa jogadores antigos (mant√©m as linhas do campo que s√£o div filhos)
            // Maneira segura: remove apenas elements com class player-token
            document.querySelectorAll('.player-token').forEach(e => e.remove());

            // Pega a forma√ß√£o selecionada
            const formCode = document.getElementById('formation-select').value;
            const coords = formations[formCode];

            // Os primeiros 11 do array 'elenco' s√£o os titulares
            for(let i=0; i<11; i++) {
                if(!myTeamObj.elenco[i]) break; // Seguran√ßa

                const jog = myTeamObj.elenco[i];
                const pos = coords[i];

                const token = document.createElement('div');
                token.className = `player-token ${selecionadoIndex === i ? 'selected' : ''}`;
                token.style.top = pos.t + '%';
                token.style.left = pos.l + '%';
                token.onclick = () => clicarJogador(i);

                // Cor da camisa baseada no overall
                let borderColor = "#333";
                if(jog.forca >= 85) borderColor = "#f1c40f"; // Ouro
                else if(jog.forca >= 75) borderColor = "#2ecc71"; // Verde

                token.innerHTML = `
                    <div class="token-shirt" style="border-color:${borderColor}">
                        ${jog.forca}
                    </div>
                    <div class="token-info">
                        <div>${jog.nome.split(' ')[0]}</div>
                        <div class="token-pos">${jog.pos}</div>
                    </div>
                `;
                field.appendChild(token);
            }
        }

        function renderizarBanco() {
            const bench = document.getElementById('bench');
            bench.innerHTML = '';

            // Do √≠ndice 11 at√© o fim s√£o reservas
            for(let i=11; i<myTeamObj.elenco.length; i++) {
                const jog = myTeamObj.elenco[i];
                
                const item = document.createElement('div');
                item.className = `bench-item ${selecionadoIndex === i ? 'selected' : ''}`;
                item.onclick = () => clicarJogador(i);
                
                item.innerHTML = `
                    <span class="b-pos">${jog.pos}</span>
                    <span class="b-name">${jog.nome}</span>
                    <span class="b-ovr">${jog.forca}</span>
                `;
                bench.appendChild(item);
            }
        }

        function clicarJogador(index) {
            // Se n√£o tinha ningu√©m selecionado, seleciona este
            if (selecionadoIndex === null) {
                selecionadoIndex = index;
                renderizarTudo(); // Atualiza visual (bordas)
                return;
            }

            // Se clicou no mesmo, deseleciona
            if (selecionadoIndex === index) {
                selecionadoIndex = null;
                renderizarTudo();
                return;
            }

            // Se clicou em outro, TROCA DE POSI√á√ÉO
            trocarJogadores(selecionadoIndex, index);
            selecionadoIndex = null; // Limpa sele√ß√£o
        }

        function trocarJogadores(idx1, idx2) {
            // Troca simples no array
            const temp = myTeamObj.elenco[idx1];
            myTeamObj.elenco[idx1] = myTeamObj.elenco[idx2];
            myTeamObj.elenco[idx2] = temp;

            renderizarTudo();
        }

        function mudarFormacao() {
            renderizarCampo();
        }

        function autoEscalar() {
            // Usa o algoritmo do Engine para escolher os melhores 11
            const melhores = Engine.escolherMelhores11(myTeamObj.elenco);
            
            // Coloca os melhores nos primeiros 11 √≠ndices
            // E o resto depois
            const novosTitularesIDs = melhores.map(j => j.id);
            const reservas = myTeamObj.elenco.filter(j => !novosTitularesIDs.includes(j.id));
            
            // Reconstr√≥i o array: Melhores + Resto
            myTeamObj.elenco = [...melhores, ...reservas];
            
            renderizarTudo();
        }

        function salvarTime() {
            // Salva coordenadas da t√°tica atual nos jogadores titulares
            // Isso ajuda o engine a saber que o usu√°rio definiu uma t√°tica personalizada
            const formCode = document.getElementById('formation-select').value;
            const coords = formations[formCode];

            // Marca os 11 primeiros com X e Y (apenas flag pro Engine saber que t√° escalado)
            for(let i=0; i<11; i++) {
                if(myTeamObj.elenco[i]) {
                    myTeamObj.elenco[i].x = coords[i].l;
                    myTeamObj.elenco[i].y = coords[i].t;
                }
            }

            // Salva no LocalStorage
            Engine.salvarJogo(gameState);

            // Feedback Visual
            const toast = document.getElementById('toast');
            toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, 2000);
        }

        function voltar() {
            window.location.href = 'dashboard.html';
        }

    </script>
</body>
</html>
