<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRFutebol - Prancheta T√°tica</title>
    
    <script src="database_jogadores.js"></script>
    <script src="engine.js"></script>

    <style>
        :root {
            --primary: #1e272e;
            --secondary: #0fb9b1;
            --highlight: #f1c40f; /* Cor de sele√ß√£o */
            --bg: #0d1115;
            --card-bg: #2d3436;
            --text: #ecf0f1;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0; padding: 0;
            display: grid; grid-template-rows: 70px 1fr;
            height: 100vh; overflow: hidden;
            user-select: none;
        }

        /* HEADER */
        header {
            background-color: rgba(30, 39, 46, 0.95);
            border-bottom: 2px solid var(--secondary);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 30px;
        }

        .header-controls { display: flex; align-items: center; gap: 20px; }

        select {
            background: #1e272e; color: white; border: 1px solid #555;
            padding: 8px 15px; border-radius: 6px; font-size: 1rem; cursor: pointer;
        }

        .action-btn { padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; border: none; transition: 0.2s; }
        .btn-back { background: #444; color: #fff; }
        .btn-save { background: var(--secondary); color: #1e272e; text-transform: uppercase; }
        .btn-save:hover { box-shadow: 0 0 15px rgba(15, 185, 177, 0.4); transform: scale(1.05); }

        /* LAYOUT */
        main {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 20px; padding: 20px; height: 100%; box-sizing: border-box;
        }

        /* CAMPO */
        .field-container {
            background: linear-gradient(180deg, #27ae60 0%, #2ecc71 100%);
            border: 4px solid #fff; border-radius: 12px;
            position: relative; box-shadow: inset 0 0 80px rgba(0,0,0,0.5);
            margin: 0 auto; width: 100%; max-width: 750px; height: 100%;
        }

        .line { position: absolute; background: rgba(255,255,255,0.4); pointer-events: none; }
        .mid-line { width: 100%; height: 2px; top: 50%; }
        .circle { width: 100px; height: 100px; border: 2px solid rgba(255,255,255,0.4); border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .area-top { width: 40%; height: 16%; border: 2px solid rgba(255,255,255,0.4); border-top: none; top: 0; left: 30%; }
        .area-bottom { width: 40%; height: 16%; border: 2px solid rgba(255,255,255,0.4); border-bottom: none; bottom: 0; left: 30%; }

        /* JOGADOR NO CAMPO (TOKEN) */
        .player-token {
            position: absolute; width: 55px; height: 55px;
            background: #fff; border: 3px solid #333; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: 800; color: #333; font-size: 0.9rem;
            cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.4);
            transform: translate(-50%, -50%); z-index: 10;
            transition: all 0.2s;
        }

        .player-token:hover { transform: translate(-50%, -50%) scale(1.1); }

        /* Efeito de Sele√ß√£o */
        .player-token.selected {
            border-color: var(--highlight);
            background-color: #fff;
            box-shadow: 0 0 0 4px var(--highlight), 0 0 20px var(--highlight);
            z-index: 20;
            animation: pulse 1s infinite;
        }

        .player-label {
            position: absolute; top: 58px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white; padding: 3px 8px;
            border-radius: 4px; font-size: 0.8rem; white-space: nowrap; pointer-events: none;
            display: flex; flex-direction: column; align-items: center; gap: 2px;
        }
        .player-label span { font-size: 0.65rem; color: #bdc3c7; }

        /* SIDEBAR (RESERVAS) */
        .sidebar {
            background: var(--card-bg); border-radius: 12px;
            display: flex; flex-direction: column; overflow: hidden; border: 1px solid #444;
        }

        .sidebar-header {
            padding: 15px; background: rgba(0,0,0,0.2);
            border-bottom: 1px solid #444;
            display: flex; justify-content: space-between; align-items: center;
        }
        
        .sidebar-header h3 { margin: 0; font-size: 0.9rem; text-transform: uppercase; color: var(--text-muted); }
        .sidebar-header.active-mode { background-color: var(--highlight); }
        .sidebar-header.active-mode h3 { color: #1e272e; font-weight: 800; }

        .player-list { overflow-y: auto; flex-grow: 1; }

        .list-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 15px; border-bottom: 1px solid #333; font-size: 0.9rem;
            cursor: pointer; background: #2d3436; transition: 0.2s;
        }
        .list-item:hover { background: rgba(255,255,255,0.05); border-left: 4px solid #aaa; }
        
        /* Item Selecionado na Lista */
        .list-item.selected {
            background: rgba(241, 196, 15, 0.1);
            border-left: 4px solid var(--highlight);
        }

        .pos-badge { font-weight: bold; width: 35px; color: #888; font-size: 0.8rem; text-align: center; }
        .name-area { display: flex; flex-direction: column; }
        .trait-mini { font-size: 0.65rem; color: #aaa; }
        .ovr-badge { font-weight: bold; color: var(--secondary); font-size: 1.1rem; }

        /* Instru√ß√£o Flutuante */
        #instruction-toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.9); color: white; padding: 10px 20px;
            border-radius: 30px; font-weight: bold; border: 1px solid var(--highlight);
            display: none; box-shadow: 0 5px 20px rgba(0,0,0,0.5); z-index: 1000;
        }

        @keyframes pulse { 0% { transform:translate(-50%, -50%) scale(1); } 50% { transform:translate(-50%, -50%) scale(1.1); } 100% { transform:translate(-50%, -50%) scale(1); } }

    </style>
</head>
<body>

    <header>
        <div class="header-controls">
            <button class="action-btn btn-back" onclick="voltar()">‚¨Ö Voltar</button>
            <h1 style="margin:0; font-size:1.2rem; text-transform:uppercase;">Prancheta</h1>
        </div>

        <div class="header-controls">
            <label style="font-size:0.9rem; color:#aaa;">Forma√ß√£o:</label>
            <select id="formationSelect" onchange="aplicarFormacaoAutomatica()">
                <option value="4-4-2">4-4-2 Cl√°ssico</option>
                <option value="4-3-3">4-3-3 Ofensivo</option>
                <option value="3-5-2">3-5-2 Equilibrado</option>
                <option value="3-4-3">3-4-3 Press√£o</option>
                <option value="5-4-1">5-4-1 Retranca</option>
            </select>
            <button class="action-btn btn-save" onclick="salvarTime()">üíæ Salvar Time</button>
        </div>
    </header>

    <main>
        <div class="field-container" id="campo" onclick="cliqueNoCampoVazio(event)">
            <div class="line mid-line"></div>
            <div class="line circle"></div>
            <div class="line area-top"></div>
            <div class="line area-bottom"></div>
            
            </div>

        <div class="sidebar">
            <div class="sidebar-header" id="sidebarHeader">
                <h3 id="sidebarTitle">Banco de Reservas</h3>
            </div>
            <div class="player-list" id="listaReservas">
                </div>
        </div>
    </main>

    <div id="instruction-toast">Selecione quem entra...</div>

    <script>
        // --- COORDENADAS ---
        const formations = {
            "4-4-2": [ {x:50,y:90,p:'GOL'}, {x:15,y:75,p:'LE'}, {x:38,y:80,p:'ZAG'}, {x:62,y:80,p:'ZAG'}, {x:85,y:75,p:'LD'}, {x:15,y:45,p:'ME'}, {x:38,y:55,p:'VOL'}, {x:62,y:55,p:'VOL'}, {x:85,y:45,p:'MD'}, {x:35,y:15,p:'ATA'}, {x:65,y:15,p:'ATA'} ],
            "4-3-3": [ {x:50,y:90,p:'GOL'}, {x:15,y:75,p:'LE'}, {x:38,y:80,p:'ZAG'}, {x:62,y:80,p:'ZAG'}, {x:85,y:75,p:'LD'}, {x:50,y:60,p:'VOL'}, {x:30,y:45,p:'MC'}, {x:70,y:45, p:'MC'}, {x:15,y:20,p:'PE'}, {x:50,y:15,p:'ATA'}, {x:85,y:20,p:'PD'} ],
            "3-5-2": [ {x:50,y:90,p:'GOL'}, {x:25,y:80,p:'ZAG'}, {x:50,y:82,p:'ZAG'}, {x:75,y:80,p:'ZAG'}, {x:10,y:50,p:'AE'}, {x:35,y:60,p:'VOL'}, {x:65,y:60,p:'VOL'}, {x:90,y:50,p:'AD'}, {x:50,y:40,p:'MAT'}, {x:35,y:15,p:'ATA'}, {x:65,y:15,p:'ATA'} ],
            "3-4-3": [ {x:50,y:90,p:'GOL'}, {x:20,y:80,p:'ZAG'}, {x:50,y:82,p:'ZAG'}, {x:80,y:80,p:'ZAG'}, {x:10,y:50,p:'ME'}, {x:40,y:55,p:'MC'}, {x:60,y:55,p:'MC'}, {x:90,y:50,p:'MD'}, {x:20,y:20,p:'PE'}, {x:50,y:15,p:'ATA'}, {x:80,y:20,p:'PD'} ],
            "5-4-1": [ {x:50,y:90,p:'GOL'}, {x:10,y:70,p:'LE'}, {x:30,y:80,p:'ZAG'}, {x:50,y:82,p:'LIB'}, {x:70,y:80,p:'ZAG'}, {x:90,y:70,p:'LD'}, {x:20,y:50,p:'ME'}, {x:40,y:55,p:'VOL'}, {x:60,y:55,p:'VOL'}, {x:80,y:50,p:'MD'}, {x:50,y:15,p:'ATA'} ]
        };

        // --- ESTADO ---
        let gameState = null;
        let myTeamObj = null;
        let titulares = [];
        let reservas = [];
        
        // Vari√°veis de Sele√ß√£o
        let selectedFieldIdx = null; // √çndice do titular selecionado
        let selectedBenchIdx = null; // √çndice do reserva selecionado

        // --- INIT ---
        window.onload = function() {
            if (typeof Engine === 'undefined') { alert("Erro de Engine"); return; }
            gameState = Engine.carregarJogo();
            if (!gameState) { window.location.href = 'index.html'; return; }

            myTeamObj = gameState.times.find(t => t.nome === gameState.meuTime) || gameState.timesContinental.find(t => t.nome === gameState.meuTime);

            titulares = myTeamObj.elenco.slice(0, 11);
            reservas = myTeamObj.elenco.slice(11);

            if(!titulares[0].x) aplicarCoordenadasPadrao("4-4-2");

            atualizarTela();
        };

        // --- RENDERIZA√á√ÉO ---

        function atualizarTela() {
            renderizarCampo();
            renderizarBanco();
            atualizarFeedbackVisual();
        }

        function renderizarCampo() {
            const field = document.getElementById('campo');
            // Limpa players antigos
            const tokens = document.querySelectorAll('.player-token');
            tokens.forEach(t => t.remove());

            titulares.forEach((jog, idx) => {
                const div = document.createElement('div');
                div.className = `player-token ${selectedFieldIdx === idx ? 'selected' : ''}`;
                div.style.left = jog.x + '%';
                div.style.top = jog.y + '%';
                
                if (jog.pos === 'GOL') div.style.background = "#f1c40f";

                div.innerHTML = `
                    ${jog.role || jog.pos.substring(0,2)} 
                    <div class="player-label">
                        <b>${jog.nome.split(' ')[0]}</b>
                        <span>${jog.forca} | ${jog.carac.substring(0,8)}</span>
                    </div>
                `;

                // CLIQUE NO JOGADOR DE CAMPO
                div.onclick = (e) => {
                    e.stopPropagation(); // N√£o clica no campo
                    selecionarTitular(idx);
                };

                field.appendChild(div);
            });
        }

        function renderizarBanco() {
            const list = document.getElementById('listaReservas');
            list.innerHTML = '';

            reservas.sort((a,b) => b.forca - a.forca);

            reservas.forEach((jog, idx) => {
                const div = document.createElement('div');
                div.className = `list-item ${selectedBenchIdx === idx ? 'selected' : ''}`;

                div.innerHTML = `
                    <div style="display:flex; gap:10px; align-items:center;">
                        <span class="pos-badge">${jog.pos}</span>
                        <div class="name-area">
                            <span>${jog.nome}</span>
                            <span class="trait-mini">${jog.carac}</span>
                        </div>
                    </div>
                    <span class="ovr-badge">${jog.forca}</span>
                `;

                // CLIQUE NO RESERVA
                div.onclick = () => selecionarReserva(idx);

                list.appendChild(div);
            });
        }

        // --- L√ìGICA DE SELE√á√ÉO E TROCA ---

        function selecionarTitular(idx) {
            // Se j√° tem um reserva selecionado -> REALIZA A TROCA
            if (selectedBenchIdx !== null) {
                realizarSubstituicao(idx, selectedBenchIdx);
                limparSelecao();
                return;
            }

            // Se clicou no mesmo, desseleciona
            if (selectedFieldIdx === idx) {
                selectedFieldIdx = null;
            } else {
                selectedFieldIdx = idx;
            }
            atualizarTela();
        }

        function selecionarReserva(idx) {
            // Se j√° tem um titular selecionado -> REALIZA A TROCA
            if (selectedFieldIdx !== null) {
                realizarSubstituicao(selectedFieldIdx, idx);
                limparSelecao();
                return;
            }

            // Se clicou no mesmo, desseleciona
            if (selectedBenchIdx === idx) {
                selectedBenchIdx = null;
            } else {
                selectedBenchIdx = idx;
            }
            atualizarTela();
        }

        function realizarSubstituicao(idxTitular, idxReserva) {
            const titularSaindo = titulares[idxTitular];
            const reservaSaindo = reservas[idxReserva];

            // Troca arrays
            titulares[idxTitular] = reservaSaindo;
            reservas[idxReserva] = titularSaindo;

            // Mant√©m coordenadas e fun√ß√£o t√°tica
            titulares[idxTitular].x = titularSaindo.x;
            titulares[idxTitular].y = titularSaindo.y;
            titulares[idxTitular].role = titularSaindo.role;

            mostrarToast(`üîÑ Saiu: ${titularSaindo.nome} / Entrou: ${reservaSaindo.nome}`);
            atualizarTela();
        }

        function cliqueNoCampoVazio(e) {
            // Se clicar no gramado, limpa a sele√ß√£o
            if (e.target.id === 'campo') {
                limparSelecao();
                atualizarTela();
            }
        }

        function limparSelecao() {
            selectedFieldIdx = null;
            selectedBenchIdx = null;
            atualizarTela();
        }

        // --- FEEDBACK VISUAL ---

        function atualizarFeedbackVisual() {
            const header = document.getElementById('sidebarHeader');
            const title = document.getElementById('sidebarTitle');
            const toast = document.getElementById('instruction-toast');

            if (selectedFieldIdx !== null) {
                // Modo: Escolher substituto
                header.classList.add('active-mode');
                title.innerText = "üîÅ Selecione quem entra...";
                toast.innerText = "Selecione um reserva para entrar";
                toast.style.display = "block";
            } 
            else if (selectedBenchIdx !== null) {
                // Modo: Escolher quem sai
                header.classList.add('active-mode');
                title.innerText = "üîÅ Selecione quem sai...";
                toast.innerText = "Clique num jogador no campo para substituir";
                toast.style.display = "block";
            } 
            else {
                // Modo normal
                header.classList.remove('active-mode');
                title.innerText = "Banco de Reservas";
                toast.style.display = "none";
            }
        }

        function mostrarToast(msg) {
            const toast = document.getElementById('instruction-toast');
            toast.innerText = msg;
            toast.style.display = 'block';
            toast.style.borderColor = '#2ecc71';
            setTimeout(() => { 
                toast.style.display = 'none'; 
                toast.style.borderColor = '#f1c40f'; // Volta cor original
            }, 3000);
        }

        // --- FORMA√á√ÉO E SALVAMENTO ---

        function aplicarFormacaoAutomatica() {
            const formacao = document.getElementById('formationSelect').value;
            aplicarCoordenadasPadrao(formacao);
            renderizarCampo();
        }

        function aplicarCoordenadasPadrao(nomeFormacao) {
            const coords = formations[nomeFormacao];
            titulares.forEach((jog, idx) => {
                if (coords[idx]) {
                    jog.x = coords[idx].x;
                    jog.y = coords[idx].y;
                    jog.role = coords[idx].p;
                }
            });
        }

        function salvarTime() {
            const novoElenco = [...titulares, ...reservas];
            myTeamObj.elenco = novoElenco;
            Engine.salvarJogo(gameState);
            alert("‚úÖ Time Escalado com Sucesso!");
            voltar();
        }

        function voltar() {
            window.location.href = 'dashboard.html';
        }

    </script>
</body>
</html>
