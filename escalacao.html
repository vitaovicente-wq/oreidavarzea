<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>O Rei da V√°rzea ‚Äî Escala√ß√£o</title>
<style>
  :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
  body{margin:0;background:#f5f7fb;color:#111}
  header{background:#0b6bd6;color:#fff;padding:14px 18px}
  .container{max-width:1100px;margin:18px auto;padding:10px}
  .card{background:#fff;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.06);padding:16px;margin-bottom:16px;}
  label{display:block;margin-top:8px}
  input[type=text]{width:100%;padding:10px;border:1px solid #ddd;border-radius:6px}
  button{background:#0b6bd6;color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
  button[disabled]{opacity:0.45;cursor:default}
  .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:20px}
  .muted{color:#666;font-size:13px}
  .bench{display:flex;flex-direction:column;gap:6px;max-height:260px;overflow:auto;padding:8px;border:1px dashed #ccc;border-radius:8px}
  .player-card{padding:8px;border-radius:8px;background:#fff;border:1px solid #eee;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center}
  .position-slot{width:140px;height:50px;border-radius:8px;background:rgba(255,255,255,0.95);display:flex;align-items:center;justify-content:center;cursor:pointer;margin:8px;border:2px dashed #ccc;transition:all 0.3s;font-size:12px;text-align:center;flex-direction:column;padding:5px}
  .position-slot:hover{background:rgba(255,255,255,0.8);border-color:#0b6bd6}
  .position-slot.assigned{background:#e8f5e8;border:2px solid #4CAF50}
  .notif{position:fixed;top:18px;right:18px;background:#ffefc2;color:#333;padding:10px 14px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,.12);border:1px solid #e6b800}
  .health-bar{width:60px;height:8px;background:#eee;border-radius:4px;overflow:hidden;display:inline-block;margin-left:8px;vertical-align:middle}
  .health-fill{height:100%;background:#4CAF50;transition:width 0.3s}
  .skill-bar{width:80px;height:8px;background:#eee;border-radius:4px;overflow:hidden;display:inline-block;margin-left:8px;vertical-align:middle}
  .skill-fill{height:100%;background:#9c27b0;transition:width 0.3s}
  .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
  .modal-content { background-color: #fff; margin: 5% auto; padding: 20px; border-radius: 10px; width: 80%; max-width: 600px; max-height: 80vh; overflow-y: auto; }
  .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
  .close:hover { color: #000; }
  .player-list-modal { display: flex; flex-direction: column; gap: 8px; margin-top: 15px; }
  .modal-player-item { padding: 10px; border: 1px solid #eee; border-radius: 6px; cursor: pointer; transition: background-color 0.2s; }
  .modal-player-item:hover { background-color: #f5f7fb; }
  .formation-line { display: flex; justify-content: center; align-items: center; gap: 20px; margin: 15px 0; }
  .pitch { width: 100%; height: 600px; background: linear-gradient(#73c26b, #5eb95e); border-radius: 12px; padding: 30px; box-sizing: border-box; position: relative; }
  .attack-line { margin-top: 150px; }
  .midfield-line { margin-top: 100px; }
  .defense-line { margin-top: 50px; }
  .goalkeeper-line { margin-top: 10px; }
  a { text-decoration: none; }
</style>
</head>
<body>
<header>
  <div class="container"><h1 id="headerTitle">O Rei da V√°rzea</h1></div>
</header>

<div class="container">
  <div id="tela3" class="card">
    <h2>Tela 3 ‚Äî Escala√ß√£o (Forma√ß√£o 4-4-2)</h2>
    
    <div class="card">
      <h3>Escala√ß√£o Principal</h3>
      <div class="pitch" id="pitch">
        <div class="formation-line goalkeeper-line">
          <div class="position-slot" data-pos="Goleiro" id="slot-GK">
            <div>üß§ Goleiro</div> <div class="muted">Clique para escalar</div>
          </div>
        </div>
        <div class="formation-line defense-line">
          <div class="position-slot" data-pos="Lateral Esquerdo" id="slot-LB">
            <div>‚¨ÖÔ∏è Lateral Esquerdo</div> <div class="muted">Clique para escalar</div>
          </div>
          <div class="position-slot" data-pos="Zagueiro" id="slot-CB1">
            <div>üõ°Ô∏è Zagueiro</div> <div class="muted">Clique para escalar</div>
          </div>
          <div class="position-slot" data-pos="Zagueiro" id="slot-CB2">
            <div>üõ°Ô∏è Zagueiro</div> <div class="muted">Clique para escalar</div>
          </div>
          <div class="position-slot" data-pos="Lateral Direito" id="slot-RB">
            <div>‚û°Ô∏è Lateral Direito</div> <div class="muted">Clique para escalar</div>
          </div>
        </div>
        <div class="formation-line midfield-line">
          <div class="position-slot" data-pos="Meia Atacante" id="slot-CM1">
            <div>üéØ Meia Esquerdo</div> <div class="muted">Clique para escalar</div>
          </div>
          <div class="position-slot" data-pos="Volante" id="slot-DM1">
            <div>‚öîÔ∏è Volante</div> <div class="muted">Clique para escalar</div>
          </div>
          <div class="position-slot" data-pos="Volante" id="slot-DM2">
            <div>‚öîÔ∏è Volante</div> <div class="muted">Clique para escalar</div>
          </div>
          <div class="position-slot" data-pos="Meia Atacante" id="slot-CM2">
            <div>üéØ Meia Direito</div> <div class="muted">Clique para escalar</div>
          </div>
        </div>
        <div class="formation-line attack-line">
          <div class="position-slot" data-pos="Atacante" id="slot-ST1">
            <div>‚öΩ Atacante</div> <div class="muted">Clique para escalar</div>
          </div>
          <div class="position-slot" data-pos="Atacante" id="slot-ST2">
            <div>‚öΩ Atacante</div> <div class="muted">Clique para escalar</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top: 20px;">
      <h3>Banco de Reservas</h3>
      <div class="bench" id="bench"></div>
      <div class="muted" style="margin-top:8px">Jogadores dispon√≠veis para escala√ß√£o</div>
    </div>

    <div class="controls">
        <a id="linkTela4" href="partida.html">
            <button id="btnPlayMatch" disabled>Jogar partida</button>
        </a>
    </div>
  </div>
</div>

<div id="playerModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3 id="modalTitle">Selecionar Jogador</h3>
    <div id="modalSubtitle" class="muted"></div>
    <div id="playerList" class="player-list-modal"></div>
  </div>
</div>

<script>
// ========== CONFIGURA√á√ïES E ESTADO DO JOGO ==========
// Essas vari√°veis ser√£o populadas com os dados do localStorage
let hired = [];
let userData = {};

// ========== ELEMENTOS DOM ==========
const elements = {
  headerTitle: document.getElementById('headerTitle'),
  bench: document.getElementById('bench'),
  btnPlayMatch: document.getElementById('btnPlayMatch'),
  linkTela4: document.getElementById('linkTela4'),
  playerModal: document.getElementById('playerModal'),
  modalTitle: document.getElementById('modalTitle'),
  modalSubtitle: document.getElementById('modalSubtitle'),
  playerList: document.getElementById('playerList'),
  modalClose: document.querySelector('.modal .close')
};

// ========== FUN√á√ïES AUXILIARES (INTOCADAS) ==========
function showNotif(text, time = 3000) {
  const box = document.createElement('div');
  box.className = 'notif';
  box.textContent = text;
  document.body.appendChild(box);
  setTimeout(() => box.remove(), time);
}
function renderHealthBar(health) {
  const color = health >= 80 ? '#4CAF50' : health >= 50 ? '#ff9800' : '#f44336';
  return `<div class="health-bar"><div class="health-fill" style="width: ${health}%; background: ${color}"></div></div>`;
}
function renderSkillBar(skill) {
  const color = skill >= 80 ? '#9c27b0' : skill >= 60 ? '#673ab7' : skill >= 40 ? '#3f51b5' : '#2196f3';
  return `<div class="skill-bar"><div class="skill-fill" style="width: ${skill}%; background: ${color}"></div></div>`;
}
function formatReal(n) {
  return 'R$ ' + n.toLocaleString('pt-BR');
}

// ========== L√ìGICA DA ESCALA√á√ÉO (INTOCADA DO SEU C√ìDIGO ORIGINAL) ==========
function openPlayerModal(slotElement) {
  const posicao = slotElement.dataset.pos;
  elements.modalTitle.textContent = `Escalar ${posicao}`;
  elements.modalSubtitle.textContent = `Selecione um jogador para a posi√ß√£o de ${posicao}`;
  elements.playerList.innerHTML = '';

  const posicoesValidas = {
    'Goleiro': ['Goleiro'],
    'Lateral Esquerdo': ['Lateral'],
    'Lateral Direito': ['Lateral'],
    'Zagueiro': ['Zagueiro'],
    'Volante': ['Volante'],
    'Meia Atacante': ['Meia'],
    'Atacante': ['Atacante']
  };

  const posicoesAceitas = posicoesValidas[posicao] || [posicao];
  
  const jogadoresDisponiveis = hired.filter(jogador => 
    posicoesAceitas.includes(jogador.pos) && 
    !document.querySelector(`[data-assigned="${jogador.id}"]`)
  );
  
  if (jogadoresDisponiveis.length === 0) {
    elements.playerList.innerHTML = '<p class="muted">Nenhum jogador dispon√≠vel para esta posi√ß√£o</p>';
  } else {
    jogadoresDisponiveis.forEach(jogador => {
      const item = document.createElement('div');
      item.className = 'modal-player-item';
      item.innerHTML = `
        <div><strong>${jogador.name}</strong> ‚Ä¢ ${jogador.pos}</div>
        <div class="muted">${jogador.age} anos ‚Ä¢ ${jogador.foot} ‚Ä¢ Habilidade: ${jogador.skill}% ‚Ä¢ Sa√∫de: ${jogador.health}%</div>
        <div>${renderSkillBar(jogador.skill)} ${renderHealthBar(jogador.health)}</div>
      `;
      item.addEventListener('click', () => {
        assignPlayerToSlot(jogador, slotElement);
        elements.playerModal.style.display = 'none';
      });
      elements.playerList.appendChild(item);
    });
  }
  
  elements.playerModal.style.display = 'block';
}

function assignPlayerToSlot(jogador, slotElement) {
  // Des-assinalar este jogador de qualquer outro slot em que ele possa estar
  const otherSlot = document.querySelector(`.position-slot[data-assigned="${jogador.id}"]`);
  if(otherSlot) {
      delete otherSlot.dataset.assigned;
      otherSlot.classList.remove('assigned');
      otherSlot.innerHTML = `<div>${otherSlot.dataset.pos.includes('Lateral') ? '‚¨ÖÔ∏è' : 'üõ°Ô∏è'} ${otherSlot.dataset.pos}</div><div class="muted">Clique para escalar</div>`;
  }
    
  // Limpa o slot atual caso tenha um jogador
  const previousPlayerId = slotElement.dataset.assigned;
  if (previousPlayerId) {
      // (Opcional) Logica para tratar o jogador que foi substituido
  }

  slotElement.dataset.assigned = jogador.id;
  slotElement.innerHTML = `
    <div><strong>${jogador.name}</strong></div>
    <div>${jogador.pos}</div>
    <div class="muted">Habilidade: ${jogador.skill}%</div>
  `;
  slotElement.classList.add('assigned');
  
  populateBench();
  
  const assignedCount = document.querySelectorAll('.position-slot.assigned').length;
  elements.btnPlayMatch.disabled = assignedCount < 11;
  
  showNotif(`${jogador.name} escalado como ${slotElement.dataset.pos}!`);
}

function populateBench() {
  elements.bench.innerHTML = '';
  
  const jogadoresNoBanco = hired.filter(jogador => 
    !document.querySelector(`[data-assigned="${jogador.id}"]`)
  );
  
  if (jogadoresNoBanco.length === 0) {
    elements.bench.innerHTML = '<p class="muted">Todos os jogadores est√£o escalados</p>';
    return;
  }
  
  jogadoresNoBanco.forEach(jogador => {
    const div = document.createElement('div');
    div.className = 'player-card';
    div.innerHTML = `
      <div>
        <strong>${jogador.name}</strong>
        <div class="muted">${jogador.pos} ‚Ä¢ ${jogador.foot} ‚Ä¢ ${jogador.age} anos</div>
        <div>${renderSkillBar(jogador.skill)} ${renderHealthBar(jogador.health)}</div>
        <div class="muted">Contrato: ${jogador.contrato}</div>
      </div>
      <div class="muted">${formatReal(jogador.salarioJogo)}/jogo</div>
    `;
    elements.bench.appendChild(div);
  });
}

function setupEscalacao() {
  document.querySelectorAll('.position-slot').forEach(slot => {
    slot.addEventListener('click', () => {
      openPlayerModal(slot);
    });
  });
  populateBench();
}

// ========== INICIALIZA√á√ÉO DA P√ÅGINA ==========
function init() {
  // 1. Carrega os dados do localStorage
  hired = JSON.parse(localStorage.getItem('elencoDoTime')) || [];
  userData = JSON.parse(localStorage.getItem('userData')) || {};

  // Se n√£o houver elenco, impede o usu√°rio de ficar na p√°gina (opcional, mas bom)
  if(hired.length === 0) {
      alert("Nenhum elenco encontrado! Contrate jogadores no mercado primeiro.");
      window.location.href = 'mercado.html';
      return;
  }
  
  // 2. Atualiza a interface
  elements.headerTitle.textContent = userData.teamName || 'O Rei da V√°rzea';

  // 3. Configura os eventos da p√°gina
  elements.modalClose.onclick = () => elements.playerModal.style.display = 'none';
  window.onclick = (event) => {
    if (event.target === elements.playerModal) {
      elements.playerModal.style.display = 'none';
    }
  };

  elements.linkTela4.addEventListener('click', (event) => {
      if(elements.btnPlayMatch.disabled) {
          event.preventDefault();
          showNotif("Voc√™ precisa escalar 11 jogadores para a partida!");
          return;
      }

      // Salva a escala√ß√£o final para a tela da partida
      const lineup = {};
      document.querySelectorAll('.position-slot[data-assigned]').forEach(slot => {
          lineup[slot.id] = slot.dataset.assigned;
      });
      localStorage.setItem('escalacaoFinal', JSON.stringify(lineup));
  });

  // 4. Inicia a l√≥gica da tela
  setupEscalacao();
}

// Roda o jogo!
init();
</script>
</body>
</html>
