<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRFutebol - T√°tica</title>
    
    <script src="database_jogadores.js"></script>
    <script src="engine.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-dark: #0f1216;
            --bg-panel: rgba(30, 35, 45, 0.95); /* Mais opaco para leitura */
            --accent: #00ff88;
            --accent-glow: rgba(0, 255, 136, 0.4);
            --text-main: #ffffff;
            --text-dim: #8b9bb4;
            --border: 1px solid rgba(255, 255, 255, 0.1);
            --pitch-grass: #1a4d2e;
            --pitch-line: rgba(255,255,255,0.3);
            --gold: #f1c40f;
            --red: #e74c3c;
            --blue: #3498db;
        }

        * { box-sizing: border-box; user-select: none; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- HEADER --- */
        header {
            height: 60px;
            background: rgba(15, 18, 22, 0.95);
            border-bottom: var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 100;
        }

        .back-btn {
            background: transparent;
            border: 1px solid #444;
            color: #ccc;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.8rem;
            transition: 0.2s;
        }
        .back-btn:hover { border-color: #fff; color: #fff; }

        .controls-wrapper { display: flex; align-items: center; gap: 15px; }

        .formation-select {
            background: #000;
            color: var(--gold);
            border: 1px solid #444;
            padding: 6px 10px;
            border-radius: 4px;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            outline: none;
        }

        .team-rating { font-family: 'Rajdhani'; font-weight: 700; font-size: 1.2rem; color: #fff; }

        .save-btn {
            background: var(--accent);
            color: #000;
            border: none;
            padding: 8px 25px;
            border-radius: 4px;
            font-weight: 800;
            cursor: pointer;
            font-size: 0.9rem;
            text-transform: uppercase;
            box-shadow: 0 0 10px var(--accent-glow);
        }
        .save-btn:hover { filter: brightness(1.1); transform: scale(1.02); }

        /* --- LAYOUT PRINCIPAL (3 COLUNAS) --- */
        .container {
            display: grid;
            grid-template-columns: 320px 1fr 280px;
            height: calc(100vh - 60px);
            width: 100%;
        }

        .panel {
            background: var(--bg-panel);
            border-right: var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .panel-right { border-right: none; border-left: var(--border); }

        .panel-header {
            padding: 12px 15px;
            border-bottom: var(--border);
            font-family: 'Rajdhani', sans-serif;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-dim);
            display: flex; justify-content: space-between; align-items: center;
        }

        .btn-auto {
            background: rgba(255,255,255,0.1);
            border: none;
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.7rem;
        }
        .btn-auto:hover { background: var(--accent); color: #000; }

        .scroll-area { flex: 1; overflow-y: auto; padding: 10px; }
        .scroll-area::-webkit-scrollbar { width: 5px; }
        .scroll-area::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }

        /* --- LISTA DE JOGADORES (ESQUERDA) --- */
        .player-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.05);
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 4px;
            display: flex; align-items: center;
            cursor: grab;
            transition: 0.2s;
        }
        .player-card:hover { background: rgba(255,255,255,0.08); border-color: var(--text-dim); }
        .player-card.used { opacity: 0.4; filter: grayscale(1); border-style: dashed; }

        .pos-badge {
            width: 28px; height: 28px;
            background: #111;
            color: #aaa;
            border-radius: 4px;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.7rem; font-weight: 800;
            margin-right: 10px; flex-shrink: 0;
        }

        .card-info { flex: 1; min-width: 0; }
        .card-name { font-weight: 600; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-trait { font-size: 0.75rem; color: var(--blue); font-style: italic; margin-bottom: 2px; display: block; }
        
        .health-row { display: flex; align-items: center; gap: 5px; }
        .health-bg { flex: 1; height: 4px; background: #000; border-radius: 2px; }
        .health-fill { height: 100%; border-radius: 2px; transition: width 0.3s; }
        .health-num { font-size: 0.65rem; color: #777; width: 25px; text-align: right; }

        .card-ovr { font-family: 'Rajdhani'; font-weight: 800; font-size: 1.1rem; color: var(--gold); margin-left: 10px; }

        /* --- CAMPO (CENTRO) --- */
        .field-area {
            background: #050505;
            display: flex; align-items: center; justify-content: center;
            position: relative;
            padding: 20px;
            overflow: hidden;
        }

        .pitch {
            width: 100%;
            height: 100%;
            max-width: 900px; /* Limite de largura para n√£o esticar demais */
            aspect-ratio: 1.5; /* Formato Retangular */
            background: linear-gradient(90deg, #27ae60 0%, #2ecc71 50%, #27ae60 100%);
            border: 3px solid rgba(255,255,255,0.8);
            border-radius: 6px;
            position: relative;
            box-shadow: 0 20px 50px rgba(0,0,0,0.6);
        }

        /* Linhas do Campo */
        .pitch::before { content:''; position:absolute; left:50%; top:0; width:2px; height:100%; background:rgba(255,255,255,0.4); transform:translateX(-50%); }
        .pitch::after { content:''; position:absolute; top:50%; left:50%; width:18%; padding-top: 18%; border:2px solid rgba(255,255,255,0.4); border-radius:50%; transform:translate(-50%, -50%); }
        .box { position:absolute; width:15%; height:45%; border:2px solid rgba(255,255,255,0.4); top:50%; transform:translateY(-50%); }
        .box-left { left:0; border-left:none; } .box-right { right:0; border-right:none; }

        /* SLOTS (JOGADORES NO CAMPO) */
        .slot {
            position: absolute;
            width: 80px; height: 80px;
            transform: translate(-50%, -50%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; z-index: 5;
            transition: top 0.4s ease, left 0.4s ease;
        }

        .slot-kit {
            width: 40px; height: 40px;
            background: rgba(0,0,0,0.4);
            border: 2px dashed rgba(255,255,255,0.4);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: #fff; font-size: 0.7rem; font-weight: bold;
            position: relative;
            transition: 0.2s;
        }
        .slot.filled .slot-kit { background: var(--bg-dark); border: 2px solid var(--accent); color: var(--accent); box-shadow: 0 0 15px rgba(0,0,0,0.5); }

        .slot-info {
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(4px);
            padding: 2px 6px;
            border-radius: 4px;
            margin-top: 4px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
            min-width: 70px;
        }
        .slot-name { display: block; font-size: 0.7rem; color: #fff; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 70px; }
        
        /* Mini barra de sa√∫de no campo */
        .slot-health-container { width: 100%; height: 3px; background: #333; margin-top: 2px; border-radius: 2px; display: none; }
        .slot.filled .slot-health-container { display: block; }
        .slot-health-fill { height: 100%; border-radius: 2px; }

        .captain-c {
            position: absolute; top: -5px; right: -5px;
            background: var(--gold); color: #000;
            width: 16px; height: 16px; font-size: 0.6rem; font-weight: 900;
            border-radius: 50%; display: none; align-items: center; justify-content: center;
            border: 1px solid #fff;
        }
        .slot.is-captain .captain-c { display: flex; }

        /* --- FUN√á√ïES (DIREITA) --- */
        .role-item { background: rgba(255,255,255,0.03); padding: 10px; margin-bottom: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.05); }
        .role-label { font-size: 0.7rem; color: var(--text-dim); text-transform: uppercase; font-weight: 700; display: block; margin-bottom: 5px; }
        .role-select {
            width: 100%; background: #111; color: #fff; border: 1px solid #333;
            padding: 6px; border-radius: 4px; font-size: 0.85rem; outline: none;
        }
        .role-select:focus { border-color: var(--accent); }

    </style>
</head>
<body>

    <header>
        <button class="back-btn" onclick="window.location.href='dashboard.html'">‚ùÆ VOLTAR</button>
        
        <div class="controls-wrapper">
            <select id="formation-select" class="formation-select" onchange="mudarFormacao()">
                <option value="4-3-3">4-3-3</option>
                <option value="4-4-2">4-4-2</option>
                <option value="3-5-2">3-5-2</option>
                <option value="4-2-3-1">4-2-3-1</option>
                <option value="3-4-3">3-4-3</option>
            </select>
            <div class="team-rating">FOR√áA: <span id="team-str">0</span></div>
        </div>

        <button class="save-btn" onclick="salvarTudo()">SALVAR</button>
    </header>

    <div class="container">
        
        <div class="panel">
            <div class="panel-header">
                <span>ELENCO</span>
                <button class="btn-auto" onclick="autoEscalar()">‚ö° AUTO</button>
            </div>
            <div class="scroll-area" id="roster-list">
                </div>
        </div>

        <div class="field-area">
            <div class="pitch">
                <div class="box box-left"></div>
                <div class="box box-right"></div>

                <div class="slot" id="slot-1"><div class="slot-kit">1</div><div class="slot-info"><span class="slot-name">Vazio</span><div class="slot-health-container"><div class="slot-health-fill"></div></div></div><div class="captain-c">C</div></div>
                <div class="slot" id="slot-2"><div class="slot-kit">2</div><div class="slot-info"><span class="slot-name">Vazio</span><div class="slot-health-container"><div class="slot-health-fill"></div></div></div><div class="captain-c">C</div></div>
                <div class="slot" id="slot-3"><div class="slot-kit">3</div><div class="slot-info"><span class="slot-name">Vazio</span><div class="slot-health-container"><div class="slot-health-fill"></div></div></div><div class="captain-c">C</div></div>
                <div class="slot" id="slot-4"><div class="slot-kit">4</div><div class="slot-info"><span class="slot-name">Vazio</span><div class="slot-health-container"><div class="slot-health-fill"></div></div></div><div class="captain-c">C</div></div>
                <div class="slot" id="slot-5"><div class="slot-kit">5</div><div class="slot-info"><span class="slot-name">Vazio</span><div class="slot-health-container"><div class="slot-health-fill"></div></div></div><div class="captain-c">C</div></div>
                <div class="slot" id="slot-6"><div class="slot-kit">6</div><div class="slot-info"><span class="slot-name">Vazio</span><div class="slot-health-container"><div class="slot-health-fill"></div></div></div><div class="captain-c">C</div></div>
                <div class="slot" id="slot-7"><div class="slot-kit">7</div><div class="slot-info"><span class="slot-name">Vazio</span><div class="slot-health-container"><div class="slot-health-fill"></div></div></div><div class="captain-c">C</div></div>
                <div class="slot" id="slot-8"><div class="slot-kit">8</div><div class="slot-info"><span class="slot-name">Vazio</span><div class="slot-health-container"><div class="slot-health-fill"></div></div></div><div class="captain-c">C</div></div>
                <div class="slot" id="slot-9"><div class="slot-kit">9</div><div class="slot-info"><span class="slot-name">Vazio</span><div class="slot-health-container"><div class="slot-health-fill"></div></div></div><div class="captain-c">C</div></div>
                <div class="slot" id="slot-10"><div class="slot-kit">10</div><div class="slot-info"><span class="slot-name">Vazio</span><div class="slot-health-container"><div class="slot-health-fill"></div></div></div><div class="captain-c">C</div></div>
                <div class="slot" id="slot-11"><div class="slot-kit">11</div><div class="slot-info"><span class="slot-name">Vazio</span><div class="slot-health-container"><div class="slot-health-fill"></div></div></div><div class="captain-c">C</div></div>
            </div>
        </div>

        <div class="panel panel-right">
            <div class="panel-header">FUN√á√ïES</div>
            <div class="scroll-area" id="roles-area">
                <div class="role-item">
                    <label class="role-label">¬© Capit√£o</label>
                    <select id="role-capitao" class="role-select" onchange="atualizarIconesFuncao()"></select>
                </div>
                <div class="role-item"><label class="role-label">‚öΩ P√™naltis</label><select id="role-penalti" class="role-select"></select></div>
                <div class="role-item"><label class="role-label">üéØ Faltas</label><select id="role-falta" class="role-select"></select></div>
                <div class="role-item"><label class="role-label">üö© Escanteio Dir.</label><select id="role-escanteioD" class="role-select"></select></div>
                <div class="role-item"><label class="role-label">üö© Escanteio Esq.</label><select id="role-escanteioE" class="role-select"></select></div>
            </div>
        </div>

    </div>

    <script>
        let gameState, meuTime;
        let escalacaoAtual = {};
        let funcoesAtuais = { capitao: null, penalti: null, falta: null, escanteioD: null, escanteioE: null };
        let formacaoAtual = "4-3-3";

        // COORDENADAS (LAYOUT HORIZONTAL: ESQ=GOL, DIR=ATAQUE)
        const layouts = {
            "4-3-3": [{id:"slot-1",t:"50%",l:"5%",r:"GOL"},{id:"slot-2",t:"15%",l:"25%",r:"LE"},{id:"slot-3",t:"35%",l:"20%",r:"ZAG"},{id:"slot-4",t:"65%",l:"20%",r:"ZAG"},{id:"slot-5",t:"85%",l:"25%",r:"LD"},{id:"slot-6",t:"50%",l:"40%",r:"VOL"},{id:"slot-7",t:"30%",l:"55%",r:"MEI"},{id:"slot-8",t:"70%",l:"55%",r:"MEI"},{id:"slot-9",t:"20%",l:"80%",r:"ATA"},{id:"slot-10",t:"50%",l:"85%",r:"ATA"},{id:"slot-11",t:"80%",l:"80%",r:"ATA"}],
            "4-4-2": [{id:"slot-1",t:"50%",l:"5%",r:"GOL"},{id:"slot-2",t:"10%",l:"25%",r:"LE"},{id:"slot-3",t:"35%",l:"20%",r:"ZAG"},{id:"slot-4",t:"65%",l:"20%",r:"ZAG"},{id:"slot-5",t:"90%",l:"25%",r:"LD"},{id:"slot-6",t:"35%",l:"45%",r:"VOL"},{id:"slot-7",t:"65%",l:"45%",r:"VOL"},{id:"slot-8",t:"15%",l:"60%",r:"MEI"},{id:"slot-9",t:"85%",l:"60%",r:"MEI"},{id:"slot-10",t:"35%",l:"85%",r:"ATA"},{id:"slot-11",t:"65%",l:"85%",r:"ATA"}],
            "3-5-2": [{id:"slot-1",t:"50%",l:"5%",r:"GOL"},{id:"slot-2",t:"20%",l:"20%",r:"ZAG"},{id:"slot-3",t:"50%",l:"18%",r:"ZAG"},{id:"slot-4",t:"80%",l:"20%",r:"ZAG"},{id:"slot-5",t:"35%",l:"40%",r:"VOL"},{id:"slot-6",t:"65%",l:"40%",r:"VOL"},{id:"slot-7",t:"10%",l:"50%",r:"MEI"},{id:"slot-8",t:"90%",l:"50%",r:"MEI"},{id:"slot-9",t:"50%",l:"60%",r:"MEI"},{id:"slot-10",t:"35%",l:"85%",r:"ATA"},{id:"slot-11",t:"65%",l:"85%",r:"ATA"}],
            "4-2-3-1":[{id:"slot-1",t:"50%",l:"5%",r:"GOL"},{id:"slot-2",t:"10%",l:"25%",r:"LE"},{id:"slot-3",t:"35%",l:"20%",r:"ZAG"},{id:"slot-4",t:"65%",l:"20%",r:"ZAG"},{id:"slot-5",t:"90%",l:"25%",r:"LD"},{id:"slot-6",t:"35%",l:"40%",r:"VOL"},{id:"slot-7",t:"65%",l:"40%",r:"VOL"},{id:"slot-8",t:"50%",l:"60%",r:"MEI"},{id:"slot-9",t:"20%",l:"75%",r:"ATA"},{id:"slot-10",t:"50%",l:"85%",r:"ATA"},{id:"slot-11",t:"80%",l:"75%",r:"ATA"}],
            "3-4-3": [{id:"slot-1",t:"50%",l:"5%",r:"GOL"},{id:"slot-2",t:"20%",l:"20%",r:"ZAG"},{id:"slot-3",t:"50%",l:"18%",r:"ZAG"},{id:"slot-4",t:"80%",l:"20%",r:"ZAG"},{id:"slot-5",t:"15%",l:"45%",r:"MEI"},{id:"slot-6",t:"40%",l:"45%",r:"VOL"},{id:"slot-7",t:"60%",l:"45%",r:"VOL"},{id:"slot-8",t:"85%",l:"45%",r:"MEI"},{id:"slot-9",t:"20%",l:"80%",r:"ATA"},{id:"slot-10",t:"50%",l:"85%",r:"ATA"},{id:"slot-11",t:"80%",l:"80%",r:"ATA"}]
        };

        window.onload = function() {
            try {
                gameState = Engine.carregarJogo();
                if (!gameState) throw new Error("Save n√£o encontrado.");
                
                meuTime = Engine.encontrarTime(gameState, gameState.meuTime);
                if (!meuTime) throw new Error("Time n√£o encontrado.");

                carregarDadosSalvos();
                aplicarLayout(formacaoAtual);
                renderizarLista();
                atualizarCampo();
                povoarDropdowns();

            } catch (e) {
                console.error(e);
                alert("Erro ao carregar: " + e.message);
                window.location.href = 'index.html';
            }
        };

        function carregarDadosSalvos() {
            const formSalva = localStorage.getItem('brfutebol_esquema');
            if(formSalva) { 
                formacaoAtual = formSalva; 
                document.getElementById('formation-select').value = formacaoAtual;
            }
            
            const escSalva = localStorage.getItem('brfutebol_formacao');
            if(escSalva) {
                try { escalacaoAtual = JSON.parse(escSalva); } catch(e){}
            } else {
                autoEscalar(true);
            }

            const funcSalva = localStorage.getItem('brfutebol_funcoes');
            if(funcSalva) {
                try { funcoesAtuais = JSON.parse(funcSalva); } catch(e){}
            }
        }

        function mudarFormacao() {
            formacaoAtual = document.getElementById('formation-select').value;
            aplicarLayout(formacaoAtual);
            atualizarCampo();
        }

        function aplicarLayout(nome) {
            if(!layouts[nome]) return;
            layouts[nome].forEach(p => {
                const s = document.getElementById(p.id);
                if(s) {
                    s.style.top = p.t; s.style.left = p.l; s.dataset.role = p.r;
                }
            });
        }

        function renderizarLista() {
            const container = document.getElementById('roster-list');
            if(!container) return;
            container.innerHTML = '';

            const emCampo = Object.values(escalacaoAtual);
            const lista = [...meuTime.elenco].sort((a,b) => b.forca - a.forca);

            lista.forEach(jog => {
                const div = document.createElement('div');
                div.className = 'player-card';
                div.draggable = true;
                div.id = `card-${jog.id}`;
                if(emCampo.includes(jog.id)) div.classList.add('used');

                const saude = jog.saude !== undefined ? jog.saude : 100;
                let cor = '#2ecc71';
                if(saude < 80) cor = '#f1c40f';
                if(saude < 60) cor = '#e74c3c';

                div.innerHTML = `
                    <div class="pos-badge">${jog.pos}</div>
                    <div class="card-info">
                        <div class="card-name">${jog.nome}</div>
                        <span class="card-trait">${jog.carac || 'Normal'}</span>
                        <div class="health-row">
                            <span class="health-num" style="color:${cor}">‚ù§Ô∏è${Math.floor(saude)}</span>
                            <div class="health-bg">
                                <div class="health-fill" style="width:${saude}%; background:${cor}"></div>
                            </div>
                        </div>
                    </div>
                    <div class="card-ovr">${jog.forca}</div>
                `;

                div.addEventListener('dragstart', handleDragStart);
                div.addEventListener('dragend', handleDragEnd);
                div.onclick = () => selecionarParaTroca(jog.id);
                container.appendChild(div);
            });
        }

        function atualizarCampo() {
            let soma = 0, count = 0;
            document.querySelectorAll('.slot').forEach(slot => {
                const jId = escalacaoAtual[slot.id];
                const jog = jId ? meuTime.elenco.find(x => x.id === jId) : null;
                const kit = slot.querySelector('.slot-kit');
                const info = slot.querySelector('.slot-info');
                const healthFill = slot.querySelector('.slot-health-fill');

                if(jog) {
                    slot.classList.add('filled');
                    kit.innerText = jog.pos; // Numero
                    info.querySelector('.slot-name').innerText = jog.nome.split(' ')[0];
                    
                    const s = jog.saude || 100;
                    let c = '#2ecc71';
                    if(s < 80) c = '#f1c40f'; if(s < 60) c = '#e74c3c';
                    
                    healthFill.style.width = `${s}%`;
                    healthFill.style.background = c;

                    // Capit√£o
                    const capId = document.getElementById('role-capitao').value || funcoesAtuais.capitao;
                    if(jog.id === capId) slot.classList.add('is-captain');
                    else slot.classList.remove('is-captain');

                    soma += jog.forca; count++;
                } else {
                    slot.classList.remove('filled');
                    slot.classList.remove('is-captain');
                    kit.innerText = slot.dataset.role || "?";
                    info.querySelector('.slot-name').innerText = "Vazio";
                }
            });
            const media = count > 0 ? Math.floor(soma/count) : 0;
            document.getElementById('team-str').innerText = count===11 ? media : `${media}*`;
        }

        function povoarDropdowns() {
            const titularesIds = Object.values(escalacaoAtual);
            const titulares = meuTime.elenco.filter(j => titularesIds.includes(j.id));
            titulares.sort((a,b) => b.forca - a.forca);

            ['capitao','penalti','falta','escanteioD','escanteioE'].forEach(role => {
                const sel = document.getElementById(`role-${role}`);
                const val = sel.value || funcoesAtuais[role];
                sel.innerHTML = '<option value="">-- Selecione --</option>';
                titulares.forEach(j => {
                    const opt = document.createElement('option');
                    opt.value = j.id;
                    opt.innerText = `[${j.pos}] ${j.nome} (${j.forca})`;
                    if(j.id === val) opt.selected = true;
                    sel.appendChild(opt);
                });
                if(val && !titularesIds.includes(val)) sel.value = "";
            });
            atualizarIconesFuncao();
        }

        function atualizarIconesFuncao() {
            const capId = document.getElementById('role-capitao').value;
            document.querySelectorAll('.slot').forEach(slot => {
                const jId = escalacaoAtual[slot.id];
                if(jId && jId === capId) slot.classList.add('is-captain');
                else slot.classList.remove('is-captain');
            });
        }

        // --- Drag & Drop ---
        function handleDragStart(e) { e.dataTransfer.setData('text/plain', this.id.replace('card-','')); }
        function handleDragEnd(e) {}
        
        document.querySelectorAll('.slot').forEach(s => {
            s.addEventListener('dragover', e => { e.preventDefault(); s.style.transform = 'translate(-50%, -50%) scale(1.1)'; });
            s.addEventListener('dragleave', e => { s.style.transform = 'translate(-50%, -50%) scale(1)'; });
            s.addEventListener('drop', handleDrop);
            s.onclick = () => removerJogador(s.id);
        });

        function handleDrop(e) {
            e.preventDefault();
            this.style.transform = 'translate(-50%, -50%) scale(1)';
            const jId = e.dataTransfer.getData('text/plain');
            
            Object.keys(escalacaoAtual).forEach(k => { if(escalacaoAtual[k]===jId) delete escalacaoAtual[k]; });
            escalacaoAtual[this.id] = jId;
            
            renderizarLista(); atualizarCampo(); povoarDropdowns();
        }

        function removerJogador(sid) {
            if(escalacaoAtual[sid]) {
                delete escalacaoAtual[sid];
                renderizarLista(); atualizarCampo(); povoarDropdowns();
            }
        }

        // --- Mobile ---
        let selId = null;
        function selecionarParaTroca(id) {
            if(selId === id) { selId=null; renderizarLista(); return; }
            selId = id;
            document.querySelectorAll('.player-card').forEach(c => c.style.borderColor = 'rgba(255,255,255,0.05)');
            const card = document.getElementById(`card-${id}`);
            if(card) card.style.borderColor = 'var(--accent)';

            document.querySelectorAll('.slot').forEach(s => {
                s.onclick = function() {
                    if(selId) {
                        Object.keys(escalacaoAtual).forEach(k => { if(escalacaoAtual[k]===selId) delete escalacaoAtual[k]; });
                        escalacaoAtual[this.id] = selId;
                        selId = null;
                        renderizarLista(); atualizarCampo(); povoarDropdowns();
                        document.querySelectorAll('.slot').forEach(x => x.onclick = () => removerJogador(x.id));
                    } else { removerJogador(this.id); }
                }
            });
        }

        function autoEscalar(silencioso=false) {
            if(!silencioso && !confirm("Auto-escalar o time?")) return;
            escalacaoAtual = {};
            const usados = [];
            const layout = layouts[formacaoAtual];

            layout.forEach(p => {
                // Prioriza posi√ß√£o correta + sa√∫de > 50
                let m = meuTime.elenco.find(j => j.pos === p.r && !usados.includes(j.id) && (j.saude===undefined || j.saude > 50));
                
                // Fallbacks de posi√ß√£o
                if(!m) {
                    if(p.r==='ATA') m=meuTime.elenco.find(j=>(j.pos==='MEI'||j.pos==='ST')&&!usados.includes(j.id));
                    if(p.r==='MEI') m=meuTime.elenco.find(j=>(j.pos==='VOL'||j.pos==='ATA')&&!usados.includes(j.id));
                    if(p.r==='VOL') m=meuTime.elenco.find(j=>(j.pos==='MEI'||j.pos==='ZAG')&&!usados.includes(j.id));
                    if(p.r==='LE'||p.r==='LD') m=meuTime.elenco.find(j=>j.pos==='ZAG'&&!usados.includes(j.id));
                }
                // Qualquer um saud√°vel (exceto GOL na linha)
                if(!m && p.r!=='GOL') m=meuTime.elenco.find(j=>j.pos!=='GOL' && !usados.includes(j.id) && j.saude > 40);

                if(m) { escalacaoAtual[p.id] = m.id; usados.push(m.id); }
            });

            renderizarLista(); atualizarCampo(); povoarDropdowns();
            
            const cap = document.getElementById('role-capitao');
            if(cap && !cap.value && usados.length>0) cap.value = usados[0];
        }

        function salvarTudo() {
            const t = Object.keys(escalacaoAtual).length;
            if(t < 11) alert("Time incompleto ("+t+"/11).");
            
            localStorage.setItem('brfutebol_formacao', JSON.stringify(escalacaoAtual));
            localStorage.setItem('brfutebol_esquema', formacaoAtual);
            
            const f = {
                capitao: document.getElementById('role-capitao').value,
                penalti: document.getElementById('role-penalti').value,
                falta: document.getElementById('role-falta').value,
                escanteioD: document.getElementById('role-escanteioD').value,
                escanteioE: document.getElementById('role-escanteioE').value
            };
            localStorage.setItem('brfutebol_funcoes', JSON.stringify(f));

            const b = document.querySelector('.save-btn');
            b.innerText = "SALVO!";
            setTimeout(() => { b.innerText="SALVAR"; window.location.href='dashboard.html'; }, 800);
        }
    </script>
</body>
</html>
