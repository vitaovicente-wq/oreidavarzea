<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRFutebol - T√°tica</title>
    <script src="database_jogadores.js"></script>
    <script src="engine.js"></script>
    <style>
        :root { --bg:#0d1115; --panel:#161b22; --card:#1e272e; --text:#ecf0f1; --green:#2ecc71; --gold:#f1c40f; --red:#e74c3c; --border:#30363d; }
        body { font-family:'Segoe UI',sans-serif; background:var(--bg); color:var(--text); margin:0; height:100vh; display:flex; flex-direction:column; overflow:hidden; }

        /* HEADER */
        header { height: 60px; background: rgba(22,27,34,0.95); border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; padding:0 20px; z-index: 10; }
        .btn-back { background:none; border:1px solid #444; color:#fff; padding:8px 15px; border-radius:5px; cursor:pointer; font-weight:bold; transition:0.2s; }
        .btn-back:hover { background:#333; }
        .btn-save { background:var(--green); border:none; color:#000; padding:10px 30px; border-radius:30px; cursor:pointer; font-weight:900; text-transform:uppercase; box-shadow:0 0 15px rgba(46,204,113,0.4); transition:0.2s; }
        .btn-save:hover { transform:scale(1.05); box-shadow:0 0 25px rgba(46,204,113,0.6); }

        /* LAYOUT DE 3 COLUNAS */
        .container { display:grid; grid-template-columns: 300px 1fr 280px; height:calc(100vh - 60px); }
        
        /* GERAL PAIN√âIS */
        .panel { background:var(--panel); border-right:1px solid var(--border); display:flex; flex-direction:column; }
        .panel-right { border-left:1px solid var(--border); border-right:none; }
        .panel-header { padding:15px; border-bottom:1px solid var(--border); font-weight:bold; text-transform:uppercase; color:var(--gold); display:flex; justify-content:space-between; align-items:center; }
        .scroll-area { flex:1; overflow-y:auto; padding:10px; }

        /* LISTA DE JOGADORES (ESQUERDA) */
        .player-card {
            background:var(--card); padding:8px; margin-bottom:6px; border-radius:4px; border:1px solid #333;
            display:flex; align-items:center; cursor:grab; user-select:none; transition:0.2s;
        }
        .player-card:hover { border-color:var(--green); background:#252e33; }
        .player-card.used { opacity:0.4; filter:grayscale(1); }
        .p-pos { background:#000; color:#aaa; font-size:0.7rem; padding:2px 5px; border-radius:3px; font-weight:bold; width:25px; text-align:center; margin-right:8px; }
        .p-name { font-weight:600; font-size:0.85rem; flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .p-ovr { font-weight:900; color:var(--gold); font-size:0.9rem; }
        .health-dot { width:8px; height:8px; border-radius:50%; margin-right:8px; }

        /* CAMPO (CENTRO) */
        .field-area { background:#0a0a0a; display:flex; justify-content:center; align-items:center; position:relative; overflow:hidden; }
        .pitch {
            width: 480px; height: 680px;
            background: linear-gradient(180deg, #27ae60 0%, #2ecc71 100%);
            border: 4px solid #fff; border-radius: 8px;
            position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.8);
        }
        .pitch::before { content:''; position:absolute; top:50%; left:0; width:100%; height:2px; background:rgba(255,255,255,0.4); }
        .pitch::after { content:''; position:absolute; top:50%; left:50%; width:100px; height:100px; border:2px solid rgba(255,255,255,0.4); border-radius:50%; transform:translate(-50%, -50%); }
        .box { position:absolute; width:220px; height:90px; border:2px solid rgba(255,255,255,0.4); left:50%; transform:translateX(-50%); }
        .box-top { top:0; border-top:none; } .box-bottom { bottom:0; border-bottom:none; }

        /* SLOTS */
        .slot {
            position: absolute; width: 70px; height: 70px; transform: translate(-50%, -50%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s; z-index: 2;
        }
        .slot-circle {
            width: 40px; height: 40px; background: rgba(0,0,0,0.4);
            border: 2px dashed rgba(255,255,255,0.4); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: #fff; font-size: 0.7rem; font-weight: bold;
        }
        .slot.filled .slot-circle { background: var(--card); border: 2px solid var(--green); color:var(--gold); }
        .slot-name { background: rgba(0,0,0,0.8); color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; margin-top: 3px; white-space: nowrap; max-width: 80px; overflow:hidden; text-overflow:ellipsis; }
        .captain-badge { position:absolute; top:-5px; right:-5px; background:var(--gold); color:#000; font-weight:bold; font-size:0.7rem; width:16px; height:16px; border-radius:50%; display:flex; align-items:center; justify-content:center; display:none; border:1px solid #fff; }
        .slot.is-captain .captain-badge { display:flex; }

        /* PAINEL DE FUN√á√ïES (DIREITA) */
        .role-group { margin-bottom: 20px; }
        .role-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 5px; display: block; font-weight: bold; }
        .role-select {
            width: 100%; background: var(--card); border: 1px solid #444; color: #fff;
            padding: 8px; border-radius: 4px; font-size: 0.9rem; outline: none;
        }
        .role-select:focus { border-color: var(--green); }
        
        /* Auto Escalar Btn */
        .btn-auto { background:#333; color:#fff; border:1px solid #555; padding:4px 10px; border-radius:4px; cursor:pointer; font-size:0.7rem; }
        .btn-auto:hover { background:#444; border-color:#fff; }

        /* Forma√ß√£o 4-3-3 Padr√£o */
        #pos-GK { bottom: 2%; left: 50%; }
        #pos-LB { bottom: 20%; left: 15%; } #pos-CB1 { bottom: 15%; left: 38%; } #pos-CB2 { bottom: 15%; left: 62%; } #pos-RB { bottom: 20%; left: 85%; }
        #pos-CDM { bottom: 35%; left: 50%; } #pos-CM1 { bottom: 50%; left: 30%; } #pos-CM2 { bottom: 50%; left: 70%; }
        #pos-LW { top: 20%; left: 15%; } #pos-ST { top: 15%; left: 50%; } #pos-RW { top: 20%; left: 85%; }

    </style>
</head>
<body>

    <header>
        <button class="btn-back" onclick="window.location.href='dashboard.html'">‚¨Ö Voltar</button>
        <div style="font-weight:bold; color:var(--text-muted); font-size:0.9rem;">
            FOR√áA: <span id="team-str" style="color:#fff; font-size:1.1rem;">0</span>
        </div>
        <button class="btn-save" onclick="salvarTudo()">SALVAR T√ÅTICA</button>
    </header>

    <div class="container">
        
        <div class="panel">
            <div class="panel-header">
                <span>Elenco</span>
                <button class="btn-auto" onclick="autoEscalar()">‚ö° AUTO</button>
            </div>
            <div class="scroll-area" id="roster">
                </div>
        </div>

        <div class="field-area">
            <div class="pitch">
                <div class="box box-top"></div>
                <div class="box box-bottom"></div>

                <div class="slot" id="pos-GK" data-role="GOL"><div class="slot-circle">GOL</div><div class="slot-name">Vazio</div><div class="captain-badge">C</div></div>
                <div class="slot" id="pos-LB" data-role="LE"><div class="slot-circle">LE</div><div class="slot-name">Vazio</div><div class="captain-badge">C</div></div>
                <div class="slot" id="pos-CB1" data-role="ZAG"><div class="slot-circle">ZAG</div><div class="slot-name">Vazio</div><div class="captain-badge">C</div></div>
                <div class="slot" id="pos-CB2" data-role="ZAG"><div class="slot-circle">ZAG</div><div class="slot-name">Vazio</div><div class="captain-badge">C</div></div>
                <div class="slot" id="pos-RB" data-role="LD"><div class="slot-circle">LD</div><div class="slot-name">Vazio</div><div class="captain-badge">C</div></div>
                <div class="slot" id="pos-CDM" data-role="VOL"><div class="slot-circle">VOL</div><div class="slot-name">Vazio</div><div class="captain-badge">C</div></div>
                <div class="slot" id="pos-CM1" data-role="MEI"><div class="slot-circle">MEI</div><div class="slot-name">Vazio</div><div class="captain-badge">C</div></div>
                <div class="slot" id="pos-CM2" data-role="MEI"><div class="slot-circle">MEI</div><div class="slot-name">Vazio</div><div class="captain-badge">C</div></div>
                <div class="slot" id="pos-LW" data-role="ATA"><div class="slot-circle">PTE</div><div class="slot-name">Vazio</div><div class="captain-badge">C</div></div>
                <div class="slot" id="pos-ST" data-role="ATA"><div class="slot-circle">ATA</div><div class="slot-name">Vazio</div><div class="captain-badge">C</div></div>
                <div class="slot" id="pos-RW" data-role="ATA"><div class="slot-circle">PTD</div><div class="slot-name">Vazio</div><div class="captain-badge">C</div></div>
            </div>
        </div>

        <div class="panel panel-right">
            <div class="panel-header">Fun√ß√µes & Bolas Paradas</div>
            <div class="scroll-area">
                
                <div class="role-group">
                    <label class="role-label">¬© Capit√£o</label>
                    <select id="role-capitao" class="role-select" onchange="atualizarIconesFuncao()"></select>
                </div>

                <div class="role-group">
                    <label class="role-label">‚öΩ P√™naltis</label>
                    <select id="role-penalti" class="role-select"></select>
                </div>

                <div class="role-group">
                    <label class="role-label">üéØ Faltas</label>
                    <select id="role-falta" class="role-select"></select>
                </div>

                <div class="role-group">
                    <label class="role-label">üö© Escanteio Direito</label>
                    <select id="role-escanteioD" class="role-select"></select>
                </div>

                <div class="role-group">
                    <label class="role-label">üö© Escanteio Esquerdo</label>
                    <select id="role-escanteioE" class="role-select"></select>
                </div>

                <div style="margin-top:20px; padding:15px; background:rgba(255,255,255,0.05); border-radius:6px; font-size:0.8rem; color:#888;">
                    ‚ÑπÔ∏è Escolha jogadores com boa t√©cnica e lideran√ßa. O capit√£o influencia a moral do time.
                </div>

            </div>
        </div>

    </div>

    <script>
        let gameState, meuTime;
        let escalacaoAtual = {}; // { "pos-GK": "id123" }
        let funcoesAtuais = { capitao: null, penalti: null, falta: null, escanteioD: null, escanteioE: null };
        let dragSrcEl = null;

        window.onload = function() {
            gameState = Engine.carregarJogo();
            if (!gameState) { window.location.href = 'index.html'; return; }
            meuTime = Engine.encontrarTime(gameState, gameState.meuTime);
            
            carregarDadosSalvos();
            renderizarLista();
            atualizarCampo();
            povoarDropdowns();
        };

        function carregarDadosSalvos() {
            // Escala√ß√£o
            const formacaoSalva = localStorage.getItem('brfutebol_formacao');
            if (formacaoSalva) {
                try { escalacaoAtual = JSON.parse(formacaoSalva); } catch(e) {}
            } else {
                autoEscalar(true);
            }

            // Fun√ß√µes
            const funcoesSalvas = localStorage.getItem('brfutebol_funcoes');
            if (funcoesSalvas) {
                try { funcoesAtuais = JSON.parse(funcoesSalvas); } catch(e) {}
            }
        }

        // --- RENDERIZA√á√ÉO ---
        function renderizarLista() {
            const container = document.getElementById('roster');
            container.innerHTML = '';
            const emCampoIds = Object.values(escalacaoAtual);
            
            // Ordena
            const lista = [...meuTime.elenco].sort((a,b) => b.forca - a.forca);

            lista.forEach(jog => {
                const div = document.createElement('div');
                div.className = 'player-card';
                div.draggable = true;
                div.id = `card-${jog.id}`;
                if (emCampoIds.includes(jog.id)) div.classList.add('used');

                // Cor da Sa√∫de
                const saude = jog.saude !== undefined ? jog.saude : 100;
                let corSaude = '#2ecc71';
                if(saude < 80) corSaude = '#f1c40f';
                if(saude < 60) corSaude = '#e74c3c';

                div.innerHTML = `
                    <div class="health-dot" style="background:${corSaude}" title="Sa√∫de: ${Math.floor(saude)}%"></div>
                    <div class="p-pos">${jog.pos}</div>
                    <div class="p-name">${jog.nome}</div>
                    <div class="p-ovr">${jog.forca}</div>
                `;

                div.addEventListener('dragstart', handleDragStart);
                div.addEventListener('dragend', handleDragEnd);
                // Mobile tap
                div.onclick = () => selecionarParaTroca(jog.id);

                container.appendChild(div);
            });
        }

        function atualizarCampo() {
            let forcaTotal = 0;
            let count = 0;

            document.querySelectorAll('.slot').forEach(slot => {
                const jogId = escalacaoAtual[slot.id];
                const jog = jogId ? meuTime.elenco.find(j => j.id === jogId) : null;

                if (jog) {
                    slot.classList.add('filled');
                    slot.querySelector('.slot-circle').innerText = jog.pos;
                    slot.querySelector('.slot-name').innerText = jog.nome.split(' ')[0];
                    
                    // Verifica capit√£o visualmente
                    const selectCapitao = document.getElementById('role-capitao');
                    if (jog.id === selectCapitao.value || jog.id === funcoesAtuais.capitao) {
                        slot.classList.add('is-captain');
                    } else {
                        slot.classList.remove('is-captain');
                    }

                    forcaTotal += jog.forca;
                    count++;
                } else {
                    slot.classList.remove('filled');
                    slot.classList.remove('is-captain');
                    slot.querySelector('.slot-circle').innerText = slot.dataset.role;
                    slot.querySelector('.slot-name').innerText = "Vazio";
                }
            });

            const media = count > 0 ? Math.floor(forcaTotal / count) : 0;
            document.getElementById('team-str').innerText = count === 11 ? media : `${media} (Incompleto)`;
        }

        function povoarDropdowns() {
            // Pega apenas os jogadores que est√£o no campo
            const titularesIds = Object.values(escalacaoAtual);
            const titulares = meuTime.elenco.filter(j => titularesIds.includes(j.id));
            
            // Ordena por for√ßa para facilitar escolha
            titulares.sort((a,b) => b.forca - a.forca);

            const selects = ['capitao', 'penalti', 'falta', 'escanteioD', 'escanteioE'];

            selects.forEach(tipo => {
                const el = document.getElementById(`role-${tipo}`);
                const valorAtual = el.value || funcoesAtuais[tipo]; // Mant√©m o que estava selecionado se poss√≠vel
                
                el.innerHTML = '<option value="">-- Selecione --</option>';
                
                titulares.forEach(jog => {
                    const opt = document.createElement('option');
                    opt.value = jog.id;
                    opt.innerText = `[${jog.pos}] ${jog.nome} (${jog.forca})`;
                    if (jog.id === valorAtual) opt.selected = true;
                    el.appendChild(opt);
                });

                // Se o valor selecionado anteriormente n√£o est√° mais no campo, reseta
                if (valorAtual && !titularesIds.includes(valorAtual)) {
                    el.value = "";
                }
            });
            
            atualizarIconesFuncao();
        }

        function atualizarIconesFuncao() {
            // Atualiza visual do campo (Badge de Capit√£o)
            const idCapitao = document.getElementById('role-capitao').value;
            document.querySelectorAll('.slot').forEach(slot => {
                const jogId = escalacaoAtual[slot.id];
                if (jogId && jogId === idCapitao) slot.classList.add('is-captain');
                else slot.classList.remove('is-captain');
            });
        }

        // --- L√ìGICA DE DRAG & DROP E CLIQUES ---
        function handleDragStart(e) {
            this.classList.add('dragging');
            e.dataTransfer.setData('text/plain', this.id.replace('card-', ''));
        }
        function handleDragEnd(e) { this.classList.remove('dragging'); }

        document.querySelectorAll('.slot').forEach(slot => {
            slot.addEventListener('dragover', e => { e.preventDefault(); slot.style.transform = 'translate(-50%, -50%) scale(1.1)'; });
            slot.addEventListener('dragleave', e => { slot.style.transform = 'translate(-50%, -50%) scale(1)'; });
            slot.addEventListener('drop', handleDrop);
            slot.onclick = () => removerJogador(slot.id);
        });

        function handleDrop(e) {
            e.preventDefault();
            this.style.transform = 'translate(-50%, -50%) scale(1)';
            const jogId = e.dataTransfer.getData('text/plain');
            
            // Remove de outro slot se j√° estiver escalado
            Object.keys(escalacaoAtual).forEach(k => { if(escalacaoAtual[k]===jogId) delete escalacaoAtual[k]; });
            
            escalacaoAtual[this.id] = jogId;
            renderizarLista();
            atualizarCampo();
            povoarDropdowns(); // Atualiza dropdowns pois entrou gente nova
        }

        function removerJogador(slotId) {
            if (escalacaoAtual[slotId]) {
                delete escalacaoAtual[slotId];
                renderizarLista();
                atualizarCampo();
                povoarDropdowns(); // Atualiza dropdowns pois saiu gente
            }
        }

        // --- SISTEMA DE SELE√á√ÉO POR CLIQUE (MOBILE) ---
        let selectedId = null;
        function selecionarParaTroca(id) {
            if (selectedId === id) { selectedId = null; renderizarLista(); return; }
            selectedId = id;
            document.querySelectorAll('.player-card').forEach(c => c.style.borderColor = '#333');
            document.getElementById(`card-${id}`).style.borderColor = 'var(--gold)';
            
            // Sobrescreve click dos slots temporariamente
            document.querySelectorAll('.slot').forEach(slot => {
                slot.onclick = function() {
                    if (selectedId) {
                        Object.keys(escalacaoAtual).forEach(k => { if(escalacaoAtual[k]===selectedId) delete escalacaoAtual[k]; });
                        escalacaoAtual[this.id] = selectedId;
                        selectedId = null;
                        renderizarLista();
                        atualizarCampo();
                        povoarDropdowns();
                        // Restaura clique normal
                        document.querySelectorAll('.slot').forEach(s => s.onclick = () => removerJogador(s.id));
                    } else {
                        removerJogador(this.id);
                    }
                }
            });
        }

        function autoEscalar(silencioso = false) {
            if(!silencioso && !confirm("Auto-escalar o time com os melhores jogadores saud√°veis?")) return;
            
            escalacaoAtual = {};
            const usados = [];
            const map = { 'pos-GK':['GOL'], 'pos-LB':['LE','ZAG'], 'pos-CB1':['ZAG'], 'pos-CB2':['ZAG'], 'pos-RB':['LD','ZAG'], 'pos-CDM':['VOL','MEI'], 'pos-CM1':['MEI','VOL'], 'pos-CM2':['MEI','ATA'], 'pos-LW':['ATA'], 'pos-ST':['ATA'], 'pos-RW':['ATA'] };

            Object.keys(map).forEach(slotId => {
                const prefs = map[slotId];
                let melhor = null;
                for(let pos of prefs) {
                    const c = meuTime.elenco.filter(j => j.pos === pos && !usados.includes(j.id) && (j.saude === undefined || j.saude > 50));
                    c.sort((a,b) => b.forca - a.forca);
                    if(c.length > 0) { melhor = c[0]; break; }
                }
                if(melhor) { escalacaoAtual[slotId] = melhor.id; usados.push(melhor.id); }
            });

            renderizarLista();
            atualizarCampo();
            povoarDropdowns();
            
            // Auto-define Capit√£o (Melhor Overall)
            if(usados.length > 0) {
                const capitao = meuTime.elenco.find(j => j.id === usados[0]); // J√° est√° ordenado por for√ßa na l√≥gica acima? N√£o necessariamente, mas √© um bom chute
                document.getElementById('role-capitao').value = capitao.id;
            }
        }

        function salvarTudo() {
            // Salva Escala√ß√£o
            const titulares = Object.keys(escalacaoAtual).length;
            if (titulares < 11) alert("Aten√ß√£o: Time incompleto!");
            localStorage.setItem('brfutebol_formacao', JSON.stringify(escalacaoAtual));

            // Salva Fun√ß√µes
            const funcoes = {
                capitao: document.getElementById('role-capitao').value,
                penalti: document.getElementById('role-penalti').value,
                falta: document.getElementById('role-falta').value,
                escanteioD: document.getElementById('role-escanteioD').value,
                escanteioE: document.getElementById('role-escanteioE').value
            };
            localStorage.setItem('brfutebol_funcoes', JSON.stringify(funcoes));

            // Feedback
            const btn = document.querySelector('.btn-save');
            btn.innerText = "SALVO! ‚úÖ";
            setTimeout(() => { btn.innerText = "SALVAR T√ÅTICA"; window.location.href='dashboard.html'; }, 800);
        }

    </script>
</body>
</html>
