<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRFutebol - Ao Vivo</title>
    
    <script src="database_jogadores.js"></script>
    <script src="engine.js"></script>

    <style>
        :root {
            --bg: #0d1115;
            --panel: #1e272e;
            --field-color: #27ae60;
            --text: #ecf0f1;
            --green: #2ecc71;
            --red: #ff4757;
            --gold: #f1c40f;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0; padding: 0;
            display: grid; 
            grid-template-rows: 30px 90px 1fr 70px; 
            height: 100vh; 
            overflow: hidden;
            user-select: none;
        }

        /* --- 0. TICKER (GC) --- */
        .ticker-wrap { background: #000; border-bottom: 1px solid #333; overflow: hidden; white-space: nowrap; display: flex; align-items: center; z-index: 20; }
        .ticker-label { background: var(--red); color: white; font-weight: bold; font-size: 0.7rem; padding: 0 15px; height: 100%; display: flex; align-items: center; z-index: 21; }
        .ticker-content { display: inline-block; padding-left: 100%; animation: ticker 40s linear infinite; font-family: monospace; font-size: 0.85rem; color: #ccc; }
        .ticker-item { margin-right: 40px; display: inline-block; }
        @keyframes ticker { 0% { transform: translate3d(0, 0, 0); } 100% { transform: translate3d(-100%, 0, 0); } }

        /* --- 1. PLACAR --- */
        header { background: linear-gradient(180deg, #151a1d 0%, #0d1115 100%); border-bottom: 2px solid #333; display: flex; align-items: center; justify-content: center; z-index: 10; }
        .scoreboard { display: flex; align-items: center; gap: 30px; width: 100%; max-width: 800px; justify-content: center; }
        .team-display { display: flex; align-items: center; gap: 15px; width: 250px; }
        .team-display.away { justify-content: flex-end; flex-direction: row-reverse; }
        .team-logo { width: 55px; height: 55px; object-fit: contain; }
        .team-name { font-weight: 800; font-size: 1.1rem; text-transform: uppercase; }
        .score-box { background: #000; padding: 5px 25px; border-radius: 8px; border: 1px solid #333; text-align: center; min-width: 120px; }
        .score-val { font-size: 2.2rem; font-weight: 800; line-height: 1; color: #fff; }
        .timer { color: var(--green); font-weight: bold; font-size: 1rem; font-family: monospace; }
        .goal-pulse { animation: pulse 1s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); filter: brightness(1.5); } 100% { transform: scale(1); } }

        /* --- 2. MAIN --- */
        main { display: grid; grid-template-columns: 220px 1fr 280px; gap: 15px; padding: 15px; overflow: hidden; }
        .panel { background: var(--panel); border: 1px solid #333; border-radius: 8px; display: flex; flex-direction: column; overflow: hidden; }
        .panel-header { background: rgba(0,0,0,0.3); padding: 10px; font-size: 0.8rem; font-weight: bold; text-transform: uppercase; color: #aaa; border-bottom: 1px solid #333; text-align: center; }
        .panel-content { flex-grow: 1; overflow-y: auto; padding: 10px; }

        /* Escala√ß√µes Texto */
        .lineup-item { padding: 4px 0; border-bottom: 1px solid #2a2a2a; display: flex; gap: 5px; font-size: 0.8rem; }
        .pos { color: #888; font-weight: bold; width: 25px; }

        /* Feed */
        .center-col { display: flex; flex-direction: column; gap: 15px; overflow: hidden; }
        .feed-box { flex-grow: 1; background: rgba(255,255,255,0.02); border: 1px solid #333; border-radius: 8px; overflow-y: auto; padding: 10px; display: flex; flex-direction: column-reverse; }
        .feed-msg { padding: 8px; margin-bottom: 8px; border-radius: 4px; font-size: 0.9rem; border-left: 3px solid #444; background: rgba(0,0,0,0.2); animation: fadeIn 0.3s; }
        .feed-msg.goal { border-color: var(--green); background: rgba(46, 204, 113, 0.1); font-weight: bold; }
        .feed-msg.card { border-color: var(--gold); }
        .feed-time { color: var(--green); font-weight: bold; margin-right: 5px; font-family: monospace; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- 3. FOOTER --- */
        footer { background: #151a1d; border-top: 1px solid #333; display: flex; align-items: center; justify-content: center; gap: 20px; z-index: 10; }
        .btn { padding: 10px 25px; border-radius: 6px; border: none; font-weight: bold; text-transform: uppercase; cursor: pointer; transition: 0.2s; color: white; }
        .btn:hover { transform: scale(1.05); }
        .btn-play { background: var(--green); color: #1e272e; }
        .btn-sub { background: var(--gold); color: #1e272e; }
        .btn-speed { background: #444; }
        .btn-exit { background: var(--red); display: none; }

        /* --- MODAL T√ÅTICO VISUAL (CAMPO) --- */
        #tactical-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 200; align-items: center; justify-content: center;
        }
        .tac-container {
            width: 90%; height: 90%; max-width: 1000px;
            display: grid; grid-template-columns: 1fr 280px; gap: 20px;
        }
        
        /* Campo do Modal */
        .tac-field {
            background: var(--field-color); border: 5px solid #1a5c36; border-radius: 8px;
            position: relative; box-shadow: inset 0 0 50px rgba(0,0,0,0.5);
        }
        .field-line { position: absolute; background: rgba(255,255,255,0.4); }
        .player-token {
            position: absolute; width: 80px; height: 80px; transform: translate(-50%, -50%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: grab; transition: 0.2s; z-index: 10;
        }
        .player-token:active { cursor: grabbing; }
        .player-token.drag-over { transform: translate(-50%, -50%) scale(1.2); filter: drop-shadow(0 0 10px white); }
        
        .token-shirt {
            width: 35px; height: 35px; background: #fff; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 0.8rem; color: #333; border: 3px solid #333;
        }
        .token-info { background: rgba(0,0,0,0.8); color: #fff; padding: 2px 5px; border-radius: 4px; font-size: 0.7rem; margin-top: 3px; }

        /* Banco do Modal */
        .tac-sidebar { background: var(--panel); border-radius: 8px; display: flex; flex-direction: column; padding: 15px; }
        .tac-title { color: #aaa; text-transform: uppercase; font-weight: bold; margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 5px; }
        .bench-list { overflow-y: auto; flex-grow: 1; }
        .bench-item {
            background: rgba(255,255,255,0.05); padding: 10px; margin-bottom: 5px; border-radius: 5px;
            display: flex; justify-content: space-between; align-items: center; cursor: grab;
        }
        .bench-item:hover { background: rgba(255,255,255,0.1); }
        .bench-item.dragging { opacity: 0.5; }

        .btn-close-sub { background: #444; color: white; border: none; padding: 10px; width: 100%; margin-top: 10px; cursor: pointer; border-radius: 5px; font-weight: bold; }
        .btn-close-sub:hover { background: #666; }

    </style>
</head>
<body>

    <div class="ticker-wrap"><div class="ticker-label">MUNDO</div><div class="ticker-content" id="ticker-feed">...</div></div>

    <header>
        <div class="scoreboard">
            <div class="team-display"><img id="logo-h" class="team-logo"><span id="name-h" class="team-name">CASA</span></div>
            <div class="score-box"><div class="score-val"><span id="gols-h">0</span> - <span id="gols-a">0</span></div><div class="timer" id="timer">00:00</div></div>
            <div class="team-display away"><img id="logo-a" class="team-logo"><span id="name-a" class="team-name">FORA</span></div>
        </div>
    </header>

    <main>
        <div class="panel">
            <div class="panel-header">Em Campo</div>
            <div class="panel-content">
                <div style="color:var(--green); font-size:0.7rem; font-weight:bold;">MANDANTE</div><div id="list-home"></div>
                <div style="color:var(--gold); font-size:0.7rem; font-weight:bold; margin-top:15px;">VISITANTE</div><div id="list-away"></div>
            </div>
        </div>

        <div class="center-col">
            <div class="panel" style="height: 100px; flex-shrink: 0;">
                <div class="panel-header">Resumo</div>
                <div class="panel-content" id="match-events" style="font-size:0.85rem;"></div>
            </div>
            <div class="panel feed-box" id="match-feed">
                <div class="feed-msg"><span class="feed-time">00'</span> Bola rolando!</div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header">Estat√≠sticas</div>
            <div class="panel-content">
                <div style="display:flex; justify-content:space-between; font-size:0.85rem; margin-bottom:5px;"><span>Posse</span> <span id="posse-txt">50% | 50%</span></div>
                <div style="height:6px; background:#333; display:flex; border-radius:3px; overflow:hidden; margin-bottom:15px;"><div id="bar-h" style="width:50%; background:#fff;"></div><div id="bar-a" style="width:50%; background:#555;"></div></div>
                <div style="display:flex; justify-content:space-between; margin-bottom:8px;"><span>Chutes</span> <b id="stats-chutes">0 - 0</b></div>
                <div style="display:flex; justify-content:space-between;"><span>Cart√µes</span> <b id="stats-cartoes" style="color:var(--gold)">0 - 0</b></div>
            </div>
        </div>
    </main>

    <footer>
        <button class="btn btn-sub" id="btn-sub" onclick="abrirPainelTatico()">üîÑ Substituir</button>
        <button class="btn btn-speed" onclick="mudarVelocidade()">‚è© <span id="lbl-speed">1x</span></button>
        <button class="btn btn-play" id="btn-pause" onclick="pausarJogo()">‚è∏Ô∏è Pausar</button>
        <button class="btn btn-exit" id="btn-exit" onclick="sairDoJogo()">üíæ Sair</button>
    </footer>

    <div id="tactical-modal">
        <div class="tac-container">
            <div class="tac-field" id="tac-field">
                <div class="field-line" style="top:50%; width:100%; height:2px;"></div>
                <div class="field-line" style="top:50%; left:50%; width:100px; height:100px; border:2px solid rgba(255,255,255,0.4); border-radius:50%; transform:translate(-50%,-50%); background:transparent;"></div>
                
                </div>

            <div class="tac-sidebar">
                <div class="tac-title">Banco de Reservas</div>
                <div style="font-size:0.75rem; color:#888; margin-bottom:10px;">Arraste o reserva para o campo</div>
                <div class="bench-list" id="tac-bench"></div>
                <button class="btn-close-sub" onclick="fecharPainelTatico()">Voltar ao Jogo</button>
            </div>
        </div>
    </div>

    <script>
        let gameState, homeTeam, awayTeam, isHome, matchObj;
        let timer = null;
        let match = { min: 0, score: [0, 0], stats: { shots: [0,0], cards: [0,0] }, speed: 1000, paused: false, finished: false };
        let draggedIndex = null; // Para Drag & Drop

        // Coordenadas Padr√£o (4-4-2) caso n√£o tenha salvo
        const defaultCoords = [
            {t:90,l:50},{t:75,l:20},{t:75,l:40},{t:75,l:60},{t:75,l:80},{t:50,l:20},{t:50,l:40},{t:50,l:60},{t:50,l:80},{t:20,l:35},{t:20,l:65}
        ];

        window.onload = function() {
            if (typeof Engine === 'undefined') { alert("Engine Off"); return; }
            gameState = Engine.carregarJogo();
            if (!gameState) { window.location.href = 'index.html'; return; }
            setupMatch();
            iniciarJogo();
        };

        function setupMatch() {
            const semIdx = gameState.semanaAtual - 1;
            const evento = gameState.calendarioUsuario[semIdx];
            matchObj = evento.jogos.find(j => j.casa === gameState.meuTime || j.fora === gameState.meuTime);
            
            homeTeam = Engine.encontrarTime(gameState, matchObj.casa);
            awayTeam = Engine.encontrarTime(gameState, matchObj.fora);
            isHome = (matchObj.casa === gameState.meuTime);

            // UI Header
            document.getElementById('name-h').innerText = homeTeam.nome.substring(0,3);
            document.getElementById('logo-h').src = homeTeam.escudo;
            document.getElementById('name-a').innerText = awayTeam.nome.substring(0,3);
            document.getElementById('logo-a').src = awayTeam.escudo;

            atualizarListasTexto();
        }

        function atualizarListasTexto() {
            renderList('list-home', homeTeam);
            renderList('list-away', awayTeam);
        }

        function renderList(id, t) {
            const el = document.getElementById(id); el.innerHTML = '';
            t.elenco.slice(0,11).forEach(p => {
                el.innerHTML += `<div class="lineup-item"><span class="pos">${p.pos}</span> <span>${p.nome.split(' ')[0]}</span></div>`;
            });
        }

        // --- SISTEMA DE SUBSTITUI√á√ÉO VISUAL ---

        function abrirPainelTatico() {
            match.paused = true; // Pausa
            document.getElementById('tactical-modal').style.display = 'flex';
            renderizarCampoTatico();
            renderizarBancoTatico();
        }

        function fecharPainelTatico() {
            document.getElementById('tactical-modal').style.display = 'none';
            match.paused = false; // Despausa
        }

        function renderizarCampoTatico() {
            const field = document.getElementById('tac-field');
            // Remove players antigos
            field.querySelectorAll('.player-token').forEach(e => e.remove());

            const meuTime = isHome ? homeTeam : awayTeam;
            
            // Renderiza os 11 titulares
            for(let i=0; i<11; i++) {
                const jog = meuTime.elenco[i];
                // Usa coordenadas salvas (x,y) ou padr√£o
                const top = jog.y ? jog.y : defaultCoords[i].t;
                const left = jog.x ? jog.x : defaultCoords[i].l;

                const token = document.createElement('div');
                token.className = 'player-token';
                token.style.top = top + '%';
                token.style.left = left + '%';
                
                // Eventos de Drop (Receber reserva)
                token.ondragover = (e) => { e.preventDefault(); token.classList.add('drag-over'); };
                token.ondragleave = (e) => { token.classList.remove('drag-over'); };
                token.ondrop = (e) => { e.preventDefault(); realizarSubstituicao(i); token.classList.remove('drag-over'); };

                let borderColor = jog.forca >= 80 ? "#f1c40f" : "#333";

                token.innerHTML = `
                    <div class="token-shirt" style="border-color:${borderColor}">${jog.forca}</div>
                    <div class="token-info">${jog.nome.split(' ')[0]}</div>
                `;
                field.appendChild(token);
            }
        }

        function renderizarBancoTatico() {
            const bench = document.getElementById('tac-bench');
            bench.innerHTML = '';
            const meuTime = isHome ? homeTeam : awayTeam;

            // Reservas (√çndice 11 em diante)
            for(let i=11; i<meuTime.elenco.length; i++) {
                const jog = meuTime.elenco[i];
                const item = document.createElement('div');
                item.className = 'bench-item';
                item.draggable = true;
                item.innerHTML = `<span>${jog.pos}</span> <span>${jog.nome}</span> <b>${jog.forca}</b>`;
                
                // Evento de Drag (Iniciar arrasto)
                item.ondragstart = (e) => { draggedIndex = i; item.classList.add('dragging'); };
                item.ondragend = (e) => { item.classList.remove('dragging'); };

                bench.appendChild(item);
            }
        }

        function realizarSubstituicao(indexTitular) {
            if (draggedIndex === null) return;

            const meuTime = isHome ? homeTeam : awayTeam;
            const indexReserva = draggedIndex; // √çndice real no array

            // Troca
            const saindo = meuTime.elenco[indexTitular];
            const entrando = meuTime.elenco[indexReserva];

            // Inverte posi√ß√µes no array
            meuTime.elenco[indexTitular] = entrando;
            meuTime.elenco[indexReserva] = saindo;

            // Mant√©m coordenadas visuais do titular para quem entrou
            if(saindo.x) { entrando.x = saindo.x; entrando.y = saindo.y; }

            // Feedback
            narra(`üîÑ Substitui√ß√£o no ${meuTime.nome}: Sai ${saindo.nome}, entra ${entrando.nome}.`, '');
            
            draggedIndex = null;
            renderizarCampoTatico(); // Re-renderiza para mostrar o novo jogador em campo
            renderizarBancoTatico();
            atualizarListasTexto(); // Atualiza a lista da tela principal
        }

        // --- GAME LOOP ---

        function iniciarJogo() {
            match.paused = false;
            timer = setInterval(loop, match.speed);
        }

        function loop() {
            if(match.paused || match.finished) return;
            match.min++;
            document.getElementById('timer').innerText = (match.min<10?'0':'')+match.min + ":00";

            simularMinuto();

            if(match.min >= 94) {
                match.finished = true; clearInterval(timer);
                narra("Fim de jogo!", 'goal');
                document.getElementById('btn-exit').style.display='inline-block';
                document.getElementById('btn-pause').style.display='none';
                document.getElementById('btn-sub').style.display='none';
            }
        }

        function simularMinuto() {
            // For√ßa + Fator Casa
            const fH = Engine.calcularForcaElenco(homeTeam.elenco) + (isHome?5:0);
            const fA = Engine.calcularForcaElenco(awayTeam.elenco);
            const diff = fH - fA;
            
            // Probabilidade din√¢mica
            const pG_H = 0.02 + (diff * 0.0005);
            const pG_A = 0.02 - (diff * 0.0005);

            if(Math.random() < pG_H) gol(0);
            else if(Math.random() < pG_A) gol(1);
            else if(Math.random() < 0.1) eventoGeral(fH>fA ? 0 : 1);
        }

        function gol(side) {
            match.score[side]++; match.stats.shots[side]++;
            const t = side===0?homeTeam:awayTeam;
            const p = t.elenco[Math.floor(Math.random()*11)]; // Autor (titular)
            document.getElementById(side===0?'gols-h':'gols-a').innerText = match.score[side];
            narra(`‚öΩ GOOOL! ${p.nome} marca para o ${t.nome}!`, 'goal');
            addEvent('‚öΩ', `${match.min}' ${p.nome}`);
            updateStatsUI();
        }

        function eventoGeral(side) {
            const t = side===0?homeTeam:awayTeam;
            const evs = [
                {t:"Chute pra fora!", s:'shots'}, 
                {t:"Defesa√ßa!", s:'shots'}, 
                {t:"Falta dura.", s:'cards', prob:0.2}
            ];
            const e = evs[Math.floor(Math.random()*evs.length)];
            
            if(e.s==='shots') match.stats.shots[side]++;
            if(e.s==='cards' && Math.random()<e.prob) {
                match.stats.cards[side]++;
                const p = t.elenco[Math.floor(Math.random()*11)];
                narra(`üü® Amarelo para ${p.nome}.`, 'card');
                addEvent('üü®', `${match.min}' ${p.nome}`);
            } else {
                narra(`${t.nome}: ${e.t}`);
            }
            updateStatsUI();
        }

        function updateStatsUI() {
            document.getElementById('stats-chutes').innerText = `${match.stats.shots[0]} - ${match.stats.shots[1]}`;
            document.getElementById('stats-cartoes').innerText = `${match.stats.cards[0]} - ${match.stats.cards[1]}`;
            // Fake Posse
            const tot = match.stats.shots[0] + match.stats.shots[1] + 10;
            const ph = Math.floor(((match.stats.shots[0]+5)/tot)*100);
            document.getElementById('posse-txt').innerText = `${ph}% | ${100-ph}%`;
            document.getElementById('bar-h').style.width = ph+'%';
            document.getElementById('bar-a').style.width = (100-ph)+'%';
        }

        function narra(txt, type='') {
            const b = document.getElementById('match-feed');
            b.insertAdjacentHTML('afterbegin', `<div class="feed-msg ${type}"><span class="feed-time">${match.min}'</span> ${txt}</div>`);
        }
        function addEvent(i,t) { document.getElementById('match-events').innerHTML+=`<div><span style="width:20px;display:inline-block">${i}</span> ${t}</div>`; }

        function sairDoJogo() {
            matchObj.golsCasa = match.score[0];
            matchObj.golsFora = match.score[1];
            Engine.salvarJogo(gameState);
            // Simula o resto do mundo
            Engine.processarSemana(gameState);
            window.location.href = 'dashboard.html';
        }

        function pausarJogo() { match.paused = !match.paused; document.getElementById('btn-pause').innerText = match.paused ? "‚ñ∂Ô∏è" : "‚è∏Ô∏è"; }
        function mudarVelocidade() { 
            match.speed = (match.speed===1000) ? 200 : 1000;
            document.getElementById('lbl-speed').innerText = (match.speed===200) ? "5x" : "1x";
            clearInterval(timer); if(!match.finished && !match.paused) timer = setInterval(loop, match.speed);
        }

    </script>
</body>
</html>
