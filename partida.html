<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRFutebol - Matchday</title>
    
    <script src="database_jogadores.js"></script>
    <script src="engine.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700;900&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-dark: #0f1216;
            --bg-panel: rgba(20, 25, 30, 0.98);
            --accent: #00ff88;
            --text-main: #ffffff;
            --text-dim: #8b9bb4;
            --gold: #f1c40f;
            --red: #ff4757;
            --blue: #3498db;
            --pos-ok: #2ecc71;
            --pos-med: #f1c40f;
            --pos-bad: #e74c3c;
        }

        * { box-sizing: border-box; user-select: none; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at 50% 50%, #1a202c 0%, #0f1216 100%);
            color: var(--text-main);
            margin: 0; height: 100vh;
            display: flex; flex-direction: column; align-items: center;
            overflow: hidden;
        }

        /* PLACAR */
        .scoreboard {
            width: 100%; max-width: 900px;
            background: linear-gradient(180deg, #1e2329 0%, #161b22 100%);
            border-bottom: 2px solid var(--accent); padding: 15px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 10; flex-shrink: 0;
        }
        .team-display { display: flex; flex-direction: column; align-items: center; width: 30%; }
        .team-logo { width: 60px; height: 60px; object-fit: contain; filter: drop-shadow(0 0 5px rgba(0,0,0,0.5)); }
        .team-name { font-family: 'Rajdhani'; font-weight: 800; font-size: 1.1rem; margin-top: 5px; text-transform: uppercase; }
        .score-area { display: flex; align-items: center; justify-content: center; gap: 15px; font-family: 'Rajdhani'; font-weight: 900; font-size: 3rem; }
        .score-box { background: #000; padding: 0 20px; border-radius: 8px; border: 1px solid #333; min-width: 70px; text-align: center; }
        .timer-badge { background: var(--accent); color: #000; padding: 2px 12px; border-radius: 15px; font-size: 0.9rem; font-weight: 800; margin-bottom: 5px; }

        /* CAMPO / FEED */
        .match-container {
            flex: 1; width: 100%; max-width: 900px;
            display: grid; grid-template-columns: 2fr 1fr;
            gap: 15px; padding: 15px; overflow: hidden;
        }

        .feed-panel {
            background: var(--bg-panel); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px; display: flex; flex-direction: column; overflow: hidden;
        }
        .feed-header { padding: 12px; background: rgba(0,0,0,0.3); border-bottom: 1px solid #333; font-family: 'Rajdhani'; font-weight: 700; display: flex; justify-content: space-between; color: var(--text-dim); }
        .feed-content { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; scroll-behavior: smooth; }
        .feed-content::-webkit-scrollbar { width: 5px; }
        .feed-content::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

        .feed-item { display: flex; gap: 10px; align-items: flex-start; padding: 8px; border-radius: 6px; background: rgba(255,255,255,0.02); border-left: 3px solid transparent; animation: slideIn 0.3s ease; font-size: 0.9rem; }
        .feed-time { font-family: 'Rajdhani'; font-weight: 800; color: var(--accent); min-width: 25px; }
        .feed-item.goal { background: rgba(0, 255, 136, 0.1); border-left-color: var(--accent); }
        .feed-item.sub { background: rgba(52, 152, 219, 0.1); border-left-color: var(--blue); color: var(--blue); }
        .feed-item.danger { border-left-color: var(--gold); }

        /* ESTAT√çSTICAS */
        .stats-panel { background: var(--bg-panel); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 15px; display: flex; flex-direction: column; gap: 15px; }
        .stat-row { display: flex; flex-direction: column; gap: 4px; }
        .stat-bars { display: flex; align-items: center; gap: 8px; }
        .bar-bg { flex: 1; height: 5px; background: #222; border-radius: 3px; overflow: hidden; display: flex; }
        .bar-L { height: 100%; background: var(--text-main); }

        /* FOOTER */
        .footer-controls {
            width: 100%; padding: 15px; background: #161b22;
            display: flex; justify-content: center; gap: 15px; border-top: 1px solid #333;
        }
        .btn-speed {
            padding: 10px 20px; border-radius: 6px; border: 1px solid #444; background: #222;
            color: #888; font-family: 'Rajdhani'; font-weight: 700; cursor: pointer; transition: 0.2s;
        }
        .btn-speed.active { background: var(--accent); color: #000; border-color: var(--accent); }
        .btn-sub { background: var(--blue); color: #fff; border: none; padding: 10px 30px; border-radius: 6px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .btn-sub:hover { background: #2980b9; }

        /* --- MODAL SUBSTITUI√á√ÉO --- */
        .sub-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.9); z-index: 200;
            display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px);
        }
        .sub-card {
            width: 95%; max-width: 950px; height: 90vh; max-height: 700px;
            background: #161b22; border: 1px solid #444; border-radius: 12px;
            display: flex; flex-direction: column; box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }
        
        .sub-header {
            padding: 15px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center;
        }
        .sub-header h2 { margin: 0; font-family: 'Rajdhani'; color: var(--text-main); font-size: 1.5rem; }
        
        .modal-tac-select {
            background: #000; color: var(--accent); border: 1px solid var(--accent);
            padding: 5px 15px; border-radius: 4px; font-family: 'Rajdhani'; font-weight: 700; cursor: pointer; outline: none;
        }

        .sub-body {
            flex: 1; display: grid; grid-template-columns: 2fr 1fr; gap: 20px; padding: 20px; overflow: hidden;
        }
        
        /* CAMPO NO MODAL */
        .mini-pitch {
            position: relative; width: 100%; height: 100%;
            background: repeating-linear-gradient(to right, #2e7d32, #2e7d32 10%, #368e3c 10%, #368e3c 20%);
            border: 2px solid rgba(255,255,255,0.5); border-radius: 6px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        }
        .mini-pitch * { pointer-events: none; }
        .mp-line { position: absolute; border: 1px solid rgba(255,255,255,0.4); }
        .mp-center { top:50%; left:50%; width:80px; height:80px; border-radius:50%; transform:translate(-50%,-50%); }
        .mp-half { left:50%; top:0; height:100%; width:1px; transform:translateX(-50%); border:none; background:rgba(255,255,255,0.4); }
        .mp-box-left { width:15%; height:50%; top:25%; left:0; border-left:none; }
        .mp-box-right { width:15%; height:50%; top:25%; right:0; border-right:none; }

        /* JOGADOR NO CAMPO (SUB) */
        .sub-p-node {
            position: absolute; width: 60px; height: 60px;
            transform: translate(-50%, -50%); pointer-events: auto !important;
            display: flex; flex-direction: column; align-items: center; cursor: pointer;
            transition: all 0.3s ease; 
        }
        .sub-p-node:hover { transform: translate(-50%, -50%) scale(1.1); z-index: 100; }
        
        .sub-kit {
            width: 32px; height: 32px; background: #222; border: 2px solid #fff; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 0.75rem; color: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        .sub-p-node.selected-out .sub-kit { border-color: var(--red); background: rgba(231, 76, 60, 0.2); box-shadow: 0 0 15px var(--red); }
        
        .sub-name { font-size: 0.75rem; background: rgba(0,0,0,0.8); padding: 2px 6px; border-radius: 4px; margin-top: 3px; white-space: nowrap; font-weight: 600; }
        .sub-health-bar { width: 100%; height: 3px; background: #444; margin-top: 2px; border-radius: 2px; }
        .sub-health-fill { height: 100%; border-radius: 2px; }

        /* LISTA RESERVAS */
        .sub-list { overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; border: 1px solid #333; }
        .sub-list::-webkit-scrollbar { width: 5px; }
        .sub-list::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }

        .player-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05);
            cursor: pointer; border-radius: 4px; transition: 0.2s;
        }
        .player-row:hover { background: rgba(255,255,255,0.05); }
        .player-row.selected-in { background: rgba(0, 255, 136, 0.2); border-left: 3px solid var(--accent); }
        
        .row-info { display: flex; flex-direction: column; }
        .row-name { font-weight: 700; font-size: 0.9rem; }
        .row-pos { font-size: 0.75rem; color: #888; font-weight: 700; }

        .sub-footer { padding: 15px; border-top: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .btn-confirm { background: var(--accent); color: #000; border: none; padding: 12px 30px; border-radius: 6px; font-weight: 800; cursor: pointer; text-transform: uppercase; }
        .btn-confirm:disabled { background: #333; color: #666; cursor: not-allowed; }
        
        .btn-back { background: transparent; border: 1px solid #666; color: #ccc; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .btn-back:hover { border-color: #fff; color: #fff; }

        /* TOOLTIP FIFA (HOVER) */
        #fifa-tooltip {
            position: fixed; display: none; width: 180px;
            background: rgba(18, 20, 24, 0.98); border: 1px solid #666; border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.9); z-index: 3000; pointer-events: none;
            padding: 10px; backdrop-filter: blur(10px);
        }
        .fifa-header { display: flex; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px; margin-bottom: 5px; }
        .fifa-ovr { font-family: 'Rajdhani'; font-size: 1.8rem; font-weight: 900; color: var(--gold); margin-right: 10px; line-height: 1; }
        .fifa-info { display: flex; flex-direction: column; }
        .fifa-name { font-weight: 800; font-size: 0.85rem; color: #fff; }
        .fifa-pos { font-size: 0.7rem; color: var(--accent); font-weight: 700; }
        .fifa-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; row-gap: 2px; }
        .fifa-stat { font-family: 'Rajdhani'; font-size: 0.8rem; display: flex; justify-content: space-between; }
        .fifa-stat span { color: #888; font-weight: 600; margin-right: 5px; }
        .fifa-stat b { color: #fff; }
        .fifa-stat b.high { color: var(--pos-ok); }
        .fifa-stat b.mid { color: var(--pos-med); }
        .fifa-stat b.low { color: var(--pos-bad); }

        /* GOAL OVERLAY */
        #goal-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.9); z-index: 300;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        .goal-text { font-family: 'Rajdhani'; font-size: 6rem; font-weight: 900; color: var(--accent); animation: zoomIn 0.5s; }
        .goal-scorer { font-size: 2rem; color: #fff; margin-top: -10px; }

        @keyframes slideIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
        @keyframes zoomIn { from { transform:scale(0); } to { transform:scale(1); } }

    </style>
</head>
<body>

    <div class="scoreboard">
        <div class="team-display">
            <img id="home-logo" src="" class="team-logo">
            <div class="team-name" id="home-name">CASA</div>
        </div>
        <div style="display:flex; flex-direction:column; align-items:center;">
            <div class="timer-badge" id="timer-display">1¬∫ 00'</div>
            <div class="score-area">
                <div class="score-box" id="score-home">0</div>
                <span>:</span>
                <div class="score-box" id="score-away">0</div>
            </div>
        </div>
        <div class="team-display">
            <img id="away-logo" src="" class="team-logo">
            <div class="team-name" id="away-name">FORA</div>
        </div>
    </div>

    <div class="match-container">
        <div class="feed-panel">
            <div class="feed-header"><span>Narra√ß√£o</span> <span style="color:var(--red)">‚óè AO VIVO</span></div>
            <div class="feed-content" id="feed"></div>
        </div>
        <div class="stats-panel">
            <div class="stat-row">
                <span style="font-size:0.8rem; color:#888;">POSSE DE BOLA</span>
                <div class="stat-bars">
                    <span id="stat-pos-h">50%</span>
                    <div class="bar-bg"><div class="bar-L" id="bar-pos-h" style="width:50%"></div></div>
                    <span id="stat-pos-a">50%</span>
                </div>
            </div>
            <div class="stat-row">
                <span style="font-size:0.8rem; color:#888;">FINALIZA√á√ïES</span>
                <div class="stat-bars">
                    <span id="stat-sho-h">0</span>
                    <div class="bar-bg"><div class="bar-L" id="bar-sho-h" style="width:0%"></div></div>
                    <span id="stat-sho-a">0</span>
                </div>
            </div>
        </div>
    </div>

    <div class="footer-controls">
        <button class="btn-speed active" onclick="setSpeed(1, this)">1x</button>
        <button class="btn-speed" onclick="setSpeed(2, this)">2x</button>
        <button class="btn-speed" onclick="setSpeed(3, this)">‚ö°</button>
        <div style="flex:1"></div>
        <button class="btn-sub" onclick="abrirModalSub()">üîÑ SUBSTITUIR / T√ÅTICA</button>
    </div>

    <div id="sub-modal" class="sub-overlay">
        <div class="sub-card">
            <div class="sub-header">
                <h2>Gerenciar Equipe</h2>
                <div style="display:flex; gap:10px; align-items:center;">
                    <span style="color:#888; font-size:0.9rem; font-weight:700;">FORMA√á√ÉO:</span>
                    <select id="sub-formation" class="modal-tac-select" onchange="mudarFormacaoJogo()">
                        <option value="4-3-3">4-3-3</option>
                        <option value="4-4-2">4-4-2</option>
                        <option value="3-5-2">3-5-2</option>
                        <option value="4-2-3-1">4-2-3-1</option>
                        <option value="3-4-3">3-4-3</option>
                    </select>
                </div>
            </div>
            
            <div class="sub-body">
                <div class="mini-pitch" id="pitch-container">
                    <div class="mp-line mp-half"></div>
                    <div class="mp-line mp-center"></div>
                    <div class="mp-line mp-box-left"></div>
                    <div class="mp-line mp-box-right"></div>
                    </div>

                <div class="sub-list" id="list-reservas">
                    </div>
            </div>
            
            <div class="sub-footer">
                <button class="btn-back" onclick="fecharModalSub()">VOLTAR AO JOGO</button>
                <div id="sub-msg" style="color:#888; font-size:0.9rem;">Selecione um no Campo e um no Banco</div>
                <button class="btn-confirm" id="btn-confirm-sub" disabled onclick="confirmarSub()">CONFIRMAR TROCA</button>
            </div>
        </div>
    </div>

    <div id="fifa-tooltip">
        <div class="fifa-header">
            <div class="fifa-ovr" id="tip-ovr">00</div>
            <div class="fifa-info">
                <div class="fifa-name" id="tip-name">NOME</div>
                <div class="fifa-pos" id="tip-pos">POS</div>
            </div>
        </div>
        <div class="fifa-grid" id="tip-grid"></div>
    </div>

    <div id="goal-overlay">
        <div class="goal-text">GOL!</div>
        <div class="goal-scorer" id="goal-scorer-name">Jogador</div>
    </div>

    <script>
        if (typeof database !== 'undefined') window.Database = database;
        if (typeof Database !== 'undefined') window.database = Database;

        let gameState, homeTeam, awayTeam;
        let titulares = [], reservas = [];
        let formacaoAtual = "4-3-3";
        let matchInterval = null, tempo = 0, etapa = 1;
        let placar = { home: 0, away: 0 };
        let stats = { homeSho:0, awaySho:0, homePos:50 };
        let speed = 200; 
        let subPending = { sai: null, entra: null };

        // COORDENADAS (LAYOUTS)
        const layouts = {
            "4-3-3": [{t:"50%",l:"6%"},{t:"15%",l:"25%"},{t:"38%",l:"20%"},{t:"62%",l:"20%"},{t:"85%",l:"25%"},{t:"50%",l:"40%"},{t:"30%",l:"55%"},{t:"70%",l:"55%"},{t:"20%",l:"85%"},{t:"50%",l:"85%"},{t:"80%",l:"85%"}],
            "4-4-2": [{t:"50%",l:"6%"},{t:"15%",l:"25%"},{t:"38%",l:"20%"},{t:"62%",l:"20%"},{t:"85%",l:"25%"},{t:"30%",l:"45%"},{t:"70%",l:"45%"},{t:"15%",l:"60%"},{t:"85%",l:"60%"},{t:"35%",l:"85%"},{t:"65%",l:"85%"}],
            "3-5-2": [{t:"50%",l:"6%"},{t:"20%",l:"20%"},{t:"50%",l:"18%"},{t:"80%",l:"20%"},{t:"15%",l:"45%"},{t:"35%",l:"40%"},{t:"65%",l:"40%"},{t:"85%",l:"45%"},{t:"50%",l:"60%"},{t:"35%",l:"85%"},{t:"65%",l:"85%"}],
            "4-2-3-1":[{t:"50%",l:"6%"},{t:"15%",l:"25%"},{t:"38%",l:"20%"},{t:"62%",l:"20%"},{t:"85%",l:"25%"},{t:"35%",l:"40%"},{t:"65%",l:"40%"},{t:"20%",l:"65%"},{t:"50%",l:"60%"},{t:"80%",l:"65%"},{t:"50%",l:"88%"}],
            "3-4-3": [{t:"50%",l:"6%"},{t:"20%",l:"20%"},{t:"50%",l:"18%"},{t:"80%",l:"20%"},{t:"15%",l:"45%"},{t:"40%",l:"45%"},{t:"60%",l:"45%"},{t:"85%",l:"45%"},{t:"20%",l:"85%"},{t:"50%",l:"85%"},{t:"80%",l:"85%"}]
        };

        window.onload = function() {
            carregarDados();
        };

        function carregarDados() {
            gameState = Engine.carregarJogo();
            if(!gameState) { window.location.href='index.html'; return; }

            // Carrega forma√ß√£o salva
            const savedScheme = localStorage.getItem('brfutebol_esquema');
            if(savedScheme) formacaoAtual = savedScheme;
            document.getElementById('sub-formation').value = formacaoAtual;

            // Carrega Times
            homeTeam = encontrarTime(gameState.meuTime);
            const opNome = localStorage.getItem('brfutebol_oponente_atual') || "Visitante";
            awayTeam = encontrarTime(opNome);
            if(!awayTeam.elenco || awayTeam.elenco.length===0) awayTeam.elenco = gerarGenericos(awayTeam.nome);

            // GERA IDs para todo mundo (CORRE√á√ÉO DE SINCRONIA: p_)
            homeTeam.elenco.forEach((j, i) => { if(!j.uid) j.uid = `p_${i}`; });

            // ORGANIZA ELENCO
            organizarElenco(homeTeam);

            // Renderiza Header
            document.getElementById('home-name').innerText = homeTeam.nome;
            document.getElementById('home-logo').src = homeTeam.escudo;
            document.getElementById('away-name').innerText = awayTeam.nome;
            document.getElementById('away-logo').src = awayTeam.escudo || "";

            adicionarLog("", "As equipes entram em campo!", "");
            iniciarRelogio();
        }

        function organizarElenco(time) {
            // Tenta recuperar do save JSON, mas se falhar ou estiver incompleto, usa os 11 primeiros
            const savedForm = localStorage.getItem('brfutebol_formacao');
            titulares = [];
            reservas = [];
            let escaladosIds = [];

            if(savedForm) {
                try {
                    const map = JSON.parse(savedForm);
                    // Pega apenas slots de 1 a 11
                    for(let i=1; i<=11; i++) {
                        const uid = map[`slot-${i}`];
                        const jog = time.elenco.find(j => j.uid === uid);
                        if(jog) {
                            titulares.push(jog);
                            escaladosIds.push(jog.uid);
                        }
                    }
                } catch(e) {}
            }

            // PROTE√á√ÉO: Se n√£o tiver 11 titulares, completa com os melhores disponiveis
            if(titulares.length < 11) {
                const disponiveis = time.elenco.filter(j => !escaladosIds.includes(j.uid));
                // Ordena por for√ßa e pega os que faltam
                disponiveis.sort((a,b)=>b.forca-a.forca);
                const faltam = 11 - titulares.length;
                for(let k=0; k<faltam; k++) {
                    if(disponiveis[k]) {
                        titulares.push(disponiveis[k]);
                        escaladosIds.push(disponiveis[k].uid);
                    }
                }
            }

            // O resto vira reserva
            reservas = time.elenco.filter(j => !escaladosIds.includes(j.uid));
        }

        function encontrarTime(nome) {
            const db = window.database || window.Database;
            for(let s in db.brasil) {
                const t = db.brasil[s].find(x => x.nome === nome);
                if(t) return JSON.parse(JSON.stringify(t)); 
            }
            return { nome: nome, escudo: "", elenco: [] };
        }

        function gerarGenericos(nome) {
            let l=[]; for(let i=0;i<15;i++) l.push({nome:`Jog ${i}`, pos:'ATA'}); return l;
        }

        // --- ENGINE ---
        function iniciarRelogio() {
            clearInterval(matchInterval);
            matchInterval = setInterval(loopJogo, speed);
        }

        function loopJogo() {
            tempo++;
            document.getElementById('timer-display').innerText = `${etapa}¬∫ ${tempo}'`;

            if(Math.random() < 0.04) processarLance();

            if(tempo === 45 && etapa === 1) {
                pausarJogo();
                adicionarLog("Juiz", "Fim do primeiro tempo! Intervalo.", "card");
                etapa = 2; tempo = 0;
                setTimeout(() => { alert("Intervalo!"); abrirModalSub(); }, 500);
            }

            if(tempo === 45 && etapa === 2) {
                pausarJogo();
                document.getElementById('timer-display').innerText = "FIM";
                adicionarLog("Juiz", "Fim de jogo!", "card");
                setTimeout(() => {
                    if(confirm("Fim de jogo! Voltar?")) {
                        localStorage.removeItem('brfutebol_oponente_atual');
                        window.location.href = 'dashboard.html';
                    }
                }, 1000);
            }
        }

        function processarLance() {
            const diff = (calcularMedia(titulares) - (awayTeam.forca||60));
            const chanceH = 50 + (diff/2);
            const rng = Math.random() * 100;

            if(rng < chanceH) { 
                if(Math.random() < 0.15) gol(true);
                else { stats.homeSho++; adicionarLog(homeTeam.nome, "Chute perigoso!", "danger"); }
            } else { 
                if(Math.random() < 0.15) gol(false);
                else { stats.awaySho++; adicionarLog(awayTeam.nome, "Contra-ataque... pra fora!", "danger"); }
            }
            atualizarStats();
        }

        function gol(isHome) {
            pausarJogo();
            if(isHome) { placar.home++; stats.homeSho++; } else { placar.away++; stats.awaySho++; }
            document.getElementById('score-home').innerText = placar.home;
            document.getElementById('score-away').innerText = placar.away;
            
            const autor = isHome ? titulares[Math.floor(Math.random()*titulares.length)].nome : "Advers√°rio";
            document.getElementById('goal-scorer-name').innerText = autor;
            document.getElementById('goal-overlay').style.display = 'flex';
            adicionarLog("GOL", `${autor} marca!`, "goal");

            setTimeout(() => { document.getElementById('goal-overlay').style.display='none'; iniciarRelogio(); }, 2000);
        }

        // --- SISTEMA DE SUBSTITUI√á√ÉO E T√ÅTICA ---
        function abrirModalSub() {
            pausarJogo();
            document.getElementById('sub-modal').style.display = 'flex';
            renderizarCampoSub();
            renderizarListaReservas();
            subPending = { sai: null, entra: null };
            atualizarUIBotao();
        }

        function fecharModalSub() {
            document.getElementById('sub-modal').style.display = 'none';
            if(!(etapa===2 && tempo===0)) iniciarRelogio();
        }

        function mudarFormacaoJogo() {
            formacaoAtual = document.getElementById('sub-formation').value;
            // Re-renderiza o campo com novas coordenadas
            renderizarCampoSub();
            adicionarLog("T√©cnico", `Altera√ß√£o t√°tica: Time agora joga no ${formacaoAtual}.`, "sub");
        }

        function renderizarCampoSub() {
            const container = document.getElementById('pitch-container');
            // Remove jogadores antigos (mant√©m linhas)
            const nodes = container.querySelectorAll('.sub-p-node');
            nodes.forEach(n => n.remove());

            // Pega layout atual
            const coords = layouts[formacaoAtual] || layouts['4-3-3'];

            titulares.forEach((jog, index) => {
                // Se tiver mais jogadores que posi√ß√µes (bug safety), usa pos 0
                const pos = coords[index] || {t:"50%", l:"50%"};
                
                const el = document.createElement('div');
                el.className = 'sub-p-node';
                el.style.top = pos.t;
                el.style.left = pos.l;
                el.onclick = () => selecionarSai(jog.uid, el);
                el.dataset.uid = jog.uid; // Para hover tooltip

                // L√≥gica de cor da barra de sa√∫de
                const saude = jog.saude !== undefined ? jog.saude : 100;
                let cor = saude < 60 ? '#e74c3c' : '#2ecc71';

                el.innerHTML = `
                    <div class="sub-kit">${jog.pos}</div>
                    <div class="sub-name">${jog.nome.split(' ')[0]}</div>
                    <div class="sub-health-bar"><div class="sub-health-fill" style="width:${saude}%; background:${cor}"></div></div>
                `;
                
                // HOVER
                el.addEventListener('mouseenter', showTooltip);
                el.addEventListener('mousemove', moveTooltip);
                el.addEventListener('mouseleave', hideTooltip);

                container.appendChild(el);
            });
        }

        function renderizarListaReservas() {
            const lista = document.getElementById('list-reservas');
            lista.innerHTML = '';
            
            reservas.forEach(jog => {
                const el = document.createElement('div');
                el.className = 'player-row';
                el.innerHTML = `
                    <div class="row-info">
                        <span class="row-pos">${jog.pos}</span>
                        <span class="row-name">${jog.nome}</span>
                    </div>
                    <span style="font-weight:800; color:#fff">${jog.forca}</span>
                `;
                el.dataset.uid = jog.uid;
                el.onclick = () => selecionarEntra(jog.uid, el);
                
                // HOVER
                el.addEventListener('mouseenter', showTooltip);
                el.addEventListener('mousemove', moveTooltip);
                el.addEventListener('mouseleave', hideTooltip);

                lista.appendChild(el);
            });
        }

        function selecionarSai(uid, el) {
            document.querySelectorAll('.sub-p-node').forEach(n => n.classList.remove('selected-out'));
            el.classList.add('selected-out');
            subPending.sai = uid;
            atualizarUIBotao();
        }

        function selecionarEntra(uid, el) {
            document.querySelectorAll('.player-row').forEach(n => n.classList.remove('selected-in'));
            el.classList.add('selected-in');
            subPending.entra = uid;
            atualizarUIBotao();
        }

        function atualizarUIBotao() {
            const btn = document.getElementById('btn-confirm-sub');
            const msg = document.getElementById('sub-msg');
            
            if(subPending.sai && subPending.entra) {
                btn.disabled = false;
                msg.innerText = "Troca pronta para confirmar.";
                msg.style.color = "var(--accent)";
            } else {
                btn.disabled = true;
                msg.innerText = "Selecione um no Campo e um no Banco";
                msg.style.color = "#888";
            }
        }

        function confirmarSub() {
            if(!subPending.sai || !subPending.entra) return;

            const idxSai = titulares.findIndex(j => j.uid === subPending.sai);
            const idxEntra = reservas.findIndex(j => j.uid === subPending.entra);

            if(idxSai > -1 && idxEntra > -1) {
                const jogSai = titulares[idxSai];
                const jogEntra = reservas[idxEntra];

                titulares[idxSai] = jogEntra;
                reservas.splice(idxEntra, 1);
                reservas.push(jogSai); // Vai pro fim do banco

                adicionarLog("Substitui√ß√£o", `Saiu ${jogSai.nome} üîª Entrou ${jogEntra.nome} üî∫`, "sub");
                
                subPending = { sai:null, entra:null };
                renderizarCampoSub();
                renderizarListaReservas();
                atualizarUIBotao();
            }
        }

        // --- TOOLTIPS (ATRIBUTOS) ---
        function showTooltip(e) {
            const uid = this.dataset.uid;
            if(!uid) return;
            // Busca em ambos
            let jog = titulares.find(j => j.uid === uid) || reservas.find(j => j.uid === uid);
            if(!jog) return;

            gerarAtributosSeNecessario(jog);

            document.getElementById('tip-name').innerText = jog.nome;
            document.getElementById('tip-pos').innerText = jog.pos;
            document.getElementById('tip-ovr').innerText = jog.forca;

            const grid = document.getElementById('tip-grid');
            grid.innerHTML = '';
            const labels = { VEL:'PAC', FIN:'SHO', PAS:'PAS', DRI:'DRI', DEF:'DEF', FIS:'PHY' };
            for(let key in labels) {
                const val = jog.atributos[key];
                let cls = 'mid'; if(val>=80) cls='high'; if(val<60) cls='low';
                grid.innerHTML += `<div class="fifa-stat"><span>${labels[key]}</span><b class="${cls}">${val}</b></div>`;
            }
            const tip = document.getElementById('fifa-tooltip');
            tip.style.display = 'block';
            moveTooltip(e);
        }

        function moveTooltip(e) {
            const tip = document.getElementById('fifa-tooltip');
            tip.style.top = (e.clientY + 15) + 'px';
            tip.style.left = (e.clientX + 15) + 'px';
        }

        function hideTooltip() { document.getElementById('fifa-tooltip').style.display = 'none'; }

        function gerarAtributosSeNecessario(jog) {
            if(!jog.atributos || !jog.atributos.VEL) {
                const base = jog.forca;
                if(jog.pos === 'GOL') {
                    jog.atributos = { VEL:base+2, FIN:base-5, PAS:base, DRI:base-10, DEF:base+5, FIS:base };
                } else if (jog.pos === 'ATA') {
                    jog.atributos = { VEL:base+5, FIN:base+5, PAS:base-5, DRI:base+5, DEF:base-30, FIS:base };
                } else {
                    jog.atributos = { VEL:base, FIN:base-5, PAS:base+5, DRI:base, DEF:base, FIS:base };
                }
            }
        }

        // --- UTIL ---
        function adicionarLog(h, t, cl) {
            const f = document.getElementById('feed');
            const d = document.createElement('div');
            d.className = `feed-item ${cl}`;
            d.innerHTML = `<div class="feed-time">${tempo}'</div><div><b>${h}</b> ${t}</div>`;
            f.prepend(d);
        }
        function calcularMedia(arr) { return arr.reduce((a,b)=>a+b.forca,0)/arr.length; }
        function atualizarStats() {
            document.getElementById('stat-sho-h').innerText=stats.homeSho;
            document.getElementById('stat-sho-a').innerText=stats.awaySho;
            const t = stats.homeSho+stats.awaySho||1;
            document.getElementById('bar-sho-h').style.width=((stats.homeSho/t)*100)+"%";
        }
        function pausarJogo() { clearInterval(matchInterval); }
        function setSpeed(m, btn) {
            document.querySelectorAll('.btn-speed').forEach(b=>b.classList.remove('active'));
            btn.classList.add('active');
            speed = m===1?200 : m===2?80 : 10;
            if(!document.getElementById('sub-modal').style.display.includes('flex')) iniciarRelogio();
        }

    </script>
</body>
</html>
