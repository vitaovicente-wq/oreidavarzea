<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRFutebol - Matchday</title>
    
    <script src="database_jogadores.js"></script>
    <script src="engine.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700;900&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-dark: #0f1216;
            --bg-panel: rgba(20, 25, 30, 0.95);
            --accent: #00ff88;
            --text-main: #ffffff;
            --text-dim: #8b9bb4;
            --gold: #f1c40f;
            --red: #ff4757;
            --blue: #3498db;
        }

        * { box-sizing: border-box; user-select: none; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at 50% 50%, #1a202c 0%, #0f1216 100%);
            color: var(--text-main);
            margin: 0;
            height: 100vh;
            display: flex; flex-direction: column; align-items: center;
            overflow: hidden;
        }

        /* PLACAR */
        .scoreboard {
            width: 100%; max-width: 900px;
            background: linear-gradient(180deg, #1e2329 0%, #161b22 100%);
            border-bottom: 2px solid var(--accent); padding: 15px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 10; flex-shrink: 0;
        }
        .team-display { display: flex; flex-direction: column; align-items: center; width: 30%; }
        .team-logo { width: 60px; height: 60px; object-fit: contain; filter: drop-shadow(0 0 5px rgba(0,0,0,0.5)); }
        .team-name { font-family: 'Rajdhani'; font-weight: 800; font-size: 1.1rem; margin-top: 5px; text-transform: uppercase; }
        
        .score-area { display: flex; align-items: center; justify-content: center; gap: 15px; font-family: 'Rajdhani'; font-weight: 900; font-size: 3rem; }
        .score-box { background: #000; padding: 0 20px; border-radius: 8px; border: 1px solid #333; min-width: 70px; text-align: center; }
        .timer-badge { background: var(--accent); color: #000; padding: 2px 12px; border-radius: 15px; font-size: 0.9rem; font-weight: 800; margin-bottom: 5px; }

        /* CAMPO / FEED */
        .match-container {
            flex: 1; width: 100%; max-width: 900px;
            display: grid; grid-template-columns: 2fr 1fr;
            gap: 15px; padding: 15px; overflow: hidden;
        }

        .feed-panel {
            background: var(--bg-panel); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px; display: flex; flex-direction: column; overflow: hidden;
        }
        .feed-header { padding: 12px; background: rgba(0,0,0,0.3); border-bottom: 1px solid #333; font-family: 'Rajdhani'; font-weight: 700; display: flex; justify-content: space-between; color: var(--text-dim); }
        .feed-content { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; scroll-behavior: smooth; }
        .feed-content::-webkit-scrollbar { width: 5px; }
        .feed-content::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

        .feed-item { display: flex; gap: 10px; align-items: flex-start; padding: 8px; border-radius: 6px; background: rgba(255,255,255,0.02); border-left: 3px solid transparent; animation: slideIn 0.3s ease; font-size: 0.9rem; }
        .feed-time { font-family: 'Rajdhani'; font-weight: 800; color: var(--accent); min-width: 25px; }
        .feed-item.goal { background: rgba(0, 255, 136, 0.1); border-left-color: var(--accent); }
        .feed-item.sub { background: rgba(52, 152, 219, 0.1); border-left-color: var(--blue); color: var(--blue); }
        .feed-item.danger { border-left-color: var(--gold); }

        /* ESTAT√çSTICAS */
        .stats-panel { background: var(--bg-panel); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 15px; display: flex; flex-direction: column; gap: 15px; }
        .stat-row { display: flex; flex-direction: column; gap: 4px; }
        .stat-bars { display: flex; align-items: center; gap: 8px; }
        .bar-bg { flex: 1; height: 5px; background: #222; border-radius: 3px; overflow: hidden; display: flex; }
        .bar-L { height: 100%; background: var(--text-main); }
        .bar-R { height: 100%; background: var(--text-dim); }

        /* FOOTER */
        .footer-controls {
            width: 100%; padding: 15px; background: #161b22;
            display: flex; justify-content: center; gap: 15px; border-top: 1px solid #333;
        }
        .btn-speed {
            padding: 10px 20px; border-radius: 6px; border: 1px solid #444; background: #222;
            color: #888; font-family: 'Rajdhani'; font-weight: 700; cursor: pointer; transition: 0.2s;
        }
        .btn-speed.active { background: var(--accent); color: #000; border-color: var(--accent); }
        .btn-sub { background: var(--blue); color: #fff; border: none; padding: 10px 30px; border-radius: 6px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .btn-sub:hover { background: #2980b9; }

        /* MODAL SUBSTITUI√á√ÉO */
        .sub-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.9); z-index: 200;
            display: none; align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
        }
        .sub-card {
            width: 700px; height: 500px; background: #161b22;
            border: 1px solid #444; border-radius: 12px; display: flex; flex-direction: column;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }
        .sub-header { padding: 15px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .sub-header h2 { margin: 0; font-family: 'Rajdhani'; color: var(--text-main); }
        .sub-body { flex: 1; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 20px; overflow: hidden; }
        
        .sub-list { overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; border: 1px solid #333; }
        .sub-list h4 { margin: 0 0 10px 0; color: var(--text-dim); text-transform: uppercase; font-size: 0.8rem; }
        
        .player-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05);
            cursor: pointer; border-radius: 4px; transition: 0.2s;
        }
        .player-row:hover { background: rgba(255,255,255,0.05); }
        .player-row.selected { background: var(--accent); color: #000; font-weight: 700; }
        
        .pos-tag { font-size: 0.7rem; font-weight: 800; width: 30px; }
        .p-name { flex: 1; }
        .p-ovr { font-weight: 700; }

        .sub-footer { padding: 15px; border-top: 1px solid #333; display: flex; justify-content: flex-end; gap: 10px; }
        .btn-confirm { background: var(--accent); color: #000; border: none; padding: 10px 20px; border-radius: 6px; font-weight: 800; cursor: pointer; }
        
        /* GOAL OVERLAY */
        #goal-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.9); z-index: 300;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        .goal-text { font-family: 'Rajdhani'; font-size: 6rem; font-weight: 900; color: var(--accent); animation: zoomIn 0.5s; }
        .goal-scorer { font-size: 2rem; color: #fff; margin-top: -10px; }

        @keyframes slideIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
        @keyframes zoomIn { from { transform:scale(0); } to { transform:scale(1); } }

    </style>
</head>
<body>

    <div class="scoreboard">
        <div class="team-display">
            <img id="home-logo" src="" class="team-logo">
            <div class="team-name" id="home-name">CASA</div>
        </div>
        <div style="display:flex; flex-direction:column; align-items:center;">
            <div class="timer-badge" id="timer-display">1¬∫ 00'</div>
            <div class="score-area">
                <div class="score-box" id="score-home">0</div>
                <span>:</span>
                <div class="score-box" id="score-away">0</div>
            </div>
        </div>
        <div class="team-display">
            <img id="away-logo" src="" class="team-logo">
            <div class="team-name" id="away-name">FORA</div>
        </div>
    </div>

    <div class="match-container">
        <div class="feed-panel">
            <div class="feed-header"><span>Narra√ß√£o</span> <span style="color:var(--red)">‚óè AO VIVO</span></div>
            <div class="feed-content" id="feed">
                </div>
        </div>
        <div class="stats-panel">
            <div class="stat-row">
                <span style="font-size:0.8rem; color:#888;">POSSE DE BOLA</span>
                <div class="stat-bars">
                    <span id="stat-pos-h">50%</span>
                    <div class="bar-bg"><div class="bar-L" id="bar-pos-h" style="width:50%"></div></div>
                    <span id="stat-pos-a">50%</span>
                </div>
            </div>
            <div class="stat-row">
                <span style="font-size:0.8rem; color:#888;">FINALIZA√á√ïES</span>
                <div class="stat-bars">
                    <span id="stat-sho-h">0</span>
                    <div class="bar-bg"><div class="bar-L" id="bar-sho-h" style="width:0%"></div></div>
                    <span id="stat-sho-a">0</span>
                </div>
            </div>
        </div>
    </div>

    <div class="footer-controls">
        <button class="btn-speed active" onclick="setSpeed(1, this)">1x</button>
        <button class="btn-speed" onclick="setSpeed(2, this)">2x</button>
        <button class="btn-speed" onclick="setSpeed(3, this)">‚ö°</button>
        
        <div style="flex:1"></div>
        
        <button class="btn-sub" onclick="abrirModalSub()">üîÑ SUBSTITUIR</button>
    </div>

    <div id="sub-modal" class="sub-overlay">
        <div class="sub-card">
            <div class="sub-header">
                <h2>Gerenciar Equipe</h2>
                <button onclick="fecharModalSub()" style="background:none; border:none; color:#fff; cursor:pointer;">‚úñ</button>
            </div>
            <div class="sub-body">
                <div class="sub-list" id="list-titulares">
                    <h4>Em Campo</h4>
                    </div>
                <div class="sub-list" id="list-reservas">
                    <h4>Banco de Reservas</h4>
                    </div>
            </div>
            <div class="sub-footer">
                <div id="sub-msg" style="margin-right:auto; color:#888; font-size:0.9rem; align-self:center;">Selecione um de cada lado</div>
                <button class="btn-confirm" onclick="confirmarSub()">CONFIRMAR TROCA</button>
            </div>
        </div>
    </div>

    <div id="goal-overlay">
        <div class="goal-text">GOL!</div>
        <div class="goal-scorer" id="goal-scorer-name">Jogador</div>
    </div>

    <script>
        // --- DADOS ---
        if (typeof database !== 'undefined') window.Database = database;
        if (typeof Database !== 'undefined') window.database = Database;

        let gameState, homeTeam, awayTeam;
        let titulares = [], reservas = []; // Meus jogadores
        
        let matchInterval = null;
        let tempo = 0;
        let etapa = 1; // 1 ou 2
        let placar = { home: 0, away: 0 };
        let stats = { homeSho:0, awaySho:0, homePos:50 };
        let speed = 200; // ms
        let subPending = { sai: null, entra: null }; // IDs para troca

        // --- INICIALIZA√á√ÉO ---
        window.onload = function() {
            carregarDados();
        };

        function carregarDados() {
            gameState = Engine.carregarJogo();
            if(!gameState) { window.location.href='index.html'; return; }

            // Carrega Meu Time (Casa)
            const savedSquad = localStorage.getItem('brfutebol_formacao');
            homeTeam = encontrarTime(gameState.meuTime);
            
            // Separa Titulares e Reservas com base no save da escala√ß√£o
            organizarElenco(homeTeam, savedSquad);

            // Carrega Oponente (Visitante)
            const opNome = localStorage.getItem('brfutebol_oponente_atual') || "Visitante";
            awayTeam = encontrarTime(opNome);
            if(!awayTeam.elenco || awayTeam.elenco.length===0) awayTeam.elenco = gerarGenericos(awayTeam.nome);

            // Renderiza Header
            document.getElementById('home-name').innerText = homeTeam.nome;
            document.getElementById('home-logo').src = homeTeam.escudo;
            document.getElementById('away-name').innerText = awayTeam.nome;
            document.getElementById('away-logo').src = awayTeam.escudo || "";

            adicionarLog("", "As equipes entram em campo!", "");
            iniciarRelogio();
        }

        function organizarElenco(time, jsonEscalacao) {
            titulares = [];
            reservas = [];
            
            if(jsonEscalacao) {
                const map = JSON.parse(jsonEscalacao);
                const idsEmCampo = Object.values(map); // UIDs dos titulares
                
                time.elenco.forEach(jog => {
                    // Se o UID estiver no mapa E a chave come√ßar com 'slot-' (ignora banco salvo no json se houver)
                    const key = Object.keys(map).find(k => map[k] === jog.uid);
                    if(key && key.startsWith('slot-')) {
                        titulares.push(jog);
                    } else {
                        reservas.push(jog);
                    }
                });
            } else {
                // Fallback: 11 primeiros
                titulares = time.elenco.slice(0, 11);
                reservas = time.elenco.slice(11);
            }
        }

        function encontrarTime(nome) {
            const db = window.database || window.Database;
            for(let s in db.brasil) {
                const t = db.brasil[s].find(x => x.nome === nome);
                if(t) return JSON.parse(JSON.stringify(t)); // Clone para n√£o alterar original
            }
            return { nome: nome, escudo: "", elenco: [] };
        }

        function gerarGenericos(nome) {
            let l=[]; for(let i=0;i<15;i++) l.push({nome:`Jog ${i}`, pos:'ATA'}); return l;
        }

        // --- ENGINE DO JOGO ---
        function iniciarRelogio() {
            clearInterval(matchInterval);
            matchInterval = setInterval(loopJogo, speed);
        }

        function loopJogo() {
            tempo++;
            document.getElementById('timer-display').innerText = `${etapa}¬∫ ${tempo}'`;

            // EVENTOS DE JOGO
            if(Math.random() < 0.04) processarLance();

            // INTERVALO (45') - OBRIGAT√ìRIO
            if(tempo === 45 && etapa === 1) {
                pausarJogo();
                adicionarLog("Juiz", "Fim do primeiro tempo! Intervalo.", "card");
                etapa = 2;
                tempo = 0;
                setTimeout(() => {
                    alert("Intervalo! Aproveite para mexer no time.");
                    abrirModalSub(); // Abre a tela de substitui√ß√£o
                }, 500);
            }

            // FIM DE JOGO (90')
            if(tempo === 45 && etapa === 2) { // 45 do 2o tempo = 90
                pausarJogo();
                document.getElementById('timer-display').innerText = "FIM";
                adicionarLog("Juiz", "Apita o √°rbitro! Fim de jogo!", "card");
                
                setTimeout(() => {
                    if(confirm("Fim de jogo! Voltar ao menu?")) {
                        localStorage.removeItem('brfutebol_oponente_atual');
                        window.location.href = 'dashboard.html';
                    }
                }, 1000);
            }
        }

        function processarLance() {
            // L√≥gica simplificada de chance
            const forcaH = calcularForcaEmCampo(titulares);
            const forcaA = (awayTeam.forca || 60);
            const diff = forcaH - forcaA;
            
            // Chance baseada na for√ßa
            const rng = Math.random() * 100;
            const chanceH = 50 + (diff/2); // Se H for mais forte, chance > 50

            if(rng < chanceH) {
                // Ataque Casa
                if(Math.random() < 0.15) gol(true);
                else {
                    stats.homeSho++;
                    adicionarLog(homeTeam.nome, "Chega com perigo e chuta pra fora!", "danger");
                }
            } else {
                // Ataque Fora
                if(Math.random() < 0.15) gol(false);
                else {
                    stats.awaySho++;
                    adicionarLog(awayTeam.nome, "Contra-ataque r√°pido... para fora!", "danger");
                }
            }
            atualizarUIStats();
        }

        function gol(isHome) {
            pausarJogo();
            const time = isHome ? homeTeam : awayTeam;
            let autor = "Desconhecido";

            if(isHome) {
                placar.home++;
                stats.homeSho++;
                // Escolhe um titular aleat√≥rio
                if(titulares.length > 0) autor = titulares[Math.floor(Math.random()*titulares.length)].nome;
            } else {
                placar.away++;
                stats.awaySho++;
                autor = awayTeam.elenco[0]?.nome || "Atacante";
            }

            document.getElementById('score-home').innerText = placar.home;
            document.getElementById('score-away').innerText = placar.away;
            
            document.getElementById('goal-scorer-name').innerText = autor;
            document.getElementById('goal-overlay').style.display = 'flex';
            adicionarLog("GOOOL", `${autor} marca para o ${time.nome}!`, "goal");

            setTimeout(() => {
                document.getElementById('goal-overlay').style.display = 'none';
                iniciarRelogio();
            }, 2000);
        }

        function calcularForcaEmCampo(lista) {
            if(!lista.length) return 0;
            let soma = 0; lista.forEach(j => soma+=j.forca);
            return soma / lista.length;
        }

        // --- SUBSTITUI√á√ïES (UI & L√ìGICA) ---
        function abrirModalSub() {
            pausarJogo(); // Pausa o tempo
            document.getElementById('sub-modal').style.display = 'flex';
            renderizarListasSub();
            subPending = { sai: null, entra: null };
            atualizarMsgSub();
        }

        function fecharModalSub() {
            document.getElementById('sub-modal').style.display = 'none';
            // Se n√£o for intervalo, retoma o jogo
            if(!(etapa === 2 && tempo === 0)) iniciarRelogio();
        }

        function renderizarListasSub() {
            const divT = document.getElementById('list-titulares');
            const divR = document.getElementById('list-reservas');
            divT.innerHTML = '<h4>Em Campo</h4>';
            divR.innerHTML = '<h4>Banco</h4>';

            titulares.forEach(j => divT.appendChild(criarItemJog(j, 'sai')));
            reservas.forEach(j => divR.appendChild(criarItemJog(j, 'entra')));
        }

        function criarItemJog(j, tipo) {
            const div = document.createElement('div');
            div.className = 'player-row';
            div.onclick = () => selecionarJogSub(j.uid, tipo, div);
            div.innerHTML = `
                <div class="pos-tag">${j.pos}</div>
                <div class="p-name">${j.nome}</div>
                <div class="p-ovr">${j.forca}</div>
            `;
            return div;
        }

        function selecionarJogSub(uid, tipo, el) {
            // UI
            const container = tipo === 'sai' ? 'list-titulares' : 'list-reservas';
            document.getElementById(container).querySelectorAll('.player-row').forEach(r => r.classList.remove('selected'));
            el.classList.add('selected');

            // Logic
            subPending[tipo] = uid;
            atualizarMsgSub();
        }

        function atualizarMsgSub() {
            const msg = document.getElementById('sub-msg');
            if(subPending.sai && subPending.entra) {
                msg.innerHTML = "<span style='color:var(--accent)'>Pronto para confirmar!</span>";
            } else {
                msg.innerHTML = "Selecione quem sai e quem entra...";
            }
        }

        function confirmarSub() {
            if(!subPending.sai || !subPending.entra) return;

            // Encontra √≠ndices
            const idxSai = titulares.findIndex(j => j.uid === subPending.sai);
            const idxEntra = reservas.findIndex(j => j.uid === subPending.entra);

            if(idxSai > -1 && idxEntra > -1) {
                const jogadorSai = titulares[idxSai];
                const jogadorEntra = reservas[idxEntra];

                // Troca Arrays
                titulares.splice(idxSai, 1); // Remove titular
                reservas.splice(idxEntra, 1); // Remove reserva
                
                titulares.push(jogadorEntra); // Entra no campo
                // reservas.push(jogadorSai); // Opcional: quem sai volta pro banco? No futebol real sim, mas n√£o joga mais. Aqui vamos simplificar e deixar ele sumir ou ir pro fim.
                reservas.push(jogadorSai);

                adicionarLog("Substitui√ß√£o", `Sai: ${jogadorSai.nome} üîª | Entra: ${jogadorEntra.nome} üî∫`, "sub");
                
                // Reset e Re-render
                subPending = { sai:null, entra:null };
                renderizarListasSub();
                alert("Substitui√ß√£o realizada!");
            }
        }

        // --- UTILIT√ÅRIOS ---
        function adicionarLog(head, text, type) {
            const feed = document.getElementById('feed');
            const div = document.createElement('div');
            div.className = `feed-item ${type}`;
            div.innerHTML = `<div class="feed-time">${tempo}'</div><div><b>${head}</b> ${text}</div>`;
            feed.prepend(div);
        }

        function atualizarUIStats() {
            document.getElementById('stat-sho-h').innerText = stats.homeSho;
            document.getElementById('stat-sho-a').innerText = stats.awaySho;
            const total = stats.homeSho + stats.awaySho || 1;
            document.getElementById('bar-sho-h').style.width = ((stats.homeSho/total)*100) + "%";
        }

        function pausarJogo() { clearInterval(matchInterval); }

        function setSpeed(mult, btn) {
            document.querySelectorAll('.btn-speed').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            if(mult === 1) speed = 200;
            if(mult === 2) speed = 80;
            if(mult === 3) speed = 10; // Instant√¢neo

            // Se o jogo n√£o estiver parado (intervalo/fim), reinicia com nova velocidade
            if(!document.getElementById('sub-modal').style.display.includes('flex')) {
                iniciarRelogio();
            }
        }

    </script>
</body>
</html>
