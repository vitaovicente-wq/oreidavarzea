<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>O Rei da V√°rzea ‚Äî Partida</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700&display=swap');
  :root{font-family:'Roboto Condensed', system-ui, -apple-system, Segoe UI, Roboto, Arial;}
  body{margin:0;background:#f5f7fb;color:#111}
  header{background:#0b6bd6;color:#fff;padding:14px 18px}
  .container{max-width:1100px;margin:18px auto;padding:10px}
  .card{background:#fff;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.06);padding:16px;margin-bottom:16px;}
  button{background:#0b6bd6;color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer; transition: all 0.2s ease-in-out; box-shadow: 0 2px 4px rgba(0,0,0,0.1);}
  button:hover{opacity:0.9; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15);}
  button[disabled]{opacity:0.45;cursor:default}
  .muted{color:#666;font-size:13px}
  .notif{position:fixed;top:18px;right:18px;background:#ffefc2;color:#333;padding:10px 14px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,.12);border:1px solid #e6b800}
  a { text-decoration: none; }
  ul { list-style-type: none; padding-left: 0; }
  li { padding: 4px; border-bottom: 1px solid #f0f0f0; font-size: 14px; }
  h4 { color: #666; font-size: 0.8em; text-transform: uppercase; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-top: 20px;}
  .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
  .modal-content { background-color: #fff; margin: 10% auto; padding: 20px; border-radius: 10px; width: 80%; max-width: 700px; }
  .sub-container { display: flex; gap: 20px; margin-top: 15px; }
  .sub-column { flex: 1; border: 1px solid #ddd; border-radius: 8px; padding: 10px; height: 300px; overflow-y: auto; }
  .sub-player-item { padding: 8px; border-radius: 6px; cursor: pointer; margin-bottom: 5px; border: 1px solid #eee; }
  .sub-player-item:hover { background-color: #f0f8ff; }
  .sub-player-item.selected { background-color: #ffc107; color: #000; border-color: #e0a800; }
  .sub-player-item.disabled { background-color: #e9ecef; color: #6c757d; cursor: not-allowed; opacity: 0.6; }

  /* --- NOVOS ESTILOS DO PLACAR --- */
  .scoreboard-container {
    padding: 10px;
    border-radius: 12px;
    background: #e9ecef;
    margin-bottom: 15px;
  }
  .scoreboard {
    background-color: #222;
    color: #fff;
    padding: 10px;
    border-radius: 10px;
    display: flex;
    justify-content: space-around;
    align-items: center;
    border: 2px solid #444;
    box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
  }
  .scoreboard-team {
    font-size: 1.2em;
    font-weight: bold;
    text-transform: uppercase;
    flex: 1;
    text-align: center;
  }
  .scoreboard-score {
    font-size: 2.8em;
    font-weight: bold;
    font-family: 'Courier New', Courier, monospace;
    padding: 0 20px;
  }
  #comentarios p {
    margin: 8px 0;
    padding-left: 5px;
    border-left: 3px solid transparent;
  }
  #comentarios p.gol {
    font-weight: bold;
    color: #1a7431;
    border-left-color: #28a745;
  }
  #comentarios p.evento {
    font-style: italic;
    color: #555;
    border-left-color: #ccc;
  }
</style>
</head>
<body>
<header>
  <div class="container"><h1 id="headerTitle">O Rei da V√°rzea</h1></div>
</header>

<div class="container">
  <div id="tela4" class="card">
    <h2>Partida em andamento</h2>
    <div style="display:flex;gap:16px; align-items: flex-start;">
      <div style="flex:1; text-align: center;">
        <h3 id="userTeamName">Meu Time</h3>
        <h4>Titulares</h4>
        <ul id="jogadoresUsuario"></ul>
        <h4>Reservas</h4>
        <ul id="jogadoresUsuarioBanco"></ul>
      </div>
      <div style="flex:2;text-align:center">
        <div class="scoreboard-container">
            <div class="scoreboard">
                <div id="homeTeamName" class="scoreboard-team">MEU TIME</div>
                <div id="score" class="scoreboard-score">0 x 0</div>
                <div id="awayTeamName" class="scoreboard-team">VILA FREITAS</div>
            </div>
        </div>
        <div id="comentarios" style="text-align:left;height:300px;overflow-y:auto;border:1px solid #ddd;border-radius:6px;padding:10px; margin-bottom: 10px;"></div>
        <a id="linkVoltar" href="escalacao.html">
            <button id="btnContinuar" style="display:none;">Voltar para Escala√ß√£o</button>
        </a>
      </div>
      <div style="flex:1; text-align: center;">
        <h3>Vila Freitas</h3>
        <h4>Titulares</h4>
        <ul id="jogadoresVila"></ul>
        <h4>Reservas</h4>
        <ul id="jogadoresVilaBanco"></ul>
      </div>
    </div>
  </div>
</div>

<div id="substitutionModal" class="modal">
  <div class="modal-content">
    <h2>Intervalo - Fa√ßa suas substitui√ß√µes</h2>
    <p>Selecione um jogador em campo e um no banco para trocar. <strong id="subsCount">Substitui√ß√µes: 0/5</strong></p>
    <div class="sub-container">
      <div class="sub-column">
        <h3>Em Campo</h3>
        <div id="subPitchPlayers"></div>
      </div>
      <div class="sub-column">
        <h3>No Banco</h3>
        <div id="subBenchPlayers"></div>
      </div>
    </div>
    <button id="btnConfirmSubs" style="margin-top: 20px;">Iniciar 2¬∫ Tempo</button>
  </div>
</div>

<script>
// ========== ESTADO DO JOGO ==========
let hired = [];
let userData = {};
let lineup = {};
let minuto = 1;
let gameInterval = null;
let subsMade = 0;
const MAX_SUBS = 5;
let selectedPlayerOutId = null;

const vilaFreitasSquad = {
    titulares: [
        { nome: "Tadeu", pos: "Goleiro" }, { nome: "Jo√£ozinho", pos: "Lateral" }, { nome: "Bira", pos: "Zagueiro" },
        { nome: "Marc√£o", pos: "Zagueiro" }, { nome: "Nego", pos: "Lateral" }, { nome: "L√©o", pos: "Volante" },
        { nome: "Careca", pos: "Volante" }, { nome: "Tico", pos: "Meia" }, { nome: "Juninho", pos: "Meia" },
        { nome: "Beto", pos: "Atacante" }, { nome: "Formiga", pos: "Atacante" }
    ],
    reservas: [
        { nome: "Gils√£o", pos: "Goleiro" }, { nome: "Paulinho", pos: "Lateral" }, { nome: "Tonh√£o", pos: "Zagueiro" },
        { nome: "Gerson", pos: "Volante" }, { nome: "Didi", pos: "Meia" }, { nome: "Chico", pos: "Atacante" },
        { nome: "Z√© Bala", pos: "Atacante" }
    ]
};

// ========== ELEMENTOS DOM ==========
const elements = {
  headerTitle: document.getElementById('headerTitle'),
  userTeamName: document.getElementById('userTeamName'),
  jogadoresUsuario: document.getElementById('jogadoresUsuario'),
  jogadoresUsuarioBanco: document.getElementById('jogadoresUsuarioBanco'),
  jogadoresVila: document.getElementById('jogadoresVila'),
  jogadoresVilaBanco: document.getElementById('jogadoresVilaBanco'),
  homeTeamName: document.getElementById('homeTeamName'),
  awayTeamName: document.getElementById('awayTeamName'),
  scoreDisplay: document.getElementById('score'),
  comentarios: document.getElementById('comentarios'),
  btnContinuar: document.getElementById('btnContinuar'),
  substitutionModal: document.getElementById('substitutionModal'),
  subsCount: document.getElementById('subsCount'),
  subPitchPlayers: document.getElementById('subPitchPlayers'),
  subBenchPlayers: document.getElementById('subBenchPlayers'),
  btnConfirmSubs: document.getElementById('btnConfirmSubs'),
};

// ========== FUN√á√ïES AUXILIARES ==========
function showNotif(text, time = 3000) { /* ...c√≥digo... */ }
const addComentario = (min, texto, tipo = 'normal') => {
    const p = document.createElement('p');
    p.innerHTML = `<strong>${min}'</strong> - ${texto}`;
    if (tipo === 'gol') p.classList.add('gol');
    if (tipo === 'evento') p.classList.add('evento');
    elements.comentarios.appendChild(p);
    elements.comentarios.scrollTop = elements.comentarios.scrollHeight;
}

// ========== L√ìGICA DA PARTIDA ==========
function runHalf(startMin, endMin, onComplete) {
    minuto = startMin;
    const stoppageTime = endMin + Math.floor(Math.random() * 5) + 1;
    addComentario(endMin, `‚è±Ô∏è O juiz indica ${stoppageTime - endMin} minutos de acr√©scimo.`, 'evento');

    gameInterval = setInterval(() => {
        if (minuto > stoppageTime) {
            clearInterval(gameInterval);
            onComplete();
            return;
        }

        const lances = [ "Jogada de perigo!", "Falta no meio-campo", "Escanteio", "Contra-ataque perigoso!", "Chute de longa dist√¢ncia!", "Defesa dif√≠cil do goleiro!", "Cart√£o amarelo üü®", "Torcida vaia o juiz!", "Impedimento duvidoso." ];
        let lance = lances[Math.floor(Math.random() * lances.length)];
        let tipoLance = 'normal';
        
        if (Math.random() < 0.12) {
            let golsCasa = parseInt(elements.scoreDisplay.textContent.split('x')[0]);
            let golsVisitante = parseInt(elements.scoreDisplay.textContent.split('x')[1]);
            if (Math.random() < 0.55) {
                golsCasa++;
                lance = `‚öΩ GOOOOL DO ${userData.teamName.toUpperCase()}!`;
            } else {
                golsVisitante++;
                lance = `‚öΩ GOOOOL DA VILA FREITAS!`;
            }
            elements.scoreDisplay.textContent = `${golsCasa} x ${golsVisitante}`;
            tipoLance = 'gol';
        }
        
        addComentario(minuto, lance, tipoLance);
        minuto += Math.floor(Math.random() * 4) + 1;
    }, 800);
}

function endGame() {
    addComentario('FIM', '‚è±Ô∏è Apita o √°rbitro! Fim de jogo!', 'evento');
    elements.btnContinuar.style.display = 'inline-block';
    
    const playersInMatch = Object.values(lineup);
    hired.forEach(jogador => {
        if (playersInMatch.includes(jogador.id)) {
            let desgaste = 8 + Math.floor(Math.random() * 5);
            if (jogador.isPai) desgaste += 3;
            jogador.health = Math.max(0, jogador.health - desgaste);
        }
    });
    
    localStorage.setItem('elencoDoTime', JSON.stringify(hired));
    showNotif('Sa√∫de dos jogadores foi atualizada!');
}

// ========== L√ìGICA DE SUBSTITUI√á√ÉO ==========
function openSubstitutionModal() {
    clearInterval(gameInterval);
    addComentario('45\'', '‚è±Ô∏è Fim do primeiro tempo! Intervalo de jogo.', 'evento');
    elements.substitutionModal.style.display = 'block';
    updateSubstitutionModal();
}

function updateSubstitutionModal() {
    elements.subPitchPlayers.innerHTML = '';
    elements.subBenchPlayers.innerHTML = '';
    elements.subsCount.textContent = `Substitui√ß√µes: ${subsMade}/${MAX_SUBS}`;

    const titularesIds = Object.values(lineup);
    const titulares = hired.filter(j => titularesIds.includes(j.id));
    const reservas = hired.filter(j => !titularesIds.includes(j.id));

    titulares.forEach(p => {
        const item = document.createElement('div');
        item.className = 'sub-player-item'; item.textContent = `${p.name} (${p.pos})`;
        item.dataset.playerId = p.id; item.onclick = () => handleSubPlayerClick(p.id, true);
        elements.subPitchPlayers.appendChild(item);
    });
    reservas.forEach(p => {
        const item = document.createElement('div');
        item.className = 'sub-player-item'; item.textContent = `${p.name} (${p.pos})`;
        item.dataset.playerId = p.id; item.onclick = () => handleSubPlayerClick(p.id, false);
        if (subsMade >= MAX_SUBS) item.classList.add('disabled');
        elements.subBenchPlayers.appendChild(item);
    });
}

function handleSubPlayerClick(playerId, isTitular) { /* ...c√≥digo da fun√ß√£o... */ }
function performSubstitution(playerOutId, playerInId) { /* ...c√≥digo da fun√ß√£o... */ }
// Fun√ß√µes de substitui√ß√£o completas
function handleSubPlayerClick(playerId, isTitular) {
    if (isTitular) {
        if (selectedPlayerOutId === playerId) {
            selectedPlayerOutId = null;
        } else {
            selectedPlayerOutId = playerId;
        }
        document.querySelectorAll('#subPitchPlayers .sub-player-item').forEach(el => {
            el.classList.toggle('selected', el.dataset.playerId === selectedPlayerOutId);
        });
    } else {
        if (!selectedPlayerOutId) {
            showNotif("Primeiro, selecione um jogador em campo para substituir.");
            return;
        }
        if (subsMade >= MAX_SUBS) {
            showNotif("Voc√™ j√° usou todas as 5 substitui√ß√µes!");
            return;
        }
        performSubstitution(selectedPlayerOutId, playerId);
    }
}
function performSubstitution(playerOutId, playerInId) {
    const playerOut = hired.find(j => j.id === playerOutId);
    const playerIn = hired.find(j => j.id === playerInId);
    if (playerOut.pos !== playerIn.pos) {
        if (!confirm(`Aten√ß√£o! ${playerIn.name} (${playerIn.pos}) vai entrar no lugar de ${playerOut.name} (${playerOut.pos}) de forma improvisada. Continuar?`)) {
            return;
        }
    }
    const slotId = Object.keys(lineup).find(key => lineup[key] === playerOutId);
    lineup[slotId] = playerInId;
    subsMade++;
    selectedPlayerOutId = null;
    addComentario('Intervalo', `üîÑ Substitui√ß√£o: Sai ${playerOut.name} e entra ${playerIn.name}.`, 'evento');
    updateSubstitutionModal();
    populateUserTeamLists();
}


// ========== INICIALIZA√á√ÉO DA P√ÅGINA ==========
function populateUserTeamLists() { /* ...c√≥digo da fun√ß√£o... */ }
// Fun√ß√£o completa para popular listas
function populateUserTeamLists() {
    elements.jogadoresUsuario.innerHTML = '';
    elements.jogadoresUsuarioBanco.innerHTML = '';
    const titularesIds = Object.values(lineup);
    
    hired.forEach(p => {
        const li = document.createElement('li');
        li.textContent = `${p.name} (${p.pos})`;
        if (titularesIds.includes(p.id)) {
            elements.jogadoresUsuario.appendChild(li);
        } else {
            elements.jogadoresUsuarioBanco.appendChild(li);
        }
    });
}

function init() {
  hired = JSON.parse(localStorage.getItem('elencoDoTime')) || [];
  userData = JSON.parse(localStorage.getItem('userData')) || {};
  lineup = JSON.parse(localStorage.getItem('escalacaoFinal')) || {};

  if (Object.keys(lineup).length < 11) {
      alert("Nenhuma escala√ß√£o encontrada! Escale seu time primeiro.");
      window.location.href = 'escalacao.html';
      return;
  }
  
  elements.headerTitle.textContent = `${userData.teamName || 'Seu Time'} em Campo`;
  elements.userTeamName.textContent = userData.teamName || 'Meu Time';
  elements.homeTeamName.textContent = (userData.teamName || 'Meu Time').substring(0, 10);
  
  populateUserTeamLists();
  
  vilaFreitasSquad.titulares.forEach(p => {
      const li = document.createElement('li'); li.textContent = `${p.nome} (${p.pos})`;
      elements.jogadoresVila.appendChild(li);
  });
  vilaFreitasSquad.reservas.forEach(p => {
      const li = document.createElement('li'); li.textContent = `${p.nome} (${p.pos})`;
      elements.jogadoresVilaBanco.appendChild(li);
  });

  elements.btnConfirmSubs.onclick = () => {
      elements.substitutionModal.style.display = 'none';
      runHalf(46, 90, endGame);
  };
  
  // Inicia o jogo
  addComentario('0', '‚è±Ô∏è Apita o √°rbitro! Come√ßa o primeiro tempo!', 'evento');
  runHalf(1, 45, openSubstitutionModal);
}

// Roda o jogo!
init();
</script>
</body>
</html>
