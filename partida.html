<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRFutebol - Ao Vivo</title>
    
    <script src="database_jogadores.js"></script>
    <script src="engine.js"></script>

    <style>
        :root {
            --bg: #0d1115;
            --panel: #1e272e;
            --text: #ecf0f1;
            --green: #2ecc71;
            --red: #ff4757;
            --gold: #f1c40f;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0; padding: 0;
            display: grid; 
            grid-template-rows: 30px 90px 1fr 70px; 
            height: 100vh; 
            overflow: hidden;
        }

        /* 0. TICKER (MUNDO) */
        .ticker-wrap {
            background: #000; border-bottom: 1px solid #333;
            overflow: hidden; white-space: nowrap; position: relative;
            display: flex; align-items: center; z-index: 20;
        }
        .ticker-label {
            background: var(--red); color: white; font-weight: bold; font-size: 0.7rem;
            padding: 0 15px; height: 100%; display: flex; align-items: center; z-index: 21;
        }
        .ticker-content {
            display: inline-block; padding-left: 100%;
            animation: ticker 40s linear infinite;
            font-family: monospace; font-size: 0.85rem; color: #ccc;
        }
        .ticker-item { margin-right: 40px; display: inline-block; }
        .live-dot { color: var(--red); animation: blink 1s infinite; font-size: 0.6rem; vertical-align: middle; margin-right: 5px; }
        @keyframes ticker { 0% { transform: translate3d(0, 0, 0); } 100% { transform: translate3d(-100%, 0, 0); } }
        @keyframes blink { 50% { opacity: 0; } }

        /* 1. PLACAR */
        header {
            background: linear-gradient(180deg, #151a1d 0%, #0d1115 100%);
            border-bottom: 2px solid #333;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 10;
        }
        .scoreboard { display: flex; align-items: center; gap: 30px; width: 100%; max-width: 800px; justify-content: center; }
        .team-display { display: flex; align-items: center; gap: 15px; width: 250px; }
        .team-display.away { justify-content: flex-end; flex-direction: row-reverse; }
        .team-logo { width: 55px; height: 55px; object-fit: contain; }
        .team-name { font-weight: 800; font-size: 1.1rem; text-transform: uppercase; }
        .score-box { background: #000; padding: 5px 25px; border-radius: 8px; border: 1px solid #333; text-align: center; min-width: 120px; }
        .score-val { font-size: 2.2rem; font-weight: 800; line-height: 1; color: #fff; }
        .timer { color: var(--green); font-weight: bold; font-size: 1rem; font-family: monospace; }
        .goal-pulse { animation: pulse 1s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); filter: brightness(1.5); } 100% { transform: scale(1); } }

        /* 2. MAIN */
        main {
            display: grid; grid-template-columns: 220px 1fr 280px;
            gap: 15px; padding: 15px; overflow: hidden;
        }
        .panel { background: var(--panel); border: 1px solid #333; border-radius: 8px; display: flex; flex-direction: column; overflow: hidden; }
        .panel-header { background: rgba(0,0,0,0.3); padding: 10px; font-size: 0.8rem; font-weight: bold; text-transform: uppercase; color: #aaa; border-bottom: 1px solid #333; text-align: center; }
        .panel-content { flex-grow: 1; overflow-y: auto; padding: 10px; }

        /* Escala√ß√µes */
        .lineup-item { padding: 4px 0; border-bottom: 1px solid #2a2a2a; display: flex; gap: 5px; font-size: 0.8rem; }
        .pos { color: #888; font-weight: bold; width: 25px; }

        /* Feed */
        .center-col { display: flex; flex-direction: column; gap: 15px; overflow: hidden; }
        .feed-box { flex-grow: 1; background: rgba(255,255,255,0.02); border: 1px solid #333; border-radius: 8px; overflow-y: auto; padding: 10px; display: flex; flex-direction: column-reverse; }
        .feed-msg { padding: 8px; margin-bottom: 8px; border-radius: 4px; font-size: 0.9rem; border-left: 3px solid #444; background: rgba(0,0,0,0.2); animation: fadeIn 0.3s; }
        .feed-msg.goal { border-color: var(--green); background: rgba(46, 204, 113, 0.1); font-weight: bold; }
        .feed-msg.card { border-color: var(--gold); }
        .feed-time { color: var(--green); font-weight: bold; margin-right: 5px; font-family: monospace; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        /* 3. FOOTER */
        footer { background: #151a1d; border-top: 1px solid #333; display: flex; align-items: center; justify-content: center; gap: 20px; z-index: 10; }
        .btn { padding: 10px 25px; border-radius: 6px; border: none; font-weight: bold; text-transform: uppercase; cursor: pointer; transition: 0.2s; color: white; }
        .btn:hover { transform: scale(1.05); }
        .btn-play { background: var(--green); color: #1e272e; }
        .btn-speed { background: #444; }
        .btn-exit { background: var(--red); display: none; }

        /* Stats Bars */
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.85rem; }
        .bar-bg { height: 6px; background: #333; display: flex; border-radius: 3px; overflow: hidden; margin-bottom: 15px; }
        .bar-h { background: #fff; height: 100%; transition: width 0.3s; }
        .bar-a { background: #555; height: 100%; transition: width 0.3s; }

    </style>
</head>
<body>

    <div class="ticker-wrap">
        <div class="ticker-label">MUNDO</div>
        <div class="ticker-content" id="ticker-feed">Carregando resultados globais...</div>
    </div>

    <header>
        <div class="scoreboard">
            <div class="team-display">
                <img id="logo-h" class="team-logo">
                <span id="name-h" class="team-name">CASA</span>
            </div>
            <div class="score-box">
                <div class="score-val"><span id="gols-h">0</span> - <span id="gols-a">0</span></div>
                <div class="timer" id="timer">00:00</div>
            </div>
            <div class="team-display away">
                <img id="logo-a" class="team-logo">
                <span id="name-a" class="team-name">FORA</span>
            </div>
        </div>
    </header>

    <main>
        <div class="panel">
            <div class="panel-header">Escala√ß√µes</div>
            <div class="panel-content">
                <div style="color:var(--green); font-size:0.7rem; font-weight:bold; margin-bottom:5px;">MANDANTE</div>
                <div id="list-home"></div>
                <div style="color:var(--gold); font-size:0.7rem; font-weight:bold; margin:15px 0 5px 0;">VISITANTE</div>
                <div id="list-away"></div>
            </div>
        </div>

        <div class="center-col">
            <div class="panel" style="height: 100px; flex-shrink: 0;">
                <div class="panel-header">Resumo</div>
                <div class="panel-content" id="match-events" style="font-size:0.85rem;"></div>
            </div>
            <div class="panel feed-box" id="match-feed">
                <div class="feed-msg"><span class="feed-time">00'</span> Bola rolando!</div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header">Estat√≠sticas</div>
            <div class="panel-content">
                <div class="stat-row"><span>Posse</span> <span><span id="ph">50</span>% | <span id="pa">50</span>%</span></div>
                <div class="bar-bg"><div id="bar-h" class="bar-h" style="width:50%"></div><div id="bar-a" class="bar-a" style="width:50%"></div></div>
                
                <div class="stat-row"><span>Chutes</span> <span style="font-weight:bold"><span id="sh">0</span> - <span id="sa">0</span></span></div>
                <div class="stat-row"><span>Cart√µes</span> <span style="font-weight:bold; color:var(--gold)"><span id="ch">0</span> - <span id="ca">0</span></span></div>
                
                <hr style="border:0; border-top:1px solid #444; margin:15px 0;">
                <div class="stat-row"><span>P√∫blico:</span> <span style="font-weight:bold" id="val-publico">0</span></div>
                <div class="stat-row"><span>Renda:</span> <span style="font-weight:bold; color:var(--green)" id="val-renda">R$ 0</span></div>
            </div>
        </div>
    </main>

    <footer>
        <button class="btn btn-speed" onclick="mudarVelocidade()">‚è© <span id="lbl-speed">1x</span></button>
        <button class="btn btn-play" id="btn-pause" onclick="pausarJogo()">‚è∏Ô∏è Pausar</button>
        <button class="btn btn-exit" id="btn-exit" onclick="sairDoJogo()">üíæ Salvar e Sair</button>
    </footer>

    <script>
        let gameState, homeTeam, awayTeam, isHome, matchObj;
        let timer = null;
        let match = { min: 0, score: [0, 0], stats: { shots: [0,0], cards: [0,0] }, speed: 1000, paused: false, finished: false, renda: 0 };
        
        // Jogos Simult√¢neos (Ticker)
        let tickerGames = [];

        window.onload = function() {
            if (typeof Engine === 'undefined') { alert("Engine Off"); return; }
            gameState = Engine.carregarJogo();
            if (!gameState) { window.location.href = 'index.html'; return; }

            setupMatch();
            prepararTicker();
            iniciarJogo();
        };

        function setupMatch() {
            // Busca o jogo na estrutura NOVA do calendarioUsuario
            const semIdx = gameState.semanaAtual - 1;
            const evento = gameState.calendarioUsuario[semIdx];
            
            if (!evento) { alert("Erro de calend√°rio!"); window.location.href='dashboard.html'; return; }

            // Encontra o jogo espec√≠fico que envolve o meu time
            matchObj = evento.jogos.find(j => j.casa === gameState.meuTime || j.fora === gameState.meuTime);
            
            if (!matchObj) { alert("Folga!"); window.location.href='dashboard.html'; return; }

            // Usa o Engine Global para achar os times
            homeTeam = Engine.encontrarTime(gameState, matchObj.casa);
            awayTeam = Engine.encontrarTime(gameState, matchObj.fora);
            isHome = (matchObj.casa === gameState.meuTime);

            // Renderiza Header
            document.getElementById('name-h').innerText = homeTeam.nome.substring(0,3);
            document.getElementById('logo-h').src = homeTeam.escudo;
            document.getElementById('name-a').innerText = awayTeam.nome.substring(0,3);
            document.getElementById('logo-a').src = awayTeam.escudo;

            renderList('list-home', homeTeam);
            renderList('list-away', awayTeam);
            calcularRenda();
        }

        function prepararTicker() {
            // Varre o MUNDO inteiro buscando jogos desta semana
            const semIdx = gameState.semanaAtual - 1;
            tickerGames = [];

            Object.keys(gameState.mundo).forEach(pais => {
                const liga = gameState.mundo[pais];
                if (liga.calendario[semIdx]) {
                    liga.calendario[semIdx].forEach(j => {
                        // N√£o inclui o jogo que estou jogando
                        if (j.casa !== homeTeam.nome && j.fora !== homeTeam.nome) {
                            tickerGames.push({
                                c: j.casa.substring(0,3).toUpperCase(),
                                f: j.fora.substring(0,3).toUpperCase(),
                                gc: 0, gf: 0,
                                // For√ßa simulada para o ticker
                                fc: Math.random()*100, ff: Math.random()*100
                            });
                        }
                    });
                }
            });
            atualizarTickerHTML();
        }

        function renderList(id, t) {
            const el = document.getElementById(id);
            el.innerHTML = '';
            t.elenco.slice(0,11).forEach(p => {
                el.innerHTML += `<div class="lineup-item"><span class="pos">${p.pos}</span> <span>${p.nome.split(' ')[0]}</span></div>`;
            });
        }

        function calcularRenda() {
            // L√≥gica simples
            const p = Math.floor(20000 + (homeTeam.moral * 200));
            match.renda = p * 50;
            document.getElementById('val-publico').innerText = p.toLocaleString();
            document.getElementById('val-renda').innerText = Engine.formatarDinheiro(match.renda, homeTeam.financas ? homeTeam.financas.moeda : 'R$');
        }

        // --- GAME LOOP ---

        function iniciarJogo() {
            match.paused = false;
            timer = setInterval(loop, match.speed);
        }

        function loop() {
            if(match.paused || match.finished) return;
            match.min++;
            document.getElementById('timer').innerText = (match.min<10?'0':'')+match.min + ":00";

            simularMinuto();
            simularTicker();

            if(match.min >= 94) finalizar();
        }

        function simularMinuto() {
            // Simula√ß√£o Visual (Baseada na for√ßa)
            const fH = Engine.calcularForcaElenco(homeTeam.elenco) + (isHome?5:0);
            const fA = Engine.calcularForcaElenco(awayTeam.elenco);
            const diff = fH - fA;
            
            // Chances por minuto
            const probGolH = 0.02 + (diff * 0.0005);
            const probGolA = 0.02 - (diff * 0.0005);

            if(Math.random() < probGolH) gol(0);
            else if(Math.random() < probGolA) gol(1);
            else if(Math.random() < 0.1) eventoGeral(fH > fA ? 0 : 1);
        }

        function simularTicker() {
            // Simula gols nos outros jogos do mundo
            let mudou = false;
            tickerGames.forEach(g => {
                if(Math.random() < 0.02) {
                    if(Math.random() > 0.5) g.gc++; else g.gf++;
                    mudou = true;
                }
            });
            if(mudou) atualizarTickerHTML();
        }

        function atualizarTickerHTML() {
            const el = document.getElementById('ticker-feed');
            let html = '';
            // Mostra apenas 10 aleat√≥rios para n√£o poluir
            const slice = tickerGames.slice(0, 15);
            slice.forEach(g => {
                html += `<span class="ticker-item"><span class="live-dot">‚óè</span> ${g.c} <b style="color:#f1c40f">${g.gc}-${g.gf}</b> ${g.f}</span>`;
            });
            if(tickerGames.length === 0) html = "Nenhum outro jogo neste momento.";
            else html += html; // Duplica para loop visual
            el.innerHTML = html;
        }

        // --- EVENTOS ---

        function gol(side) {
            match.score[side]++;
            match.stats.shots[side]++;
            const t = side===0 ? homeTeam : awayTeam;
            // Escolhe artilheiro
            const p = t.elenco[Math.floor(Math.random()*11)]; 
            
            document.getElementById(side===0?'gols-h':'gols-a').innerText = match.score[side];
            narra(`‚öΩ GOOOL! ${p.nome} marca para o ${t.nome}!`, 'goal');
            addEvent('‚öΩ', `${match.min}' ${p.nome}`);
            updateStats();
        }

        function eventoGeral(side) {
            const t = side===0 ? homeTeam : awayTeam;
            const msgs = ["Chute perigoso!", "Bela defesa.", "Falta no meio."];
            const msg = msgs[Math.floor(Math.random()*msgs.length)];
            
            if(msg.includes("Chute")) match.stats.shots[side]++;
            narra(`${t.nome}: ${msg}`);
            updateStats();
        }

        function updateStats() {
            document.getElementById('sh').innerText = match.stats.shots[0];
            document.getElementById('sa').innerText = match.stats.shots[1];
            // Posse fake baseada em chutes
            const tot = match.stats.shots[0] + match.stats.shots[1] + 10;
            const ph = Math.floor(((match.stats.shots[0]+5)/tot)*100);
            document.getElementById('ph').innerText = ph;
            document.getElementById('pa').innerText = 100-ph;
            document.getElementById('bar-h').style.width = ph+"%";
            document.getElementById('bar-a').style.width = (100-ph)+"%";
        }

        function narra(txt, type='') {
            const b = document.getElementById('match-feed');
            b.insertAdjacentHTML('afterbegin', `<div class="feed-msg ${type}"><span class="feed-time">${match.min}'</span> ${txt}</div>`);
        }
        function addEvent(ico, txt) {
            document.getElementById('match-events').innerHTML += `<div><span style="width:20px; display:inline-block">${ico}</span> ${txt}</div>`;
        }

        function finalizar() {
            match.finished = true; clearInterval(timer);
            narra("Apita o √°rbitro! Fim de jogo.", 'goal');
            document.getElementById('btn-exit').style.display='inline-block';
            document.getElementById('btn-pause').style.display='none';
        }

        // --- SA√çDA ---

        function sairDoJogo() {
            // 1. Atualiza o objeto do jogo na mem√≥ria (refer√™ncia global)
            matchObj.golsCasa = match.score[0];
            matchObj.golsFora = match.score[1];

            // 2. Grana (Se for mandante)
            if (isHome) {
                const meu = Engine.encontrarTime(gameState, gameState.meuTime);
                if(meu && meu.financas) {
                    meu.financas.caixa += (match.renda - 50000);
                    meu.financas.receitas.bilheteria += match.renda;
                }
            }

            // 3. Salva estado tempor√°rio
            Engine.salvarJogo(gameState);

            // 4. Chama o Engine para processar o resto do mundo
            // O Engine vai ver que 'matchObj' j√° tem placar e vai pular ele, simulando s√≥ o resto
            Engine.processarSemana(gameState);

            // 5. Redireciona
            window.location.href = 'dashboard.html';
        }

        function pausarJogo() { match.paused = !match.paused; document.getElementById('btn-pause').innerText = match.paused ? "‚ñ∂Ô∏è" : "‚è∏Ô∏è"; }
        function mudarVelocidade() { 
            if(match.speed===1000) { match.speed=200; document.getElementById('lbl-speed').innerText="5x"; }
            else { match.speed=1000; document.getElementById('lbl-speed').innerText="1x"; }
            clearInterval(timer); if(!match.finished && !match.paused) timer = setInterval(loop, match.speed);
        }

    </script>
</body>
</html>
