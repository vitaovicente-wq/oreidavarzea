<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRFutebol - Ao Vivo</title>
    
    <script src="database_jogadores.js"></script>
    <script src="engine.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700;900&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-dark: #0f1216;
            --bg-panel: rgba(20, 25, 30, 0.95);
            --accent: #00ff88;
            --text-main: #ffffff;
            --text-dim: #8b9bb4;
            --gold: #f1c40f;
            --red: #ff4757;
        }

        * { box-sizing: border-box; user-select: none; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at 50% 50%, #1a202c 0%, #0f1216 100%);
            color: var(--text-main);
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow: hidden;
        }

        /* --- PLACAR (HEADER) --- */
        .scoreboard {
            width: 100%; max-width: 900px;
            background: linear-gradient(180deg, #1e2329 0%, #161b22 100%);
            border-bottom: 2px solid var(--accent);
            padding: 20px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            z-index: 10;
        }

        .team-display {
            display: flex; flex-direction: column; align-items: center; width: 30%;
        }
        .team-logo { width: 70px; height: 70px; object-fit: contain; filter: drop-shadow(0 0 10px rgba(0,0,0,0.5)); transition: 0.3s; }
        .team-name { font-family: 'Rajdhani'; font-weight: 800; font-size: 1.2rem; margin-top: 10px; text-transform: uppercase; text-align: center; }
        .team-ovr { font-size: 0.8rem; color: #666; font-weight: 700; background: #000; padding: 2px 6px; border-radius: 4px; margin-top: 5px; }

        .score-area {
            display: flex; align-items: center; justify-content: center; gap: 20px;
            font-family: 'Rajdhani'; font-weight: 900; font-size: 3.5rem;
            text-shadow: 0 0 20px rgba(255,255,255,0.2);
        }
        .score-box { background: #000; padding: 5px 25px; border-radius: 8px; border: 1px solid #333; min-width: 80px; text-align: center; }
        
        .timer-badge {
            background: var(--accent); color: #000;
            padding: 5px 15px; border-radius: 20px;
            font-size: 1rem; font-weight: 800;
            margin-top: -10px; margin-bottom: 10px;
            box-shadow: 0 0 15px rgba(0,255,136,0.4);
        }

        /* --- CAMPO VIRTUAL (CENTRO) --- */
        .match-container {
            flex: 1; width: 100%; max-width: 900px;
            display: grid; grid-template-columns: 2fr 1fr;
            gap: 20px; padding: 20px; overflow: hidden;
        }

        /* NARRAÇÃO */
        .feed-panel {
            background: var(--bg-panel); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px; display: flex; flex-direction: column;
            overflow: hidden; box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }
        .feed-header {
            padding: 15px; background: rgba(0,0,0,0.3); border-bottom: 1px solid #333;
            font-family: 'Rajdhani'; font-weight: 700; text-transform: uppercase; color: var(--text-dim);
            display: flex; justify-content: space-between;
        }
        .feed-content {
            flex: 1; overflow-y: auto; padding: 15px;
            display: flex; flex-direction: column; gap: 10px;
            scroll-behavior: smooth;
        }
        /* Scrollbar custom */
        .feed-content::-webkit-scrollbar { width: 5px; }
        .feed-content::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

        .feed-item {
            display: flex; gap: 15px; align-items: flex-start;
            padding: 10px; border-radius: 6px;
            background: rgba(255,255,255,0.02);
            border-left: 3px solid transparent;
            animation: slideIn 0.3s ease;
        }
        .feed-time { font-family: 'Rajdhani'; font-weight: 800; color: var(--accent); min-width: 30px; }
        .feed-text { font-size: 0.95rem; line-height: 1.4; color: #ddd; }
        
        .feed-item.goal { background: rgba(0, 255, 136, 0.1); border-left-color: var(--accent); }
        .feed-item.danger { background: rgba(241, 196, 15, 0.1); border-left-color: var(--gold); }
        .feed-item.card { background: rgba(231, 76, 60, 0.1); border-left-color: var(--red); }

        /* ESTATÍSTICAS */
        .stats-panel {
            background: var(--bg-panel); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px; padding: 20px;
            display: flex; flex-direction: column; gap: 20px;
        }
        .stat-row { display: flex; flex-direction: column; gap: 5px; }
        .stat-label { text-align: center; font-size: 0.8rem; color: #888; text-transform: uppercase; font-weight: 700; }
        .stat-bars { display: flex; align-items: center; gap: 10px; }
        .stat-val { font-family: 'Rajdhani'; font-weight: 800; width: 30px; text-align: center; }
        .bar-bg { flex: 1; height: 6px; background: #222; border-radius: 3px; overflow: hidden; display: flex; }
        .bar-L { height: 100%; background: var(--text-main); }
        .bar-R { height: 100%; background: var(--text-dim); }

        /* GOAL OVERLAY */
        #goal-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.9); z-index: 100;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            animation: fadeIn 0.2s;
        }
        .goal-text { font-family: 'Rajdhani'; font-size: 8rem; font-weight: 900; color: var(--accent); text-transform: uppercase; animation: zoomIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .goal-scorer { font-size: 2rem; color: #fff; margin-top: -20px; animation: slideUp 0.5s 0.2s backwards; }

        /* FOOTER CONTROLS */
        .footer-controls {
            width: 100%; padding: 20px; background: #161b22;
            display: flex; justify-content: center; gap: 20px;
            border-top: 1px solid #333;
        }
        .btn-control {
            padding: 12px 30px; border-radius: 6px; border: none;
            font-family: 'Rajdhani'; font-weight: 700; text-transform: uppercase; font-size: 1rem;
            cursor: pointer; transition: 0.2s;
        }
        .btn-skip { background: #333; color: #fff; }
        .btn-skip:hover { background: #444; }
        
        .btn-finish { background: var(--accent); color: #000; display: none; }
        .btn-finish:hover { background: #fff; transform: scale(1.05); }

        @keyframes slideIn { from { opacity:0; transform:translateX(-20px); } to { opacity:1; transform:translateX(0); } }
        @keyframes zoomIn { from { transform:scale(0); } to { transform:scale(1); } }
        @keyframes slideUp { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }

    </style>
</head>
<body>

    <div class="scoreboard">
        <div class="team-display">
            <img id="home-logo" src="" class="team-logo">
            <div class="team-name" id="home-name">CASA</div>
            <div class="team-ovr" id="home-ovr">OVR 00</div>
        </div>
        
        <div style="display:flex; flex-direction:column; align-items:center;">
            <div class="timer-badge"><span id="timer">00</span>'</div>
            <div class="score-area">
                <div class="score-box" id="score-home">0</div>
                <span style="font-size: 2rem; color: #666;">:</span>
                <div class="score-box" id="score-away">0</div>
            </div>
        </div>

        <div class="team-display">
            <img id="away-logo" src="" class="team-logo">
            <div class="team-name" id="away-name">FORA</div>
            <div class="team-ovr" id="away-ovr">OVR 00</div>
        </div>
    </div>

    <div class="match-container">
        
        <div class="feed-panel">
            <div class="feed-header">
                <span>Narração em Tempo Real</span>
                <span style="color:var(--accent)">AO VIVO ●</span>
            </div>
            <div class="feed-content" id="feed">
                <div class="feed-item"><div class="feed-time">00'</div><div class="feed-text">Apita o árbitro! Começa a partida!</div></div>
            </div>
        </div>

        <div class="stats-panel">
            <div style="text-align:center; font-family:'Rajdhani'; font-weight:800; font-size:1.2rem; color:var(--gold);">ESTATÍSTICAS</div>
            
            <div class="stat-row">
                <div class="stat-label">Posse de Bola</div>
                <div class="stat-bars">
                    <span class="stat-val" id="stat-pos-h">50%</span>
                    <div class="bar-bg">
                        <div class="bar-L" id="bar-pos-h" style="width:50%"></div>
                        <div class="bar-R" id="bar-pos-a" style="width:50%; background:#444"></div>
                    </div>
                    <span class="stat-val" id="stat-pos-a">50%</span>
                </div>
            </div>

            <div class="stat-row">
                <div class="stat-label">Finalizações</div>
                <div class="stat-bars">
                    <span class="stat-val" id="stat-sho-h">0</span>
                    <div class="bar-bg">
                        <div class="bar-L" id="bar-sho-h" style="width:0%"></div>
                    </div>
                    <span class="stat-val" id="stat-sho-a">0</span>
                </div>
            </div>

            <div class="stat-row">
                <div class="stat-label">Faltas</div>
                <div class="stat-bars">
                    <span class="stat-val" id="stat-fou-h">0</span>
                    <div class="bar-bg">
                        <div class="bar-L" style="width:0%; background:yellow"></div> </div>
                    <span class="stat-val" id="stat-fou-a">0</span>
                </div>
            </div>
        </div>

    </div>

    <div class="footer-controls">
        <button class="btn-control btn-skip" onclick="acelerarTempo()">⏩ Acelerar</button>
        <button class="btn-control btn-finish" id="btn-continuar" onclick="finalizarPartida()">CONTINUAR ❯</button>
    </div>

    <div id="goal-overlay">
        <div class="goal-text">GOL!</div>
        <div class="goal-scorer" id="goal-scorer-name">Jogador</div>
    </div>

    <script>
        // --- DADOS ---
        if (typeof database !== 'undefined') window.Database = database;
        if (typeof Database !== 'undefined') window.database = Database;

        let gameState = null;
        let homeTeam = null;
        let awayTeam = null;
        let matchInterval = null;
        let tempo = 0;
        let placar = { home: 0, away: 0 };
        let stats = { homeSho:0, awaySho:0, homePos:50 };
        let speed = 150; // ms por minuto (quanto menor, mais rápido)

        // --- INICIALIZAÇÃO ---
        window.onload = function() {
            carregarPartida();
        };

        function carregarPartida() {
            // 1. Carregar Save
            gameState = Engine.carregarJogo();
            if(!gameState) { alert("Erro de save."); window.location.href='index.html'; return; }

            // 2. Identificar Times
            // Time da Casa = Meu Time (Simplificação para MVP)
            homeTeam = encontrarTime(gameState.meuTime);
            
            // Time Visitante = Salvo no localStorage pelo Dashboard
            const oponenteNome = localStorage.getItem('brfutebol_oponente_atual') || localStorage.getItem('brfutebol_oponente_nome');
            awayTeam = encontrarTime(oponenteNome);

            if(!homeTeam || !awayTeam) {
                // Fallback se der erro
                alert("Erro ao carregar times. Usando genéricos.");
                homeTeam = homeTeam || { nome: "Meu Time", forca: 70, escudo: "", elenco: [] };
                awayTeam = awayTeam || { nome: "Adversário", forca: 70, escudo: "", elenco: [] };
            }

            // Garante Elencos
            if(!homeTeam.elenco || homeTeam.elenco.length===0) homeTeam.elenco = gerarElencoGenerico(homeTeam.nome);
            if(!awayTeam.elenco || awayTeam.elenco.length===0) awayTeam.elenco = gerarElencoGenerico(awayTeam.nome);

            // 3. Renderizar Infos
            document.getElementById('home-name').innerText = homeTeam.nome;
            document.getElementById('home-logo').src = homeTeam.escudo || "https://cdn-icons-png.flaticon.com/512/53/53283.png";
            document.getElementById('home-ovr').innerText = "OVR " + (homeTeam.forca || 60);

            document.getElementById('away-name').innerText = awayTeam.nome;
            document.getElementById('away-logo').src = awayTeam.escudo || "https://cdn-icons-png.flaticon.com/512/53/53283.png";
            document.getElementById('away-ovr').innerText = "OVR " + (awayTeam.forca || 60);

            // Calcular Posse de Bola baseada na força
            const totalForca = (homeTeam.forca || 60) + (awayTeam.forca || 60);
            stats.homePos = Math.round(((homeTeam.forca || 60) / totalForca) * 100);
            atualizarStats();

            // 4. Iniciar Jogo
            iniciarSimulacao();
        }

        function encontrarTime(nomeOuId) {
            const db = window.database || window.Database;
            if(!db || !db.brasil) return null;
            for(let serie in db.brasil) {
                const t = db.brasil[serie].find(x => x.id === nomeOuId || x.nome === nomeOuId);
                if(t) return t;
            }
            return null;
        }

        function gerarElencoGenerico(nome) {
            let l = [];
            ['ATA','MEI','ZAG'].forEach((p,i)=>l.push({nome:`Jogador ${nome} ${i}`, pos:p}));
            return l;
        }

        // --- ENGINE DA PARTIDA ---
        function iniciarSimulacao() {
            tempo = 0;
            matchInterval = setInterval(processarMinuto, speed);
        }

        function processarMinuto() {
            tempo++;
            document.getElementById('timer').innerText = tempo < 10 ? '0'+tempo : tempo;

            // Chance de Evento (Baseada em RNG e Força)
            const diff = (homeTeam.forca || 60) - (awayTeam.forca || 60);
            const chanceBase = 3; // % de chance de algo acontecer por minuto
            
            if(Math.random() * 100 < chanceBase) {
                gerarEvento(diff);
            }

            // Fim de Jogo
            if(tempo >= 90) {
                clearInterval(matchInterval);
                encerrarJogo();
            }
        }

        function gerarEvento(diff) {
            // Quem ataca? (Se diff > 0, casa tem mais chance)
            // Roll 0-100. Se 50 + diff > roll, ataque Casa. Senão, ataque Fora.
            const ataqueCasa = (Math.random() * 100) < (50 + (diff/2));
            
            const timeAtq = ataqueCasa ? homeTeam : awayTeam;
            const timeDef = ataqueCasa ? awayTeam : homeTeam;
            
            // Tipo de evento
            const roll = Math.random();
            if(roll < 0.15) { // GOL (15% dos eventos de perigo)
                marcarGol(ataqueCasa);
            } else if (roll < 0.50) { // CHUTE PRA FORA / DEFESA
                adicionarLog(timeAtq.nome, "Finalização perigosa, mas vai para fora!", "danger");
                if(ataqueCasa) stats.homeSho++; else stats.awaySho++;
                atualizarStats();
            } else if (roll < 0.60) { // CARTÃO
                adicionarLog("Juiz", `Cartão amarelo para jogador do ${timeDef.nome}.`, "card");
            } else {
                // LANCE NORMAL
                const frases = ["Troca passes no meio campo.", "Tenta o cruzamento...", "Desarme preciso da defesa.", "Ganha o escanteio."];
                adicionarLog(timeAtq.nome, frases[Math.floor(Math.random()*frases.length)]);
            }
        }

        function marcarGol(isHome) {
            // Pausa tempo para celebrar
            clearInterval(matchInterval);
            
            // Atualiza Placar
            if(isHome) { 
                placar.home++; 
                document.getElementById('score-home').innerText = placar.home;
                stats.homeSho++;
            } else { 
                placar.away++; 
                document.getElementById('score-away').innerText = placar.away;
                stats.awaySho++;
            }
            atualizarStats();

            // Escolhe Autor
            const time = isHome ? homeTeam : awayTeam;
            // Filtra atacantes/meias preferencialmente
            let autores = time.elenco.filter(j => j.pos === 'ATA' || j.pos === 'MEI');
            if(autores.length === 0) autores = time.elenco;
            const autor = autores[Math.floor(Math.random() * autores.length)];

            // Mostra Overlay
            const overlay = document.getElementById('goal-overlay');
            const txt = document.getElementById('goal-scorer-name');
            txt.innerText = autor.nome + " (" + time.nome + ")";
            
            overlay.style.display = 'flex';
            
            // Log
            adicionarLog(time.nome, `GOOOOOOOL! ${autor.nome} balança a rede!`, "goal");

            // Retoma
            setTimeout(() => {
                overlay.style.display = 'none';
                if(tempo < 90) matchInterval = setInterval(processarMinuto, speed);
                else encerrarJogo();
            }, 2500);
        }

        function adicionarLog(titulo, msg, tipo="") {
            const feed = document.getElementById('feed');
            const item = document.createElement('div');
            item.className = `feed-item ${tipo}`;
            item.innerHTML = `<div class="feed-time">${tempo}'</div><div class="feed-text"><b>${titulo}:</b> ${msg}</div>`;
            feed.prepend(item); // Adiciona no topo
        }

        function atualizarStats() {
            // Barras de Posse
            document.getElementById('stat-pos-h').innerText = stats.homePos + "%";
            document.getElementById('stat-pos-a').innerText = (100-stats.homePos) + "%";
            document.getElementById('bar-pos-h').style.width = stats.homePos + "%";
            document.getElementById('bar-pos-a').style.width = (100-stats.homePos) + "%";

            // Chutes (Visual simples de proporção)
            document.getElementById('stat-sho-h').innerText = stats.homeSho;
            document.getElementById('stat-sho-a').innerText = stats.awaySho;
            const totalSho = stats.homeSho + stats.awaySho || 1;
            const wH = (stats.homeSho / totalSho) * 100;
            document.getElementById('bar-sho-h').style.width = wH + "%";
        }

        function acelerarTempo() {
            speed = 50; // Muito rápido
            clearInterval(matchInterval);
            matchInterval = setInterval(processarMinuto, speed);
        }

        function encerrarJogo() {
            document.getElementById('timer').innerText = "90";
            adicionarLog("Juiz", "Fim de jogo! O árbitro encerra a partida.");
            document.getElementById('btn-continuar').style.display = 'block';
            
            // Processa pontos para o dashboard
            // No futuro, isso iria para a Engine salvar na tabela
            let pontosGanhos = 0;
            if(placar.home > placar.away) pontosGanhos = 3;
            else if(placar.home === placar.away) pontosGanhos = 1;
            
            // Salva resultado temporário para o dashboard ler (opcional)
            // Aqui poderíamos chamar Engine.registrarResultado(...)
        }

        function finalizarPartida() {
            // Remove o oponente atual da memória para gerar um novo na próxima
            localStorage.removeItem('brfutebol_oponente_atual');
            window.location.href = 'dashboard.html';
        }

    </script>
</body>
</html>
