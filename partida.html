<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRFutebol - Match Engine</title>
    
    <script src="database_jogadores.js"></script>
    <script src="engine.js"></script>

    <style>
        :root {
            --bg: #0d1115;
            --card-bg: #1e272e;
            --text: #ecf0f1;
            --green: #2ecc71;
            --red: #ff4757;
            --gold: #f1c40f;
            --border: #333;
        }

        /* LAYOUT TRAVADO NA TELA (100vh) */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0; padding: 0;
            display: grid; 
            grid-template-rows: 100px 1fr 70px; /* Header | Conte√∫do | Footer */
            height: 100vh; 
            overflow: hidden; /* Impede scroll na p√°gina inteira */
        }

        /* --- 1. CABE√áALHO (PLACAR) --- */
        header {
            background: linear-gradient(180deg, #151a1d 0%, #0d1115 100%);
            border-bottom: 2px solid var(--border);
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 10;
        }

        .scoreboard { display: flex; align-items: center; gap: 30px; width: 100%; max-width: 900px; justify-content: center; }
        .team-display { display: flex; align-items: center; gap: 15px; width: 250px; }
        .team-display.away { justify-content: flex-end; flex-direction: row-reverse; }
        
        .team-logo { width: 60px; height: 60px; object-fit: contain; }
        .team-name { font-weight: 800; font-size: 1.2rem; text-transform: uppercase; letter-spacing: 1px; }
        
        .score-box {
            background: #000; padding: 5px 25px; border-radius: 8px; border: 1px solid #333;
            text-align: center; min-width: 120px;
        }
        .score-val { font-size: 2.5rem; font-weight: 800; line-height: 1; color: #fff; }
        .timer { color: var(--green); font-weight: bold; font-size: 1.1rem; font-family: monospace; }

        /* Anima√ß√£o Gol */
        .goal-pulse { animation: pulse 1s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); filter: brightness(1.5); } 100% { transform: scale(1); } }

        /* --- 2. √ÅREA PRINCIPAL (3 COLUNAS) --- */
        main {
            display: grid;
            grid-template-columns: 220px 1fr 280px; /* Escala√ß√£o | Jogo | Stats */
            gap: 15px;
            padding: 15px;
            overflow: hidden; /* Conte√∫do interno que rola */
        }

        /* Estilo Gen√©rico de Card */
        .panel {
            background: var(--card-bg); border: 1px solid var(--border);
            border-radius: 8px; display: flex; flex-direction: column;
            overflow: hidden;
        }
        .panel-header {
            background: rgba(0,0,0,0.3); padding: 10px; 
            font-size: 0.8rem; font-weight: bold; text-transform: uppercase; color: #aaa;
            border-bottom: 1px solid var(--border); text-align: center;
        }
        .panel-content { flex-grow: 1; overflow-y: auto; padding: 10px; }

        /* COLUNA 1: ESCALA√á√ïES */
        .lineup-list { list-style: none; padding: 0; margin: 0; font-size: 0.8rem; }
        .lineup-item { padding: 4px 0; border-bottom: 1px solid #2a2a2a; display: flex; gap: 5px; }
        .pos { color: #888; font-weight: bold; width: 25px; }
        .p-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* COLUNA 2: CENTRO (EVENTOS + FEED) */
        .center-col { display: flex; flex-direction: column; gap: 15px; overflow: hidden; }

        /* Resumo do Jogo (Gols/Cart√µes) */
        .summary-box {
            height: 120px; flex-shrink: 0; background: rgba(0,0,0,0.2);
            border: 1px solid var(--border); border-radius: 8px;
            overflow-y: auto; padding: 10px;
        }
        .event-row { font-size: 0.85rem; margin-bottom: 5px; display: flex; align-items: center; gap: 8px; }
        .icon { width: 16px; text-align: center; }

        /* Narra√ß√£o */
        .feed-box {
            flex-grow: 1; background: rgba(255,255,255,0.02);
            border: 1px solid var(--border); border-radius: 8px;
            overflow-y: auto; padding: 10px;
            display: flex; flex-direction: column-reverse; /* Recentes embaixo se scroll down, ou topo se column-reverse */
        }
        .feed-msg { 
            padding: 8px; margin-bottom: 8px; border-radius: 4px; font-size: 0.9rem; border-left: 3px solid #444; background: rgba(0,0,0,0.2);
            animation: fadeIn 0.3s;
        }
        .feed-msg.goal { border-color: var(--green); background: rgba(46, 204, 113, 0.1); font-weight: bold; }
        .feed-msg.card { border-color: var(--gold); }
        .feed-time { color: var(--green); font-weight: bold; margin-right: 5px; font-family: monospace; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        /* COLUNA 3: STATS */
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.85rem; }
        .stat-val { font-weight: bold; font-family: monospace; }
        
        .bar-container { height: 6px; background: #333; border-radius: 3px; overflow: hidden; margin-bottom: 15px; display: flex; }
        .bar-h { background: #fff; height: 100%; transition: width 0.3s; }
        .bar-a { background: #555; height: 100%; transition: width 0.3s; }

        /* --- 3. RODAP√â (CONTROLES) --- */
        footer {
            background: #151a1d; border-top: 1px solid var(--border);
            display: flex; align-items: center; justify-content: center; gap: 20px;
            z-index: 10;
        }

        .btn {
            padding: 10px 25px; border-radius: 6px; border: none; font-weight: bold; text-transform: uppercase;
            cursor: pointer; transition: 0.2s; color: white; display: flex; align-items: center; gap: 8px;
        }
        .btn:hover { transform: scale(1.05); }
        .btn-play { background: var(--green); color: #1e272e; }
        .btn-sub { background: var(--gold); color: #1e272e; }
        .btn-speed { background: #444; }
        .btn-exit { background: var(--red); display: none; }

        /* MODAL SUBSTITUI√á√ÉO */
        #sub-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 50; align-items: center; justify-content: center;
        }
        .modal-box { background: #2d3436; width: 500px; height: 400px; display: flex; flex-direction: column; border-radius: 8px; border: 1px solid #555; }
        .modal-header { padding: 15px; background: #222; font-weight: bold; display: flex; justify-content: space-between; }
        .modal-body { display: grid; grid-template-columns: 1fr 1fr; flex-grow: 1; overflow: hidden; }
        .modal-col { overflow-y: auto; border-right: 1px solid #444; }
        .p-opt { padding: 8px; cursor: pointer; border-bottom: 1px solid #333; font-size: 0.85rem; }
        .p-opt:hover { background: rgba(255,255,255,0.1); }
        .p-opt.selected { background: var(--green); color: #1e272e; }

    </style>
</head>
<body>

    <header>
        <div class="scoreboard">
            <div class="team-display">
                <img id="logo-h" class="team-logo">
                <span id="name-h" class="team-name">CASA</span>
            </div>
            <div class="score-box">
                <div class="score-val"><span id="gols-h">0</span> - <span id="gols-a">0</span></div>
                <div class="timer" id="timer">00:00</div>
            </div>
            <div class="team-display away">
                <img id="logo-a" class="team-logo">
                <span id="name-a" class="team-name">FORA</span>
            </div>
        </div>
    </header>

    <main>
        <div class="panel">
            <div class="panel-header">Escala√ß√µes Iniciais</div>
            <div class="panel-content">
                <div style="color:var(--green); margin-bottom:5px; font-weight:bold; font-size:0.7rem;">MANDANTE</div>
                <ul class="lineup-list" id="list-home"></ul>
                <div style="color:var(--gold); margin:15px 0 5px 0; font-weight:bold; font-size:0.7rem;">VISITANTE</div>
                <ul class="lineup-list" id="list-away"></ul>
            </div>
        </div>

        <div class="center-col">
            <div class="panel summary-box" id="match-events">
                <div style="text-align:center; color:#555; font-size:0.8rem; margin-top:20px;">Nenhum evento importante ainda.</div>
            </div>

            <div class="panel feed-box" id="match-feed">
                <div class="feed-msg"><span class="feed-time">00'</span> üì¢ Bola rolando! O √°rbitro autoriza o in√≠cio da partida.</div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header">Estat√≠sticas & Renda</div>
            <div class="panel-content">
                <div class="stat-row">
                    <span>Posse</span> 
                    <div><span id="ph">50%</span> <span style="color:#555">|</span> <span id="pa">50%</span></div>
                </div>
                <div class="bar-container">
                    <div id="bar-h" class="bar-h" style="width:50%"></div>
                    <div id="bar-a" class="bar-a" style="width:50%"></div>
                </div>

                <div class="stat-row">
                    <span>Finaliza√ß√µes</span> 
                    <span class="stat-val"><span id="sh">0</span> - <span id="sa">0</span></span>
                </div>

                <div class="stat-row">
                    <span>Cart√µes Amarelos</span> 
                    <span class="stat-val" style="color:var(--gold)"><span id="ch">0</span> - <span id="ca">0</span></span>
                </div>

                <hr style="border:0; border-top:1px solid #444; margin:15px 0;">
                <div class="stat-row"><span>P√∫blico:</span> <span class="stat-val" id="val-publico">0</span></div>
                <div class="stat-row"><span>Renda:</span> <span class="stat-val" style="color:var(--green)" id="val-renda">R$ 0</span></div>
            </div>
        </div>
    </main>

    <footer>
        <button class="btn btn-sub" id="btn-sub" onclick="abrirSubs()">üîÑ Substituir</button>
        <button class="btn btn-speed" onclick="mudarVelocidade()">‚è© <span id="lbl-speed">1x</span></button>
        <button class="btn btn-play" id="btn-pause" onclick="pausarJogo()">‚è∏Ô∏è Pausar</button>
        <button class="btn btn-exit" id="btn-exit" onclick="sairDoJogo()">üíæ Salvar e Sair</button>
    </footer>

    <div id="sub-modal">
        <div class="modal-box">
            <div class="modal-header">
                <span>Substitui√ß√£o</span>
                <span style="cursor:pointer" onclick="fecharSubs()">‚úñ</span>
            </div>
            <div class="modal-body">
                <div class="modal-col" id="col-out"></div>
                <div class="modal-col" id="col-in"></div>
            </div>
            <button class="btn btn-play" style="width:100%; border-radius:0;" onclick="confirmarSub()">Confirmar</button>
        </div>
    </div>

    <script>
        // --- MOTOR DA PARTIDA ---
        let gameState, homeTeam, awayTeam, isHome;
        let timer = null;
        let match = {
            min: 0, 
            score: [0, 0], 
            stats: { shots: [0,0], cards: [0,0], poss: [50,50] },
            speed: 1000, 
            paused: false, 
            finished: false,
            renda: 0
        };

        // Sele√ß√µes de Subs
        let subOut = null, subIn = null;

        window.onload = function() {
            if (typeof Engine === 'undefined') return alert("Engine Missing");
            gameState = Engine.carregarJogo();
            if (!gameState) return window.location.href = 'index.html';

            configurarTimes();
            renderizarEscalacoes();
            calcularEconomia();
            iniciarJogo();
        };

        function configurarTimes() {
            const semIdx = gameState.semanaAtual - 1;
            const jogo = gameState.calendario[semIdx].jogos.find(j => j.casa === gameState.meuTime || j.fora === gameState.meuTime);
            
            if(!jogo) { alert("Folga!"); return window.location.href='dashboard.html'; }

            homeTeam = Engine.encontrarTime(gameState, jogo.casa);
            awayTeam = Engine.encontrarTime(gameState, jogo.fora);
            isHome = (jogo.casa === gameState.meuTime);

            // UI Header
            document.getElementById('name-h').innerText = homeTeam.nome.substring(0, 3);
            document.getElementById('logo-h').src = homeTeam.escudo;
            document.getElementById('name-a').innerText = awayTeam.nome.substring(0, 3);
            document.getElementById('logo-a').src = awayTeam.escudo;
        }

        function renderizarEscalacoes() {
            const fillList = (ulId, team) => {
                const ul = document.getElementById(ulId);
                ul.innerHTML = '';
                // Pega os 11 primeiros (titulares)
                const tits = team.elenco.slice(0, 11);
                tits.forEach(p => {
                    ul.innerHTML += `<li class="lineup-item"><span class="pos">${p.pos}</span> <span class="p-name">${p.nome.split(' ')[0]}</span></li>`;
                });
            };
            fillList('list-home', homeTeam);
            fillList('list-away', awayTeam);
        }

        function calcularEconomia() {
            // Renda baseada na for√ßa dos times e moral
            const base = 20000;
            const bonus = (homeTeam.moral * 100) + (awayTeam.forca * 50);
            const publico = Math.min(60000, Math.floor(base + bonus + Math.random() * 5000));
            const ticket = 50;
            match.renda = publico * ticket;

            document.getElementById('val-publico').innerText = publico.toLocaleString();
            document.getElementById('val-renda').innerText = Engine.formatarDinheiro(match.renda, 'R$');
        }

        // --- GAME LOOP ---

        function iniciarJogo() {
            match.paused = false;
            timer = setInterval(loop, match.speed);
        }

        function loop() {
            if(match.paused || match.finished) return;

            match.min++;
            document.getElementById('timer').innerText = (match.min < 10 ? "0"+match.min : match.min) + ":00";

            simularMinuto();

            if(match.min >= 94) encerrarJogo();
        }

        function simularMinuto() {
            // L√≥gica Simplificada de Simula√ß√£o
            const fH = Engine.calcularForcaElenco(homeTeam.elenco) + 5; // Casa
            const fA = Engine.calcularForcaElenco(awayTeam.elenco);
            const diff = fH - fA;

            // Chance de Gol (Base 2%)
            const chanceH = 0.02 + (diff * 0.0005);
            const chanceA = 0.02 - (diff * 0.0005);

            if(Math.random() < chanceH) eventoGol(0);
            else if(Math.random() < chanceA) eventoGol(1);
            else if(Math.random() < 0.15) eventoGeral(fH > fA ? 0 : 1);
        }

        function eventoGol(sideIdx) {
            match.score[sideIdx]++;
            match.stats.shots[sideIdx]++;
            
            const team = sideIdx === 0 ? homeTeam : awayTeam;
            const scorer = team.elenco.find(j => j.carac === 'Artilheiro') || team.elenco[10]; // Atacante ou random

            // Atualiza Placar
            document.getElementById(sideIdx === 0 ? 'gols-h' : 'gols-a').innerText = match.score[sideIdx];
            document.getElementById(sideIdx === 0 ? 'logo-h' : 'logo-a').classList.add('goal-pulse');
            setTimeout(() => document.querySelector('.goal-pulse').classList.remove('goal-pulse'), 2000);

            // Feed e Resumo
            narra(`‚öΩ GOOOOL! ${scorer.nome} abre o placar para o ${team.nome}!`, 'goal');
            registrarResumo('‚öΩ', `${match.min}' ${scorer.nome} (${team.nome})`);
            atualizarStats();
        }

        function eventoGeral(sideIdx) {
            const team = sideIdx === 0 ? homeTeam : awayTeam;
            const eventos = [
                { txt: "Chute perigoso pra fora!", stat: 'shots' },
                { txt: "Defesa√ßa do goleiro!", stat: 'shots' },
                { txt: "Falta dura no meio campo.", stat: 'cards', chance: 0.2 }
            ];
            
            const evt = eventos[Math.floor(Math.random() * eventos.length)];
            
            if(evt.stat === 'shots') match.stats.shots[sideIdx]++;
            
            if(evt.stat === 'cards' && Math.random() < evt.chance) {
                match.stats.cards[sideIdx]++;
                const offender = team.elenco[Math.floor(Math.random()*11)];
                narra(`üü® Cart√£o amarelo para ${offender.nome}.`, 'card');
                registrarResumo('üü®', `${match.min}' ${offender.nome}`);
            } else {
                narra(`${team.nome}: ${evt.txt}`);
            }
            atualizarStats();
        }

        function atualizarStats() {
            document.getElementById('sh').innerText = match.stats.shots[0];
            document.getElementById('sa').innerText = match.stats.shots[1];
            document.getElementById('ch').innerText = match.stats.cards[0];
            document.getElementById('ca').innerText = match.stats.cards[1];

            // Posse Fake baseada em chutes
            const total = match.stats.shots[0] + match.stats.shots[1] + 10;
            const ph = Math.floor(((match.stats.shots[0] + 5) / total) * 100);
            document.getElementById('ph').innerText = ph + "%";
            document.getElementById('pa').innerText = (100 - ph) + "%";
            document.getElementById('bar-h').style.width = ph + "%";
            document.getElementById('bar-a').style.width = (100 - ph) + "%";
        }

        function narra(txt, tipo = '') {
            const box = document.getElementById('match-feed');
            const div = document.createElement('div');
            div.className = `feed-msg ${tipo}`;
            div.innerHTML = `<span class="feed-time">${match.min}'</span> ${txt}`;
            box.prepend(div);
        }

        function registrarResumo(icone, texto) {
            const box = document.getElementById('match-events');
            // Remove msg de vazio se existir
            if(box.innerText.includes("Nenhum")) box.innerHTML = '';
            
            const div = document.createElement('div');
            div.className = 'event-row';
            div.innerHTML = `<span class="icon">${icone}</span> <span>${texto}</span>`;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        function encerrarJogo() {
            match.finished = true;
            clearInterval(timer);
            narra("üèÅ Fim de Jogo!", 'goal');
            
            document.getElementById('btn-exit').style.display = 'flex';
            document.getElementById('btn-pause').style.display = 'none';
            document.getElementById('btn-sub').style.display = 'none';
        }

        // --- CONTROLES ---

        function pausarJogo() {
            match.paused = !match.paused;
            document.getElementById('btn-pause').innerText = match.paused ? "‚ñ∂Ô∏è Retomar" : "‚è∏Ô∏è Pausar";
        }

        function mudarVelocidade() {
            if(match.speed === 1000) { match.speed = 200; document.getElementById('lbl-speed').innerText = "5x"; }
            else if(match.speed === 200) { match.speed = 50; document.getElementById('lbl-speed').innerText = "MAX"; }
            else { match.speed = 1000; document.getElementById('lbl-speed').innerText = "1x"; }
            
            clearInterval(timer);
            if(!match.paused && !match.finished) timer = setInterval(loop, match.speed);
        }

        // --- SUBSTITUI√á√ÉO ---

        function abrirSubs() {
            match.paused = true;
            document.getElementById('sub-modal').style.display = 'flex';
            renderSubs();
        }
        function fecharSubs() {
            document.getElementById('sub-modal').style.display = 'none';
            match.paused = false;
        }

        function renderSubs() {
            const team = isHome ? homeTeam : awayTeam;
            const tits = team.elenco.slice(0, 11);
            const res = team.elenco.slice(11);

            const fillCol = (id, list, type) => {
                const div = document.getElementById(id);
                div.innerHTML = `<div style="padding:10px; font-weight:bold; color:#aaa; text-align:center;">${type === 'out' ? 'TITULARES (Sair)' : 'RESERVAS (Entrar)'}</div>`;
                list.forEach((p, i) => {
                    const el = document.createElement('div');
                    el.className = 'p-opt';
                    if((type==='out' && subOut===i) || (type==='in' && subIn===i)) el.classList.add('selected');
                    el.innerText = `${p.pos} ${p.nome} (${p.energia}%)`;
                    el.onclick = () => { 
                        if(type==='out') subOut = i; else subIn = i;
                        renderSubs();
                    };
                    div.appendChild(el);
                });
            };
            fillCol('col-out', tits, 'out');
            fillCol('col-in', res, 'in');
        }

        function confirmarSub() {
            if(subOut === null || subIn === null) return;
            const team = isHome ? homeTeam : awayTeam;
            const realInIdx = subIn + 11;
            
            const temp = team.elenco[subOut];
            team.elenco[subOut] = team.elenco[realInIdx];
            team.elenco[realInIdx] = temp;

            narra(`üîÑ ${team.nome}: Sai ${temp.nome}, entra ${team.elenco[subOut].nome}.`);
            
            subOut = null; subIn = null;
            fecharSubs();
            renderizarEscalacoes(); // Atualiza lista visual
        }

        // --- SAIR ---
        
        function sairDoJogo() {
            // Salva resultado
            const semIdx = gameState.semanaAtual - 1;
            const jogo = gameState.calendario[semIdx].jogos.find(j => j.casa === homeTeam.nome && j.fora === awayTeam.nome);
            
            jogo.golsCasa = match.score[0];
            jogo.golsFora = match.score[1];

            // Grana
            if(isHome) {
                const meu = gameState.times.find(t => t.nome === gameState.meuTime);
                if(meu && meu.financas) {
                    meu.financas.caixa += (match.renda - 50000); // Custo op.
                    meu.financas.receitas.bilheteria += match.renda;
                }
            }

            Engine.salvarJogo(gameState);
            
            // Simula o resto da rodada (HACK: Chama processarSemana mas vamos ignorar nosso jogo pois j√° temos placar,
            // mas o engine atual sobrescreve. Aceit√°vel pra v1).
            Engine.processarSemana(gameState); 
            
            // Corrige o placar do engine com o nosso real
            const jogoPosSim = gameState.calendario[semIdx].jogos.find(j => j.casa === homeTeam.nome && j.fora === awayTeam.nome);
            jogoPosSim.golsCasa = match.score[0];
            jogoPosSim.golsFora = match.score[1];
            Engine.salvarJogo(gameState);

            window.location.href = 'dashboard.html';
        }

    </script>
</body>
</html>
