<script>
        // Compatibilidade
        if (typeof database !== 'undefined') window.Database = database;
        if (typeof Database !== 'undefined') window.database = Database;

        let gameState, homeTeam, awayTeam;
        let titulares = [], reservas = [], indisponiveis = [];
        let awayTitulares = []; 
        let events = {}; 
        let formacaoAtual = "4-3-3";
        let matchInterval = null, tempo = 0, etapa = 1;
        let placar = { home: 0, away: 0 };
        let stats = { homeSho:0, awaySho:0, homePos:50 };
        let speed = 200; 
        let subPending = { sai: null, entra: null };
        let gameEvents = [];

        // T츼TICAS: Agora influenciam atributos espec칤ficos
        const TATICAS = {
            "4-3-3": { def: 1.0, mid: 1.0, att: 1.2, nome: "Ofensiva" },
            "4-4-2": { def: 1.1, mid: 1.1, att: 1.0, nome: "Linhas de 4" },
            "3-5-2": { def: 0.9, mid: 1.3, att: 1.0, nome: "Povoar Meio" },
            "4-2-3-1": { def: 1.15, mid: 1.0, att: 0.9, nome: "Segura e Sai" },
            "3-4-3": { def: 0.8, mid: 1.0, att: 1.25, nome: "Ataque Total" }
        };

        const layouts = { 
            "4-3-3": [{t:"50%",l:"6%"},{t:"15%",l:"25%"},{t:"38%",l:"20%"},{t:"62%",l:"20%"},{t:"85%",l:"25%"},{t:"50%",l:"40%"},{t:"30%",l:"55%"},{t:"70%",l:"55%"},{t:"20%",l:"85%"},{t:"50%",l:"85%"},{t:"80%",l:"85%"}],
            "4-4-2": [{t:"50%",l:"6%"},{t:"15%",l:"25%"},{t:"38%",l:"20%"},{t:"62%",l:"20%"},{t:"85%",l:"25%"},{t:"30%",l:"45%"},{t:"70%",l:"45%"},{t:"15%",l:"60%"},{t:"85%",l:"60%"},{t:"35%",l:"85%"},{t:"65%",l:"85%"}],
            "3-5-2": [{t:"50%",l:"6%"},{t:"20%",l:"20%"},{t:"50%",l:"18%"},{t:"80%",l:"20%"},{t:"15%",l:"45%"},{t:"35%",l:"40%"},{t:"65%",l:"40%"},{t:"85%",l:"45%"},{t:"50%",l:"60%"},{t:"35%",l:"85%"},{t:"65%",l:"85%"}],
            "4-2-3-1":[{t:"50%",l:"6%"},{t:"15%",l:"25%"},{t:"38%",l:"20%"},{t:"62%",l:"20%"},{t:"85%",l:"25%"},{t:"35%",l:"40%"},{t:"65%",l:"40%"},{t:"20%",l:"65%"},{t:"50%",l:"60%"},{t:"80%",l:"65%"},{t:"50%",l:"88%"}],
            "3-4-3": [{t:"50%",l:"6%"},{t:"20%",l:"20%"},{t:"50%",l:"18%"},{t:"80%",l:"20%"},{t:"15%",l:"45%"},{t:"40%",l:"45%"},{t:"60%",l:"45%"},{t:"85%",l:"45%"},{t:"20%",l:"85%"},{t:"50%",l:"85%"},{t:"80%",l:"85%"}]
        };

        window.onload = function() { carregarDados(); };

        function carregarDados() {
            gameState = Engine.carregarJogo();
            if(!gameState) { window.location.href='index.html'; return; }

            const savedScheme = localStorage.getItem('brfutebol_esquema');
            if(savedScheme && TATICAS[savedScheme]) formacaoAtual = savedScheme;
            
            document.getElementById('sub-formation').value = formacaoAtual;
            document.getElementById('home-form-tag').innerText = formacaoAtual;

            homeTeam = encontrarTime(gameState.info.time);
            const opNome = localStorage.getItem('brfutebol_oponente_atual') || "Visitante";
            awayTeam = encontrarTime(opNome);
            
            if(!awayTeam.elenco || awayTeam.elenco.length===0) awayTeam.elenco = gerarGenericos(awayTeam.nome);
            if (!homeTeam.elenco || homeTeam.elenco.length === 0) homeTeam.elenco = gerarGenericos(homeTeam.nome);

            // Prepara meu time e garante atributos
            homeTeam.elenco.forEach((j, i) => { 
                if(!j.uid) j.uid = `p_${i}`; 
                if(!j.atributos) gerarAtributos(j); // Garante que existam para o c치lculo
                if(gameState.jogadoresStatus && gameState.jogadoresStatus[j.uid]) {
                    j.saude = gameState.jogadoresStatus[j.uid].saude;
                } else if(j.saude === undefined) {
                    j.saude = 100;
                }
            });
            organizarElenco(homeTeam);

            // Prepara rival e garante atributos
            const rivalForms = Object.keys(layouts);
            const rForm = rivalForms[Math.floor(Math.random() * rivalForms.length)];
            document.getElementById('away-form-tag').innerText = rForm;

            awayTeam.elenco.forEach((j,i) => { 
                j.uid = `cpu_${i}`; 
                j.saude = 100; 
                if(!j.atributos) gerarAtributos(j); 
            });
            const ordem = {'GOL':1, 'LD':2, 'LE':2, 'ZAG':3, 'VOL':4, 'MEI':5, 'ATA':6};
            const elencoRival = awayTeam.elenco.sort((a,b) => (ordem[a.pos]||99) - (ordem[b.pos]||99) || b.forca - a.forca);
            awayTitulares = elencoRival.slice(0, 11);

            renderizarSidebars();

            document.getElementById('home-name').innerText = homeTeam.nome;
            const shieldDefault = "https://cdn-icons-png.flaticon.com/512/53/53283.png";
            document.getElementById('home-logo').src = homeTeam.escudo || shieldDefault;
            document.getElementById('away-name').innerText = awayTeam.nome;
            document.getElementById('away-logo').src = awayTeam.escudo || shieldDefault;

            adicionarLog("", "Bola rolando! Estrat칠gia definida.", "");
            iniciarRelogio();
        }

        // --- C츼LCULO DE FOR칂A BASEADO EM ATRIBUTOS ---

        function calcularSetoresReais(timeJogadores, taticaNome, isHome) {
            let s = { def: 0, mid: 0, att: 0 };
            
            // Pesos: Quanto cada posi칞칚o contribui para cada setor
            const pPos = {
                'GOL': { def: 1.0, mid: 0.0, att: 0.0 }, // Goleiro 칠 100% defesa
                'ZAG': { def: 1.0, mid: 0.1, att: 0.0 },
                'LD':  { def: 0.7, mid: 0.3, att: 0.1 },
                'LE':  { def: 0.7, mid: 0.3, att: 0.1 },
                'VOL': { def: 0.6, mid: 0.4, att: 0.0 },
                'MEI': { def: 0.1, mid: 0.7, att: 0.2 },
                'ATA': { def: 0.0, mid: 0.1, att: 0.9 }
            };

            timeJogadores.forEach(j => {
                if (events[j.uid] && events[j.uid].cards.includes('游린')) return; // Expulso n칚o joga

                const atr = j.atributos || { VEL:60, FIN:60, PAS:60, DRI:60, DEF:60, FIS:60 };
                const peso = pPos[j.pos] || { def: 0.3, mid: 0.3, att: 0.3 };
                
                // Qualidade REAL em cada fundamento
                // Defesa = Marca칞칚o + F칤sico + Velocidade (para acompanhar)
                const valDef = (atr.DEF * 1.5 + atr.FIS + atr.VEL * 0.5) / 3;
                
                // Meio = Passe + Drible + Vis칚o(Passe)
                const valMid = (atr.PAS * 1.5 + atr.DRI + atr.FIS * 0.5) / 3;
                
                // Ataque = Finaliza칞칚o + Velocidade + Drible
                const valAtt = (atr.FIN * 1.5 + atr.VEL + atr.DRI * 0.5) / 3;

                // Penalidade de Cansa칞o
                const fadiga = (j.saude < 50) ? 0.6 : (j.saude < 80 ? 0.9 : 1.0);

                // Soma ao total do time
                s.def += valDef * peso.def * fadiga;
                s.mid += valMid * peso.mid * fadiga;
                s.att += valAtt * peso.att * fadiga;
            });

            // Aplica T치tica
            const tac = TATICAS[taticaNome] || { def:1, mid:1, att:1 };
            s.def *= tac.def; s.mid *= tac.mid; s.att *= tac.att;

            // Fator Casa
            if(isHome) { s.def *= 1.05; s.mid *= 1.05; s.att *= 1.05; }

            return s;
        }

        function processarLance() {
            const sHome = calcularSetoresReais(titulares, formacaoAtual, true);
            const taticaCpu = document.getElementById('away-form-tag').innerText || "4-4-2";
            const sAway = calcularSetoresReais(awayTitulares, taticaCpu, false);

            // 1. BATALHA DO MEIO-CAMPO (Posse)
            // Quem tem mais atributo de Passe/Drible no meio domina
            const totalMid = sHome.mid + sAway.mid || 1;
            let posseHome = (sHome.mid / totalMid) * 100;
            
            // Fator Sorte do Momento (+/- 12%)
            posseHome += (Math.random() * 24) - 12;
            posseHome = Math.max(20, Math.min(80, posseHome));

            stats.homePos = Math.round(posseHome);
            document.getElementById('stat-pos-h').innerText = stats.homePos + "%";
            document.getElementById('bar-pos-h').style.width = stats.homePos + "%";
            document.getElementById('stat-pos-a').innerText = (100 - stats.homePos) + "%";

            // 2. TENTATIVA DE ATAQUE
            const isHomeAttacking = Math.random() * 100 < stats.homePos;
            
            if (isHomeAttacking) {
                // Ataque Casa (FIN/VEL) vs Defesa Fora (DEF/FIS)
                tentarFinalizacao(sHome.att, sAway.def, true);
            } else {
                tentarFinalizacao(sAway.att, sHome.def, false);
            }

            // Eventos aleat칩rios
            if (Math.random() < 0.012) aplicarCartao();
            if (Math.random() < 0.003) aplicarLesao();
        }

        function tentarFinalizacao(ataque, defesa, isHome) {
            // Ratio de Poder Ofensivo
            const ratio = ataque / (defesa || 1); 
            // Chance base de criar chance clara: 6% * ratio
            if (Math.random() < 0.06 * ratio) {
                // Criou chance!
                if(isHome) { stats.homeSho++; adicionarLog(homeTeam.nome, "Finaliza com perigo!", "danger"); }
                else { stats.awaySho++; adicionarLog(awayTeam.nome, "Chute perigoso!", "danger"); }
                atualizarStats();

                // Convers칚o em Gol (Depende muito do "Finishing" do time)
                // Se o ataque for muito superior a defesa, chance de gol aumenta
                const chanceGol = 0.18 * ratio; 
                
                if (Math.random() < chanceGol) {
                    gol(isHome);
                }
            }
        }

        // --- SISTEMAS DE JOGO (Gol, Cart칚o, Les칚o) ---

        function gol(isHome) {
            let timeJogadores = isHome ? titulares : awayTitulares;
            // Filtra expulsos
            let validos = timeJogadores.filter(j => !events[j.uid] || !events[j.uid].cards.includes('游린'));
            
            if (validos.length === 0) return;

            pausarJogo();
            
            // Sorteio Ponderado: Quem tem mais FINALIZA칂츾O tem mais chance de ser o autor
            let totalFin = 0;
            validos.forEach(j => totalFin += (j.atributos ? j.atributos.FIN : 60));
            
            let r = Math.random() * totalFin;
            let autorObj = validos[0];
            let acumulado = 0;
            
            for(let j of validos) {
                acumulado += (j.atributos ? j.atributos.FIN : 60);
                if (r <= acumulado) { autorObj = j; break; }
            }

            if(isHome) placar.home++; else placar.away++;
            
            // Salva
            gameEvents.push({
                min: tempo + (etapa===2?45:0),
                time: isHome ? homeTeam.nome : awayTeam.nome,
                jogador: autorObj.nome,
                tipo: 'gol'
            });

            document.getElementById('score-home').innerText = placar.home;
            document.getElementById('score-away').innerText = placar.away;
            document.getElementById('goal-scorer-name').innerText = autorObj.nome;
            document.getElementById('goal-overlay').style.display = 'flex';
            
            adicionarLog("GOL", `${autorObj.nome} balan칞a a rede!`, "goal");
            registrarEvento(autorObj.uid, 'goals');
            renderizarSidebars();

            setTimeout(() => { document.getElementById('goal-overlay').style.display='none'; iniciarRelogio(); }, 2500);
        }

        function aplicarCartao() {
            const isHome = Math.random() > 0.5;
            const targetTeam = isHome ? titulares : awayTitulares;
            // Pega quem joga agressivo (DEF alta) ou aleat칩rio
            const jog = targetTeam[Math.floor(Math.random() * targetTeam.length)];
            
            if (events[jog.uid] && events[jog.uid].cards.includes('游린')) return;

            let novoCartao = '游릳';
            let txtLog = "Cart칚o Amarelo";
            let clsLog = "card";

            if (events[jog.uid] && events[jog.uid].cards.includes('游릳')) {
                novoCartao = '游린';
                txtLog = "Segundo Amarelo! EXPULSO";
                clsLog = "red-card";
            } else if (Math.random() < 0.04) { 
                novoCartao = '游린';
                txtLog = "Vermelho Direto! Entrada dura";
                clsLog = "red-card";
            }

            if(!events[jog.uid]) events[jog.uid] = { goals: 0, cards: '' };
            if (novoCartao === '游린') events[jog.uid].cards = '游린';
            else events[jog.uid].cards += '游릳';

            adicionarLog("Juiz", `${txtLog}: ${jog.nome}`, clsLog);
            
            gameEvents.push({
                min: tempo + (etapa===2?45:0),
                time: isHome ? homeTeam.nome : awayTeam.nome,
                jogador: jog.nome,
                tipo: 'card',
                detalhe: novoCartao
            });

            renderizarSidebars();
        }

        function aplicarLesao() {
            const isHome = Math.random() > 0.5;
            const targetTeam = isHome ? titulares : awayTitulares;
            // Jogadores cansados (saude < 60) tem mais chance de les칚o?
            // Por enquanto, aleat칩rio entre os n칚o expulsos
            const validos = targetTeam.filter(j => !events[j.uid] || !events[j.uid].cards.includes('游린'));
            if (validos.length === 0) return;

            const jog = validos[Math.floor(Math.random() * validos.length)];
            jog.saude = 10; // Les칚o grave
            adicionarLog("Les칚o", `${jog.nome} sente dores musculares!`, "injury");
            
            if (isHome) {
                pausarJogo();
                setTimeout(() => {
                    if(confirm(`${jog.nome} se lesionou! Substituir?`)) abrirModalSub();
                    else iniciarRelogio();
                }, 200);
            }
            renderizarSidebars();
        }

        function registrarEvento(uid, tipo) {
            if(!events[uid]) events[uid] = { goals: 0, cards: '' };
            if(tipo === 'goals') events[uid].goals++;
        }

        // --- FINALIZA칂츾O E INTERFACE ---

        function finalizarPartida() {
            titulares.forEach(j => { j.saude = Math.max(0, j.saude - 8); }); 
            indisponiveis.forEach(j => { j.saude = Math.max(0, j.saude - 4); }); 
            reservas.forEach(j => { j.saude = Math.min(100, j.saude + 6); }); 

            const statusJogadores = gameState.jogadoresStatus || {};
            [...titulares, ...reservas, ...indisponiveis].forEach(j => {
                statusJogadores[j.uid] = { saude: j.saude };
            });
            
            if(!gameState.classificacao) gameState.classificacao = []; 
            if(gameState.classificacao.length === 0 && gameState.times) {
                 gameState.classificacao = gameState.times.map(t => ({
                    nome: t.nome, pts: 0, j: 0, v: 0, e: 0, d: 0, gp: 0, gc: 0, sg: 0
                }));
            }
            
            const rodadaIndex = gameState.rodadaAtual - 1;
            if(gameState.calendario && gameState.calendario[rodadaIndex]) {
                const jogos = gameState.calendario[rodadaIndex].jogos;
                const meuJogo = jogos.find(j => j.mandante === homeTeam.nome || j.visitante === homeTeam.nome);
                if(meuJogo) {
                    meuJogo.jogado = true;
                    meuJogo.eventos = gameEvents;
                    if(meuJogo.mandante === homeTeam.nome) {
                        meuJogo.placarCasa = placar.home; meuJogo.placarFora = placar.away;
                    } else {
                        meuJogo.placarCasa = placar.away; meuJogo.placarFora = placar.home;
                    }
                }
                jogos.forEach(j => { if(!j.jogado) Engine.simularJogoCPU(j); });
            }

            Engine.atualizarTabela(gameState);
            gameState.jogadoresStatus = statusJogadores;
            gameState.rodadaAtual++;
            Engine.salvarJogo(gameState);
            localStorage.removeItem('brfutebol_oponente_atual');
            window.location.href = 'dashboard.html';
        }

        // --- MODAL, SUBS E TOOLTIPS (MANTIDOS) ---
        
        function abrirModalSub() {
            pausarJogo();
            document.getElementById('sub-modal').style.display = 'flex';
            renderizarCampoSub(); renderizarListaReservas();
            subPending = { sai: null, entra: null }; atualizarUIBotao();
        }
        function fecharModalSub() {
            document.getElementById('sub-modal').style.display = 'none';
            if(etapa===1 && tempo===45) { etapa=2; tempo=0; }
            iniciarRelogio();
        }
        function mudarFormacaoJogo() { formacaoAtual=document.getElementById('sub-formation').value; renderizarCampoSub(); adicionarLog("T칠c", `Mudou para ${formacaoAtual}`, "sub"); document.getElementById('home-form-tag').innerText = formacaoAtual; }
        
        function renderizarCampoSub() {
            const c = document.getElementById('pitch-container');
            c.querySelectorAll('.sub-p-node').forEach(n=>n.remove());
            const layout = layouts[formacaoAtual] || layouts['4-3-3'];
            titulares.forEach((j, i) => {
                const pos = layout[i] || {t:"50%",l:"50%"};
                const el = document.createElement('div');
                el.className = 'sub-p-node'; el.style.top=pos.t; el.style.left=pos.l;
                el.innerHTML = `<div class="sub-kit">${j.pos}</div><div class="sub-name">${j.nome.split(' ')[0]}</div>`;
                el.onclick = () => selecionarSai(j.uid, el);
                el.dataset.uid=j.uid;
                el.addEventListener('mouseenter', showTooltip); el.addEventListener('mousemove', moveTooltip); el.addEventListener('mouseleave', hideTooltip);
                c.appendChild(el);
            });
        }

        function renderizarListaReservas() {
            const l = document.getElementById('list-reservas-modal'); l.innerHTML='';
            const disp = reservas.filter(r => !indisponiveis.includes(r));
            disp.forEach(j => {
                const saude = j.saude !== undefined ? j.saude : 100;
                let cor = saude < 60 ? '#e74c3c' : '#2ecc71';
                const el = document.createElement('div'); el.className='player-row';
                el.innerHTML=`<div class="row-info"><span class="row-pos">${j.pos}</span><span class="row-name">${j.nome}</span></div><div class="row-stats"><span class="row-ovr">${j.forca || 60}</span><div class="row-hp-track"><div class="row-hp-fill" style="width:${saude}%; background:${cor}"></div></div></div>`;
                el.onclick = () => selecionarEntra(j.uid, el);
                el.dataset.uid=j.uid;
                el.addEventListener('mouseenter', showTooltip); el.addEventListener('mousemove', moveTooltip); el.addEventListener('mouseleave', hideTooltip);
                l.appendChild(el);
            });
        }

        function selecionarSai(uid, el) {
            document.querySelectorAll('.sub-p-node').forEach(n=>n.classList.remove('selected-out'));
            el.classList.add('selected-out'); subPending.sai=uid; atualizarUIBotao();
        }
        function selecionarEntra(uid, el) {
            document.querySelectorAll('.player-row').forEach(n=>n.classList.remove('selected-in'));
            el.classList.add('selected-in'); subPending.entra=uid; atualizarUIBotao();
        }
        function atualizarUIBotao() {
            const btn = document.getElementById('btn-confirm-sub');
            if(subPending.sai && subPending.entra) { btn.disabled=false; } else { btn.disabled=true; }
        }
        function confirmarSub() {
            if(!subPending.sai || !subPending.entra) return;
            const idxS = titulares.findIndex(j=>j.uid===subPending.sai);
            const idxE = reservas.findIndex(j=>j.uid===subPending.entra);
            if(idxS>-1 && idxE>-1) {
                const sai = titulares[idxS]; const entra = reservas[idxE];
                titulares[idxS] = entra; reservas.splice(idxE, 1); indisponiveis.push(sai);
                adicionarLog("Sub", `Sai ${sai.nome} | Entra ${entra.nome}`, "sub");
                registrarEvento(entra.uid, 'sub_in'); 
                subPending={sai:null, entra:null};
                renderizarCampoSub(); renderizarListaReservas(); renderizarSidebars(); atualizarUIBotao();
            }
        }

        function showTooltip(e) {
            const uid = this.dataset.uid; if(!uid)return;
            const jog = titulares.find(j=>j.uid===uid) || reservas.find(j=>j.uid===uid) || indisponiveis.find(j=>j.uid===uid);
            if(!jog)return;
            if(!jog.atributos) gerarAtributos(jog);
            document.getElementById('tip-name').innerText=jog.nome; document.getElementById('tip-pos').innerText=jog.pos; document.getElementById('tip-ovr').innerText=jog.forca||60;
            const g=document.getElementById('tip-grid'); g.innerHTML='';
            const l={VEL:'PAC',FIN:'SHO',PAS:'PAS',DRI:'DRI',DEF:'DEF',FIS:'PHY'};
            for(let k in l) { let v=jog.atributos[k]; let c='mid'; if(v>=80)c='high'; if(v<60)c='low'; g.innerHTML+=`<div class="fifa-stat"><span>${l[k]}</span><b class="${c}">${v}</b></div>`; }
            document.getElementById('fifa-tooltip').style.display='block'; moveTooltip(e);
        }
        function moveTooltip(e) { const t=document.getElementById('fifa-tooltip'); t.style.top=(e.clientY+15)+'px'; t.style.left=(e.clientX+15)+'px'; }
        function hideTooltip() { document.getElementById('fifa-tooltip').style.display='none'; }
        
        function gerarAtributos(j) {
            // Garante atributos se o jogador n칚o tiver
            const b = j.forca || 60;
            if(j.pos==='GOL') j.atributos={VEL:b+2, FIN:b-15, PAS:b, DRI:b-15, DEF:b+5, FIS:b};
            else if(j.pos==='ZAG') j.atributos={VEL:b-5, FIN:b-20, PAS:b-5, DRI:b-10, DEF:b+5, FIS:b+5};
            else if(j.pos==='ATA') j.atributos={VEL:b+5, FIN:b+5, PAS:b-5, DRI:b+5, DEF:b-25, FIS:b};
            else j.atributos={VEL:b, FIN:b-5, PAS:b+5, DRI:b, DEF:b, FIS:b};
        }

        function adicionarLog(h, t, cl) { const f=document.getElementById('feed'); f.insertAdjacentHTML('afterbegin', `<div class="feed-item ${cl}"><div class="feed-time">${tempo}'</div><div><b>${h}</b> ${t}</div></div>`); }
        function calcularMedia(arr) { if(!arr.length) return 60; return arr.reduce((a,b)=>a+(b.forca||60),0)/arr.length; }
        function atualizarStats() { 
            document.getElementById('stat-sho-h').innerText=stats.homeSho; document.getElementById('stat-sho-a').innerText=stats.awaySho;
            const t = stats.homeSho+stats.awaySho||1; document.getElementById('bar-sho-h').style.width=((stats.homeSho/t)*100)+"%";
        }
        function encontrarTime(nome) {
            if (gameState && gameState.times) {
                const timeNoSave = gameState.times.find(t => t.nome === nome);
                if (timeNoSave) return JSON.parse(JSON.stringify(timeNoSave));
            }
            const db = window.database || window.Database;
            if (db && db.brasil) {
                 for(let s in db.brasil) {
                    if (Array.isArray(db.brasil[s])) {
                        const t = db.brasil[s].find(x => x.nome === nome);
                        if(t) return JSON.parse(JSON.stringify(t)); 
                    }
                 }
            }
            return { nome: nome, escudo: "", elenco: [] };
        }
        function gerarGenericos(nome) { 
            let l=[]; 
            const posicoes = ['GOL','ZAG','ZAG','LD','LE','VOL','MEI','MEI','ATA','ATA','ATA', 'GOL', 'ZAG', 'MEI', 'ATA'];
            for(let i=0;i<posicoes.length;i++) {
                let j = {nome:`Jogador ${i+1}`, pos:posicoes[i], forca: Math.floor(Math.random()*20)+60};
                gerarAtributos(j);
                l.push(j);
            }
            return l; 
        }
        function organizarElenco(time) {
            const savedForm = localStorage.getItem('brfutebol_formacao');
            titulares = []; reservas = []; indisponiveis = [];
            let escaladosIds = [];
            if(savedForm) {
                try {
                    const map = JSON.parse(savedForm);
                    for(let i=1; i<=11; i++) {
                        const uid = map[`slot-${i}`];
                        const jog = time.elenco.find(j => j.uid === uid);
                        if(jog) { titulares.push(jog); escaladosIds.push(jog.uid); }
                    }
                } catch(e){}
            }
            if(titulares.length < 11) {
                const disp = time.elenco.filter(j => !escaladosIds.includes(j.uid));
                disp.sort((a,b)=> (b.forca||60) - (a.forca||60));
                for(let k=0; k<(11-titulares.length); k++) {
                    if(disp[k]) { titulares.push(disp[k]); escaladosIds.push(disp[k].uid); }
                }
            }
            reservas = time.elenco.filter(j => !escaladosIds.includes(j.uid));
        }
        function iniciarRelogio() { clearInterval(matchInterval); matchInterval = setInterval(loopJogo, speed); }
        function pausarJogo() { clearInterval(matchInterval); }
        function setSpeed(m, btn) {
            document.querySelectorAll('.btn-speed').forEach(b=>b.classList.remove('active')); btn.classList.add('active');
            speed = m===1?200 : m===2?80 : 10;
            if(!document.getElementById('sub-modal').style.display.includes('flex')) iniciarRelogio();
        }
    </script>
